(function(){"use strict";sap.ui.controller("tiles.indicatordeviation.DeviationTile",{onInit:function(){var t=this;this.firstTimeVisible=false;this.oKpiTileView=this.getView();this.oViewData=this.oKpiTileView.getViewData(),this.oTileApi=this.oViewData.chip;if(this.oTileApi.visible){this.oTileApi.visible.attachVisible(this.visibleHandler.bind(this))}this.system=this.oTileApi.url.getApplicationSystem();this.oKpiTileView.oGenericTile.setState(sap.suite.ui.commons.LoadState.Loading);try{sap.ushell.components.tiles.indicatorTileUtils.util.getParsedChip(this.oTileApi.configuration.getParameterValueAsString("tileConfiguration"),function(c){t.oConfig=c;t.setTextInTile();if(t.oTileApi.preview){t.oTileApi.preview.setTargetUrl(sap.ushell.components.tiles.indicatorTileUtils.util.getNavigationTarget(t.oConfig,t.system))}if(t.oTileApi.preview.isEnabled()){t._updateTileModel({actual:{value:120,color:sap.suite.ui.commons.InfoTileValueColor.Good},targetValue:100,thresholds:[{value:0,color:sap.suite.ui.commons.InfoTileValueColor.Error},{value:50,color:sap.suite.ui.commons.InfoTileValueColor.Critical},{value:150,color:sap.suite.ui.commons.InfoTileValueColor.Critical},{value:200,color:sap.suite.ui.commons.InfoTileValueColor.Error}],showActualValue:true,showTargetValue:true});t.oKpiTileView.oGenericTile.setState(sap.suite.ui.commons.LoadState.Loaded)}else{t.oKpiTileView.oGenericTile.attachPress(function(){sap.ushell.components.tiles.indicatorTileUtils.util.abortPendingODataCalls(t.queryServiceUriODataReadRef);sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,null);window.location.hash=sap.ushell.components.tiles.indicatorTileUtils.util.getNavigationTarget(t.oConfig,t.system)});if(Number(t.oTileApi.configuration.getParameterValueAsString("isSufficient"))){sap.ushell.components.tiles.indicatorTileUtils.cache.setEvaluationById(t.oConfig.TILE_PROPERTIES.id,t.oConfig);t.flowWithoutDesignTimeCall()}else{t.flowWithDesignTimeCall()}}})}catch(e){this.logError(e)}},_setLocalModelToTile:function(){if(this.getTile().getModel()){}else{this.getTile().setModel(new sap.ui.model.json.JSONModel({}))}},getTile:function(){return this.oKpiTileView.oGenericTile},_updateTileModel:function(n){var m=this.getTile().getModel().getData();jQuery.extend(m,n);this.getTile().getModel().setData(m)},fetchKpiValue:function(s,E){var t=this;var k=0;try{var u=this.DEFINITION_DATA.EVALUATION.ODATA_URL;var a=this.DEFINITION_DATA.EVALUATION.ODATA_ENTITYSET;var T=this.setThresholdValues();var m=T.fullyFormedMeasure;var c=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(t.oConfig.TILE_PROPERTIES.id);if(!c){var v=sap.ushell.components.tiles.indicatorTileUtils.util.prepareFilterStructure(this.DEFINITION_DATA.EVALUATION_FILTERS,this.DEFINITION_DATA.ADDITIONAL_FILTERS);var q=sap.ushell.components.tiles.indicatorTileUtils.util.prepareQueryServiceUri(t.oTileApi.url.addSystemToServiceUrl(u),a,m,null,v);if(q){this.QUERY_SERVICE_MODEL=q.model;this.queryUriForKpiValue=q.uri;try{this.queryServiceUriODataReadRef=this.QUERY_SERVICE_MODEL.read(q.uri,null,null,true,function(d){var w={};if(d&&d.results&&d.results.length){k=d.results[0][t.DEFINITION_DATA.EVALUATION.COLUMN_NAME];if(q.unit){t._updateTileModel({unit:d.results[0][q.unit.name]});w.unit=q.unit;w.unit.name=q.unit.name}w.data=d;sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,w);if(t.DEFINITION_DATA.EVALUATION.VALUES_SOURCE=="MEASURE"){T.criticalHighValue=d.results[0][T.sCriticalHigh];T.criticalLowValue=d.results[0][T.sCriticalLow];T.warningHighValue=d.results[0][T.sWarningHigh];T.warningLowValue=d.results[0][T.sWarningLow];T.targetValue=d.results[0][T.sTarget];T.trendValue=d.results[0][T.sTrend]}s.call(t,k,T)}else{E.call(t,"no Response from QueryServiceUri")}},function(b){if(b&&b.response){E.call(t,b.message)}})}catch(e){t.logError("Error in Query Service URI")}}}else{if(c.data&&c.data.results&&c.data.results.length){k=c.data.results[0][t.DEFINITION_DATA.EVALUATION.COLUMN_NAME];if(c.unit){t._updateTileModel({unit:c.data.results[0][c.unit.name]})}if(t.DEFINITION_DATA.EVALUATION.VALUES_SOURCE=="MEASURE"){T.criticalHighValue=c.data.results[0][T.sCriticalHigh];T.criticalLowValue=c.data.results[0][T.sCriticalLow];T.warningHighValue=c.data.results[0][T.sWarningHigh];T.warningLowValue=c.data.results[0][T.sWarningLow];T.targetValue=c.data.results[0][T.sTarget];T.trendValue=c.data.results[0][T.sTrend]}s.call(t,k,T)}else{E.call(t,"no Response from QueryServiceUri")}}}catch(e){E.call(t,e)}},getThresholdsObjAndColor:function(t){try{var T={};T.arrObj=[];T.returnColor=sap.suite.ui.commons.InfoTileValueColor.Neutral;var i=this.DEFINITION_DATA.EVALUATION.GOAL_TYPE;var a=this.DEFINITION_DATA.EVALUATION_VALUES;var w,c,b,d;if(i==="MI"){b=Number(t.criticalHighValue)||0;d=Number(t.warningHighValue)||0;if(b&&d){b=window.parseFloat(b);d=window.parseFloat(d);T.arrObj.push({value:b,color:sap.suite.ui.commons.InfoTileValueColor.Error});T.arrObj.push({value:d,color:sap.suite.ui.commons.InfoTileValueColor.Critical});if(this.CALCULATED_KPI_VALUE<d){T.returnColor=sap.suite.ui.commons.InfoTileValueColor.Good}else if(this.CALCULATED_KPI_VALUE<=b){T.returnColor=sap.suite.ui.commons.InfoTileValueColor.Critical}else{T.returnColor=sap.suite.ui.commons.InfoTileValueColor.Error}}}else if(i==="MA"){c=Number(t.criticalLowValue)||0;w=Number(t.warningLowValue)||0;if(c&&w){c=window.parseFloat(c);w=window.parseFloat(w);T.arrObj.push({value:c,color:sap.suite.ui.commons.InfoTileValueColor.Error});T.arrObj.push({value:w,color:sap.suite.ui.commons.InfoTileValueColor.Critical});if(this.CALCULATED_KPI_VALUE<c){T.returnColor=sap.suite.ui.commons.InfoTileValueColor.Error}else if(this.CALCULATED_KPI_VALUE<=w){T.returnColor=sap.suite.ui.commons.InfoTileValueColor.Critical}else{T.returnColor=sap.suite.ui.commons.InfoTileValueColor.Good}}}else{b=Number(t.criticalHighValue)||0;d=Number(t.warningHighValue)||0;c=Number(t.criticalLowValue)||0;w=Number(t.warningLowValue)||0;if(w&&d&&c&&c){b=window.parseFloat(b);d=window.parseFloat(d);w=window.parseFloat(w);c=window.parseFloat(c);T.arrObj.push({value:b,color:sap.suite.ui.commons.InfoTileValueColor.Error});T.arrObj.push({value:d,color:sap.suite.ui.commons.InfoTileValueColor.Critical});T.arrObj.push({value:w,color:sap.suite.ui.commons.InfoTileValueColor.Critical});T.arrObj.push({value:c,color:sap.suite.ui.commons.InfoTileValueColor.Error});if(this.CALCULATED_KPI_VALUE<c||this.CALCULATED_KPI_VALUE>b){T.returnColor=sap.suite.ui.commons.InfoTileValueColor.Error}else if((this.CALCULATED_KPI_VALUE>=c&&this.CALCULATED_KPI_VALUE<=w)||(this.CALCULATED_KPI_VALUE>=d&&this.CALCULATED_KPI_VALUE<=b)){T.returnColor=sap.suite.ui.commons.InfoTileValueColor.Critical}else{T.returnColor=sap.suite.ui.commons.InfoTileValueColor.Good}}}return T}catch(e){this.logError(e)}},flowWithoutDesignTimeCall:function(){var t=this;var f,a;this.DEFINITION_DATA=this.oConfig;this._updateTileModel(this.DEFINITION_DATA);if(this.oTileApi.visible.isVisible()&&!this.firstTimeVisible){this.firstTimeVisible=true;this.fetchKpiValue(function(k,b){var c=Number(k);if(this.oConfig.EVALUATION.SCALING==-2)c*=100;f=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(Number(c),this.oConfig.EVALUATION.SCALING);if(this.oConfig.EVALUATION.SCALING==-2)f+=" %";this.CALCULATED_KPI_VALUE=Number(k);var d={};var e=this.getThresholdsObjAndColor(b);var g={value:Number(k),color:e.returnColor};d.actualValueLabel=f.toString();d.actual=g;d.thresholds=[];d.thresholds=e.arrObj;var h=this.DEFINITION_DATA.EVALUATION_VALUES;if(this.DEFINITION_DATA.EVALUATION.VALUES_SOURCE=="MEASURE"){var i=Number(b.targetValue);if(this.oConfig.EVALUATION.SCALING==-2)i*=100;a=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(i,this.oConfig.EVALUATION.SCALING);if(this.oConfig.EVALUATION.SCALING==-2)a+="%";d.targetValue=Number(b.targetValue);d.targetValueLabel=a.toString()}else{for(var j=0;j<h.length;j++){if(h[j].TYPE==="TA"){var i=Number(h[j].FIXED);if(this.oConfig.EVALUATION.SCALING==-2)i*=100;a=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(i);if(this.oConfig.EVALUATION.SCALING==-2)a+="%";d.targetValue=Number(h[j].FIXED);d.targetValueLabel=a.toString()}}}this._updateTileModel(d);var n=sap.ushell.components.tiles.indicatorTileUtils.util.getNavigationTarget(t.oConfig,t.system);t.oKpiTileView.oGenericTile.$().wrap("<a href ='"+n+"'/>");this.oKpiTileView.oGenericTile.setState(sap.suite.ui.commons.LoadState.Loaded)},this.logError)}},flowWithDesignTimeCall:function(){var t=this;try{var a=sap.ushell.components.tiles.indicatorTileUtils.cache.getEvaluationById(this.oConfig.EVALUATION.ID);if(a){t.oConfig.EVALUATION_FILTERS=a.EVALUATION_FILTERS;t.flowWithoutDesignTimeCall()}else{sap.ushell.components.tiles.indicatorTileUtils.util.getFilterFromRunTimeService(this.oConfig,function(f){t.oConfig.EVALUATION_FILTERS=f;sap.ushell.components.tiles.indicatorTileUtils.cache.setEvaluationById(t.oConfig.TILE_PROPERTIES.id,t.oConfig);t.flowWithoutDesignTimeCall()})}}catch(e){this.logError(e)}},setTextInTile:function(){var t=this;this._updateTileModel({header:t.oTileApi.preview.getTitle()||sap.ushell.components.tiles.indicatorTileUtils.util.getChipTitle(t.oConfig),subheader:t.oTileApi.preview.getDescription()||sap.ushell.components.tiles.indicatorTileUtils.util.getChipSubTitle(t.oConfig)})},logError:function(e){this.oKpiTileView.oGenericTile.setState(sap.suite.ui.commons.LoadState.Failed);this.oKpiTileView.oGenericTile.setState(sap.suite.ui.commons.LoadState.Failed);sap.ushell.components.tiles.indicatorTileUtils.util.logError(e)},setThresholdValues:function(){var t=this;var T={};T.fullyFormedMeasure=this.DEFINITION_DATA.EVALUATION.COLUMN_NAME;if(this.DEFINITION_DATA.EVALUATION.VALUES_SOURCE=="MEASURE"){switch(this.DEFINITION_DATA.EVALUATION.GOAL_TYPE){case"MI":T.sWarningHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WH","MEASURE");T.sCriticalHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CH","MEASURE");T.sTarget=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TA","MEASURE");T.sTrend=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TC","MEASURE");T.fullyFormedMeasure+=t.formSelectStatement(T);break;case"MA":T.sWarningLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WL","MEASURE");T.sCriticalLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CL","MEASURE");T.sTarget=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TA","MEASURE");T.sTrend=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TC","MEASURE");T.fullyFormedMeasure+=t.formSelectStatement(T);break;case"RA":T.sWarningHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WH","MEASURE");T.sCriticalHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CH","MEASURE");T.sTarget=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TA","MEASURE");T.sTrend=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TC","MEASURE");T.sWarningLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WL","MEASURE");T.sCriticalLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CL","MEASURE");T.fullyFormedMeasure+=t.formSelectStatement(T);break}}else{T.criticalHighValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CH","FIXED");T.criticalLowValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CL","FIXED");T.warningHighValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WH","FIXED");T.warningLowValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WL","FIXED");T.targetValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TA","FIXED");T.trendValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TC","FIXED")}return T},formSelectStatement:function(o){var t=Object.keys(o);var f="";for(var i=0;i<t.length;i++)if((o[t[i]]!==undefined)&&(o.fullyFormedMeasure))f+=","+o[t[i]];return f},refreshHandler:function(c){if(!c.firstTimeVisible){if(Number(this.oTileApi.configuration.getParameterValueAsString("isSufficient")))c.flowWithoutDesignTimeCall();else c.flowWithDesignTimeCall()}},visibleHandler:function(i){if(!i){this.firstTimeVisible=false;sap.ushell.components.tiles.indicatorTileUtils.util.abortPendingODataCalls(this.queryServiceUriODataReadRef)}if(i){this.refreshHandler(this)}},onExit:function(){sap.ushell.components.tiles.indicatorTileUtils.util.abortPendingODataCalls(this.queryServiceUriODataReadRef)}})}());
