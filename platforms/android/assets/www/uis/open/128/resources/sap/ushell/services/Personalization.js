// Copyright (c) 2013 SAP AG, All Rights Reserved
(function(){"use strict";jQuery.sap.declare("sap.ushell.services.Personalization");jQuery.sap.require("sap.ushell.utils");jQuery.sap.require("sap.ui.core.format.DateFormat");var c="sap.ushell.personalization#",i="ITEM#",v="VARIANTSET#",A="yyyyMMddHHmmss",d="ADMIN#",I="sap-ushell-container-scope",f="sap-ushell-container-storageUTCTimestamp",g="sap-ushell-container-expireUTCTimestamp";function h(C){return c+C}sap.ushell.services.Personalization=function(a){this._oAdapter=a;this._oContainerMap=new sap.ushell.utils.Map();this._oPendingOperationsMap=new sap.ushell.utils.Map()};sap.ushell.services.Personalization.prototype.SAVE_DEFERRED_DROPPED="Deferred save dropped (OK) - Data superseeded by subsequent save";sap.ushell.services.Personalization.prototype.getPersonalizer=function(p){return new sap.ushell.services.Personalizer(this,this._oAdapter,p)};sap.ushell.services.Personalization.prototype.getTransientPersonalizer=function(){return new sap.ushell.services.TransientPersonalizer()};function r(s){var C={validity:Infinity};C.validity=s&&s.validity;if(C.validity===null||C.validity===undefined||typeof C.validity!=="number"){C.validity=Infinity}if(!(typeof C.validity==="number"&&((C.validity>=0&&C.validity<1000)||C.validity===Infinity))){C.liftime=Infinity}return C}sap.ushell.services.Personalization.prototype.getContainer=function(C,s){var p="",o={},P={},D={},a,t=this;if(typeof C!=="string"){throw new sap.ushell.utils.Error("sContainerKey is not a string: sap.ushell.services.Personalization")}if(C.length>40){jQuery.sap.log.error("Personalization Service container key (\""+C+"\") should be less than 40 characters [current :"+C.length+"]")}s=r(s);p=h(C);D=new jQuery.Deferred();a=this._oAdapter;if(s&&s.validity===0){a=new sap.ushell.services.Personalization.WindowValidityPersistenceAdapter(this)}o=new sap.ushell.services.Personalization.ContextContainer(this,a,p,s);o.load().fail(function(){D.reject()}).done(function(){if(o._isExpired()){o.clear()}D.resolve(o)});return D.promise()};sap.ushell.services.Personalization.prototype.createEmptyContainer=function(C,s){var p=this.getContainer(C,s),D=new jQuery.Deferred();p.fail(function(){D.reject()}).done(function(o){o.clear();D.resolve(o)});return D.promise()};sap.ushell.services.Personalization.prototype.delContainer=function(C,s){var o={},D={},p,a,P="",t=this;s=r(s);P=h(C);D=new jQuery.Deferred();p=t._pendingContainerOperations_cancelAddNext(C,null);p.always(function(){t.getContainer(C,s).fail(function(){t._pendingContainerOperations_cancelAddNext(C,D);D.reject()}).done(function(o){var b=t._oAdapter;t._pendingContainerOperations_cancelAddNext(C,D);if(s.validity===0){b=new sap.ushell.services.Personalization.WindowValidityPersistenceAdapter(t)}b.delAdapterContainer(P).fail(function(){D.reject()}).done(function(){D.resolve()})})});return D.promise()};sap.ushell.services.Personalization.prototype._pendingContainerOperations_flushAddNext=function(C,D){var p,s;p=this._oPendingOperationsMap.get(C);if(!p){p=new jQuery.Deferred();p.resolve()}if(D!==null){this._oPendingOperationsMap.put(C,D)}if(!p||p.state()!=="pending"){return p}clearTimeout(p._sapTimeoutId);p._sapTimeoutId=undefined;if(typeof p._sapFnSave==="function"){s=p._sapFnSave;p._sapFnSave=undefined;s()}return p};sap.ushell.services.Personalization.prototype._pendingContainerOperations_cancelAddNext=function(C,D){var p,s;p=this._oPendingOperationsMap.get(C);if(!p){p=new jQuery.Deferred();p.resolve()}if(D!==null){this._oPendingOperationsMap.put(C,D)}if(!p||p.state()!=="pending"){return p}if(p._sapTimeoutId){clearTimeout(p._sapTimeoutId);p._sapTimeoutId=undefined;p.resolve(sap.ushell.services.Personalization.prototype.SAVE_DEFERRED_DROPPED)}return p};sap.ushell.services.Personalization.prototype.getPersonalizationContainer=function(C){var p="",o={},P={},D={},t=this;if(typeof C!=="string"){throw new sap.ushell.utils.Error("sContainerKey is not a string: sap.ushell.services.Personalization")}p=h(C);if(this._oContainerMap.containsKey(p)){return this._oContainerMap.get(p).promise()}D=new jQuery.Deferred();P=new sap.ushell.services.PersonalizationContainer(this._oAdapter,p);P.done(function(o){D.resolve(o)}).fail(function(o){D.reject(o)});this._oContainerMap.put(p,D);return D.promise()};sap.ushell.services.Personalization.prototype.delPersonalizationContainer=function(C){var o={},D={},p="",t=this;p=h(C);D=new jQuery.Deferred();this.getPersonalizationContainer(C).fail(function(){D.reject()}).done(function(o){t._oAdapter.delAdapterContainer(p).fail(function(){D.reject()}).done(function(){t._oContainerMap.remove(p);D.resolve()})});return D.promise()};sap.ushell.services.Personalizer=function(s,a,p){var C="sap.ushell.personalization#";this._sPersContainer="";this._sPersItem="";this._sPersVariant=null;this._oAdapter={};this._oService={};this._oService=s;this._oAdapter=a;if(!p||!p.container||!p.item||typeof p.container!=="string"||typeof p.item!=="string"){throw new sap.ushell.utils.Error("Invalid input for oPersId: sap.ushell.services.Personalization")}this._sPersContainer=p.container;this._sPersItem=p.item};sap.ushell.services.Personalizer.prototype._getContainer=function(p){if(!this._oGetContainerPromise){this._oGetContainerPromise=this._oService.getContainer(p)}return this._oGetContainerPromise};sap.ushell.services.Personalizer.prototype.getPersData=function(){var D={},t=this;D=new jQuery.Deferred();this._getContainer(this._sPersContainer).fail(function(){D.reject()}).done(function(C){D.resolve(C.getItemValue(t._sPersItem))});D.fail(function(){jQuery.sap.log.error("Fail to get Personalization data for Personalizer container: "+t._sPersContainer)});return D.promise()};sap.ushell.services.Personalizer.prototype.setPersData=function(V){var D={},t=this;D=new jQuery.Deferred();this._getContainer(this._sPersContainer).fail(function(){D.reject()}).done(function(C){C.setItemValue(t._sPersItem,V);C.save().fail(function(){D.reject()}).done(function(){D.resolve()})});D.fail(function(){jQuery.sap.log.error("Fail to set Personalization data for Personalizer container: "+t._sPersContainer)});return D.promise()};sap.ushell.services.Personalizer.prototype.delPersData=function(){var D={},t=this,m;D=new jQuery.Deferred();this._oService.getPersonalizationContainer(this._sPersContainer).fail(function(){D.reject()}).done(function(C){C.delItem(t._sPersItem);C.save().fail(function(){D.reject()}).done(function(){D.resolve()})});m=D.promise();m.fail(function(){jQuery.sap.log.error("Fail to delete Personalization data for Personalizer container: "+this._sPersContainer)});return m};sap.ushell.services.TransientPersonalizer=function(){this._oValue=undefined};sap.ushell.services.TransientPersonalizer.prototype.getPersData=function(){var D;D=new jQuery.Deferred();D.resolve(this._oValue);return D.promise()};sap.ushell.services.TransientPersonalizer.prototype.setPersData=function(V){var D;D=new jQuery.Deferred();this._oValue=V;D.resolve();return D.promise()};sap.ushell.services.TransientPersonalizer.prototype.delPersData=function(){var D;D=new jQuery.Deferred();this._oValue=undefined;D.resolve();return D.promise()};sap.ushell.services.TransientPersonalizer.prototype.setValue=function(V){this._oValue=V};sap.ushell.services.TransientPersonalizer.prototype.getValue=function(){return this._oValue};sap.ushell.services.PersonalizationContainer=function(a,C){this._sContainerKey=C;this._oAdapterContainer={};this._aLoadedVariantSetKeys=[];this._aLoadedItemKeys=[];var D={},t=this;this._init();D=new jQuery.Deferred();if(!this._sContainerKey||typeof this._sContainerKey!=="string"){throw new sap.ushell.utils.Error("Invalid container key: sap.ushell.services.Personalization")}this._oAdapterContainer=a.getAdapterContainer(this._sContainerKey);this.load().fail(function(){D.reject()}).done(function(){D.resolve(t)});return D.promise()};sap.ushell.services.PersonalizationContainer.prototype._init=function(){this._oVariantSetMap={};this._oItemMap={};this._aLoadedVariantSetKeys=[];this._aLoadedItemKeys=[];this._oVariantSetMap=new sap.ushell.utils.Map();this._oItemMap=new sap.ushell.utils.Map()};function j(o){if(o===undefined){return undefined}try{return JSON.parse(JSON.stringify(o))}catch(e){return undefined}}function k(o){if(o===undefined){return undefined}try{return JSON.parse(o)}catch(e){return undefined}}sap.ushell.services.PersonalizationContainer.prototype.load=function(){var D={},a=[],V=[],b=[],m=[],t=this;function e(b){var n=[],p=[],R=[];n=b.filter(function(s){return s.indexOf(i)!==0});if(n.length===0){return b}p=b.filter(function(s){return s.indexOf(i)===0});n.forEach(function(s){var o={},P="";P=i+s;o=j(t._oAdapterContainer.getItemValue(s));t._oAdapterContainer.setItemValue(P,o);t._oAdapterContainer.delItem(s);if(jQuery.inArray(P,p)===-1){p.push(P)}});return p}D=new jQuery.Deferred();if(!this._sContainerKey){throw new sap.ushell.utils.Error("Invalid container key: sap.ushell.services.Personalization")}this._init();this._oAdapterContainer.load().fail(function(){D.reject()}).done(function(){a=t._oAdapterContainer.getItemKeys().splice(0);V=a.filter(function(s){return s.indexOf(v)===0});V.forEach(function(s){var o={};o=new sap.ushell.services.PersonalizationContainerVariantSet(s,t._oAdapterContainer);t._oVariantSetMap.put(s,o)});b=a.filter(function(s){return s.indexOf(v)!==0});m=e(b);m.forEach(function(s){t._oItemMap.put(s,j(t._oAdapterContainer.getItemValue(s)))});t._aLoadedVariantSetKeys=t._oVariantSetMap.keys().splice(0);t._aLoadedItemKeys=t._oItemMap.keys().splice(0);D.resolve()});return D.promise()};sap.ushell.services.PersonalizationContainer.prototype.save=function(){var s,o;this._serializeVariantSets();this._serializeItems();s=new jQuery.Deferred();function S(){s.resolve()}function a(){s.reject()}try{o=this._oAdapterContainer.save();o.fail(a);o.done(S)}catch(e){s.reject()}return s.promise()};sap.ushell.services.PersonalizationContainer.prototype.getItemKeys=function(){return this._oItemMap.keys().map(function(e){return e.replace(i,"","")})};sap.ushell.services.PersonalizationContainer.prototype.getItemValue=function(s){if(typeof s!=="string"){return undefined}return this._oItemMap.get(i+s)};sap.ushell.services.PersonalizationContainer.prototype.containsItem=function(s){if(typeof s!=="string"){return undefined}return this._oItemMap.containsKey(i+s)};sap.ushell.services.PersonalizationContainer.prototype.setItemValue=function(s,o){if(typeof s!=="string"){throw new sap.ushell.utils.Error("Parameter value of sItemKey is not a string: sap.ushell.services.Personalization")}this._oItemMap.put(i+s,o)};sap.ushell.services.PersonalizationContainer.prototype.delItem=function(s){if(typeof s!=="string"){return undefined}if(this.containsItem(s)){this._oItemMap.remove(i+s)}};sap.ushell.services.PersonalizationContainer.prototype._serializeItems=function(){var a=[],D=[],t=this;a=this._oItemMap.keys();a.forEach(function(s){t._oAdapterContainer.setItemValue(s,j(t._oItemMap.get(s)))});D=this._aLoadedItemKeys.filter(function(s){return!(a.indexOf(s)>-1)});D.forEach(function(s){t._oAdapterContainer.delItem(s)})};sap.ushell.services.PersonalizationContainer.prototype.getVariantSetKeys=function(){var a=[],V=[],p=[],t=this;p=this._oVariantSetMap.keys();V=p.map(function(e){return e.replace(v,"","")});return V};sap.ushell.services.PersonalizationContainer.prototype.containsVariantSet=function(V){return this._oVariantSetMap.containsKey(v+V)};sap.ushell.services.PersonalizationContainer.prototype.getVariantSet=function(V){var p,o={},m={};p=v+V;o=this._oVariantSetMap.get(p);return o};sap.ushell.services.PersonalizationContainer.prototype.addVariantSet=function(V){var e={},o={},p="";if(this.containsVariantSet(V)){throw new sap.ushell.utils.Error("Container already contains a variant set with key '"+V+"': sap.ushell.services.Personalization")}p=v+V;e={currentVariant:null,variants:{}};this._oAdapterContainer.setItemValue(p,e);o=new sap.ushell.services.PersonalizationContainerVariantSet(p,this._oAdapterContainer);this._oVariantSetMap.put(p,o);return o};sap.ushell.services.PersonalizationContainer.prototype._serializeVariantSets=function(){var V=[],s="",D=[],t=this;V=this._oVariantSetMap.keys();V.forEach(function(s){var o={},a={};o=t._oVariantSetMap.get(s);a=o._serialize();t._oAdapterContainer.setItemValue(s,j(a))});D=this._aLoadedVariantSetKeys.filter(function(s){return!(V.indexOf(s)>-1)});D.forEach(function(s){t._oAdapterContainer.delItem(s)})};sap.ushell.services.PersonalizationContainer.prototype.delVariantSet=function(V){var p="";p=v+V;this._oVariantSetMap.remove(p);return this._oAdapterContainer.delItem(p)};sap.ushell.services.Personalization.ContextContainer=function(s,a,C,S){this._oService=s;this._sContainerKey=C;this._oAdapterContainer={};this._oScope=S||{validity:Infinity};this._aLoadedKeys=[];var D={},t=this;this.clear();if(!this._sContainerKey||typeof this._sContainerKey!=="string"){throw new sap.ushell.utils.Error("Invalid container key: sap.ushell.services.Personalization")}this._oAdapterContainer=a.getAdapterContainer(this._sContainerKey);return this};sap.ushell.services.Personalization.ContextContainer.prototype.getValidity=function(){return this._oScope.validity};sap.ushell.services.Personalization.ContextContainer.prototype.clear=function(){this._oItemMap={};this._aLoadedItemKeys=[];this._clear=true;this._oItemMap=new sap.ushell.utils.Map()};sap.ushell.services.Personalization.ContextContainer.prototype.load=function(){var D={},a=[],p,t=this;D=new jQuery.Deferred();if(!this._sContainerKey){throw new sap.ushell.utils.Error("Invalid container key: sap.ushell.services.Personalization")}this.clear();p=this._oService._pendingContainerOperations_flushAddNext(this._sContainerKey,D);p.always(function(){t._oAdapterContainer.load().fail(function(){D.reject()}).done(function(){t._copyFromAdapter();D.resolve()})});return D.promise()};sap.ushell.services.Personalization.ContextContainer.prototype._copyFromAdapter=function(){var t=this,a;a=t._oAdapterContainer.getItemKeys().splice(0);a.forEach(function(s){t._oItemMap.put(s,JSON.stringify(t._oAdapterContainer.getItemValue(s)))});this._aLoadedItemKeys=t._oItemMap.keys().splice(0)};sap.ushell.services.Personalization.ContextContainer.prototype._isExpired=function(){var t=this,F,T,s;if(this.getValidity()===Infinity||this.getValidity()===0){return false}T=this._getItemValueInternal(d,g);F=sap.ui.core.format.DateFormat.getDateInstance({pattern:A});s=F.format(this._getNow(),true);return T&&s>T};sap.ushell.services.Personalization.ContextContainer.prototype._getNow=function(){return new Date()};sap.ushell.services.Personalization.ContextContainer.prototype._copyToAdapterUpdatingValidity=function(){var a=[],D=[],t=this,n,F,T,s;if(this._clear){a=this._oAdapterContainer.getItemKeys().splice(0);a.forEach(function(b){t._oAdapterContainer.delItem(b)});this._clear=false}if(this.getValidity()===Infinity||this.getValidity()===0){this._delItemInternal(d,I);this._delItemInternal(d,g);this._delItemInternal(d,f)}else{F=sap.ui.core.format.DateFormat.getDateInstance({pattern:A});n=this._getNow();s=F.format(n,true);T=F.format(new Date(n.getTime()+this.getValidity()*60000),true);this._setItemValueInternal(d,I,this._oScope);this._setItemValueInternal(d,g,T);this._setItemValueInternal(d,f,s)}a=this._oItemMap.keys();a.forEach(function(b){t._oAdapterContainer.setItemValue(b,k(t._oItemMap.get(b)))});D=this._aLoadedItemKeys.filter(function(b){return!(a.indexOf(b)>-1)});D.forEach(function(b){t._oAdapterContainer.delItem(b)})};sap.ushell.services.Personalization.ContextContainer.prototype.save=function(){var s,o,p,t=this;this._copyToAdapterUpdatingValidity();s=new jQuery.Deferred();p=this._oService._pendingContainerOperations_cancelAddNext(this._sContainerKey,s);p.always(function(){try{o=t._oAdapterContainer.save().fail(function(){s.reject()}).done(function(){s.resolve()})}catch(e){s.reject()}});return s.promise()};sap.ushell.services.Personalization.ContextContainer.prototype.saveDeferred=function(n){var s,o,p,t=this;this._copyToAdapterUpdatingValidity();s=new jQuery.Deferred();p=this._oService._pendingContainerOperations_cancelAddNext(this._sContainerKey,s);function D(){p.always(function(){try{o=t._oAdapterContainer.save().fail(function(){s.reject()}).done(function(){s.resolve()})}catch(e){s.reject()}})}s._sapFnSave=D;s._sapTimeoutId=setTimeout(D,n);return s.promise()};sap.ushell.services.Personalization.ContextContainer.prototype.flush=function(){var s,o,p,t=this;this._copyToAdapterUpdatingValidity();s=new jQuery.Deferred();p=this._oService._pendingContainerOperations_flushAddNext(this._sContainerKey,s);p.fail(function(){s.reject()}).done(function(){s.resolve()});return s.promise()};sap.ushell.services.Personalization.ContextContainer.prototype.getItemKeys=function(){var F=this._oItemMap.keys().filter(function(s){return s.indexOf(i)===0});return F.map(function(e){return e.replace(i,"","")})};sap.ushell.services.Personalization.ContextContainer.prototype._getInternalKeys=function(){return this._oItemMap.keys().splice(0)};sap.ushell.services.Personalization.ContextContainer.prototype.getItemValue=function(s){return this._getItemValueInternal(i,s)};sap.ushell.services.Personalization.ContextContainer.prototype._getItemValueInternal=function(p,s){if(typeof s!=="string"||typeof p!=="string"){return undefined}return k(this._oItemMap.get(p+s))};sap.ushell.services.Personalization.ContextContainer.prototype.containsItem=function(s){if(typeof s!=="string"){return undefined}return this._oItemMap.containsKey(i+s)};sap.ushell.services.Personalization.ContextContainer.prototype.setItemValue=function(s,o){this._setItemValueInternal(i,s,o)};sap.ushell.services.Personalization.ContextContainer.prototype._setItemValueInternal=function(s,a,o){if(typeof a!=="string"||typeof s!=="string"){throw new sap.ushell.utils.Error("Parameter value of sItemKey or sItemValue is not a string: sap.ushell.services.Personalization")}if(a.length>40){jQuery.sap.log.error("Personalization Service item key/variant set name (\""+a+"\") should be less than 40 characters [current :"+a.length+"]")}this._oItemMap.put(s+a,JSON.stringify(o))};sap.ushell.services.Personalization.ContextContainer.prototype.delItem=function(s){this._delItemInternal(i,s)};sap.ushell.services.Personalization.ContextContainer.prototype._delItemInternal=function(p,s){if(typeof s!=="string"){return undefined}if(typeof p!=="string"){return undefined}this._oItemMap.remove(p+s)};sap.ushell.services.Personalization.VariantSetAdapter=function(C){this._oContextContainer=C};sap.ushell.services.Personalization.VariantSetAdapter.prototype.save=function(){return this._oContextContainer.save()};sap.ushell.services.Personalization.VariantSetAdapter.prototype.getVariantSetKeys=function(){var p=this._oContextContainer._getInternalKeys(),V=[];V=p.map(function(e){return e.replace(v,"","")});return V};sap.ushell.services.Personalization.VariantSetAdapter.prototype.containsVariantSet=function(V){return this.getVariantSetKeys().indexOf(V)>=0};sap.ushell.services.Personalization.VariantSetAdapter.prototype.getVariantSet=function(V){var o=this._oContextContainer._getItemValueInternal(v,V);if(!o){return undefined}return new sap.ushell.services.Personalization.VariantSet(V,this._oContextContainer)};sap.ushell.services.Personalization.VariantSetAdapter.prototype.addVariantSet=function(V){var e={},o={},p="";if(this.containsVariantSet(V)){throw new sap.ushell.utils.Error("Container already contains a variant set with key '"+V+"': sap.ushell.services.Personalization")}e={currentVariant:null,variants:{}};this._oContextContainer._setItemValueInternal(v,V,e);o=new sap.ushell.services.Personalization.VariantSet(V,this._oContextContainer);return o};sap.ushell.services.Personalization.VariantSetAdapter.prototype.delVariantSet=function(V){this._oContextContainer._delItemInternal(v,V)};sap.ushell.services.Personalization.VariantSet=function(V,C){var s,a,b,o=new sap.ushell.utils.Map(),e=new sap.ushell.utils.Map(),l,m,n;this._oContextContainer=C;this._sVariantSetKey=V;this._oVariantSetData=this._oContextContainer._getItemValueInternal(v,this._sVariantSetKey);if(Object.prototype.hasOwnProperty.call(this._oVariantSetData,"currentVariant")){b=this._oVariantSetData.currentVariant}else{throw new sap.ushell.utils.Error("Corrupt variant set data: sap.ushell.services.Personalization")}if(Object.prototype.hasOwnProperty.call(this._oVariantSetData,"variants")){for(s in this._oVariantSetData.variants){if(Object.prototype.hasOwnProperty.call(this._oVariantSetData.variants,s)){a=this._oVariantSetData.variants[s].name;l=this._oVariantSetData.variants[s].variantData;if(o.containsKey(a)){throw new sap.ushell.utils.Error("Variant name already exists: sap.ushell.services.Personalization")}else{o.put(a,s);m=new sap.ushell.services.PersonalizationContainerVariant(s,a,l);e.put(s,m)}}}}else{throw new sap.ushell.utils.Error("Corrupt variant set data: sap.ushell.services.Personalization")}return this};sap.ushell.services.Personalization.VariantSet.prototype._getVariantSet=function(){return this._oVariantSetData};sap.ushell.services.Personalization.VariantSet.prototype._serialize=function(){this._oContextContainer._setItemValueInternal(v,this._sVariantSetKey,this._oVariantSetData)};sap.ushell.services.Personalization.VariantSet.prototype.getCurrentVariantKey=function(){return this._getVariantSet().currentVariant};sap.ushell.services.Personalization.VariantSet.prototype.setCurrentVariantKey=function(V){this._getVariantSet().currentVariant=V;this._serialize()};sap.ushell.services.Personalization.VariantSet.prototype.getVariantKeys=function(){var V=new sap.ushell.utils.Map(),o=this._getVariantSet(this._sVariantSetKey),s;if(Object.prototype.hasOwnProperty.call(o,"variants")){for(s in o.variants){if(Object.prototype.hasOwnProperty.call(o.variants,s)){V.put(s,"dummy")}}}else{throw new sap.ushell.utils.Error("Corrupt variant set data: sap.ushell.services.Personalization")}return V.keys()};sap.ushell.services.Personalization.VariantSet.prototype.getVariantNamesAndKeys=function(){var V=new sap.ushell.utils.Map(),o=new sap.ushell.utils.Map(),a=this._getVariantSet(this._sVariantSetKey),s,b,e;if(Object.prototype.hasOwnProperty.call(a,"variants")){for(s in a.variants){if(Object.prototype.hasOwnProperty.call(a.variants,s)){b=a.variants[s].name;e=a.variants[s].variantData;if(V.containsKey(b)){throw new sap.ushell.utils.Error("Variant name already exists: sap.ushell.services.Personalization")}else{V.put(b,s)}o.put(s,"dummy")}}}else{throw new sap.ushell.utils.Error("Corrupt variant set data: sap.ushell.services.Personalization")}return V.entries};sap.ushell.services.Personalization.VariantSet.prototype.getVariant=function(V){if(typeof V!=="string"){return undefined}var o=this._getVariantSet(this._sVariantSetKey),s,a,b;if(Object.prototype.hasOwnProperty.call(o,"variants")&&Object.prototype.hasOwnProperty.call(o.variants,V)){s=o.variants[V].name;b=o.variants[V].variantData;a=new sap.ushell.services.Personalization.Variant(this,V,s,b);return a}return undefined};sap.ushell.services.Personalization.VariantSet.prototype.getVariantKeyByName=function(V){if(typeof V!=="string"){return undefined}var o=this._getVariantSet(this._sVariantSetKey),s;if(Object.prototype.hasOwnProperty.call(o,"variants")){for(s in o.variants){if(Object.prototype.hasOwnProperty.call(o.variants,s)){if(V===o.variants[s].name){return s}}}}else{throw new sap.ushell.utils.Error("Corrupt variant set data: sap.ushell.services.Personalization")}return undefined};sap.ushell.services.Personalization.VariantSet.prototype.containsVariant=function(V){var o=this._getVariantSet();if(typeof V!=="string"){return undefined}return Object.prototype.hasOwnProperty.call(o,"variants")&&Object.prototype.hasOwnProperty.call(o.variants,V)};sap.ushell.services.Personalization.VariantSet.prototype.addVariant=function(V){var K=[],m=0,s="",o={};K=this.getVariantKeys();m=parseInt(K.sort(function(a,b){return a-b}).reverse()[0],10);s=isNaN(m)?"0":(m+1).toString();if(K.indexOf(s)>=0){throw new sap.ushell.utils.Error("Variant key '"+s+"' already exists in variant set"+this._sVariantSetKey+"': sap.ushell.services.Personalization")}if(typeof V!=="string"){throw new sap.ushell.utils.Error("Parameter value of sVariantName is not a string: sap.ushell.services.Personalization")}if(this.getVariantKeyByName(V)!==undefined){throw new sap.ushell.utils.Error("Variant name '"+V+"' already exists in variant set '"+this._sVariantSetKey+"' (Old key: '"+this.getVariantKeyByName(V)+"' New key: '"+s+"') ': sap.ushell.services.Personalization")}o=new sap.ushell.services.Personalization.Variant(this,s,V);this._getVariantSet(this._sVariantSetKey).variants[s]={name:V,variantData:{}};this._serialize();return o};sap.ushell.services.Personalization.VariantSet.prototype.delVariant=function(V){var o;if(typeof V!=="string"){return undefined}o=this._getVariantSet();if(o&&o.variants){delete this._oVariantSetData.variants[V]}this._serialize()};sap.ushell.services.PersonalizationContainerVariantSet=function(V,a){var o,s,b,e,l,m;this._sVariantSetKey=V;this._oAdapterContainer=a;this._oVariantNameMap=new sap.ushell.utils.Map();this._oVariantMap=new sap.ushell.utils.Map();o=j(this._oAdapterContainer.getItemValue(V));if(o.hasOwnProperty("currentVariant")){this._sCurrentVariantKey=o.currentVariant}else{throw new sap.ushell.utils.Error("Corrupt variant set data: sap.ushell.services.Personalization")}if(o.hasOwnProperty("variants")){for(s in o.variants){if(o.variants.hasOwnProperty(s)){b=o.variants[s].name;e=o.variants[s].variantData;if(this._oVariantNameMap.containsKey(b)){throw new sap.ushell.utils.Error("Variant name already exists: sap.ushell.services.Personalization")}else{this._oVariantNameMap.put(b,s);l=new sap.ushell.services.PersonalizationContainerVariant(s,b,e);this._oVariantMap.put(s,l)}}}}else{throw new sap.ushell.utils.Error("Corrupt variant set data: sap.ushell.services.Personalization")}return this};sap.ushell.services.PersonalizationContainerVariantSet.prototype.getCurrentVariantKey=function(){return this._sCurrentVariantKey};sap.ushell.services.PersonalizationContainerVariantSet.prototype.setCurrentVariantKey=function(V){this._sCurrentVariantKey=V};sap.ushell.services.PersonalizationContainerVariantSet.prototype.getVariantKeys=function(){return this._oVariantMap.keys()};sap.ushell.services.PersonalizationContainerVariantSet.prototype.getVariantNamesAndKeys=function(){return JSON.parse(JSON.stringify(this._oVariantNameMap.entries))};sap.ushell.services.PersonalizationContainerVariantSet.prototype.getVariant=function(V){if(typeof V!=="string"){return undefined}return this._oVariantMap.get(V)};sap.ushell.services.PersonalizationContainerVariantSet.prototype.getVariantKeyByName=function(V){if(typeof V!=="string"){return undefined}return this._oVariantNameMap.get(V)};sap.ushell.services.PersonalizationContainerVariantSet.prototype.containsVariant=function(V){if(typeof V!=="string"){return undefined}return this._oVariantMap.containsKey(V)};sap.ushell.services.PersonalizationContainerVariantSet.prototype.addVariant=function(V){var K=[],m=0,s="",o={};K=this._oVariantMap.keys();m=parseInt(this._oVariantMap.keys().sort(function(a,b){return a-b}).reverse()[0],10);s=isNaN(m)?"0":(m+1).toString();if(this._oVariantMap.containsKey(s)){throw new sap.ushell.utils.Error("Variant key '"+s+"' already exists in variant set"+this._sVariantSetKey+"': sap.ushell.services.Personalization")}if(typeof V!=="string"){throw new sap.ushell.utils.Error("Parameter value of sVariantName is not a string: sap.ushell.services.Personalization")}if(this._oVariantNameMap.containsKey(V)){throw new sap.ushell.utils.Error("Variant name '"+V+"' already exists in variant set '"+this._sVariantSetKey+"' (Old key: '"+this._oVariantNameMap.get(V)+"' New key: '"+s+"') ': sap.ushell.services.Personalization")}o=new sap.ushell.services.PersonalizationContainerVariant(s,V);this._oVariantMap.put(s,o);this._oVariantNameMap.put(V,s);return o};sap.ushell.services.PersonalizationContainerVariantSet.prototype._serialize=function(){var V={},a=[],o={},b={},t=this;o.currentVariant=this._sCurrentVariantKey;a=this.getVariantKeys();a.forEach(function(s){var V={};V=t._oVariantMap.get(s);b[s]=V._serialize()});o.variants=b;return o};sap.ushell.services.PersonalizationContainerVariantSet.prototype.delVariant=function(V){var o=this._oVariantMap.get(V);if(o){this._oVariantNameMap.remove(o.getVariantName());this._oVariantMap.remove(V)}};sap.ushell.services.Personalization.Variant=function(V,s,a){if(typeof s!=="string"){throw new sap.ushell.utils.Error("Parameter value of sVariantKey is not a string: sap.ushell.services.Personalization")}if(typeof a!=="string"){throw new sap.ushell.utils.Error("Parameter value of sVariantName is not a string: sap.ushell.services.Personalization")}this._oVariantSet=V;this._sVariantKey=s;this._sVariantName=a};sap.ushell.services.Personalization.Variant.prototype.getVariantKey=function(){return this._sVariantKey};sap.ushell.services.Personalization.Variant.prototype.getVariantName=function(){return this._sVariantName};sap.ushell.services.Personalization.Variant.prototype.setVariantName=function(V){var o=this._oVariantSet._getVariantSet(),a;if(typeof V!=="string"){throw new sap.ushell.utils.Error("Parameter value of sVariantName is not a string: sap.ushell.services.Personalization")}if(this._oVariantSet.getVariantKeyByName(V)!==undefined){throw new sap.ushell.utils.Error("Variant with name '"+V+"' already exists in variant set '"+this._oVariantSet._sVariantSetKey+"': sap.ushell.services.Personalization")}if(Object.prototype.hasOwnProperty.call(o,"variants")&&Object.prototype.hasOwnProperty.call(o.variants,this._sVariantKey)){a=o.variants[this._sVariantKey];a.name=V;this._sVariantName=V;this._oVariantSet._serialize()}else{throw new sap.ushell.utils.Error("Variant does not longer exist")}};sap.ushell.services.Personalization.Variant.prototype.getItemValue=function(s){if(typeof s!=="string"){return undefined}var a=this._oVariantSet._getVariantSet().variants[this._sVariantKey].variantData;return Object.prototype.hasOwnProperty.call(a,s)&&j(a[s])};sap.ushell.services.Personalization.Variant.prototype.setItemValue=function(s,o){if(typeof s!=="string"){throw new sap.ushell.utils.Error("Parameter value of sItemKey is not a string: sap.ushell.services.Personalization")}var a,b=this._oVariantSet._getVariantSet().variants&&this._oVariantSet._getVariantSet().variants[this._sVariantKey];if(!b){throw new sap.ushell.utils.Error("Variant does not longer exist")}if(!b.variantData){b.variantData={}}a=b.variantData;a[s]=j(o);this._oVariantSet._serialize()};sap.ushell.services.Personalization.Variant.prototype.containsItem=function(s){if(typeof s!=="string"){return undefined}var a=this.oAccess.variantSet._getVariantSet().variants[this._sVariantKey].variantData;return Object.prototype.hasOwnProperty.call(a,s)};sap.ushell.services.Personalization.Variant.prototype.getItemKeys=function(){var a=this._oVariantSet._getVariantSet().variants[this._sVariantKey].variantData,s,o=[];for(s in a){if(Object.prototype.hasOwnProperty.call(a,s)){o.push(s)}}o.sort();return o};sap.ushell.services.Personalization.Variant.prototype.delItem=function(s){if(typeof s!=="string"){return undefined}var a=this.oVariantSet._getVariantSet().variants[this._sVariantKey].variantData;delete a[s];this.oVariantSet._serialize()};sap.ushell.services.PersonalizationContainerVariant=function(V,s,o){if(typeof V!=="string"){throw new sap.ushell.utils.Error("Parameter value of sVariantKey is not a string: sap.ushell.services.Personalization")}if(typeof s!=="string"){throw new sap.ushell.utils.Error("Parameter value of sVariantName is not a string: sap.ushell.services.Personalization")}if(o&&typeof o!=="object"){throw new sap.ushell.utils.Error("Parameter value of sVariantName is not a string: sap.ushell.services.Personalization")}this._oVariantKey=V;this._oVariantName=s;this._oItemMap=new sap.ushell.utils.Map();this._oItemMap.entries=o||{}};sap.ushell.services.PersonalizationContainerVariant.prototype.getVariantKey=function(){return this._oVariantKey};sap.ushell.services.PersonalizationContainerVariant.prototype.getVariantName=function(){return this._oVariantName};sap.ushell.services.PersonalizationContainerVariant.prototype.getItemValue=function(s){if(typeof s!=="string"){return undefined}return this._oItemMap.get(s)};sap.ushell.services.PersonalizationContainerVariant.prototype.setItemValue=function(s,o){if(typeof s!=="string"){throw new sap.ushell.utils.Error("Parameter value of sItemKey is not a string: sap.ushell.services.Personalization")}return this._oItemMap.put(s,o)};sap.ushell.services.PersonalizationContainerVariant.prototype.containsItem=function(s){if(typeof s!=="string"){return undefined}return this._oItemMap.containsKey(s)};sap.ushell.services.PersonalizationContainerVariant.prototype.getItemKeys=function(){return this._oItemMap.keys()};sap.ushell.services.PersonalizationContainerVariant.prototype.delItem=function(s){if(typeof s!=="string"){return undefined}return this._oItemMap.remove(s)};sap.ushell.services.PersonalizationContainerVariant.prototype._serialize=function(){var a=[],V={},o={},t=this;V.name=this.getVariantName();a=this._oItemMap.keys();a.forEach(function(s){o[s]=t.getItemValue(s)});V.variantData=o;return V};sap.ushell.services.Personalization.WindowValidityPersistenceAdapter=function(s){if(!sap.ushell.services.Personalization.WindowValidityPersistenceAdapter.prototype.data){sap.ushell.services.Personalization.WindowValidityPersistenceAdapter.prototype.data={}}};sap.ushell.services.Personalization.WindowValidityPersistenceAdapter.prototype.getAdapterContainer=function(C){return new sap.ushell.services.Personalization.WindowValidityPersistenceAdapterContainer(C)};sap.ushell.services.Personalization.WindowValidityPersistenceAdapter.prototype.delAdapterContainer=function(C){var D=new jQuery.Deferred();delete sap.ushell.services.Personalization.WindowValidityPersistenceAdapter.prototype.data[C];D.resolve();return D.promise()};sap.ushell.services.Personalization.WindowValidityPersistenceAdapterContainer=function(C){this._oItemMap=new sap.ushell.utils.Map();this._sContainerKey=C};sap.ushell.services.Personalization.WindowValidityPersistenceAdapterContainer.prototype.load=function(){var D=new jQuery.Deferred();this._oItemMap.entries=j(sap.ushell.services.Personalization.WindowValidityPersistenceAdapter.prototype.data[this._sContainerKey])||{};D.resolve();return D.promise()};sap.ushell.services.Personalization.WindowValidityPersistenceAdapterContainer.prototype.save=function(){var D=new jQuery.Deferred();sap.ushell.services.Personalization.WindowValidityPersistenceAdapter.prototype.data[this._sContainerKey]=j(this._oItemMap.entries);D.resolve();return D.promise()};sap.ushell.services.Personalization.WindowValidityPersistenceAdapterContainer.prototype.getItemKeys=function(){return this._oItemMap.keys()};sap.ushell.services.Personalization.WindowValidityPersistenceAdapterContainer.prototype.containsItem=function(s){this._oItemMap.containsKey(s)};sap.ushell.services.Personalization.WindowValidityPersistenceAdapterContainer.prototype.getItemValue=function(s){return this._oItemMap.get(s)};sap.ushell.services.Personalization.WindowValidityPersistenceAdapterContainer.prototype.setItemValue=function(s,o){this._oItemMap.put(s,o)};sap.ushell.services.Personalization.WindowValidityPersistenceAdapterContainer.prototype.delItem=function(s){this._oItemMap.remove(s)}}());
