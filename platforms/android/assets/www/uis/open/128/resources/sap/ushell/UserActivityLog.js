// Copyright (c) 2013 SAP AG, All Rights Reserved
(function(){"use strict";jQuery.sap.declare("sap.ushell.UserActivityLog");var U=function(){};U.prototype={_maxLoggedMessages:30,_maxMessageByteSize:2048,_maxQueueByteSize:30720,_isActive:false,_observedLaunchpadActions:["createGroup","deleteGroup","resetGroup","changeGroupTitle","moveGroup","addTile","deleteTile","moveTile","externalSearch","openApp","addBookmarkTile"],_observedGeneralActions:["showCatalog","openApp"],messageType:{ACTION:0,ERROR:1},_tileOntapOrigFunc:undefined,activate:function(c){if(this._isActive){return}this._isActive=true;var e=sap.ui.getCore().getEventBus(),s=this;this._observedLaunchpadActions.forEach(function(a,i,b){e.subscribe("launchpad",a,s._handleAction,s)});this._observedGeneralActions.forEach(function(a,i,b){e.subscribe(a,s._handleAction,s)});jQuery.sap.log.addLogListener(this);setTimeout(function(){s._tileOntapOrigFunc=sap.ushell.ui.launchpad.Tile.prototype.ontap;sap.ushell.ui.launchpad.Tile.prototype.ontap=s._tileOnTapDecorator(s._tileOntapOrigFunc)},0)},deactivate:function(){if(!this._isActive){return}this._isActive=false;var e=sap.ui.getCore().getEventBus(),s=this;this._observedLaunchpadActions.forEach(function(a,i,b){e.unsubscribe("launchpad",a,s._handleAction,s)});this._observedGeneralActions.forEach(function(a,i,b){e.unsubscribe(a,s._handleAction,s)});jQuery.sap.log.removeLogListener(this);sap.ushell.ui.launchpad.Tile.prototype.ontap=this._tileOntapOrigFunc},addMessage:function(t,m,a){if(this._isActive){this._addMessageInternal(t,m,a)}},getLog:function(){return this._getLoggingQueueFromStorage()},getMessageInfo:function(u){var r={userDetails:this._getUserDetails(),shellState:this._getShellState(),navigationData:this._getLastNavActionFromStorage(),userLog:this.getLog()};return r},getMessageInfoAsString:function(u){return JSON.stringify(this.getMessageInfo(u))},onLogEntry:function(d){var e=(typeof d.details!="undefined"&&(d.details!==""))?(d.message+" , "+d.details):d.message;this.addMessage(this.messageType.ERROR,e)},onAttachToLog:function(){},onDetachFromLog:function(){},_tileOnTapDecorator:function(o){var s=this,n,l,t,a,b,c;return function(e,u){var d=this.getMetadata().getName();if(d=="sap.ushell.ui.launchpad.PlusTile"){s.addMessage(s.messageType.ACTION,"Open Catalog for empty group "+this.getGroupId())}else if(d=="sap.ushell.ui.launchpad.Tile"){n=jQuery(e.currentTarget).find('a').first().attr('href');if(n){var f=sap.ushell.Container.getService("URLParsing");var g=f.parseShellHash(n);n='#'+f.constructShellHash({target:{semanticObject:g.semanticObject,action:g.action}})}l=s._getLastNavActionFromStorage();l.time=new Date();l.navigationHash=n;l.tileDebugInfo=this.getDebugInfo();t=sap.ui.getCore().byId(this.getId());a=t.getModel();b=this.getBindingContext();c=b.getPath();l.tileTitle=b.getModel().getProperty(c).title;s._putInLocalStorage("sap.ushell.UserActivityLog.lastNavigationActionData",JSON.stringify(l));s.addMessage(s.messageType.ACTION,"Click on Tile: "+a.getData().title+" Tile debugInfo: "+this.getDebugInfo())}o.apply(this,arguments)}},_addMessageInternal:function(t,m,a){var l=this._getLoggingQueueFromStorage(),b={type:null},p;for(p in this.messageType){if(t==this.messageType[p]){b.type=p;break}}if(b.type===null){return}jQuery.extend(b,{messageID:a,messageText:m,time:new Date(),toString:function(){var c=[this.type,this.time];if(typeof this.messageID!=="undefined"){c.push(this.messageID)}c.push(this.messageText);return c.join(" :: ")}});l.push(b);if(l.length>this._maxLoggedMessages){l.shift()}this._putInLocalStorage("sap.ushell.UserActivityLog.loggingQueue",JSON.stringify(l))},_handleAction:function(c,e,d){var m;switch(e){case'deleteTile':m="Delete Tile "+(d.tileId||"");break;case'moveTile':m="Move Tile "+(d.sTileId||"")+" to Group "+(d.toGroupId||"");break;case'createGroup':m="Create Group";break;case'changeGroupTitle':m="Change Group Title of "+(d.groupId||"")+" to "+(d.newTitle||"");break;case'deleteGroup':m="Delete Group "+(d.groupId||"");break;case'addTile':var t=d.catalogTileContext.oModel.oData,T=d.catalogTileContext.sPath,a=this._findInModel(T,t),b=a.id,g=d.groupContext.oModel.oData,G=d.groupContext.sPath,f=this._findInModel(G,g),h=f.groupId;m="Add Tile "+(b||"")+" to Group "+(h||"");break;case'moveGroup':m="Move Group from index "+(d.fromIndex||"")+" to index "+(d.toIndex||"");break;case'openApp':m="Open application "+d.action;var l=this._getLastNavActionFromStorage();l.applicationInformation=d.oApplication;if(!this._hashSegmentsEqual(l.navigationHash,d.sShellHash)){l.tileDebugInfo=""}l.navigationHash=d.sShellHash;this._putInLocalStorage("sap.ushell.UserActivityLog.lastNavigationActionData",JSON.stringify(l));break;case'addBookmarkTile':m="Add Bookmark "+(d.title||"")+" "+(d.subtitle||"")+" for URL: "+(d.url||"");break;case'showCatalog':m="Show Catalog";break}this.addMessage(this.messageType.ACTION,m)},_findInModel:function(p,m){var a,b=m,i,c;try{a=p.split("/");for(i=0;i<a.length;i=i+1){if(c!==a[i]){continue}b=b[c]}}catch(e){return undefined}return b},_getUserDetails:function(u){var a=sap.ushell.Container.getUser();return{fullName:a.getFullName()||"",userId:a.getId()||"",eMail:a.getEmail()||"",Language:a.getLanguage()||""}},_getShellState:function(){var n=sap.ui.getCore().byId("navContainer"),m,r="";if(n!==undefined){m=n.getModel();r=m.getProperty("/currentState/stateName")}return r},_getLoggingQueueFromStorage:function(){var l=this._getFromLocalStorage("sap.ushell.UserActivityLog.loggingQueue");var q=[];if(l){try{q=JSON.parse(l)}catch(e){}}return q},_getLastNavActionFromStorage:function(){var l=this._getFromLocalStorage("sap.ushell.UserActivityLog.lastNavigationActionData");return(l?JSON.parse(l):{})},_hashSegmentsEqual:function(u,a){if((!u)||(!a)){return false}return(this._getHashSegment(u)==this._getHashSegment(a))?true:false},_getHashSegment:function(u){var i=u.indexOf("~"),a;if(i>-1){return u.substring(0,i)}a=u.indexOf("?");if(a>-1){return u.substring(0,a)}return u},_getFromLocalStorage:function(k){var r=null;try{r=localStorage.getItem(k)}catch(e){}return r},_putInLocalStorage:function(k,v){try{localStorage.setItem(k,v)}catch(e){}}};sap.ushell.UserActivityLog=new U()})();
