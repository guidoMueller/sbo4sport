jQuery.sap.declare("sap.suite.ui.smartbusiness.lib.DrilldownModel");jQuery.sap.require("sap.suite.ui.smartbusiness.lib.DrilldownConfiguration");sap.suite=sap.suite||{};sap.suite.smartbusiness=sap.suite.smartbusiness||{};sap.suite.smartbusiness.ddaconfig=sap.suite.smartbusiness.ddaconfig||{};
sap.suite.smartbusiness.ddaconfig.Model=function(e,v,i){this.ddaConfigurator=null;this.viewId=v;this.selectedView=null;this.i18nModel=i;this.evaluationId=e;if(this.evaluationId){this._init()}};
sap.suite.smartbusiness.ddaconfig.Model._instances={};sap.suite.smartbusiness.ddaconfig.Model.languageTexts={ALL_LANGUAGES:[],CURRENT_LANGUAGE:[],isLoaded:false};
sap.suite.smartbusiness.ddaconfig.Model.getInstance=function(e,f,i){function g(a){var m=new sap.suite.smartbusiness.ddaconfig.Model(a,null,i);sap.suite.smartbusiness.ddaconfig.Model._instances[a]=m;return sap.suite.smartbusiness.ddaconfig.Model._instances[a]}if(f){return g(e,null,i)}if(sap.suite.smartbusiness.ddaconfig.Model._instances[e]){return sap.suite.smartbusiness.ddaconfig.Model._instances[e]}else{return g(e,null,i)}};
sap.suite.smartbusiness.ddaconfig.Model.prototype={_init:function(e){this.ddaConfigurator=new sap.suite.smartbusiness.ddaconfig.Configuration(this.evaluationId);this.EVALUATION_DATA=sap.suite.smartbusiness.kpi.getEvaluationById({id:this.evaluationId,cache:true,filters:true,thresholds:true});this._setModel()},NEW_VIEWID:"~NA~",_setModel:function(){this._oModel=new sap.ui.model.json.JSONModel(this.getModelDataForDDAConfiguration());try{this._oModel.setSizeLimit(9999)}catch(e){}},removeAllViews:function(){this.getConfigurator().removeAllViews();this._oModel.setData(this.getModelDataForDDAConfiguration())},bindModel:function(c,n){if(n){c.setModel(this._oModel,n)}else{c.setModel(this._oModel)}this._oModel.refresh()},getConfigurator:function(){return this.ddaConfigurator},setEvaluationId:function(e){this.evaluationId=e;this._init()},setViewId:function(v){this.viewId=v;this.selectedView=this.ddaConfigurator.findViewById(this.viewId);this._setModel()},fetchLanguageData:function(n,s){if(sap.suite.smartbusiness.ddaconfig.Model.languageTexts.isLoaded){s({ALL_LANGUAGES:sap.suite.smartbusiness.ddaconfig.Model.languageTexts.ALL_LANGUAGES,CURRENT_LANGUAGE:sap.suite.smartbusiness.ddaconfig.Model.languageTexts.CURRENT_LANGUAGE})}else{var l=sap.ui.getCore().getConfiguration().getLocale().getLanguage().toUpperCase();new sap.ui.model.odata.ODataModel("/sap/hba/r/sb/core/odata/modeler/SMART_BUSINESS.xsodata",true).read("/LANGUAGE?$select=SPRAS,LAISO",null,null,true,function(d){sap.suite.smartbusiness.ddaconfig.Model.languageTexts.isLoaded=true;var a={ALL_LANGUAGES:[],CURRENT_LANGUAGE:[]};for(var i=0;i<d.results.length;++i){if(d.results[i]["LAISO"]==l){a["CURRENT_LANGUAGE"]=d.results[i]["SPRAS"];d.results.splice(i,1);break}}a["ALL_LANGUAGES"]=d.results;sap.suite.smartbusiness.ddaconfig.Model.languageTexts.ALL_LANGUAGES=a["ALL_LANGUAGES"];sap.suite.smartbusiness.ddaconfig.Model.languageTexts.CURRENT_LANGUAGE=a["CURRENT_LANGUAGE"];s(a)})}},_getEvalData:function(i){try{var a=sap.suite.smartbusiness.kpi.getEvaluationById({id:i,cache:true,filters:false,thresholds:false,getDDAEvaluation:true});return a}catch(e){return{}}},getDefaultModelData:function(){var t=this;try{var d=sap.suite.smartbusiness.odata.getAllDimensions(this.EVALUATION_DATA.ODATA_URL,this.EVALUATION_DATA.ODATA_ENTITYSET);var m=sap.suite.smartbusiness.odata.getAllMeasures(this.EVALUATION_DATA.ODATA_URL,this.EVALUATION_DATA.ODATA_ENTITYSET);var p=sap.suite.smartbusiness.odata.properties(this.EVALUATION_DATA.ODATA_URL,this.EVALUATION_DATA.ODATA_ENTITYSET);var C=p.getLabelMappingObject()}catch(e){var d=[];var m=[]}function _(i){return t._getEvalData(i).INDICATOR_TITLE}function a(i){return t._getEvalData(i).TITLE}function b(i){return t._getEvalData(i).INDICATOR}function g(){var f=[];for(var i=0;i<m.length;i++){f.push({NAME:m[i],LABEL:C[m[i]]})}return f}var c={CONFIG:{SAP_AGGREGATE_VALUE:true},ID_EDITABLE:true,INDICATOR:this.EVALUATION_DATA.INDICATOR,ID:"",TITLE:"",EVALUATION_TITLE:this.EVALUATION_DATA.TITLE,QUERY_SERVICE_URI:this.EVALUATION_DATA.ODATA_URL,QUERY_ENTITY_SET:this.EVALUATION_DATA.ODATA_ENTITYSET,TEXT:"",MAIN_MEASURE:"",THRESHOLD_MEASURE:"",ALL_DIMENSIONS:d,ALL_MEASURES:m,ALL_MEASURES_LABELS:g(),VALUE_TYPES:[{key:"ABSOLUTE",text:this.i18nModel.getProperty("ABSOLUTE_VALUES")},{key:"PERCENTAGE",text:this.i18nModel.getProperty("PERCENTAGE_VALUES")}],AXIS_TYPES:[{key:"SINGLE",text:this.i18nModel.getProperty("SINGLE_AXIS")},{key:"DUAL",text:this.i18nModel.getProperty("DUAL_AXIS")}],AXIS_TYPE:"SINGLE",VALUE_TYPE:"ABSOLUTE",CHART_TYPE:"Column",CHART_TYPES:[{key:"Bar",text:this.i18nModel.getProperty("BARS")},{key:"Column",text:this.i18nModel.getProperty("COLUMNS")},{key:"Line",text:this.i18nModel.getProperty("LINES")},{key:"Combination",text:this.i18nModel.getProperty("COLUMNS_AND_LINES")},{key:"Bubble",text:this.i18nModel.getProperty("BUBBLES")},{key:"Table",text:this.i18nModel.getProperty("TABLE")}],DATA_MODES:[{key:"DUMMY",text:this.i18nModel.getProperty("DUMMY_DATA")},{key:"RUNTIME",text:this.i18nModel.getProperty("ACTUAL_BACKEND_DATA")}],DATA_MODE:"DUMMY",DATA_LIMIT:200,DATA_LIMITATIONS:false,COLOR_SCHEME:"NONE",COLOR_SCHEMES:[{key:"AUTO_SEMANTIC",text:this.i18nModel.getProperty("AUTO_SEMANTIC_COLORS")},{key:"MANUAL_SEMANTIC",text:this.i18nModel.getProperty("MANUAL_SEMANTIC_COLORS")},{key:"MANUAL_NON_SEMANTIC",text:this.i18nModel.getProperty("MANUAL_COLORS")},{key:"NONE",text:this.i18nModel.getProperty("DEFAULT_COLORS")}],"MANUAL_NON_SEMANTIC":[{color:sap.ca.ui.charts.ChartColor.sapUiChart1,index:0},{color:sap.ca.ui.charts.ChartColor.sapUiChart2,index:1},{color:sap.ca.ui.charts.ChartColor.sapUiChart3,index:2},{color:sap.ca.ui.charts.ChartColor.sapUiChart4,index:3},{color:sap.ca.ui.charts.ChartColor.sapUiChart5,index:4},{color:sap.ca.ui.charts.ChartColor.sapUiChart6,index:5},{color:sap.ca.ui.charts.ChartColor.sapUiChart7,index:6},{color:sap.ca.ui.charts.ChartColor.sapUiChart8,index:7},{color:sap.ca.ui.charts.ChartColor.sapUiChart9,index:8},{color:sap.ca.ui.charts.ChartColor.sapUiChart10,index:9},{color:sap.ca.ui.charts.ChartColor.sapUiChart11,index:10}],"MANUAL_SEMANTIC":[{color:"sapCaUiChartSemanticColor-Neutral-Dark",index:0},{color:"sapCaUiChartSemanticColor-Neutral",index:1},{color:"sapCaUiChartSemanticColor-Neutral-Light",index:2},{color:"sapCaUiChartSemanticColor-Good-Dark",index:3},{color:"sapCaUiChartSemanticColor-Good",index:4},{color:"sapCaUiChartSemanticColor-Good-Light",index:5},{color:"sapCaUiChartSemanticColor-Critical-Dark",index:6},{color:"sapCaUiChartSemanticColor-Critical",index:7},{color:"sapCaUiChartSemanticColor-Critical-Light",index:8},{color:"sapCaUiChartSemanticColor-Bad-Dark",index:9},{color:"sapCaUiChartSemanticColor-Bad",index:10},{color:"sapCaUiChartSemanticColor-Bad-Light",index:11}],COLUMNS:[],SIBLING_EVALUATIONS:[],ASSOCIATED_EVALUATIONS:[],ADDITIONAL_LANGUAGE_TITLES:[],FILTERS:[],HEADER_EVALUATIONID:{},HEADERS_VISIBLE:[],HEADERS:[{EVALUATION_ID:this.evaluationId,CONFIGURATION_ID:this.NEW_VIEWID,REFERENCE_EVALUATION_ID:this.evaluationId,VISUALIZATION_TYPE:'NT',VISUALIZATION_TYPE_INDEX:0,VISUALIZATION_ORDER:1,DIMENSION:d[0],SORT_BY:"",SORT_ORDER:"MD",ALL_MEASURES:m,VISIBILITY:1,ALL_DIMENSIONS:d,visible:true,TITLE:_(this.evaluationId),SUBTITLE:a(this.evaluationId),GROUPING_TITLE:"",INDICATOR:b(this.evaluationId)},{EVALUATION_ID:this.evaluationId,CONFIGURATION_ID:this.NEW_VIEWID,REFERENCE_EVALUATION_ID:this.evaluationId,VISUALIZATION_TYPE:'AT',VISUALIZATION_TYPE_INDEX:1,VISUALIZATION_ORDER:1,DIMENSION:d[0],SORT_BY:"",SORT_ORDER:"MD",ALL_MEASURES:m,ALL_DIMENSIONS:d,VISIBILITY:1,visible:false,TITLE:_(this.evaluationId),SUBTITLE:a(this.evaluationId),GROUPING_TITLE:"",INDICATOR:b(this.evaluationId)},{EVALUATION_ID:this.evaluationId,CONFIGURATION_ID:this.NEW_VIEWID,REFERENCE_EVALUATION_ID:this.evaluationId,VISUALIZATION_TYPE:'CT',VISUALIZATION_TYPE_INDEX:2,VISUALIZATION_ORDER:1,DIMENSION:d[0],SORT_BY:"",SORT_ORDER:"MD",ALL_MEASURES:m,ALL_DIMENSIONS:d,VISIBILITY:1,visible:false,TITLE:_(this.evaluationId),SUBTITLE:a(this.evaluationId),GROUPING_TITLE:"",INDICATOR:b(this.evaluationId)},{EVALUATION_ID:this.evaluationId,CONFIGURATION_ID:this.NEW_VIEWID,REFERENCE_EVALUATION_ID:this.evaluationId,VISUALIZATION_TYPE:'TT',VISUALIZATION_TYPE_INDEX:3,VISUALIZATION_ORDER:1,DIMENSION:d[0],SORT_BY:"",SORT_ORDER:"MD",ALL_MEASURES:m,ALL_DIMENSIONS:d,VISIBILITY:1,visible:false,TITLE:_(this.evaluationId),SUBTITLE:a(this.evaluationId),GROUPING_TITLE:"",INDICATOR:b(this.evaluationId)},{EVALUATION_ID:this.evaluationId,CONFIGURATION_ID:this.NEW_VIEWID,REFERENCE_EVALUATION_ID:this.evaluationId,VISUALIZATION_TYPE:'CM',VISUALIZATION_TYPE_INDEX:4,VISUALIZATION_ORDER:1,DIMENSION:d[0],SORT_BY:"",SORT_ORDER:"MD",MEASURE1:m[0],MEASURE2:m[1]||m[0],MEASURE3:"",COLOR1:"Good",COLOR2:"Critical",COLOR3:"Error",ALL_MEASURES:m,ALL_DIMENSIONS:d,VISIBILITY:1,visible:false,TITLE:_(this.evaluationId),SUBTITLE:a(this.evaluationId),GROUPING_TITLE:_(this.evaluationId)+" "+a(this.evaluationId),INDICATOR:b(this.evaluationId)}],SELECTED_VIEW:"",ALL_VIEWS:this.ddaConfigurator.getAllViews(),ALL_LANGUAGES:[],CURRENT_LANGUAGE:"E"};c.HEADER_EVALUATIONID[this.evaluationId]=true;this.fetchLanguageData("SB_DDACONFIG_LANG",function(o){c.ALL_LANGUAGES=o.ALL_LANGUAGES;c.CURRENT_LANGUAGE=o.CURRENT_LANGUAGE});return c},getModelDataForDDAConfiguration:function(){var t=this;var c=["NT","AT","CT","TT","CM"];function g(n){return(n==-1||!n)?200:n}function _(I){try{var a=sap.suite.smartbusiness.kpi.getEvaluationById({id:I,cache:true,filters:true,thresholds:true});return sap.suite.smartbusiness.odata.getAllDimensions(a.ODATA_URL,a.ODATA_ENTITYSET)}catch(e){return[]}}function d(I){try{var a=sap.suite.smartbusiness.kpi.getEvaluationById({id:I,cache:true,filters:true,thresholds:true});return sap.suite.smartbusiness.odata.getAllMeasures(a.ODATA_URL,a.ODATA_ENTITYSET)}catch(e){return[]}}var m=sap.suite.smartbusiness.odata.getAllMeasures(this.EVALUATION_DATA.ODATA_URL,this.EVALUATION_DATA.ODATA_ENTITYSET);function f(I){var e=t._getEvalData(I);return(e&&e.INDICATOR_TITLE)?e.INDICATOR_TITLE:""}function h(I){var e=t._getEvalData(I);return(e&&e.TITLE)?e.TITLE:""}function j(I){var e=t._getEvalData(I);return(e&&e.INDICATOR)?e.INDICATOR:""}var k=this.getDefaultModelData();if(this.selectedView){var t=this;k.ALL_VIEWS=this.ddaConfigurator.getAllViews();k.SELECTED_VIEW=this.selectedView.getId();k.ID=this.selectedView.getId();k.TITLE=this.selectedView.getTitle();k.ADDITIONAL_LANGUAGE_TITLES=this.selectedView.getAdditionalLanguageTitles();k.ID_EDITABLE=false;var l=this.selectedView.getChartConfiguration()[0];k.THRESHOLD_MEASURE=l?l.getThresholdMeasure():"";k.AXIS_TYPE=l?l.getAxisType():"SINGLE";k.VALUE_TYPE=l?l.getValueType():"ABSOLUTE";k.CHART_TYPE=l?l.getChartType().getText():"Bar";k.DATA_LIMIT=l?g(l.getDataLimit()):200;k.DATA_LIMITATIONS=this.getDataLimitations();k.CONFIG.SAP_AGGREGATE_VALUE=this.selectedView.isAggregateValueEnabled();k.COLOR_SCHEME=l?l.getColorScheme().getText():"AUTO_SEMANTIC";if(this.selectedView.getHeaders().length){var o=this.selectedView.getHeaders();k.HEADERS=[];k.HEADERS_VISIBLE=[];var p={};k.HEADER_EVALUATIONID={};o.forEach(function(H){k.HEADER_EVALUATIONID[H.getReferenceEvaluationId()]=true;p[H.getReferenceEvaluationId()]=p[H.getReferenceEvaluationId()]||{};var m=d(H.getReferenceEvaluationId());var r=_(H.getReferenceEvaluationId());var a=H.getConfiguration();k.HEADERS_VISIBLE.push({EVALUATION_ID:t.evaluationId,CONFIGURATION_ID:k.SELECTED_VIEW,REFERENCE_EVALUATION_ID:H.getReferenceEvaluationId(),VISUALIZATION_TYPE:H.getVisualizationType(),VISUALIZATION_ORDER:H.getVisualizationOrder(),DIMENSION:H.getDimension()||r[0],SORT_BY:"",SORT_ORDER:a.SORTING.by+(a.SORTING.order=="desc"?+"D":"A"),MEASURE1:a.MEASURES[0].name||m[0],MEASURE2:a.MEASURES[1].name||m[1]||m[0],MEASURE3:a.MEASURES[2]?a.MEASURES[2].name:"",COLOR1:a.MEASURES[0].color||"Neutral",COLOR2:a.MEASURES[1].color||"Neutral",COLOR3:a.MEASURES[2]?a.MEASURES[2].color:"Neutral",ALL_MEASURES:m,ALL_DIMENSIONS:r,VISIBILITY:H.getVisibility(),visible:true,TITLE:f(H.getReferenceEvaluationId()),SUBTITLE:h(H.getReferenceEvaluationId()),INDICATOR:j(H.getReferenceEvaluationId())})});k.HEADERS_VISIBLE.sort(function(a,b){return a.VISUALIZATION_ORDER>b.VISUALIZATION_ORDER?1:-1});k.HEADER_EVALUATIONID[this.evaluationId]=true;p[this.evaluationId]=p[this.evaluationId]||{};var t=this;for(var q in p){var m=d(q);var r=_(q);c.forEach(function(s){k.HEADERS.push({EVALUATION_ID:t.evaluationId,CONFIGURATION_ID:k.SELECTED_VIEW,REFERENCE_EVALUATION_ID:q,VISUALIZATION_TYPE:s,VISUALIZATION_TYPE_INDEX:c.indexOf(s),VISUALIZATION_ORDER:1,DIMENSION:r[0],SORT_BY:"",SORT_ORDER:"MD",MEASURE1:m[0],MEASURE2:m[1]||m[0],MEASURE3:"",COLOR1:"Good",COLOR2:"Critical",COLOR3:"Error",ALL_MEASURES:m,ALL_DIMENSIONS:_(q),VISIBILITY:1,visible:false,TITLE:f(q),SUBTITLE:h(q),GROUPING_TITLE:f(q)+" "+h(q),INDICATOR:j(q)})})}}var u=this.selectedView.getColumns();for(var i=0;i<u.length;i++){var v=this.selectedView.findColumnByName(u[i]);k.COLUMNS.push({NAME:v.getName(),TYPE:v.getType(),COLOR1:k.COLOR_SCHEME=="MANUAL_NON_SEMANTIC"?v.getColor():"",COLOR2:k.COLOR_SCHEME=="MANUAL_SEMANTIC"?v.getColor():"",AXIS:v.getAxis(),SORT_ORDER:v.getSortOrder(),SORT_BY:v.getSortBy(),VISIBILITY:v.getVisibility(),STACKING:v.getStacking()})}var w=this.selectedView.getFilters();for(var i=0;i<w.length;i++){var x=w[i];k.FILTERS.push({name:x})}}return k},getDataLimitations:function(){var c=this.selectedView.getChartConfiguration()[0];if(c&&c.getDataLimit()!=-1){return true}else if(c&&c.getDataLimit()==-1){return false}}};
