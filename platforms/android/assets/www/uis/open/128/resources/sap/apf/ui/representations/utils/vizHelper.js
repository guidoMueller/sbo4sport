/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.apf.ui.representations.utils.vizHelper");
sap.apf.ui.representations.utils.vizHelper=function(a,p){var s=this;this.parameter=p;this.classifiedData=[];this.extendedDataSet=[];this.fieldKeysLookup={};this.displayNameLookup={};this.fieldNameLookup={};this.filterLookup={};this.datasetObj={};this.cachedSelection=[];this.filterValues=[];this.dataAlreadySorted=false;this.init=function(D,m,f){this.metadata=m;this.formatter=new sap.apf.ui.representations.utils.formatter(a,m,D);b.bind(this)(m,D);c.bind(this)(D);d.bind(this)(f);if(this.parameter.requiredFilters!==undefined&&this.parameter.requiredFilters.length!==0){v()}};this.validateSelectionModes=function(f){var C=f;var h=new sap.viz.ui5.types.controller.Interaction_selectability();var i=new sap.viz.ui5.types.controller.Interaction();i.setSelectability(h);C.setInteraction(i);if(this.parameter.requiredFilters===undefined||this.parameter.requiredFilters.length===0){h.setMode("none")}else{h.setMode("multiple");if(this.parameter.dimensions.length>1){if(this.parameter.requiredFilters[0]===this.parameter.dimensions[1].fieldName){h.setAxisLabelSelection(false)}else if(this.parameter.requiredFilters[0]===this.parameter.dimensions[0].fieldName){h.setLegendSelection(false)}}}};var v=function(){s.filterValues=s.filterValues.filter(function(f){for(var i=0;i<s.extendedDataResponse.length;i++){var h=0;for(var j=0;j<s.parameter.requiredFilters.length;j++){if(f[j]===s.extendedDataResponse[i][s.parameter.requiredFilters[j]]){h=h+1}}if(h===s.parameter.requiredFilters.length){return true}else if(i===s.extendedDataResponse.length-1){return false}}});s.cachedSelection=e()};var b=function(m,D){var f=this.parameter.dimensions.concat(this.parameter.measures);for(var i=0;i<f.length;i++){var h=f[i];var j=h.fieldName;this.displayNameLookup[j]={};if(m!==undefined){if(m.getPropertyMetadata(j).hasOwnProperty('text')){var t=m.getPropertyMetadata(j).text;var k=m.getPropertyMetadata(t).label;this.displayNameLookup[j].DISPLAY_NAME=k;this.displayNameLookup[j].VALUE="formatted_"+j}else if(m.getPropertyMetadata(j)["aggregation-role"]==="dimension"){this.displayNameLookup[j].DISPLAY_NAME=m.getPropertyMetadata(j).label;this.displayNameLookup[j].VALUE="formatted_"+j}else{this.displayNameLookup[j].DISPLAY_NAME=m.getPropertyMetadata(j).label;this.displayNameLookup[j].VALUE=j}if(h.fieldDesc!==undefined){this.displayNameLookup[j].DISPLAY_NAME=a.getTextNotHtmlEncoded(h.fieldDesc)}if(m.getPropertyMetadata(j).unit!==undefined){var u=m.getPropertyMetadata(j).unit;var U;if(D!==undefined&&D.length!==0){U=D[0][u];this.displayNameLookup[j].DISPLAY_NAME=this.displayNameLookup[j].DISPLAY_NAME+' ('+U+')'}}}this.fieldNameLookup[this.displayNameLookup[j].DISPLAY_NAME]={};this.fieldNameLookup[this.displayNameLookup[j].DISPLAY_NAME].FIELD_NAME=j;this.fieldNameLookup[this.displayNameLookup[j].DISPLAY_NAME].VALUE=this.displayNameLookup[j].VALUE}};var c=function(D){this.extendedDataResponse=jQuery.extend([],true,D);var i,j,k;if(this.extendedDataResponse.length!==0){for(i=0;i<this.extendedDataResponse.length;i++){for(k=0;k<this.parameter.measures.length;k++){this.extendedDataResponse[i][this.parameter.measures[k].fieldName]=parseFloat(this.extendedDataResponse[i][this.parameter.measures[k].fieldName])}for(j=0;j<Object.keys(this.displayNameLookup).length;j++){var f=Object.keys(this.displayNameLookup)[j];var h=(this.displayNameLookup[f].VALUE.search('formatted_')!==-1);if(h){var t=this.metadata.getPropertyMetadata(f).hasOwnProperty('text');if(!t){this.extendedDataResponse[i][this.displayNameLookup[f].VALUE]=this.formatter.getFormattedValue(f,this.extendedDataResponse[i][f])}else{var l=this.metadata.getPropertyMetadata(f).text;this.extendedDataResponse[i][this.displayNameLookup[f].VALUE]=this.extendedDataResponse[i][l]+"("+this.extendedDataResponse[i][f]+")"}}}var m="";for(j=0;j<this.parameter.dimensions.length;j++){var n=this.displayNameLookup[this.parameter.dimensions[j].fieldName].VALUE;this.extendedDataResponse[i][n]=this.extendedDataResponse[i][n].toString();m=m+this.extendedDataResponse[i][n];this.filterLookup[m]=[];for(k=0;k<this.parameter.requiredFilters.length;k++){var o=this.extendedDataResponse[i][this.parameter.requiredFilters[k]];this.filterLookup[m].push(o)}}}}else{var q={};for(k=0;k<this.parameter.measures.length;k++){q[s.displayNameLookup[this.parameter.measures[k].fieldName].VALUE]=undefined}for(j=0;j<this.parameter.dimensions.length;j++){q[s.displayNameLookup[this.parameter.dimensions[j].fieldName].VALUE]=undefined}this.extendedDataResponse.push(q)}};var d=function(f){var o=this.extendedDataResponse;var m=new sap.ui.model.json.JSONModel();m.setData({data:o});var h=[];var j=[];var i=0;for(i=0;i<this.parameter.dimensions.length;i++){h[i]={name:this.displayNameLookup[this.parameter.dimensions[i].fieldName].DISPLAY_NAME,axis:i+1,value:'{'+this.displayNameLookup[this.parameter.dimensions[i].fieldName].VALUE+'}'}}s.measureAxisType=f;for(i=0;i<this.parameter.measures.length;i++){j[i]={name:this.displayNameLookup[this.parameter.measures[i].fieldName].DISPLAY_NAME,value:'{'+this.displayNameLookup[this.parameter.measures[i].fieldName].VALUE+'}'};j[i][f]=i+1}var k={dimensions:h,measures:j,data:{path:"/data"}};if(this.metadata!==undefined){for(i=0;i<this.parameter.dimensions.length;i++){var M=this.metadata.getPropertyMetadata(this.parameter.dimensions[i].fieldName);if(M.isCalendarYearMonth==="true"){if(this.parameter.dimensions.length>1){k.data.sorter=new sap.ui.model.Sorter(this.parameter.dimensions[0].fieldName,false)}}}}this.datasetObj=k};this.getDataset=function(){return new sap.viz.ui5.data.FlattenedDataset(this.datasetObj)};this.getModel=function(){var o=this.extendedDataResponse;var m=new sap.ui.model.json.JSONModel();m.setData({data:o});return m};this.getFilterCount=function(){return this.filterValues.length};this.getSelectionFromFilter=function(){if(this.parameter.requiredFilters===undefined||this.parameter.requiredFilters.length===0){return[]}var h=e();return h};this.getHighlightPointsFromSelectionEvent=function(f){var h=[];var n=[];h=g(f,this.cachedSelection);for(var i=0;i<h.length;i++){var k=h[i];if(this.parameter.measures.length===1){var m=this.displayNameLookup[this.parameter.measures[0].fieldName].DISPLAY_NAME;if(k.data[m]===undefined||k.data[m]===null){continue}}var l="";for(var j=0;j<this.parameter.dimensions.length;j++){var o=this.displayNameLookup[this.parameter.dimensions[j].fieldName].DISPLAY_NAME;l=l+k.data[o]}var q=this.filterLookup[l];var r=this.filterValues.filter(function(t){var u=0;for(var i=0;i<s.parameter.requiredFilters.length;i++){if(t[i]===q[i]){u=u+1}else{break}}if(u===s.parameter.requiredFilters.length){return true}else if(i===s.parameter.requiredFilters.length){return false}});if(r.length===0){this.filterValues.push(q)}}n=e();this.cachedSelection=n;return n};var g=function(f,n){var h=f.filter(function(k){for(var i=0;i<n.length;i++){var l=0;for(var j=0;j<Object.keys(k.data).length;j++){if(n[i].data[Object.keys(k.data)[j]]===k.data[Object.keys(k.data)[j]]){l=l+1}else{break}}if(l===Object.keys(k.data).length){return false}else if(j===Object.keys(k.data).length){return true}}return true});return h};this.getFilterFromSelection=function(){var r=[];var i;for(i=0;i<s.filterValues.length;i++){r.push(s.filterValues[i][0])}var f=a.createFilter();var E=f.getOperators().EQ;var F;var A=f.getTopAnd().addOr('exprssionOr');for(i=0;i<r.length;i++){var h=this.metadata.getPropertyMetadata(s.parameter.requiredFilters[0]).dataType.type;if(h==="Edm.Int32"){r[i]=parseFloat(r[i])}F={id:r[i],name:s.parameter.requiredFilters[0],operator:E,value:r[i]};A.addExpression(F)}return f};var e=function(){var r=[];r[0]=[];var i,j,k,l;for(i=0;i<s.filterValues.length;i++){r[0].push(s.filterValues[i][0])}var n=[];for(i=0;i<s.extendedDataResponse.length;i++){var f=s.extendedDataResponse[i];for(j=0;j<r[0].length;j++){var h=0;for(k=0;k<r.length;k++){if(f[s.parameter.requiredFilters[k]]===r[k][j]){h=h+1}}if(h===r.length){var m={data:{}};var o;var q;for(k=0;k<s.getDataset().getDimensions().length;k++){var t=s.getDataset().getDimensions()[k].getName();var u=s.fieldNameLookup[t].VALUE;m.data[t]=f[u]}if(s.measureAxisType!=="group"){var w;var x;for(l=0;l<s.getDataset().getMeasures().length;l++){var y=jQuery.extend(true,{},m);w=s.getDataset().getMeasures()[l].getName();x=s.fieldNameLookup[w].VALUE;y.data[w]=parseFloat(f[x]);n.push(y)}}else{for(k=0;k<s.getDataset().getMeasures().length;k++){o=s.getDataset().getMeasures()[k].getName();q=s.fieldNameLookup[o].VALUE;m.data[o]=parseFloat(f[q])}n.push(m)}}}}return n};this.getHighlightPointsFromDeselectionEvent=function(f){var i,j;var h=g(this.cachedSelection,f);for(i=0;i<h.length;i++){var k=h[i];var l="";for(j=0;j<this.parameter.dimensions.length;j++){var m=this.displayNameLookup[this.parameter.dimensions[j].fieldName].DISPLAY_NAME;l=l+k.data[m]}var n=this.filterLookup[l];this.filterValues=this.filterValues.filter(function(q,r){var t=0;for(var i=0;i<n.length;i++){if(n[i]===q[i]){t=t+1}}if(t===n.length){return false}else{return true}})}var o=e();this.cachedSelection=o;return o}};
