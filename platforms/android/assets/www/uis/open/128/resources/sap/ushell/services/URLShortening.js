// Copyright (c) 2013 SAP AG, All Rights Reserved
(function(){"use strict";jQuery.sap.declare("sap.ushell.services.URLShortening");jQuery.sap.require("jquery.sap.storage");sap.ushell.services.URLShortening=function(){var s=this;this.ABBREV_PARAM_NAME="sap-ushell-appparams";this.URL_LENGTH_LIMIT=1023;this.URL_PARAMS_LENGTH_LIMIT=512;this.compactHash=function(u){var S,r,p,U,R;if(typeof u!=="string"||u.length<s.URL_LENGTH_LIMIT){return u}U=sap.ushell.Container.getService("URLParsing");S=U.parseShellHash(u);p='';if(u.charAt(0)==='#'){p='#'}if(S&&S.params&&S.params[s.ABBREV_PARAM_NAME]){return u}r=this._splitParameters(S.params);if(!r.key){return u}R=U.paramsToString(r.tailParams);this._storeValue(r.key,R);return p+U.constructShellHash({target:{semanticObject:S.semanticObject,action:S.action,contextRaw:S.contextRaw},params:r.headParams,appSpecificRoute:S.appSpecificRoute})};this.checkHashLength=function(u){var S,r,p,U,R;if(typeof u!=="string"||u.length<s.URL_LENGTH_LIMIT){return{hash:u}}U=sap.ushell.Container.getService("URLParsing");S=U.parseShellHash(u);p='';if(u.charAt(0)==='#'){p='#'}r=this._splitParameters(S.params);if(r.key){jQuery.sap.log.error("Application startup parameter length exceeds "+s.URL_PARAMS_LENGTH_LIMIT+" characters, truncation occured!");delete r.headParams[this.ABBREV_PARAM_NAME];return{hash:p+U.constructShellHash({target:{semanticObject:S.semanticObject,action:S.action,contextRaw:S.contextRaw},params:r.headParams,appSpecificRoute:S.appSpecificRoute}),params:r.headParams,skippedParams:r.tailParams}}jQuery.sap.log.error("URL exceeds dangerous limits, arbitrary shortening or worse may occur!");return u};this._splitParameters=function(p){var a,i,k,b,h={},t={},c=false,o,d,e=0,f,l=[];for(a in p){if(Object.prototype.hasOwnProperty.call(p,a)){l.push(a)}}l.sort();for(k=0;k<l.length;k=k+1){a=l[k];o=p[a];if(o.length>1){jQuery.sap.log.error("Array startup parameters violate the designed intent of the Unified Shell Intent, use only single-valued parameters!")}for(i=0;i<o.length;i=i+1){d=p[a][i];f=a.length+d.length;if(f+e>this.URL_PARAMS_LENGTH_LIMIT){if(t[a]){t[a].push(d)}else{t[a]=[d]}c=true}else{if(h[a]){h[a].push(d)}else{h[a]=[d]}}e=e+f+1}}if(c){b=this._generateKey();h[this.ABBREV_PARAM_NAME]=b}return{key:b,tailParams:t,headParams:h}};this._generateKey=function(){return jQuery.sap.uid()};this.expandHash=function(u){var a,v,p,b;if(typeof u!=="string"){return u}a=sap.ushell.Container.getService("URLParsing").parseShellHash(u);if(!a||(a&&a.params&&!a.params[this.ABBREV_PARAM_NAME])){return u}p='';if(u.charAt(0)==='#'){p='#'}v=this._retrieveValue(a.params[this.ABBREV_PARAM_NAME]&&a.params[this.ABBREV_PARAM_NAME][0]);if(!v){return u}b=this._blendParameters(a.params,v);return p+sap.ushell.Container.getService("URLParsing").constructShellHash({target:{semanticObject:a.semanticObject,action:a.action,contextRaw:a.contextRaw},params:b,appSpecificRoute:a.appSpecificRoute})};this._retrieveValue=function(k){return jQuery.sap.storage(jQuery.sap.storage.Type.session).get(k)};this._storeValue=function(k,v){jQuery.sap.storage(jQuery.sap.storage.Type.session).put(k,v)};this._blendParameters=function(p,v){var n=sap.ushell.Container.getService("URLParsing").parseParameters("?"+v),a;delete p[this.ABBREV_PARAM_NAME];for(a in n){if(Object.prototype.hasOwnProperty.call(n,a)){if(p[a]){p[a]=p[a].concat(n[a])}else{p[a]=n[a]}}}return p}};sap.ushell.services.URLShortening.hasNoAdapter=true}());
