/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.require('sap.apf.ui.representations.utils.formatter');jQuery.sap.declare("sap.apf.ui.representations.table");
sap.apf.ui.representations.table=function(a,p){var s=this;this.parameter=p;this.type=sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION;this.fields=p.dimensions.concat(p.measures);this.columns={name:[],value:[],width:[]};jQuery.sap.require({modName:"sap.ui.thirdparty.d3"});this.aDataResponse=[];this.alternateRepresentation=p.defaultListConfigurationTypeID;this.filter=a.createFilter();var b=0;var t=100;var c;var d;var f;var g=false;var h=0;var j=0;var r=[];this.printMode=false;this.oModel=new sap.ui.model.json.JSONModel();this.oModel.setSizeLimit(10000);this.isAlternateRepresentation=p.isAlternateRepresentation;this.getParameter=function(){return this.parameter};this.setData=function(D,m){if(j===0){if(g){D.map(function(o){s.aDataResponse.push(o)});j++}else{b=0;s.aDataResponse=[];D.map(function(o){s.aDataResponse.push(o)})}}r=D;this.metadata=m;g=false;this.formatter=new sap.apf.ui.representations.utils.formatter(a,m,D)};this.getAlternateRepresentation=function(){return this.alternateRepresentation};this.getMetaData=function(){return this.metadata};this.getData=function(){return this.aDataResponse};this.getRequestOptions=function(){if(!g){t=100;b=0;j=0}var e={paging:{top:t,skip:b,inlineCount:true}};var o;if(d!==undefined){o=[{property:d,descending:f}];e.orderby=o}else{if(this.getParameter().sort!==undefined){o=[{property:this.getParameter().sort.sortField,descending:this.getParameter().sort.descending}];e.orderby=o}}return e};this.createDataset=function(){if(s.getData().length!==0){for(var i=0;i<s.fields.length;i++){s.columns.value[i]=s.fields[i].fieldName;var n="";var u="";if(s.getMetaData()!==undefined&&s.getMetaData().getPropertyMetadata(s.fields[i].fieldName).unit!==undefined){var U=s.getMetaData().getPropertyMetadata(s.fields[i].fieldName).unit;u=s.getData()[0][U];n=s.fields[i].fieldDesc===undefined?s.getMetaData().getPropertyMetadata(s.fields[i].fieldName).label+" ("+u+")":a.getTextNotHtmlEncoded(s.fields[i].fieldDesc)+" ("+u+")";s.columns.name[i]=n}else s.columns.name[i]=this.fields[i].fieldDesc===undefined?s.getMetaData().getPropertyMetadata(s.fields[i].fieldName).label:a.getTextNotHtmlEncoded(s.fields[i].fieldDesc);if(s.parameter.width!==undefined){s.columns.width[i]=s.parameter.width[s.columns.value[i]]}}}};this.drawSelection=function(e){var R=s.getFilter().getInternalFilter().getProperties()[0],F=s.getFilter().getInternalFilter().getFilterTermsForProperty(R),i=F.map(function(k){return k.getValue()}),l=this.getItems(),S=l.filter(function(k){var m=k.getBindingContext().getProperty(R);return i.indexOf(m)!==-1});S.forEach(function(k){k.addStyleClass('sapMLIBSelected')})};this.getMainContent=function(S,e,w){s.createDataset();var m;if(!S){m=a.createMessageObject({code:"6002",aParameters:["title",a.getTextNotHtmlEncoded("step")]});a.putMessage(m)}if(this.fields.length===0){m=a.createMessageObject({code:"6002",aParameters:["dimensions",S]});a.putMessage(m)}if(!this.aDataResponse||this.aDataResponse.length===0){m=a.createMessageObject({code:"6000",aParameters:[S]});a.putMessage(m)}var k=e||600;k=k+"px";var l=w||1000;l=l+"px";s.title=S;var o=s.aDataResponse;s.oModel.setData({tableData:o});var n=[];var i;for(i=0;i<s.columns.name.length;i++){s.cellValues=new sap.m.Text().bindText(s.columns.value[i],function(G){return function(H){if(s.metadata===undefined){return H}else{var J=s.formatter.getFormattedValue(s.columns.value[G],H);if(J!==undefined){return J}else{return H}}}}(i),sap.ui.model.BindingMode.OneWay);n.push(s.cellValues)}var q=[];var u=[];var W;var v;var x;var y;for(i=0;i<s.columns.name.length;i++){W=false;if(s.columns.width!==undefined&&s.columns.width instanceof Array&&s.columns.width.length!==0)W=true;v=d3.scale.linear().domain([0,8]).range([0,72]);x=W?s.columns.width[i]:(v(s.columns.name[i].length))+"px";s.columnName=new sap.m.Column({width:x,header:new sap.m.Text({text:s.columns.name[i]})});q.push(s.columnName);s.columnName1=new sap.m.Column({width:x});u.push(s.columnName1)}var T=new sap.m.Table({headerText:s.title,showNoData:false,columns:q}).addStyleClass("tableWithHeaders");this.oTableWithoutHeaders=new sap.m.Table({columns:u,items:{path:"/tableData",template:new sap.m.ColumnListItem({cells:n})}});T.setModel(s.oModel);this.oTableWithoutHeaders.setModel(s.oModel);this.oTableWithoutHeaders.attachUpdateFinished(this.drawSelection.bind(this.oTableWithoutHeaders));var z=function(G){var H=G.getParameters();s.oTableWithoutHeaders.setBusy(true);j=0;d=H.sortItem.getKey();f=H.sortDescending;t=100;b=0;var A=[];if(H.sortItem){if(s.isAlternateRepresentation){var B=s.oTableWithoutHeaders.getBinding("items");A.push(new sap.ui.model.Sorter(d,f));B.sort(A);s.oTableWithoutHeaders.setBusy(false);return}a.updatePath(function(J,K){if(J===a.getActiveStep()){s.oModel.setData({tableData:s.aDataResponse});s.oTableWithoutHeaders.rerender();s.oTableWithoutHeaders.setBusy(false)}}.bind(this))}};this.viewSettingsDialog=new sap.m.ViewSettingsDialog({confirm:z});for(i=0;i<T.getColumns().length;i++){var I=new sap.m.ViewSettingsItem({text:s.columns.name[i],key:s.columns.value[i]});this.viewSettingsDialog.addSortItem(I)}if(d===undefined&&f===undefined){if(this.getParameter().sort!==undefined){for(i=0;i<this.viewSettingsDialog.getSortItems().length;i++){if(this.getParameter().sort.sortField===this.viewSettingsDialog.getSortItems()[i].getKey()){this.viewSettingsDialog.setSelectedSortItem(this.viewSettingsDialog.getSortItems()[i]);this.viewSettingsDialog.setSortDescending(this.getParameter().sort.descending)}}}else{this.viewSettingsDialog.setSelectedSortItem(this.viewSettingsDialog.getSortItems()[0]);this.viewSettingsDialog.setSortDescending(false)}}else{for(i=0;i<this.viewSettingsDialog.getSortItems().length;i++){if(d===this.viewSettingsDialog.getSortItems()[i].getKey()){this.viewSettingsDialog.setSelectedSortItem(this.viewSettingsDialog.getSortItems()[i])}}this.viewSettingsDialog.setSortDescending(f);var A=[];if(this.isAlternateRepresentation){var B=s.oTableWithoutHeaders.getBinding("items");A.push(new sap.ui.model.Sorter(d,f));B.sort(A)}}if(s.metadata!==undefined){for(i=0;i<s.columns.name.length;i++){var M=s.metadata.getPropertyMetadata(s.columns.value[i]);if(M.unit){var C=s.oTableWithoutHeaders.getColumns()[i];C.setHAlign(sap.ui.core.TextAlign.Right)}}}var D=new sap.m.ScrollContainer({content:s.oTableWithoutHeaders,height:"480px",horizontal:false,vertical:true}).addStyleClass("tableWithoutHeaders");var E=new sap.m.Link({text:"More"}).addStyleClass("loadMoreLink");var F=new sap.m.ScrollContainer({content:[T,D],width:l,horizontal:true,vertical:false}).addStyleClass("scrollContainer");s.oModel.setSizeLimit(10000);T.addEventDelegate({onAfterRendering:function(){jQuery(".scrollContainer > div:first-child").css({"display":"table","width":"inherit"});var G;if(s.offsetTop===undefined){s.offsetTop=jQuery(".tableWithoutHeaders").offset().top}if(jQuery(".tableWithoutHeaders").offset().top!==s.offsetTop){G=((window.innerHeight-jQuery('.tableWithoutHeaders').offset().top))+"px"}else{G=((window.innerHeight-jQuery('.tableWithoutHeaders').offset().top)-(jQuery(".applicationFooter").height())-20)+"px"}document.querySelector('.tableWithoutHeaders').style.cssText+="height : "+G;var L=sap.ui.getCore().getRenderManager().getHTML(E);var H;sap.ui.Device.orientation.attachHandler(function(){F.rerender()});var J=a.getActiveStep();if(J.getSelectedRepresentation().bIsAlternateView===undefined||J.getSelectedRepresentation().bIsAlternateView===false){if(sap.ui.Device.browser.mobile){jQuery(jQuery(".tableWithoutHeaders > div:first-child")).append(L);E.attachPress(function(){if(!jQuery(".openToggleImage").length&&(r.length>0)){if(h===0){K();j=0;h++;jQuery(".loadMoreLink").remove();jQuery(jQuery(".tableWithoutHeaders > div:first-child")).append(L)}}else{jQuery(".loadMoreLink").remove()}})}else{jQuery('.tableWithoutHeaders').on("scroll",function(){var s=jQuery(this);var N=s.prop("scrollTop");var O=s.prop("scrollHeight");var P=s.prop("offsetHeight");var Q=O-P-5;if((Q<=N)&&!jQuery(".openToggleImage").length&&(r.length>0)){if(h===0){K();j=0;h++}}})}}var K=function(){s.oTableWithoutHeaders.setBusy(true);sap.ui.getCore().applyChanges();var N=s.oModel.getData();b+=o.length;t=10;g=true;a.updatePath(function(O,P){if(O===a.getActiveStep()){s.oModel.setData(N);s.oTableWithoutHeaders.rerender();s.oTableWithoutHeaders.setBusy(false);h=0}}.bind(this))}}});return new sap.ui.layout.VerticalLayout({content:[F]})};this.getThumbnailContent=function(){if(this.aDataResponse!==undefined&&this.aDataResponse.length!==0){var i=new sap.ui.core.Icon({src:"sap-icon://table-chart",size:"70px"}).addStyleClass('thumbnailTableImage');return i}else{var n=new sap.m.Text({text:a.getTextNotHtmlEncoded("noDataText")}).addStyleClass('noDataText');return new sap.ui.layout.VerticalLayout({content:n})}};this.serialize=function(){return{oFilter:this.getFilter().serialize()}};this.deserialize=function(S){var e=a.createFilter();this.setFilter(e.deserialize(S.oFilter))};this.getFilterMethodType=function(){return sap.apf.core.constants.filterMethodTypes.filter};this.getSelectionCount=function(){var R=s.getFilter().getInternalFilter().getProperties()[0],F=s.getFilter().getInternalFilter().getFilterTermsForProperty(R);return F.length};this.getFilter=function(){return this.filter};this.setFilter=function(F){this.filter=F};this.adoptSelection=function(S){if(S&&S.getFilter){this.setFilter(S.getFilter())}};this.removeAllSelection=function(){this.setFilter(a.createFilter());a.selectionChanged();s.oTableWithoutHeaders.getItems().forEach(function(i){i.removeStyleClass('sapMLIBSelected')})};this.getPrintContent=function(S){this.createDataset();var o=this.aDataResponse;this.oModel.setData({tableData:o});var i;var e=[];for(i=0;i<s.columns.name.length;i++){s.columnName=new sap.m.Column({width:"75px",header:new sap.m.Label({text:s.columns.name[i]})});e.push(s.columnName)}var k=[];for(i=0;i<s.columns.name.length;i++){s.cellValues=new sap.m.Text().bindText(s.columns.value[i],function(n){return function(q){if(s.metadata===undefined){return q}else{var m=s.metadata.getPropertyMetadata(s.columns.value[n]);if(m.dataType.type==="Edm.DateTime"){if(q===null){return"-"}var u=new Date(parseInt(q.slice(6,q.length-2),10));u=u.toLocaleDateString();if(u==="Invalid Date"){return"-"}return u}if(m.unit){if(q===null){return"-"}var v=s.metadata.getPropertyMetadata(m.unit);if(v.semantics==="currency-code"){var w=s.aDataResponse[0][m.scale];q=parseFloat(q,10).toFixed(w).toString();var x=q.split(".");var y=parseFloat(x[0]).toLocaleString();var z=0.1;z=z.toLocaleString();if(y.split(z.substring(1,2)).length>1){y=y.split(z.substring(1,2))[0]}y=y.concat(z.substring(1,2),x[1]);return y}}else{return q}}}}(i),sap.ui.model.BindingMode.OneWay);k.push(s.cellValues)}var T=new sap.m.Table({headerText:S,headerDesign:sap.m.ListHeaderDesign.Standard,columns:e,items:{path:"/tableData",template:new sap.m.ColumnListItem({cells:k})}}).addStyleClass("printTable");if(s.metadata!==undefined){for(i=0;i<s.columns.name.length;i++){var m=s.metadata.getPropertyMetadata(s.columns.value[i]);if(m.unit){var l=T.getColumns()[i];l.setHAlign(sap.ui.core.TextAlign.Right)}}}T.setModel(s.oModel);T.attachUpdateFinished(this.drawSelection.bind(T));return new sap.ui.layout.VerticalLayout({content:[T]})}};
