/*!
 * @copyright@
 */
jQuery.sap.require("sap.collaboration.components.utils.CommonUtil");jQuery.sap.require("sap.collaboration.components.utils.OdataUtil");jQuery.sap.require("sap.collaboration.components.fiori.sharing.helper.ShareUtil");jQuery.sap.require("sap.collaboration.components.fiori.sharing.helper.AttachmentsUtil");jQuery.sap.require("sap.m.MessageToast");sap.ui.controller("sap.collaboration.components.fiori.sharing.Sharing",{onInit:function(){this.oNoteTextArea=this.getView().oNoteTextArea;this.oAttachmentsInput=this.getView().oAttachmentsInput;this.oTargetFolderInput=this.getView().oTargetFolderInput;this.oODataUtil=undefined;this.sPrefixId=this.getView().getViewData().controlId;this.oLangBundle=this.getView().getViewData().langBundle;this.aJamGroups=this.getView().getViewData().jamGroups;this.aGroupsLinkedToBo=[];this.iJamGroupsCount=0;this.sObjectId=this.getView().getViewData().objectId;this.sObjectShare=this.getView().getViewData().objectShare;this.oObjectDisplay=this.getView().getViewData().objectDisplay;this.oExternalObject=undefined;this.oMappedExternalObject=undefined;this.sMemberEmail=undefined;this.oSharingDialog=this.getView().getViewData().sharingDialog;this.fNoGroupsCallBack=this.getView().getViewData().noGroupsCallBack;this.oCommonUtil=new sap.collaboration.components.utils.CommonUtil();this.oAttachments=this.getView().getViewData().attachments;this.bAttachmentsCB=false;this.aFiles=[];this.aSelectedFiles=[];this.sSelectedFolderId=''},onBeforeRendering:function(){try{this.sSelectedGroupId='';if(!this.oSMIODataModel)this.initializeOdataModel();if(!this.oODataUtil)this.initializeOdataUtils();if(!this.oAttachmentsUtil)this.initializeAttachmentsUtil();this.initializeShareUtil();this.preRenderSetup();this.fetchData();this.clearAttachmentsData();this.oAttachments=this.getView().getViewData().attachments;if(this.oAttachments&&this.oAttachments.attachmentsArray){this.aFiles=this.oAttachments.attachmentsArray;if(this.aFiles.length>0){this.getView().oAttachmentsInput.setEnabled(true)}else{this.getView().oAttachmentsInput.setEnabled(false)}if(this.oFileSelectionDialog){var a=this.oAttachmentsUtil.createAttachmentsModel(this.aFiles);this.oFileSelectionDialog.setModel(a)}this.showAttachmentsFields(true)}else{this.showAttachmentsFields(false)}if(this.sObjectId!=this.getView().getViewData().objectId){this.sObjectId=this.getView().getViewData().objectId}if(this.sObjectShare!=this.getView().getViewData().objectShare||sap.ui.getCore().byId(this.sPrefixId+"_NoteTextArea").setValue!==this.getView().getViewData().objectShare){this.sObjectShare=this.getView().getViewData().objectShare;sap.ui.getCore().byId(this.sPrefixId+"_NoteTextArea").setValue(this.sObjectShare)}if(this.oObjectDisplay!=this.getView().getViewData().objectDisplay){if(this.oObjectDisplay!=undefined){this.getView().oSharingVBox.removeItem(0)}this.oObjectDisplay=this.getView().getViewData().objectDisplay;this.getView().oSharingVBox.insertItem(this.oObjectDisplay,0)}}catch(e){if(this.oSharingDialog){throw e}this.oCommonUtil.displayError(e)}},onAfterRendering:function(){setTimeout(function(){sap.ui.getCore().byId(this.sPrefixId+"_GroupSelect").focus()}.bind(this),1)},onExit:function(){this.getView().destroyContent()},preRenderSetup:function(){this.getView().oGroupSelect.setEnabled(false);this.setGroupSelectionText("");if(this.oAttachments&&this.oAttachments.attachmentsArray){this.getView().oTargetFolderInput.setEnabled(false)}this.getView().oNoteTextArea.setEnabled(false);if(this.oSharingDialog){this.oSharingDialog.getBeginButton().setEnabled(false)}},fetchData:function(){var s=this;var g=new jQuery.Deferred();g.done(function(c){s.iJamGroupsCount=c;if(s.iJamGroupsCount>0){s.postFetchSetup()}else{if(s.fNoGroupsCallBack){s.fNoGroupsCallBack()}}});var a=new jQuery.Deferred();a.done(function(u){if(!s.sJamUrl){s.sJamUrl=u}});var m=new jQuery.Deferred();m.done(function(e){s.oMappedExternalObject=e});m.fail(function(){s.oMappedExternalObject=undefined;jQuery.sap.log.debug('Mapping Internal BO to External BO failed')});var b=new jQuery.Deferred();b.done(function(e){if(!s.sMemberEmail){s.sMemberEmail=e}});jQuery.when(g,a,m).fail(function(){if(s.oSharingDialog){s.oSharingDialog.close()}s.oCommonUtil.displayError()});this.oJamODataModel.read('/Groups/$count',{success:function(d,r){g.resolve(parseInt(r.body))},error:function(e){g.reject()}});this.oJamODataModel.read('/Self',{success:function(d,r){b.resolve(d.results.Email)},error:function(e){b.reject()}});if(!this.sJamUrl){this.oSMIODataModel.read('/GetCollaborationHostURL',{success:function(d,r){a.resolve(d.GetCollaborationHostURL.URL)},error:function(e){a.reject()}})}else{a.resolve()}this.oExternalObject=this.getView().getViewData().externalObject;if(this.oExternalObject){this.oSMIODataModel.read('/MapInternalBOToExternalBO',{urlParameters:{ApplicationContext:"'"+s.oExternalObject.appContext+"'",ODataCollection:"'"+s.oExternalObject.collection+"'",ODataKeyPredicate:"'"+s.oExternalObject.key+"'",ODataServicePath:"'"+s.oExternalObject.odataServicePath+"'"},success:function(d,r){m.resolve(d.MapInternalBOToExternalBO)},error:function(e){m.reject()}})}},postFetchSetup:function(){this.setGroupSelectionEnabled(true)},initializeOdataModel:function(){var a=true;this.sSMIODataServiceUrl=this.getView().getViewData().odataServiceUrl;this.oSMIODataModel=new sap.ui.model.odata.ODataModel(this.sSMIODataServiceUrl,a);this.sJamODataServiceUrl=this.getView().getViewData().collaborationHostODataServiceUrl;this.oJamODataModel=new sap.ui.model.odata.ODataModel(this.sJamODataServiceUrl,a);this.oJamODataModel.setDefaultCountMode(sap.ui.model.odata.CountMode.Inline)},initializeOdataUtils:function(){this.oODataUtil=new sap.collaboration.components.utils.OdataUtil()},initializeAttachmentsUtil:function(){this.oAttachmentsUtil=new sap.collaboration.components.fiori.sharing.helper.AttachmentsUtil(this.oLangBundle,this.oODataUtil,this.oJamODataModel)},initializeShareUtil:function(){this.oShareUtil=new sap.collaboration.components.fiori.sharing.helper.ShareUtil(this.oLangBundle,this.oODataUtil,this.oSMIODataModel,this.oCommonUtil,this.oJamODataModel,this.getView().getViewData().collaborationHostRestService)},setGroupSelectionText:function(t){var g=sap.ui.getCore().byId(this.sPrefixId+"_GroupSelect");g.setValue(t)},setGroupSelectionEnabled:function(e){var g=sap.ui.getCore().byId(this.sPrefixId+"_GroupSelect");g.setEnabled(e)},setFolderSelectionEnabled:function(e){this.oTargetFolderInput.setEnabled(e)},showAttachmentsFields:function(v){this.getView().AttachmentsInputLayout.setVisible(v);this.getView().oTargetFolderInputLayout.setVisible(v);this.getView().oAttachmentCB.setVisible(v)},clearAttachmentsData:function(){this.aFiles=[];this.aSelectedFiles=[];this.sSelectedFolderId='';this.bAttachmentsCB=false;this.oAttachmentsInput.setValue("");this.getView().oAttachmentCB.setSelected(this.bAttachmentsCB);this.getView().oAttachmentCB.setEnabled(false);this.oTargetFolderInput.setValue("");if(this.oFolderSelectionDialog){this.oAttachmentsUtil.resetFolderSelection(this.getSelectedGroupId())}},onAttachmentsValueHelpPress:function(c){if(this.oSharingDialog){var s=this.oSharingDialog.getContent()[0].getDomRef().offsetHeight;var S=this.oSharingDialog.getDomRef().offsetWidth}if(!this.oFileSelectionDialog){var a=this.oAttachmentsUtil.createAttachmentsModel(this.aFiles);this.oFileSelectionDialog=this.oAttachmentsUtil.createFileSelectionDialog(this.sPrefixId,a,this.onFileSelectionDialogConfirm(),S,s)}var b=this.oFileSelectionDialog.getBinding("items");b.filter([]);this.oFileSelectionDialog.open()},onFileSelectionDialogConfirm:function(){var s=this;return function(e){s.aSelectedFiles=[];var c=e.getParameter("selectedContexts");for(var i=0;i<c.length;i++){s.aSelectedFiles.push(c[i].getObject())}if(s.aSelectedFiles&&s.aSelectedFiles.length>0){s.postFileSelectionSetup(true)}else{s.postFileSelectionSetup(false)}}},postFileSelectionSetup:function(f){if(f===true){if(this.aSelectedFiles.length==1){this.oAttachmentsInput.setValue(this.oLangBundle.getText("SELECTED_ATTACHMENT_FIELD_TEXT",[this.aSelectedFiles.length]))}else{this.oAttachmentsInput.setValue(this.oLangBundle.getText("SELECTED_ATTACHMENTS_FIELD_TEXT",[this.aSelectedFiles.length]))}this.getView().oAttachmentCB.setEnabled(true);if(this.sSelectedGroupId!==''){this.setFolderSelectionEnabled(true)}}else{this.oAttachmentsInput.setValue("");this.bAttachmentsCB=false;this.getView().oAttachmentCB.setSelected(this.bAttachmentsCB);this.postAttachmentCheckBoxSelection();this.getView().oAttachmentCB.setEnabled(false);this.setFolderSelectionEnabled(false)}},onGroupSelectValueHelpPress:function(e){if(this.oSharingDialog){var s=this.oSharingDialog.getContent()[0].getDomRef().offsetHeight;var S=this.oSharingDialog.getContent()[0].getDomRef().offsetWidth}var a=this;var o=function(e,b){a.postGroupSelectionSetup(b);a.oGroupSelectionDialog.close()};if(!this.oGroupSelectionDialog){this.oGroupSelectionDialog=this.oShareUtil.createGroupSelectionDialog(this.sPrefixId,this.aGroupsLinkedToBo,o,S,s,this.oJamODataModel)}else{this.oGroupSelectionDialog.refresh(this.aJamGroups)}this.oGroupSelectionDialog.open()},postGroupSelectionSetup:function(s){this.sSelectedGroupId=s.Id.toString();this.setGroupSelectionText(s.Name);if(this.oAttachments&&this.oAttachments.attachmentsArray){this.sSelectedFolderId='';this.oAttachmentsUtil.resetFolderSelection(this.getSelectedGroupId());var S=this.oAttachmentsUtil.getCurrentFolder();this.oTargetFolderInput.setValue(S.name)}if(this.aSelectedFiles&&this.aSelectedFiles.length>0){this.setFolderSelectionEnabled(true)}if(this.bAttachmentsCB===false){this.getView().oNoteTextArea.setEnabled(true)}if(this.oSharingDialog){this.oSharingDialog.getBeginButton().setEnabled(true)}},onTargetFolderValueHelpPress:function(c){if(this.oSharingDialog){var s=this.oSharingDialog.getContent()[0].getDomRef().offsetHeight;var S=this.oSharingDialog.getContent()[0].getDomRef().offsetWidth}if(!this.oFolderSelectionDialog){this.oFolderSelectionDialog=this.oAttachmentsUtil.createFolderSelectionDialog(this.sPrefixId,this.getSelectedGroupId(),this.onFolderSelectionDialogConfirm(),this.onFolderSelectionDialogCancel(),S,s);this.sSelectedFolderId=''}this.oFolderSelectionDialog.getContent()[0].oController.setFolderSelectionDialogTitle(this.oTargetFolderInput.getValue());this.oFolderSelectionDialog.open()},onFolderSelectionDialogConfirm:function(e){var s=this;return function(){var S=s.oAttachmentsUtil.getCurrentFolder();s.sSelectedFolderId=S.id;s.oTargetFolderInput.setValue(S.name)}},onFolderSelectionDialogCancel:function(e){var s=this;return function(e){s.oAttachmentsUtil.setCurrentFolderId(s.sSelectedFolderId)}},onAttachmentCheckBoxSelected:function(){this.bAttachmentsCB=this.getView().oAttachmentCB.getSelected();this.postAttachmentCheckBoxSelection()},postAttachmentCheckBoxSelection:function(){if(this.bAttachmentsCB===true){this.getView().oNoteTextArea.setEnabled(false)}else{if(this.sSelectedGroupId!==''){this.getView().oNoteTextArea.setEnabled(true)}}},getSharingData:function(){var f;if((this.oNoteTextArea.getValue()!==undefined&&this.oNoteTextArea.getValue()!=="")||(this.sObjectId!==undefined&&this.sObjectId!=="")){f={note:this.oNoteTextArea.getValue(),uiUrl:this.sObjectId}}if(JSON.stringify(this.oExternalObject)==='{}'){this.oExternalObject=undefined}return{feedContent:f,groupId:this.getSelectedGroupId(),folderId:this.getSelectedFolderId(),aFilesToUpload:this.aSelectedFiles,externalObject:this.oExternalObject,mappedExternalObject:this.oMappedExternalObject,groupName:sap.ui.getCore().byId(this.sPrefixId+"_GroupSelect").getValue(),memberEmail:this.sMemberEmail}},getSelectedGroupId:function(){return this.sSelectedGroupId},getSelectedFolderId:function(){return this.sSelectedFolderId},shareToJam:function(){var s=this.getSharingData();var a=this;if(s.aFilesToUpload.length===0&&(!s.feedContent||(!s.feedContent.uiUrl&&s.feedContent.note.trim()===""))&&!s.externalObject){var r=a.oLangBundle.getText("SHARING_NOTHING_TO_SHARE_MSG");this.oCommonUtil.showMessage(r,{duration:3000,autoclose:false})}else{if(!this.bAttachmentsCB){this.oShareUtil.shareBusinessObject(s)}if(s.aFilesToUpload.length>0){this.oShareUtil.uploadAttachments(s);var r=this.oLangBundle.getText("SHARING_ACKNOWLEDGMENT_MSG");setTimeout(function(){a.oCommonUtil.showMessage(r,{duration:3000,width:"30em",autoClose:false})},500)}}}});
