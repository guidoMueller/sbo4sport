jQuery.sap.require("sap.ca.scfld.md.controller.BaseFullscreenController");jQuery.sap.require("sap.m.MessageBox");sap.ca.scfld.md.controller.BaseFullscreenController.extend("sap.suite.ui.smartbusiness.drilldown.view.Drilldown",{_getEvaluationId:function(){try{var s=this.oConnectionManager.getComponent().oComponentData.startupParameters;return s["evaluationId"][0]}catch(e){return sap.suite.smartbusiness.url.hash.getStartupParameters().evaluationId[0]}},_getDataFromUrl:function(){try{var s=this.oConnectionManager.getComponent().oComponentData.startupParameters;this.TILE_TYPE='';this.DIMENSION='';if(s["tileType"]){this.TILE_TYPE=s["tileType"][0]}if(s["dimension"]){this.DIMENSION=s["dimension"][0]}if(s["sap-system"]){this.SAP_SYSTEM=s["sap-system"][0]}if(s["chipId"]){this.CHIP_ID=s["chipId"][0]}}catch(e){var p=sap.suite.smartbusiness.url.hash.getStartupParameters();if(p){if(p.tileType){this.TILE_TYPE=p.tileType[0]}if(p.dimension){this.DIMENSION=p.dimension[0]}if(p["sap-system"]){this.SAP_SYSTEM=p["sap-system"][0]}if(p["chipId"]){this.CHIP_ID=p["chipId"][0]}}}},fetchAllEvaluations:function(p){var h=[this._getEvaluationId()];var H=this.CONFIGURATION.getHeaders();H.forEach(function(c){if(c.isAssociated()){if(h.indexOf(c.getReferenceEvaluationId())==-1){h.push(c.getReferenceEvaluationId())}if(h.indexOf(c.getEvaluationId())==-1){h.push(c.getEvaluationId())}}});this._bundled_evaluations_call_ref=sap.suite.smartbusiness.drilldown.setEvaluationsCache({evalIdArray:h,sapSystem:this.SAP_SYSTEM,success:p.success,context:p.context})},onAfterRendering:function(){var E=this._getEvaluationId();this._EVALUATION_ID=E;this.firstTimeFlag=false;this._getDataFromUrl();if(!this._proxyHashChangeListener){this._proxyHashChangeListener=jQuery.proxy(this.hashChangeListener,this);this._attachHashChangeEvent()}this._busyDialog.open();var s=new Date().getTime();this.DDA_CONFIG_ODATA_CALL_REF=sap.suite.smartbusiness.drilldown.loadConfiguration({evaluationId:E,cache:true,success:function(b){var e=new Date().getTime();this._requestTimeLog["DDA_CONFIG_FETCH"]={title:"Configuration",time:e-s};this.CONFIGURATION=sap.suite.smartbusiness.drilldown.parse(E,b);var t=this;if(this.CONFIGURATION.getAllViews().length==0){jQuery.sap.log.error("drilldown not configured");var i=t.getView().getModel("i18n");sap.m.MessageBox.alert(i.getResourceBundle().getText("DDA_NOT_CONFIGURED"),function(){window.location.hash="";t._busyDialog.close()});return}var a=new Date().getTime();this.fetchAllEvaluations({success:function(){var c=new Date().getTime();this._requestTimeLog["BUNDLED_EVALUATIONS_FETCH"]={title:"Evaluations",time:c-a};this.EVALUATION_ODATA_CALL_REF=sap.suite.smartbusiness.drilldown.getEvaluationById({id:E,cache:true,filters:true,thresholds:true,success:function(d){this._busyDialog.close();this.EVALUATION=sap.suite.smartbusiness.kpi.parseEvaluation(d);this._initialize()},error:function(){this._busyDialog.close();throw new Error("Evaluation Details Not Found with ID : "+E)},context:this,sapSystem:this.SAP_SYSTEM})},context:this,})},error:function(){jQuery.sap.log.error("Drilldown Configuration Fetching Failed");this._busyDialog.close()},context:this,sapSystem:this.SAP_SYSTEM})},onInit:function(){sap.suite.smartbusiness.cache.invalidateKpiDetailsCache();this._requestTimeLog={};this._busyDialog=new sap.m.BusyDialog();sap.sb_drilldown_app=this;this.EVALUATION=null;this.CONFIGURATION=null;this.SELECTED_VIEW=null;this.POPOVER_VIEW_NAVIGATION_MODEL=new sap.ui.model.json.JSONModel({"VIEW_NAVIGATION":[]});this.POPOVER_EXTERNAL_APP_NAVIGATION_MODEL=new sap.ui.model.json.JSONModel({"APP_NAVIGATION":[]});this.SEMANTIC_OBJECT=sap.suite.smartbusiness.url.hash.getSemanticObject();this.ACTION=sap.suite.smartbusiness.url.hash.getAction();var l=new sap.ui.core.Locale(sap.ui.getCore().getConfiguration().getLanguage());this.VALUE_FORMATTER=sap.ca.ui.model.format.NumberFormat.getInstance({style:"standard"},l);this.urlParsingService=sap.ushell.Container.getService("URLParsing");this.addExportMethodToTable();this._hideOrShowFacetFilterIfRequired()},_hideOrShowFacetFilterIfRequired:function(){var f=this.getUIComponents().getFilter();var a=sap.suite.smartbusiness.url.hash.getApplicationParameters(["viewId"]);if(jQuery.isEmptyObject(a)==false){f.setVisible(true)}},onBeforeRendering:function(){},_initialize:function(){this.setHeaderFooterOptions(this.getHeaderFooterOptions());this._initExternalNavigationLinks();var w=this.EVALUATION.getKpiName()+" - "+this.EVALUATION.getTitle();try{if(sap.ushell.services.AppConfiguration&&sap.ushell.services.AppConfiguration.setWindowTitle){sap.ushell.services.AppConfiguration.setWindowTitle(w)}}catch(e){jQuery.sap.log.error("Error Setting Window Page Title : "+w)}var p=sap.suite.smartbusiness.odata.properties(this.urlParsingService.addSystemToServiceUrl(this.EVALUATION.getODataUrl(),this.SAP_SYSTEM),this.EVALUATION.getEntitySet());this.COLUMN_LABEL_MAPPING=p.getLabelMappingObject();this.DIMENSION_TEXT_PROPERTY_MAPPING=p.getTextPropertyMappingObject();this.MEASURE_UNIT_PROPERTY_MAPPING=p.getUnitPropertyMappingObject();this._initAddToHomeDialogBox();var v=new sap.ui.model.json.JSONModel();v.setData(this.CONFIGURATION.getAllViews());var U=this.getUIComponents();U.getChartToolbar().setModel(v,"VIEW_SWITCH");this.chartModel=new sap.ui.model.json.JSONModel();var c=9999;this.chartModel.setSizeLimit(c);U.getChartToolbar().setModel(this.chartModel);this.EvaluationHeaderModel=new sap.ui.model.json.JSONModel();U.getHeader().setModel(this.EvaluationHeaderModel);this.titleModel=new sap.ui.model.json.JSONModel();U.getPage().getCustomHeader().getContentMiddle()[0].setModel(this.titleModel);this.renderDrilldownHeader();this._initRequestTimeLogChart();this.hashChangeListener()},switchedToTableView:function(){if(this.getUIComponents().getChart()){this.setChartSelectionContextObject(null)}},switchedToChartView:function(){this.getUIComponents().getTable().setSelectedContext(null)},renderDrilldownHeader:function(){var f=this.CONFIGURATION.getFilters();this.renderFilters(f);var h=this.CONFIGURATION.getHeaders();this.renderKpiHeaders(h);this.renderTitle();this.renderEvaluationHeader()},renderTitle:function(){var t=this.getUIComponents().getPage().getCustomHeader().getContentMiddle()[0];if(t){t.setText(this.EVALUATION.getKpiName())}},renderFilters:function(f){var a=this.getUIComponents().getFilter();a.setEvaluationData(this.EVALUATION);a.setEvaluationId(this.EVALUATION.getId());a.setDimensions(f);a.setSapSystem(this.SAP_SYSTEM)},renderKpiHeaders:function(h){var s=this;var a=this.getUIComponents().getTileContainer();a.removeAllItems();this.miniChartManager=sap.suite.smartbusiness.miniChartManager.renderHeaders({allTiles:h,headerContainer:a,sapSystem:this.SAP_SYSTEM,urlFilters:this.getUrlFilters()})},renderView:function(c){this.table=null;this.chart=null;this._addUIComponents(c);var a=c.getColumns();var b=c.getChartConfiguration();this.renderTable(a,b[0].getColorScheme());if(this.chart){this.renderChart(c,b[0],a)}},renderEvaluationHeader:function(){var o=this.getUIComponents().getHeader(),t=this;o.setTitle(this.EVALUATION.getTitle());if(this.EVALUATION.getDescription()){o.removeAllAttributes();o.addAttribute(new sap.m.ObjectAttribute({text:this.EVALUATION.getDescription()}))}var k=this.EVALUATION.getKpiMeasureName();var f=k;if(this.DIMENSION_TEXT_PROPERTY_MAPPING[k]){f=this.DIMENSION_TEXT_PROPERTY_MAPPING[k]}var a=this.MEASURE_UNIT_PROPERTY_MAPPING[k];o.bindProperty("number","/data/"+f,f!=k?function(v){return v}:function(v){if(v){if(t.EVALUATION.getScaling()==-2){return(t.VALUE_FORMATTER.format(v*100)+"%")}else{return t.VALUE_FORMATTER.format(v)}}return v});if(a){o.bindProperty("numberUnit","/data/"+a)}},fetchKpiValue:function(){if(!this.CONFIGURATION.isAggregateValueEnabled()){return}var t=this;var u=sap.suite.smartbusiness.odata.getUri({serviceUri:this.urlParsingService.addSystemToServiceUrl(this.EVALUATION.getODataUrl(),this.SAP_SYSTEM),entitySet:this.EVALUATION.getEntitySet(),measure:this._getEvaluationThresholdMeasures(),filter:this.getAllFilters()});var s=new Date().getTime();var e=this._getEvaluationId();this.FETCH_AGREGATION_VALUE_ODATA_CALL_REF_SUCCESS=function(d){var a=new Date().getTime();t._requestTimeLog["KPI_VALUE"]={title:"Kpi Value",time:a-s};if(d&&d.results.length){t.EvaluationHeaderModel.setData({data:d.results[0]});sap.suite.smartbusiness.cache.setKpiDetailsById(e,d);if(sap.suite.smartbusiness.cache.current_calls[e]){var x=sap.suite.smartbusiness.cache.current_calls[e];delete sap.suite.smartbusiness.cache.current_calls[e];x.resolve()}}else{jQuery.sap.log.error("Couldn't fetch Aggregate Value. Response was "+d+" for uri : "+u.uri);t.EvaluationHeaderModel.setData({data:{}})}};this.FETCH_AGREGATION_VALUE_ODATA_CALL_REF_FAIL=function(a){jQuery.sap.log.error(a);t.EvaluationHeaderModel.setData({data:{}});if(sap.suite.smartbusiness.cache.current_calls[e]){sap.suite.smartbusiness.cache.current_calls[e].reject()}};var f=sap.suite.smartbusiness.cache.getKpiDetailsById(e);if(f){this.FETCH_AGREGATION_VALUE_ODATA_CALL_REF_SUCCESS(f)}else if(sap.suite.smartbusiness.cache.current_calls[e]){jQuery.when(sap.suite.smartbusiness.cache.current_calls[e]).then(function(){var d=sap.suite.smartbusiness.cache.getKpiDetailsById(e);t.FETCH_AGREGATION_VALUE_ODATA_CALL_REF_SUCCESS(d)},function(a){t.logError(a)})}else{sap.suite.smartbusiness.cache.current_calls[e]=jQuery.Deferred();this.FETCH_AGREGATION_VALUE_ODATA_CALL_REF=u.model.read(u.uri,null,null,true,this.FETCH_AGREGATION_VALUE_ODATA_CALL_REF_SUCCESS,this.FETCH_AGREGATION_VALUE_ODATA_CALL_REF_FAIL)}},_addPopoverContent:function(c,i){var l=new sap.m.List({visible:{path:"/VIEW_NAVIGATION",formatter:function(A){if(A&&A.length>0){return true}return false}}});l.bindItems("/VIEW_NAVIGATION",new sap.m.StandardListItem({title:"{TITLE}",type:sap.m.ListType.Navigation,customData:new sap.ui.core.CustomData({key:"{ID}",value:"{ID}"}),press:jQuery.proxy(this._onViewSelection,this,{publishContext:true,isTable:!!i})}).setTooltip("{TITLE}"));var a=this._getListOfViewsForPopover(this.CONFIGURATION.getAllViews(),this.SELECTED_VIEW.getId());l.setModel(this.POPOVER_VIEW_NAVIGATION_MODEL);var b=new sap.m.List({});this._popoverNavigationListReferences.push(b);b.bindItems("/APP_NAVIGATION",new sap.m.StandardListItem({title:"{text}",type:sap.m.ListType.Navigation,customData:new sap.ui.core.CustomData({key:"{id}",value:"{applicationAlias}"}),press:jQuery.proxy(this._onAppSelection,this,{publishContext:true,isTable:!!i})}).setTooltip("{text}"));b.setModel(this.POPOVER_EXTERNAL_APP_NAVIGATION_MODEL);var p=new sap.m.VBox({items:[l,b],width:"99%"});c.setPopoverFooter(p)},_addUIComponents:function(v){this.table=null;this.chart=null;var c=this.getUIComponents().getChartToolbar();c.removeAllCharts();var a=v.getChartConfiguration()[0];if(a){var t=this;this._popoverNavigationListReferences=[];this.table=new sap.suite.ui.smartbusiness.drilldown.lib.CustomTable({mode:sap.m.ListMode.SingleSelectMaster}).addStyleClass("smartBusinessDrilldownTable");this.table.attachSelectionChange(function(){t._onTableRowSelected()});this.table.addEventDelegate({onAfterRendering:function(){t.switchedToTableView()}});this.table.setModel(this.getView().getModel("i18n"),"i18n");this._addPopoverContent(this.table,true);if(a.getChartType().isTable()){c.addChart(this.table)}else{this.chart=new sap.ca.ui.charts.Chart({showPopover:true,chartType:"Bar"});this.chart.setAdvancedChartSettings({plotArea:{animation:{dataLoading:false,dataUpdating:false,resizing:false}},legend:{title:{visible:false}},yAxis:{title:{visible:true}},xAxis:{title:{visible:true}}});this.chart.addEventDelegate({onAfterRendering:function(){t.switchedToChartView()}});c.addChart(this.chart);c.addChart(this.table);this._addPopoverContent(this.chart,false)}}else{jQuery.sap.log.error("NO Chart Configuration found!! ")}},_setNoDataText:function(p){this.table.setNoDataText(this.getView().getModel("i18n").getProperty(p));if(this.chart){this.chart.setNoData(new sap.m.Label({text:this.getView().getModel("i18n").getProperty(p)}))}},fetchDataForChart:function(){var c=this.getUIComponents().getChartToolbar();var V=this.SELECTED_VIEW;var t=this;try{this.chartModel.setData({data:[]});c.setBusy(true);var d=[].concat(this.SELECTED_VIEW.getDimensions());d.forEach(function(f){var o=V.findDimensionByName(f);var g=o.getSortBy();if((d.indexOf(g)==-1)){if(o.getSortOrder()=="asc"||o.getSortOrder()=="desc"){d.push(g)}}});var m=this.SELECTED_VIEW.getMeasures();var s=null;if(this.TABLE_SORTING&&this.TABLE_SORTING.length){s=this.TABLE_SORTING}else if(this.COLUMNS_SORT&&this.COLUMNS_SORT.length){s=this.COLUMNS_SORT}var a=null;try{var D=window.parseInt(this.SELECTED_VIEW.getChartConfiguration()[0].getDataLimit());if(isNaN(D)){jQuery.sap.log.error("Invalid Data Limit Value : "+a)}else{if(D!=-1){a=D}}}catch(e){jQuery.sap.log.error("Error parsing Data Limit Value")}var u=sap.suite.smartbusiness.odata.getUri({serviceUri:this.urlParsingService.addSystemToServiceUrl(this.EVALUATION.getODataUrl(),this.SAP_SYSTEM),entitySet:this.EVALUATION.getEntitySet(),dimension:d,measure:m,filter:this.getAllFilters(),sort:s,dataLimit:a});this._setNoDataText("DATA_LOADING");var b=new Date().getTime();this.CHART_TABLE_DATA_ODATA_CALL_REF=u.model.read(u.uri,null,null,true,function(f){var g=new Date().getTime();t._requestTimeLog["CHART_TABLE_DATA"]={title:"Chart/Table Data",time:g-b};if(f.results.length===0){t._setNoDataText("DATA_NODATA")}t.chartModel.setData({data:f.results});c.setBusy(false);if(t.getUIComponents().getChart()){var p=t.getChartPopoverFormatter();t.getUIComponents().getChart().setPopoverFormatter(p)}if(f.results.length){t._appendUOMToTableHeader(f.results[0]);t._appendUOMToChartAxis(f.results[0])}},function(){jQuery.sap.log.error("Error fetching data : "+u.uri);t._setNoDataText("DATA_LOADING_FAILED");t.chartModel.setData({data:[]});c.setBusy(false);t.chartModel.setData({data:[]})})}catch(e){t._setNoDataText("DATA_LOADING_FAILED");jQuery.sap.log.error(e);c.setBusy(false);this.chartModel.setData({data:[]})}},_getTableContextParameters:function(d){var e={};var t=this.getUIComponents().getTable().getSelectedContext();if(t&&t.length){t.forEach(function(a){d.forEach(function(b){var c=a[b];if(c){if(c.getTime){c=c.getTime()}if(e[b]){e[b].push(c)}else{e[b]=[];e[b].push(c)}}})})}return e},_getChartContextParameters:function(d){var e,c;c=this.getChartSelectionContextObject();e={};if(c){var a=this.getUIComponents().getChart().getDataset();for(var b in c){var f=c[b];var g=a.findContext(f).getObject();d.forEach(function(h){var i=g[h];if(i){if(i.getTime){i=i.getTime()}if(e[h]){e[h].push(i)}else{e[h]=[];e[h].push(i)}}})}}return e},_onViewSelection:function(c,e){var v=e.getSource().getCustomData()[0].getKey();var p=sap.suite.smartbusiness.url.hash.getApplicationParameters();p["viewId"]=v;sap.suite.smartbusiness.url.hash.setApplicationParameters(p,false);var a={};var d=this.SELECTED_VIEW.getDimensions();if(c.isTable){a=this._getTableContextParameters(d);sap.suite.smartbusiness.url.hash.updateApplicationParameters(a,false);this.getUIComponents().getTable().setSelectedContext(null)}else{a=this._getChartContextParameters(d);sap.suite.smartbusiness.url.hash.updateApplicationParameters(a,false);this.setChartSelectionContextObject(null)}sap.suite.smartbusiness.url.hash.updateHash();this._hideOrShowFacetFilterIfRequired()},getChartSelectionContextObject:function(){return this._chartPopoverContext},setChartSelectionContextObject:function(v){this._chartPopoverContext=v},_detachHashChangeListener:function(){try{this.hashChanger.detachEvent("hashChanged",this._proxyHashChangeListener);this._proxyHashChangeListener=null}catch(e){jQuery.sap.log.error("Error Detaching hashChanged Event")}},_onAppSelection:function(c,e){var a,n=e.getSource().getCustomData()[0].getKey();var s=n.split("~")[0];var b=s.split("-");var d=b[0];var f=b[1];var g=sap.suite.smartbusiness.url.hash.getApplicationParameters(["viewId"]);if(d=="AdhocAnalysis"){g=sap.suite.smartbusiness.url.hash.getApplicationParameters()}sap.suite.smartbusiness.url.hash.setSemanticObject(d,false);sap.suite.smartbusiness.url.hash.setAction(f,false);sap.suite.smartbusiness.url.hash.setApplicationParameters(null,false);sap.suite.smartbusiness.url.hash.updateStartupParameters(g,false);var h=this.SELECTED_VIEW.getDimensions();if(c.isFromOpenIn){a=this._getTableContextParameters(h);sap.suite.smartbusiness.url.hash.updateStartupParameters(a,false);a=this._getChartContextParameters(h);sap.suite.smartbusiness.url.hash.updateStartupParameters(a,false)}else{if(c.isTable){a=this._getTableContextParameters(h);sap.suite.smartbusiness.url.hash.updateStartupParameters(a,false)}else{a=this._getChartContextParameters(h);sap.suite.smartbusiness.url.hash.updateStartupParameters(a,false)}}this._detachHashChangeListener();sap.suite.smartbusiness.url.hash.updateHash()},_fillChartTablePopoverContent:function(){var v=this._getListOfViewsForPopover(this.CONFIGURATION.getAllViews(),this.SELECTED_VIEW.getId());this.POPOVER_VIEW_NAVIGATION_MODEL.setData({VIEW_NAVIGATION:v});this.POPOVER_EXTERNAL_APP_NAVIGATION_MODEL.setData({APP_NAVIGATION:[]});if(this._popoverNavigationListReferences&&this._popoverNavigationListReferences.length){this._popoverNavigationListReferences.forEach(function(n){n.setNoDataText(" ");n.setBusy(true)},this)}this.SEMANTIC_OBJECT_BY_CONTEXT_LINKS_ODATA_CALL_REF=sap.suite.smartbusiness.navigation.getLinksByContext({semanticObject:this.SEMANTIC_OBJECT,dimensions:this.SELECTED_VIEW.getDimensions(),context:this,viewId:this.EVALUATION.getId()+"_"+this.SELECTED_VIEW.getId(),success:function(l){var O=jQuery.extend({},this._OPEN_IN_LINKS);var u=this._getUniqueNavLinks(l,O);if(u.length){this.POPOVER_EXTERNAL_APP_NAVIGATION_MODEL.setData({APP_NAVIGATION:u})}if(this._popoverNavigationListReferences&&this._popoverNavigationListReferences.length){this._popoverNavigationListReferences.forEach(function(n){n.setBusy(false);n.setNoDataText("-")},this)}}})},_getListOfViewsForPopover:function(a,e){var b=[];a.forEach(function(v){if(v.ID!==e){b.push(jQuery.extend(false,{},v))}});return b},_onTableRowSelected:function(){this._fillChartTablePopoverContent()},_onChartDataPointSelection:function(e){var s=e.getParameter("srcEvent");var c=s.getParameter("data")[0].data[0].ctx.path;this._chartPopoverContext=this._chartPopoverContext||{};var g=function(b){var d=Object.keys(b).sort();var f="";d.forEach(function(k){f+=k+"#"+b[k]+"#"});return f};var _=g(c);if(this._chartPopoverContext[_]){delete this._chartPopoverContext[_]}else{this._chartPopoverContext[_]=c}if(this._chartPopoverContext){var a=Object.keys(this._chartPopoverContext).length;if(a!==this.chart.getInternalVizChart().getVIZInstance().selection().length){this._chartPopoverContext={};this._chartPopoverContext[_]=c}}if(this.chart.getInternalVizChart().getVIZInstance().selection().length==0){this._chartPopoverContext={}}this._fillChartTablePopoverContent()},_getStacking:function(c){var s={stacking:false,dimensionStacked:false,measureStacked:false,stackedDimensionName:null};var a=this.SELECTED_VIEW;c.forEach(function(e){var C=a.findColumnByName(e);if(C.isMeasure()){if(C.isStacked()){s.stacking=true;s.measureStacked=true;return false}}});if(!s.stacking){c.forEach(function(e){var C=a.findColumnByName(e);if(C.isDimension()){if(C.isStacked()){s.stacking=true;s.dimensionStacked=true;if(C.getAxis()==2){s.stackedDimensionName=C.getName();return false}}}})}return s},_getEvaluationThresholdMeasures:function(){var t=[];t.push(this.EVALUATION.getKpiMeasureName());if(this.EVALUATION.getThresholdValueType()==="MEASURE"){var a=this.EVALUATION.getValues().results;if(a&&a.length){for(var i=0;i<a.length;i++){if((a[i]).COLUMN_NAME&&!((a[i]).FIXED)){t.push((a[i]).COLUMN_NAME)}}}}return t},_addDimensionAndMeasureToDataset:function(c,d,C,a){this.thresholdMeasuresArray=this._getEvaluationThresholdMeasures();var s=this._getStacking(a);var V=this.SELECTED_VIEW;var o=C.getChartType();if((o.isBar()||o.isColumn())&&s.dimensionStacked){a.forEach(function(b){var e=V.findColumnByName(b);if(e.isDimension()){var A=1;if(e.getName()==s.stackedDimensionName&&V.getDimensionCount()>1){A=2;c.setStackedChartWidthEnhancer(true)}var D=new sap.viz.ui5.data.DimensionDefinition({name:this.COLUMN_LABEL_MAPPING[e.getName()],axis:A,value:{path:this.DIMENSION_TEXT_PROPERTY_MAPPING[e.getName()],formatter:this.getColumnValueFormatter(this.DIMENSION_TEXT_PROPERTY_MAPPING[e.getName()],true)}});D.column_name=e.getName();d.addDimension(D)}},this)}else{a.forEach(function(b){var e=V.findColumnByName(b);if(e.isDimension()){var D=new sap.viz.ui5.data.DimensionDefinition({name:this.COLUMN_LABEL_MAPPING[e.getName()],axis:1,value:{path:this.DIMENSION_TEXT_PROPERTY_MAPPING[e.getName()],formatter:this.getColumnValueFormatter(this.DIMENSION_TEXT_PROPERTY_MAPPING[e.getName()],true)}});D.column_name=e.getName();d.addDimension(D)}},this)}if(o.isLine()||o.isCombination()){a.forEach(function(b){var e=V.findColumnByName(b);if(e.isMeasure()){var m=new sap.viz.ui5.data.MeasureDefinition({name:this.COLUMN_LABEL_MAPPING[e.getName()],value:{path:e.getName()}});m.column_name=e.getName();d.addMeasure(m)}},this)}else if(o.isBubble()){var _=0;a.forEach(function(b,i){var e=V.findColumnByName(b);if(e.isMeasure()){++_;var m=new sap.viz.ui5.data.MeasureDefinition({name:this.COLUMN_LABEL_MAPPING[e.getName()],group:_,value:{path:e.getName()}});m.column_name=e.getName();d.addMeasure(m)}},this)}else if(o.isBar()||o.isColumn()){if(C.isSingleAxis()){a.forEach(function(b){var e=V.findColumnByName(b);if(e.isMeasure()){var m=new sap.viz.ui5.data.MeasureDefinition({name:this.COLUMN_LABEL_MAPPING[e.getName()],value:{path:e.getName()}});m.column_name=e.getName();d.addMeasure(m)}},this)}else if(C.isDualAxis()){a.forEach(function(b){var e=V.findColumnByName(b);if(e.isMeasure()){var m=new sap.viz.ui5.data.MeasureDefinition({group:e.getAxis(),name:this.COLUMN_LABEL_MAPPING[e.getName()],value:{path:e.getName()}});m.column_name=e.getName();d.addMeasure(m)}},this)}}},_appendUOMToChartAxis:function(d){var c,m,a,U,u,b,e,f,g;var h=function(o){var k=[];for(var l in o){k.push(o[l])}return k.join(" & ")};var i=function(A){return{title:{visible:true,text:A}}};c=this.getUIComponents().getChart();if(!c){return}m=this.SELECTED_VIEW.getMeasures();a=c.getAdvancedChartSettings()||{};U={};u=false;if(m.length==1&&m[0]==this.EVALUATION.getKpiMeasureName()){var M=m[0];b=this.MEASURE_UNIT_PROPERTY_MAPPING[M];if(b){e=d[b];if(e){U[M]=e;u=true}else{U[M]=this.COLUMN_LABEL_MAPPING[M]}}else{U[M]=this.COLUMN_LABEL_MAPPING[M]}}else{m.forEach(function(M){b=this.MEASURE_UNIT_PROPERTY_MAPPING[M];if(b){e=d[b];if(e){U[M]=this.COLUMN_LABEL_MAPPING[M]+" ("+e+")";u=true}else{U[M]=this.COLUMN_LABEL_MAPPING[M]}}else{U[M]=this.COLUMN_LABEL_MAPPING[M]}},this)}f=this.SELECTED_VIEW.getChartConfiguration()[0];g=f.getChartType();if(u){if(g.isColumn()||g.isBar()){if(f.isSingleAxis()){if(g.isBar()){a.xAxis=i(h(U))}else{a.yAxis=i(h(U))}}else{var x={},j={};m.forEach(function(M){var o=this.SELECTED_VIEW.findMeasureByName(M);if(o.getAxis()==1){x[M]=U[M]}else if(o.getAxis()==2){j[M]=U[M]}},this);if(g.isBar()){a.xAxis=i(h(j));a.xAxis2=i(h(x))}else{a.yAxis=i(h(x));a.yAxis2=i(h(j))}}}else if(g.isBubble()){var D=c.getDataset().getMeasures();D.forEach(function(o){var s=o.column_name;var l=U[s];if(o.getGroup()==1){a.xAxis=i(l)}else if(o.getGroup()==2){a.yAxis=i(l)}},this)}else if(g.isTable()){}else{a.yAxis=i(h(U))}}},_updateAxisLabelIfRequired:function(c,d,C,a){var o=C.getChartType();var V=this.SELECTED_VIEW;var b=c.getAdvancedChartSettings()||{};var I="("+this.getView().getModel("i18n").getProperty("IN_PERCENTAGE")+")";var g=function(l){return{title:{visible:true,text:l}}};if(C.isPercentageValue()){if(o.isBar()||o.isColumn()){var m=V.getMeasures();if(C.isSingleAxis()){var M=[];m.forEach(function(i){M.push(this.COLUMN_LABEL_MAPPING[i])},this);var s=M.join(" & ")+I;if(o.isColumn()){b.yAxis=g(s)}else{b.xAxis=g(s)}}else{var f=[];var S=[];m.forEach(function(i){var j=V.findMeasureByName(i);if(j.getAxis()==1){f.push(this.COLUMN_LABEL_MAPPING[i])}else if(j.getAxis()==2){S.push(this.COLUMN_LABEL_MAPPING[i])}},this);var e=f.join(" & ")+I;var h=S.join(" & ")+I;if(o.isColumn()){b.yAxis=g(e);b.yAxis2=g(h)}else{b.xAxis2=g(e);b.xAxis=g(h)}}}}},renderChart:function(v,c,a){var b=this.getUIComponents().getChart();b.attachSelectDataPoint(jQuery.proxy(this._onChartDataPointSelection,this));if(!c||!a.length)return;var d=new sap.viz.core.FlattenedDataset({data:{path:"/data"}});b.setStackedChartWidthEnhancer(false);this._addDimensionAndMeasureToDataset(b,d,c,a);b.setChartType(this.getCAChartType(c,v));b.setDataset(d);this.setChartLabelFormatters(b,c,this.SELECTED_VIEW);this._overrideChartAxisLabelFormatters(b,c);if((this.EVALUATION.getScaling()==-2)&&(c.isDualAxis())&&(c.isAbsoluteValue())&&(c.getChartType().isBar()||c.getChartType().isColumn())){this._handleDualAxisWhenPercentScale(b,c.getChartType())}this.applyColorToChart(b,c);this._showChartLegendIfApplicable(c,a)},_showChartLegendIfApplicable:function(c,C){var o=this.getUIComponents().getChartToolbar();var s=this._getStacking(C);var V=this.SELECTED_VIEW;var a=c.getChartType();var i=((a.isBar()||a.isColumn())&&s.dimensionStacked&&s.stackedDimensionName&&(V.getDimensionCount()>1))?true:false;if((V.getMeasures().length>1)||(i)){o.setShowLegend(true)}else{o.setShowLegend(false)}},_overrideChartAxisLabelFormatters:function(c,C){var l=new sap.ui.core.Locale(sap.ui.getCore().getConfiguration().getLanguage());var p=sap.ca.ui.model.format.NumberFormat.getInstance({},l);if(C.isPercentageValue()){var o=C.getChartType();if(o.isBar()){c.setXAxisLabelFormatter(function(r){return p.format_percentage(r)});c.setYAxisLabelFormatter(function(r){return r});if(C.isDualAxis()){c.setXAxis2LabelFormatter(function(r){return p.format_percentage(r)})}}else if(o.isColumn()){c.setYAxisLabelFormatter(function(r){return p.format_percentage(r)});c.setXAxisLabelFormatter(function(r){return r});if(C.isDualAxis()){c.setYAxis2LabelFormatter(function(r){return p.format_percentage(r)})}}}},_handleDualAxisWhenPercentScale:function(c,a){var t=this;var V=this.SELECTED_VIEW;var m=V.getMeasures();var b=this._getMeasuresByAxis();var i=this._isMeasureSetPercentScaled(b.axis1Msr);var d=this._isMeasureSetPercentScaled(b.axis2Msr);var l=[[],[]];if(i)l[0].push(t._getChartPercentFormatter());else l[0].push(t._getChartNumberFormatter());if(d)l[1].push(t._getChartPercentFormatter());else l[1].push(t._getChartNumberFormatter());c.setDataLabelFormatter(l);if(a.isBar()){c.setXAxisLabelFormatter(i?t._getChartPercentFormatter():t._getChartNumberFormatter());c.setYAxisLabelFormatter(t._pseudoChartFormatter);c.setXAxis2LabelFormatter(d?t._getChartPercentFormatter():t._getChartNumberFormatter());c.setYAxis2LabelFormatter(t._pseudoChartFormatter)}else if(a.isColumn()){c.setXAxisLabelFormatter(t._pseudoChartFormatter);c.setYAxisLabelFormatter(i?t._getChartPercentFormatter():t._getChartNumberFormatter());c.setXAxis2LabelFormatter(t._pseudoChartFormatter);c.setYAxis2LabelFormatter(d?t._getChartPercentFormatter():t._getChartNumberFormatter())}},_isEvaluationThresholdMeasure:function(m){if(this.thresholdMeasuresArray&&this.thresholdMeasuresArray.length){var t=this.thresholdMeasuresArray}else{var t=this._getEvaluationThresholdMeasures()}if(t&&t.length){if(t.indexOf(m)!=-1){return true}}return false},_getMeasuresByAxis:function(){var t=this;var V=this.SELECTED_VIEW;var m=V.getMeasures();var a=[],b=[];for(var i=0;i<m.length;i++){var c=V.findColumnByName(m[i]);if(c.isMeasure()&&(c.getAxis()==1)){a.push(m[i])}else if(c.isMeasure()&&(c.getAxis()==2)){b.push(m[i])}}return{axis1Msr:a,axis2Msr:b}},_isMeasureSetPercentScaled:function(m){if(this.thresholdMeasuresArray&&this.thresholdMeasuresArray.length){var t=this.thresholdMeasuresArray}else{var t=this._getEvaluationThresholdMeasures()}if(t&&t.length&&m&&m.length){for(var i=0;i<m.length;i++){if(t.indexOf(m[i])!=-1){return true}}}return false},setChartLabelFormatters:function(c,o,v){var i=this._isMeasureSetPercentScaled(this.SELECTED_VIEW.getMeasures());if((this.EVALUATION.getScaling()==-2)&&!((o.isPercentageValue())&&(o.getChartType().isBar()||o.getChartType().isColumn()))&&i){var f=this.getChartLabelFormatter(o,v,true);c.setXAxisLabelFormatter(f.x1);c.setYAxisLabelFormatter(f.y1);c.setXAxis2LabelFormatter(f.x2);c.setYAxis2LabelFormatter(f.y2);c.setDataLabelFormatter(f.dataLabel)}else{var f=this.getChartLabelFormatter(o,v);c.setXAxisLabelFormatter(f.x1);c.setYAxisLabelFormatter(f.y1);c.setXAxis2LabelFormatter(f.x2);c.setYAxis2LabelFormatter(f.y2);c.setDataLabelFormatter(f.dataLabel)}},_pseudoChartFormatter:function(s){return s},_getChartNumberFormatter:function(i){var l=new sap.ui.core.Locale(sap.ui.getCore().getConfiguration().getLanguage());function a(n){return!isNaN(parseFloat(n))&&isFinite(n)}var f={style:i?'standard':'short'};var c=sap.ca.ui.model.format.NumberFormat.getInstance(f,l);return function(s){return a(s)?c.format(s):s}},_getChartPercentFormatter:function(i){var l=new sap.ui.core.Locale(sap.ui.getCore().getConfiguration().getLanguage());function a(n){return!isNaN(parseFloat(n))&&isFinite(n)}var f={style:i?'standard':'short'};var c=sap.ca.ui.model.format.NumberFormat.getInstance(f,l);return function(s){return a(s)?c.format_percentage(s):s}},getChartLabelFormatter:function(c,v,i){jQuery.sap.require("sap.ca.ui.model.format.NumberFormat");if(i){var f={x1:this._pseudoChartFormatter,y1:this._getChartPercentFormatter(),x2:this._pseudoChartFormatter,y2:this._pseudoChartFormatter,dataLabel:[[this._getChartPercentFormatter()],[this._getChartPercentFormatter()],[this._getChartPercentFormatter()]]}}else{var f={x1:this._pseudoChartFormatter,y1:this._getChartNumberFormatter(),x2:this._pseudoChartFormatter,y2:this._pseudoChartFormatter,dataLabel:[[this._getChartNumberFormatter()]]}}if(c.getChartType().isBubble()||(c.getChartType().isBar()&&c.isAbsoluteValue())){if(i)f.x1=this._getChartPercentFormatter();else f.x1=this._getChartNumberFormatter()}if(c.getChartType().isBar()||(c.getChartType().isColumn()&&c.isStackingEnabled(v)&&c.isPercentageValue())){f.y1=this._pseudoChartFormatter}if(c.getChartType().isBar()&&c.isDualAxis()&&c.isStackingEnabled(v)){if(i)f.x2=this._getChartPercentFormatter();else f.x2=this._getChartNumberFormatter()}if(c.getChartType().isColumn()&&c.isStackingEnabled(v)&&c.isDualAxis()){if(i)f.y2=this._getChartPercentFormatter();else f.y2=this._getChartNumberFormatter()}return f},getColumnValueFormatter:function(n,i,a,b){var t=this;var V=this.SELECTED_VIEW;var c=(V.getChartConfiguration())[0];var f;if(i){f=function(s){return s==0?s+"":s}}else{if(a){if(c.getChartType().isTable()){if(t._isEvaluationThresholdMeasure(n))f=this._getChartPercentFormatter(true);else f=this._getChartNumberFormatter(true)}else if((c.isDualAxis())&&(c.isAbsoluteValue())&&(c.getChartType().isBar()||c.getChartType().isColumn())){var C=V.findColumnByName(n);if(b[(C.getAxis())-1])f=this._getChartPercentFormatter(true);else f=this._getChartNumberFormatter(true)}else{f=this._getChartPercentFormatter(true)}}else f=this._getChartNumberFormatter(true)}var u=this.urlParsingService.addSystemToServiceUrl(this.EVALUATION.getODataUrl(),this.SAP_SYSTEM);var m=sap.suite.smartbusiness.odata.getEdmType(u,n,true);var T=m.type;var F=m.format;F=F.toUpperCase();if(T=='Edm.DateTime'){if(!sap.suite.smartbusiness.odata.isTimeZoneIndependent(u,this.EVALUATION.getEntitySet())){var d;if(F=="DATE"){d="daysAgo"}else if(F=="DATETIME"){d="short"}else if(F=="NONE"){d="daysAgo"}if(d){var o=new sap.ca.ui.model.type.Date({style:d});f=function(s){return o.formatValue(s,"string")}}}else{f=function(e){if(e&&e.getMinutes){e.setMinutes(e.getMinutes()+e.getTimezoneOffset());var g=(F=="DATE")?"getDateInstance":"getDateTimeInstance";return sap.ui.core.format.DateFormat[g]().format(e)}return e}}}return f},getChartPopoverFormatter:function(){var c=this.SELECTED_VIEW.getChartConfiguration()[0];var f=[[],[],[]];var t=this;var V=this.SELECTED_VIEW;var m=this.SELECTED_VIEW.getMeasures();var u=this.MEASURE_UNIT_PROPERTY_MAPPING;var C=c.getChartType();var l=new sap.ui.core.Locale(sap.ui.getCore().getConfiguration().getLanguage());var a=sap.ca.ui.model.format.NumberFormat.getInstance({style:'Standard'},l);var i=this._isMeasureSetPercentScaled(m);function _(M){return function(v){var h="";var j=t.getUIComponents().getChart().getModel().getData().data;if(j&&j.length){h=(j&&j[0])?j[0][u[M]]?" "+j[0][u[M]]:"":"";j[0][u[M]]}return a.format_standard(v)+h}}function b(M){return function(v){return a.format_percentage(v)}}if(c.isPercentageValue()){for(var k=0;k<m.length;k++){f[0].push(function(v){return a.format_percentage(v)});f[1].push(function(v){return a.format_percentage(v)})}}else{if(this.EVALUATION.getScaling()==-2&&i){if((c.isDualAxis())&&(c.isAbsoluteValue())&&(c.getChartType().isBar()||c.getChartType().isColumn())){var d=this._getMeasuresByAxis();var e=this._isMeasureSetPercentScaled(d.axis1Msr);var g=this._isMeasureSetPercentScaled(d.axis2Msr);if(e){for(var k=0;k<d.axis1Msr.length;k++){f[0].push(b((d.axis1Msr)[k]))}}else{for(var k=0;k<d.axis1Msr.length;k++){f[0].push(_((d.axis1Msr)[k]))}}if(g){for(var k=0;k<d.axis2Msr.length;k++){f[1].push(b((d.axis2Msr)[k]))}}else{for(var k=0;k<d.axis2Msr.length;k++){f[1].push(_((d.axis2Msr)[k]))}}}else{for(var k=0;k<m.length;k++){f[0].push(b(m[k]));f[1].push(b(m[k]));f[2].push(b(m[k]))}}}else{for(var k=0;k<m.length;k++){f[0].push(_(m[k]));f[1].push(_(m[k]))}}}return f},applyColorToChart:function(c,a){var t=a.getThresholdMeasure();var C=this;var b=a.getColorScheme();if(!b.getText()){JQuery.sap.log.error("Color Scheme Value Missing");return}var m=c.getDataset().getMeasures();if(b.isManual()){m.forEach(function(M,i,o){var _=this.SELECTED_VIEW.findMeasureByName(M.column_name).getColor();if(!_){if(b.isManualSemantic()){jQuery.sap.log.warning("Semantic Color NOT found for measure name : "+M.getName()+", assigning default to 'Neutral Light'");_="sapCaUiChartSemanticColor-Neutral-Light"}else{jQuery.sap.log.warning("Color NOT found for measure name : "+M.getName()+", assigning default color");_=""}}M.addCustomData(new sap.ui.core.CustomData({key:"fillColor",value:_}))},this)}else if(b.isAutoSemantic()&&!this.EVALUATION.isTargetKpi()){if(t){m.forEach(function(M,i,o){if(M.getName()==t){M.addCustomData(new sap.ui.core.CustomData({key:"fillColor",value:sap.ca.ui.charts.ChartSemanticColor.Neutral}))}else{M.addCustomData(new sap.ui.core.CustomData({key:"fillColor",value:sap.ca.ui.charts.ChartSemanticColor.Good}))}},this);c.setChartSemanticColorFormatter(function(o){var d=c.getModel().getData().data;var e=o.ctx.path.dii_a1;var f=d[e];var r=f[t];if(r!=null&&typeof r!='undefined'){if(C.EVALUATION.isTargetKpi()){if(o.val==r){return sap.ca.ui.charts.ChartSemanticColor.Neutral}return sap.ca.ui.charts.ChartSemanticColor.NeutralLight}else{if(o.val>r){if(C.EVALUATION.isMaximizingKpi()){return sap.ca.ui.charts.ChartSemanticColor.Good}return sap.ca.ui.charts.ChartSemanticColor.Bad}else if(o.val<r){if(C.EVALUATION.isMinimizingKpi()){return sap.ca.ui.charts.ChartSemanticColor.Good}return sap.ca.ui.charts.ChartSemanticColor.Bad}else{return sap.ca.ui.charts.ChartSemanticColor.Neutral}}}else{jQuery.sap.log.error("Threshold Measure:'"+t+"'  not in Dataset. Error Applying Semantic Color");return sap.ca.ui.charts.ChartSemanticColor.NeutralLight}})}else{jQuery.sap.log.error("Chart Color Scheme is Auto-Semantic but no threshold measure Configured!!!")}}else{jQuery.sap.log.debug("Color Scheme is None: Default Color will be used by CA Chart")}if(b.isAutoSemantic()){if(this.EVALUATION.isTargetKpi()){jQuery.sap.log.error("Auto Semantic Coloring can not be applied on target type KPI")}}},getCAChartType:function(c,v){if(c.getChartType().isBar()){if(c.isSingleAxis()){if(c.isAbsoluteValue()){if(c.isStackingEnabled(v)){return sap.ca.ui.charts.ChartType.StackedBar}else{return sap.ca.ui.charts.ChartType.Bar}}else{return sap.ca.ui.charts.ChartType.StackedBar100}}else if(c.isDualAxis()){if(c.isAbsoluteValue()){return sap.ca.ui.charts.ChartType.DualStackedBar}else{return sap.ca.ui.charts.ChartType.DualStackedBar100}}}else if(c.getChartType().isColumn()){if(c.isSingleAxis()){if(c.isAbsoluteValue()){if(c.isStackingEnabled(v)){return sap.ca.ui.charts.ChartType.StackedColumn}else{return sap.ca.ui.charts.ChartType.Column}}else{return sap.ca.ui.charts.ChartType.StackedColumn100}}else if(c.isDualAxis()){if(c.isAbsoluteValue()){return sap.ca.ui.charts.ChartType.DualStackedColumn}else{return sap.ca.ui.charts.ChartType.DualStackedColumn100}}}else{return c.getChartType().getText()}},_getVisibleColumns:function(d){var v=[];d.forEach(function(c,i,a){var C=this.SELECTED_VIEW.findColumnByName(c);if(C.isVisibleInTable()){v.push(c)}},this);return v},_getValueState:function(a,t){if(!this.EVALUATION.isTargetKpi()){if(a<t){return this.EVALUATION.isMaximizingKpi()?sap.ui.core.ValueState.Error:sap.ui.core.ValueState.Success}else if(a==t){return sap.ui.core.ValueState.None}else{return this.EVALUATION.isMaximizingKpi()?sap.ui.core.ValueState.Success:sap.ui.core.ValueState.Error}}else{return sap.ui.core.ValueState.None}},_getTableCell:function(o,c,i,a){var t=this.SELECTED_VIEW.getChartConfiguration()[0]&&this.SELECTED_VIEW.getChartConfiguration()[0].getThresholdMeasure();var b=this;if(this.EVALUATION.isTargetKpi()){return new sap.m.Label({text:{path:o,formatter:this.getColumnValueFormatter(o,false,i,a)}})}else{if(c.isAutoSemantic()&&t){return new sap.m.ObjectNumber({number:{path:o,formatter:this.getColumnValueFormatter(o,false,i,a)},state:{parts:[{path:o},{path:t}],formatter:function(m,d){try{m=window.parseFloat(m);d=window.parseFloat(d);return b._getValueState(m,d)}catch(e){return sap.ui.core.ValueState.None}}}})}else{return new sap.m.Label({text:{path:o,formatter:this.getColumnValueFormatter(o,false,i,a)}})}}},_sortTableByColumnName:function(c){var i={"asc":String.fromCharCode(0xe1e1),"desc":String.fromCharCode(0xe1e2)};var s=null;if(c.sort_by===void(0)){s="desc"}else{s=c.sort_by=="asc"?"desc":"asc"}c.sort_by=s;var a=this.getUIComponents().getTable().getColumns();a.forEach(function(C){var h=C.getHeader();h.setText(h.dimension_label+(h.UOM?" ("+h.UOM+")":""))});c.setText(i[s]+" "+c.dimension_label+(c.UOM?" ("+c.UOM+")":""));var C=this.SELECTED_VIEW.findColumnByName(c.dimension_key);var b=C.getSortBy();this.TABLE_SORTING=[{name:b,order:s}];this.fetchDataForChart()},_appendUOMToTableHeader:function(r){if(this.UOM_APPENDED_TO_HEADER){return}var c=this.getUIComponents().getTable().getColumns();c.forEach(function(C){var a=C.getHeader().getText();var b=C.column_name;var o=this.SELECTED_VIEW.findColumnByName(b);if(o.isMeasure()){var u=this.MEASURE_UNIT_PROPERTY_MAPPING[b];if(u!==b){var d=r[u];if(d){C.getHeader().UOM=d;C.getHeader().setText(a+" ("+d+")")}}}},this);this.UOM_APPENDED_TO_HEADER=true},renderTable:function(t,c){var a=this;var b=this.getUIComponents().getTable();var C=(this.SELECTED_VIEW.getChartConfiguration())[0];b.removeAllColumns();var S=this.SELECTED_VIEW;var v=this._getVisibleColumns(t);this.COLUMNS_SORT=[];t.forEach(function(s,k,m){var o=this.SELECTED_VIEW.findColumnByName(s);if(o.getSortBy()&&o.getSortOrder()){if(o.getSortOrder()=="asc"||o.getSortOrder()=="desc"){this.COLUMNS_SORT.push({name:o.getSortBy(),order:o.getSortOrder()})}}},this);var d=false;if((this.EVALUATION.getScaling()==-2)&&!((C.isPercentageValue())&&(C.getChartType().isBar()||C.getChartType().isColumn()))){d=this._isMeasureSetPercentScaled(this.SELECTED_VIEW.getMeasures())}var e=[];if(d){if((C.isDualAxis())&&(C.isAbsoluteValue())&&(C.getChartType().isBar()||C.getChartType().isColumn())){var f=this._getMeasuresByAxis();e.push(this._isMeasureSetPercentScaled(f.axis1Msr));e.push(this._isMeasureSetPercentScaled(f.axis2Msr))}}var g=new sap.m.ColumnListItem();for(var i=0,l=v.length;i<l;i++){var o=this.SELECTED_VIEW.findColumnByName(v[i]);var L=new sap.m.Label({text:this.COLUMN_LABEL_MAPPING[v[i]]}).addStyleClass("tableColumnHeader");L.dimension_key=v[i];L.dimension_label=this.COLUMN_LABEL_MAPPING[v[i]];L.attachBrowserEvent("click",function(){a._sortTableByColumnName(this)});var h=new sap.m.Column({hAlign:o.isMeasure()?"Right":"Left",styleClass:"qty",header:L,minScreenWidth:"Tablet",demandPopin:true,});h.column_name=v[i];if(o.isMeasure()){var j=this._getTableCell(v[i],c,d,e);g.addCell(j)}else{var j=new sap.m.Label({text:{path:this.DIMENSION_TEXT_PROPERTY_MAPPING[v[i]],formatter:this.getColumnValueFormatter(this.DIMENSION_TEXT_PROPERTY_MAPPING[v[i]],true)}});g.addCell(j)}b.addColumn(h)}b.bindAggregation("items","/data",g)},_abortPendingODataCalls:function(){var a=function(d){try{if(d){d.abort()}}catch(e){}};var b=function(o){if(o&&o.length){o.forEach(function(c){a(c)})}};a(this.DDA_CONFIG_ODATA_CALL_REF);a(this._bundled_evaluations_call_ref);a(this.EVALUATION_ODATA_CALL_REF);a(this.SEMANTIC_OBJECT_LINKS_ODATA_CALL_REF);b(this.SEMANTIC_OBJECT_BY_CONTEXT_LINKS_ODATA_CALL_REF);a(this.CHART_TABLE_DATA_ODATA_CALL_REF);a(this.FETCH_AGREGATION_VALUE_ODATA_CALL_REF)},onBack:function(e){this._abortPendingODataCalls();window.history.back()},_resetConfigurations:function(){this.TABLE_SORTING=null;this.UOM_APPENDED_TO_HEADER=null;this.setChartSelectionContextObject(null)},onViewChange:function(e){this._resetConfigurations();var s=e.getParameters()["selectedKey"];var A=sap.suite.smartbusiness.url.hash.getApplicationParameters();A["viewId"]=[s];sap.suite.smartbusiness.url.hash.setApplicationParameters(A)},_attachHashChangeEvent:function(){this.hashChanger=this.oRouter.oHashChanger;var t=this;if(this.hashChanger){try{if(!t.hashChangerAttached){this.hashChanger.attachEvent("hashChanged",this._proxyHashChangeListener);this.hashChanger.viewRef=this}t.hashChangerAttached=true}catch(e){jQuery.sap.log.error("Couldn't Attach HashChange Event")}}else{jQuery.sap.log.error("Router HashChanger Object Found NULL")}},getUrlFilters:function(){var p=sap.suite.smartbusiness.url.hash.getApplicationParameters(["viewId"]);var u=[];for(var k in p){var f=p[k];if(f&&f.length){f.forEach(function(F){var O={};O["NAME"]=k;O["OPERATOR"]="EQ";O["VALUE_1"]=F;O["VALUE_2"]="";O["TYPE"]="FI";u.push(O)})}}return u},getAllFilters:function(){var e=this.EVALUATION.getFilters()["results"]||[];return e.concat(this.getUrlFilters())},getAdditionFiltersForChipConfiguration:function(){var p=sap.suite.smartbusiness.url.hash.getApplicationParameters(["viewId"]);var u=[];if(p){for(var k in p){var f=p[k];if(f&&f.length){f.forEach(function(e){var t=[];t[0]=k;t[1]="EQ";t[2]=e;t[3]="";u.push(t)})}}}return u},_hideKpiHeaderIfRequired:function(){return;if(this.CONFIGURATION.getHeaders().length==0){return}try{var a=sap.suite.smartbusiness.url.hash.getApplicationParameters(["viewId"]);if(a){if(Object.keys(a).length){this.getUIComponents().getTileContainer().$().css("overflow","hidden");this.getUIComponents().getTileContainer().$().animate({height:"0px"});return}}this.getUIComponents().getTileContainer().$().animate({height:"156px"})}catch(e){jQuery.sap.log.error("Failed to Hide KPI Header : "+e)}},hashChangeListener:function(h){this.NEW_HASH=h?h.getParameter("newHash"):"";this.OLD_HASH=h?h.getParameter("oldHash"):"";var A=sap.suite.smartbusiness.url.hash.getApplicationParameters();var K="viewId";if(!A[K]){this.SELECTED_VIEW=this.CONFIGURATION.getDefaultView();if(this.SELECTED_VIEW){this.renderView(this.SELECTED_VIEW);A.viewId=[this.SELECTED_VIEW.getId()];sap.suite.smartbusiness.url.hash.setApplicationParameters(A,false);var a=sap.suite.smartbusiness.url.hash.getHash();window.location.replace("#"+a)}else{jQuery.sap.log.error("Evaluation does not have any views configured")}}else if(!this.SELECTED_VIEW){this.firstTimeFlag=true;this.SELECTED_VIEW=this.CONFIGURATION.findViewById(A[K][0]);if(this.SELECTED_VIEW){this._resetConfigurations();this.renderView(this.SELECTED_VIEW);this._hideKpiHeaderIfRequired();this._setViewComboBoxSelectedIndex();this.fetchKpiValue();this.fetchDataForChart();this._fixFacetListSelection()}else{jQuery.sap.log.error("The view with viewId : "+A[K][0]+" does not exist")}}else if(this.SELECTED_VIEW&&A[K][0]!=this.SELECTED_VIEW.getId()){this.SELECTED_VIEW=this.CONFIGURATION.findViewById(A[K][0]);if(this.firstTimeFlag){sap.suite.smartbusiness.cache.invalidateKpiDetailsCache()}this._setViewComboBoxSelectedIndex();this._resetConfigurations();this.renderView(this.SELECTED_VIEW);this.fetchKpiValue();this.fetchDataForChart();this._hideKpiHeaderIfRequired();this._fixFacetListSelection();this._refreshKpiHeaderTiles()}else{if(this.firstTimeFlag){sap.suite.smartbusiness.cache.invalidateKpiDetailsCache()}this._setViewComboBoxSelectedIndex();this._hideKpiHeaderIfRequired();this.fetchKpiValue();this.fetchDataForChart();this._fixFacetListSelection();this._refreshKpiHeaderTiles()}this.getUIComponents().getFilter().refreshFilter()},_refreshKpiHeaderTiles:function(){var h=this.getUIComponents().getTileContainer();sap.suite.smartbusiness.miniChartManager.hashChangeListner({allTiles:this.CONFIGURATION.getHeaders(),headerContainer:h,sapSystem:this.SAP_SYSTEM,urlFilters:this.getUrlFilters(),firstTimeFlag:this.firstTimeFlag});this.firstTimeFlag=true},_setViewComboBoxSelectedIndex:function(){try{this.getUIComponents().getChartToolbar()._oFirstDimensionSelect.setSelectedKey(this.SELECTED_VIEW.getId())}catch(e){jQuery.sap.log.error("Failed to Set Selected Index of View ComboBox")}},_fixFacetListSelection:function(){try{var f=this.getUIComponents().getFilter();var a=f.getFacetFilterReference();var u=sap.suite.smartbusiness.url.hash.getApplicationParameters(["viewId"]);var b=a.getLists();if(b.length){b.forEach(function(c){var d=c._techName;if(u[d]){var F=u[d];var i=c.getItems();if(i.length){i.forEach(function(g){var h=g.getBindingContext().getObject()[c._techName]||"";h=h.getTime?h.getTime()+"":h+"";if(F.indexOf(h)>-1){g.setSelected(true)}else{g.setSelected(false)}})}}else{var i=c.getItems();if(i.length){i.forEach(function(g){g.setSelected(false)})}}},this)}}catch(e){}},_getUniqueNavLinks:function(r,e){var u=[];var c=sap.suite.smartbusiness.url.hash.getSemanticObject()+"-"+sap.suite.smartbusiness.url.hash.getAction();r.forEach(function(s){var t=s.id.match(/-([^?~])*~([^?])*/g);t=t?t.toString():"";if(t){if(!e[t]){e[t]=t;if(s.id.indexOf(c)==-1){u.push(s)}}}});return u},_initExternalNavigationLinks:function(){this._OPEN_IN_LINKS={};var s=sap.suite.smartbusiness.url.hash.getSemanticObject();this._oExternalNavLinksSOPopover=new sap.m.ResponsivePopover({modal:false,showHeader:false,enableScrolling:true,verticalScrolling:true,horizontalScrolling:false,placement:sap.m.PlacementType.Top,contentWidth:"18rem",});var a=new Date().getTime();var b={};if(this.CHIP_ID){b["chipId"]=this.CHIP_ID}if(this._EVALUATION_ID){b["evaluationId"]=this._EVALUATION_ID}this.SEMANTIC_OBJECT_LINKS_ODATA_CALL_REF=sap.suite.smartbusiness.navigation.getLinksBySemanticObject({success:function(r){var e=new Date().getTime();this._requestTimeLog["SEMANTIC_OBJECT_LINKS"]={title:"Semantic Object Links",time:e-a};r=this._getUniqueNavLinks(r,this._OPEN_IN_LINKS);if(r.length){var m=new sap.ui.model.json.JSONModel({"EXTERNAL_APP_LINKS":r});var l=new sap.m.List({});l.bindItems("/EXTERNAL_APP_LINKS",new sap.m.StandardListItem({title:"{text}",customData:new sap.ui.core.CustomData({key:"{id}",value:"{applicationAlias}"}),type:sap.m.ListType.Navigation,press:jQuery.proxy(this._onAppSelection,this,{publishContext:true,isFromOpenIn:true})})).setModel(m);this._oExternalNavLinksSOPopover.removeAllContent();this._oExternalNavLinksSOPopover.addContent(l)}else{this.setHeaderFooterOptionsWithoutOpenInButton()}},async:false,error:function(e){jQuery.sap.log.error("Error fetching navigation links by semantic object : "+s);this.setHeaderFooterOptionsWithoutOpenInButton()},semanticObject:s,businessParam:b,context:this})},_showExternalNavigationLinks:function(s){if(!this._oExternalNavLinksSOPopover.isOpen()){this._oExternalNavLinksSOPopover.openBy(s)}},_toggleFilter:function(){var c=this;var f=this.getUIComponents().getFilter();if(!f.getSelectedItems()){f.setVisible(!f.getVisible())}else if(f.getSelectedItems()&&f.getVisible()==true){this.oI18nModel=c.getView().getModel("i18n");sap.m.MessageBox.alert(c.oI18nModel.getResourceBundle().getText("Do_you_really_want_to_reset_the_filters?"),{onClose:function(e){if(e=="OK"){f.resetFilter();f.setVisible(false)}else if(e=="CANCEL"){f.setVisible(true)}},title:c.oI18nModel.getResourceBundle().getText("Reset_Filters"),actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL]})}},setHeaderFooterOptionsWithoutOpenInButton:function(){var o=this.getHeaderFooterOptions();o.buttonList=[];this.setHeaderFooterOptions(o);this.renderTitle()},getHeaderFooterOptions:function(){var o=this._getHeaderFooterOptions();var c=this;var i=c.getView().getModel("i18n");var a=sap.ui.Device.os.name;if(a&&a!=sap.ui.Device.os.OS.IOS){o.additionalShareButtonList.push({sBtnTxt:i.getResourceBundle().getText("EXPORT_AS_EXCEL"),sIcon:"sap-icon://excel-attachment",onBtnPressed:function(e){c._exportAsExcel()}})}if((window.location.hostname=="localhost")||(jQuery.sap.getUriParameters().get("sbcmode")=="99")){o.additionalShareButtonList.push({sBtnTxt:"Enable Compact Mode",sIcon:"sap-icon://resize",onBtnPressed:function(e){if(c._compactMode){c.getView().removeStyleClass("sapUiSizeCompact");c._compactMode=false;e.getSource().setText("Enable Compact Mode")}else{c.getView().addStyleClass("sapUiSizeCompact");c._compactMode=true;e.getSource().setText("Disable Compact Mode")}jQuery(window).trigger("resize")}})}if((window.location.hostname=="localhost")||(jQuery.sap.getUriParameters().get("sbrequestlog")=="99")){o.additionalShareButtonList.push({sBtnTxt:"Request-Time Log",sIcon:"sap-icon://time-entry-request",onBtnPressed:function(e){c._performance.start(c._requestTimeLog,c._compactMode)}})}var E=["NT","AT","TT"];if(E.indexOf(this.TILE_TYPE)>-1){o.additionalShareButtonList.push({sBtnTxt:i.getResourceBundle().getText("SAVE_AS_TILE"),sIcon:"sap-icon://add-favorite",onBtnPressed:function(e){c._openAddToHomeDialogBox()}})}return o},_getHeaderFooterOptions:function(){var c=this;var i=c.getView().getModel("i18n");this.oListItem=new sap.m.ObjectListItem();var a=String.fromCharCode(0xe078);var o={onBack:function(){c._abortPendingODataCalls();window.history.back()},sFullscreenTitle:"",onFacetFilter:function(){c._toggleFilter();$(window).trigger('resize')},buttonList:[{sBtnTxt:i.getResourceBundle().getText("OPEN_IN_LABEL"),onBtnPressed:function(e){c._showExternalNavigationLinks(e.getSource())}}],bSuppressBookmarkButton:true,oJamOptions:{fGetShareSettings:function(){var h=c.getView().byId("header-ribbon");var l=new sap.m.ObjectListItem();l.setTitle(h.getTitle());l.setNumber(h.getNumber());l.setNumberUnit(h.getNumberUnit());var s={object:{id:window.location.href,display:l,share:"SAP Smart Business"}};return s},},additionalShareButtonList:[],oEmailSettings:{fGetMailBody:function(){var h=c.getView().byId("header-ribbon");if(h.getNumberUnit()){return"("+c.EVALUATION.getKpiName().trim()+"/"+h.getTitle().trim()+": "+h.getNumber()+" "+(h.getNumberUnit())+")"+"\n"+window.location.href}else{return"("+c.EVALUATION.getKpiName().trim()+"/"+h.getTitle().trim()+": "+h.getNumber()+")"+"\n"+window.location.href}}},};return o},_initRequestTimeLogChart:function(){if((window.location.hostname=="localhost")||(jQuery.sap.getUriParameters().get("sbrequestlog")=="99")){jQuery.sap.require("sap.suite.ui.smartbusiness.drilldown.lib.Performance");this._performance=new sap.suite.ui.smartbusiness.drilldown.lib.Performance()}},addExportMethodToTable:function(){var t=this;sap.m.Table.prototype.exportData=sap.m.Table.prototype.exportData||function(s){jQuery.sap.require("sap.ui.core.util.Export");s=s||{};if(!s.rows){s.rows={path:"/data"}}var e=new sap.ui.core.util.Export(s);this.addDependent(e);return e}},_exportAsExcel:function(){var t=this;jQuery.sap.require("sap.ui.core.util.ExportTypeCSV");var c=[];var a=[];a=this.SELECTED_VIEW.getColumns();for(var i=0;i<a.length;i++){c.push(a[i]);var b=this.DIMENSION_TEXT_PROPERTY_MAPPING[a[i]];var u=this.MEASURE_UNIT_PROPERTY_MAPPING[a[i]];if(b&&b!=a[i]){c.push(b)}if(u){c.push(u)}}var d=jQuery.map(c,function(e){return{name:t.COLUMN_LABEL_MAPPING[e]||e,template:{content:{path:e,}}}});this.getUIComponents().getTable().exportData({exportType:new sap.ui.core.util.ExportTypeCSV({separatorChar:";"}),columns:d}).saveFile().always(function(){this.destroy()})},_openAddToHomeDialogBox:function(){this.oATHDialog.setModel(this.getView().getModel("i18n"),"i18n");this._compactMode?this.oATHDialog.addStyleClass("sapUiSizeCompact"):this.oATHDialog.removeStyleClass("sapUiSizeCompact");this.oATHDialog.open()},_initAddToHomeDialogBox:function(){var c=this;this.oATHDialogContent=new sap.ui.view({type:"XML",viewName:"sap.suite.ui.smartbusiness.drilldown.view.AddToHome",viewData:this});this.oATHDialog=new sap.m.Dialog({title:"{i18n>SAVE_AS_TILE_DIALOG_TITLE}",content:[this.oATHDialogContent],beginButton:new sap.m.Button({text:"{i18n>OK_BUTTON}",press:function(){c.oATHDialogContent.getController().publishTile(function(){c.oATHDialog.close()})}}),endButton:new sap.m.Button({text:"{i18n>CANCEL_BUTTON}",press:function(){c.oATHDialog.close()}})});this.oATHDialog.addStyleClass("sbAddToHomeDialogBox");this.getView().addDependent(this.oATHDialog)},getUIComponents:function(){var p=this.getView().byId("smartbusiness_drilldown_page");var c=this.getView().byId("chartToolbar");var h=this.getView().byId("header-ribbon");var t=this.getView().byId("header-container");var f=this.getView().byId("facetFilter");var a=this;return{getChart:function(){return a.chart},getTable:function(){return a.table},getChartToolbar:function(){return c},getFilter:function(){return f},getHeader:function(){return h},getTileContainer:function(){return t},getPage:function(){return p}}},onExit:function(){this._abortPendingODataCalls();this._detachHashChangeListener()}});
