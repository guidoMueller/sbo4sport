/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.apf.core.request");jQuery.sap.require("sap.apf.utils.utils");jQuery.sap.require("sap.apf.core.utils.filter");jQuery.sap.require("sap.apf.core.utils.filterTerm");jQuery.sap.require("sap.ui.thirdparty.datajs");
sap.apf.core.Request=function(I,c){var m=I.messageHandler;var C=I.coreApi;var s=c.service;var e=c.entityType;var a=c.selectProperties;var u=C.getUriGenerator();var M;if(s===undefined){M=m.createMessageObject({code:"5015",aParameters:[c.id]});m.putMessage(M)}var o=C.getMetadata(s);this.type=c.type;this.sendGetInBatch=function(F,g,R){var p=r(F);var h;d(F);if(F&&F.getProperties){h=F.reduceToProperty(o.getFilterableProperties(e))}b(R);var P=R&&R.paging;var S=R&&R.orderby;var U=o.getUriSuffix(e);var i=u.buildUri(m,e,a,h,p,S,P,undefined,f,U);var j={method:'POST',headers:{"x-csrf-token":C.getXsrfToken(s)},requestUri:u.getAbsolutePath(s)+'$batch',data:{__batchRequests:[{requestUri:i,method:'GET',headers:{"Accept-Language":sap.ui.getCore().getConfiguration().getLanguage(),"x-csrf-token":C.getXsrfToken(s)}}]}};var k=function(l,n){var q={};var t="";if(l&&l.__batchResponses&&l.__batchResponses[0].data){q.data=l.__batchResponses[0].data.results;q.metadata=C.getEntityTypeMetadata(c.service,c.entityType);if(l.__batchResponses[0].data.__count){q.count=parseInt(l.__batchResponses[0].data.__count,10)}}else if(l&&l.__batchResponses[0]&&l.__batchResponses[0].response&&l.__batchResponses[0].message){t=n.requestUri;var v=l.__batchResponses[0].message;var w=l.__batchResponses[0].response.body;var H=l.__batchResponses[0].response.statusCode;q=m.createMessageObject({code:"5001",aParameters:[H,v,w,t]})}else{t=n.requestUri||i;q=m.createMessageObject({code:"5001",aParameters:["unknown","unknown error","unknown error",t]})}g(q,false)};var E=function(l){var n="unknown error";var q="unknown error";var t=i;if(l.message!==undefined){n=l.message}var H="unknown";if(l.response&&l.response.statusCode){H=l.response.statusCode;q=l.response.statusText||"";t=l.response.requestUri||i}if(l.messageObject&&l.messageObject.type==="messageObject"){g(l.messageObject)}else{g(m.createMessageObject({code:"5001",aParameters:[H,n,q,t]}))}};C.odataRequest(j,k,E,OData.batchHandler)};function f(p,v){var g="'";var E=o.getPropertyMetadata(e,p);if(E&&E.dataType){return sap.apf.utils.formatValue(v,E.dataType.type)}else{if(typeof v==='number'){return v}else{return g+sap.apf.utils.escapeOdata(v)+g}}};function b(R){var p,i;if(!R){return}p=Object.getOwnPropertyNames(R);for(i=0;i<p.length;i++){if(p[i]!=='orderby'&&p[i]!=='paging'){m.putMessage(m.createMessageObject({code:'5032',aParameters:[e,p[i]]}))}}}function d(F){var g=o.getFilterableProperties(e);var R="";var E=o.getEntityTypeMetadata(e);var M;if(E.requiresFilter!==undefined&&E.requiresFilter==="true"){if(E.requiredProperties!==undefined){R=E.requiredProperties}}if(R===""){return}if(jQuery.inArray(R,g)===-1){M=m.createMessageObject({code:"5006",aParameters:[e,R]});m.putMessage(M)}var p=F.getProperties();if(jQuery.inArray(R,p)===-1){M=m.createMessageObject({code:"5005",aParameters:[e,R]});m.putMessage(M)}}function r(F){var p={};var P;var n;var t;P=o.getHanaViewParameters(e);if(P!==undefined){n=P.length}else{n=0}if(n>0){for(var i=0;i<n;i++){var g;if(F&&F instanceof sap.apf.core.utils.Filter){t=F.getFilterTermsForProperty(P[i].name);g=t[t.length-1]}if(g instanceof sap.apf.core.utils.FilterTerm){h(i,g.getValue())}else if(P[i].defaultValue){h(i,P[i].defaultValue)}else{var M=m.createMessageObject({code:"5016",aParameters:[P[i].name]});m.putMessage(M)}}}return p;function h(j,v){if(P[j].dataType.type==='Edm.String'){p[P[j].name]=(jQuery.sap.encodeURL("'"+sap.apf.utils.escapeOdata(v)+"'"))}else if(P[j].dataType.type){p[P[j].name]=sap.apf.utils.formatValue(v,P[j].dataType.type)}else{if(typeof v==="string"){p[P[j].name]=jQuery.sap.encodeURL(sap.apf.utils.escapeOdata(v))}else{p[P[j].name]=v}}}}};
