jQuery.sap.require("sap.m.MessageBox");jQuery.sap.require("sap.suite.ui.smartbusiness.lib.Chip");sap.ui.controller("sap.suite.ui.smartbusiness.drilldown.view.AddToHome",{onInit:function(){this.drilldownController=this.getView().getViewData();this.evaluationApi=this.drilldownController.EVALUATION;this.thresholds=this.evaluationApi.getThresholds();this.LAYOUT=this.byId("container");this.SAP_SYSTEM=this.drilldownController.SAP_SYSTEM;try{this.LAYOUT_MODEL=new sap.ui.model.json.JSONModel({TITLE:"",CL:this.thresholds.getCriticalLow(),CH:this.thresholds.getCriticalHigh(),WL:this.thresholds.getWarningLow(),WH:this.thresholds.getWarningHigh(),TA:this.thresholds.getTarget(),TC:this.thresholds.getTrend(),RE:this.thresholds.getReference(),MINIMIZING_KPI:this.evaluationApi.isMinimizingKpi(),MAXIMIZING_KPI:this.evaluationApi.isMaximizingKpi(),TARGET_KPI:this.evaluationApi.isTargetKpi()});this.LAYOUT.setModel(this.LAYOUT_MODEL),this.createForm(this.evaluationApi.getThresholdValueType()=="MEASURE")}catch(e){}},createForm:function(i){var _=function(m){return{parts:[{path:m},{path:"/TARGET_KPI"}],formatter:function(M,t){if(M||t){return true}return false}}};var f=null;var n=null;if(!i){f=new sap.ui.layout.form.SimpleForm({content:[new sap.m.Label({text:"{i18n>SUB_TITLE_LABEL}",required:true}),new sap.m.Input({value:"{/TITLE}",id:"subtitleInput"}),new sap.m.Label({text:"{i18n>CRITICAL_HIGH_LABEL}",visible:_("/MINIMIZING_KPI")}),new sap.m.Input({value:"{/CH}",visible:_("/MINIMIZING_KPI"),valueState:sap.ui.core.ValueState.Error,valueStateText:"{i18n>CRITICAL_HIGH_VALUE_HELP}"}),new sap.m.Label({text:"{i18n>WARNING_HIGH_LABEL}",visible:_("/MINIMIZING_KPI")}),new sap.m.Input({value:"{/WH}",visible:_("/MINIMIZING_KPI"),valueState:sap.ui.core.ValueState.Warning,valueStateText:"{i18n>WARNING_HIGH_VALUE_HELP}"}),new sap.m.Label({text:"{i18n>TARGET_LABEL}"}),new sap.m.Input({value:"{/TA}",valueState:sap.ui.core.ValueState.None,valueStateText:"{i18n>TARGET_VALUE_HELP}"}),new sap.m.Label({text:"{i18n>WARNING_LOW_LABEL}",visible:_("/MAXIMIZING_KPI")}),new sap.m.Input({value:"{/WL}",visible:_("/MAXIMIZING_KPI"),valueState:sap.ui.core.ValueState.Warning,valueStateText:"{i18n>WARNING_LOW_VALUE_HELP}"}),new sap.m.Label({text:"{i18n>CRITICAL_LOW_LABEL}",visible:_("/MAXIMIZING_KPI")}),new sap.m.Input({value:"{/CL}",visible:_("/MAXIMIZING_KPI"),valueState:sap.ui.core.ValueState.Error,valueStateText:"{i18n>CRITICAL_LOW_VALUE_HELP}"}),]})}else{f=new sap.ui.layout.form.SimpleForm({content:[new sap.m.Label({text:"{i18n>SUB_TITLE_LABEL}",required:true}),new sap.m.Input({value:"{/TITLE}"}),]});n=new sap.m.Label({text:"{i18n>DYNAMIC_MEASURE_NOT_EDITABLE}"});n.addStyleClass("labelDynamicThresholdNotEditable")}this.LAYOUT.removeAllItems();this.LAYOUT.addItem(f);if(n){this.LAYOUT.addItem(n)}},validate:function(c,C){var m=this.LAYOUT_MODEL.getData();m.TITLE=sap.ui.getCore().byId("subtitleInput").getValue();var o={title:""};if(this.evaluationApi.getThresholdValueType()=="MEASURE"){if(!m.TITLE.trim()){C.call(this,{errorMessage:this.drilldownController.getView().getModel("i18n").getProperty("VALIDATION_ERROR_TITLE_MISSING")})}else{o.title=m.TITLE.trim();c.call(this,o)}}else{if(!m.TITLE.trim()){C.call(this,{errorMessage:this.drilldownController.getView().getModel("i18n").getProperty("VALIDATION_ERROR_TITLE_MISSING")});return}o.title=m.TITLE.trim();o.evaluationValues=[];var t=m.TA?m.TA.trim():null;var a=m.CL?m.CL.trim():null;var b=m.CH?m.CH.trim():null;var W=m.WL?m.WL.trim():null;var d=m.WH?m.WH.trim():null;if(t){o.evaluationValues.push({TYPE:"TA",FIXED:t,ID:this.evaluationApi.getId(),COLUMN_NAME:null,ODATA_PROPERTY:null})}if(a){o.evaluationValues.push({TYPE:"CL",FIXED:a,ID:this.evaluationApi.getId(),COLUMN_NAME:null,ODATA_PROPERTY:null})}if(b){o.evaluationValues.push({TYPE:"CH",FIXED:b,ID:this.evaluationApi.getId(),COLUMN_NAME:null,ODATA_PROPERTY:null})}if(W){o.evaluationValues.push({TYPE:"WL",FIXED:W,ID:this.evaluationApi.getId(),COLUMN_NAME:null,ODATA_PROPERTY:null})}if(d){o.evaluationValues.push({TYPE:"WH",FIXED:d,ID:this.evaluationApi.getId(),COLUMN_NAME:null,ODATA_PROPERTY:null})}if(o.evaluationValues.length==0){o.evaluationValues=null}c.call(this,o)}},_addTileToHomePage:function(c){var b=sap.ushell.Container.getService("Bookmark");var a=null;b.addCatalogTileToGroup(c,a,{baseUrl:"/sap/hba/r/sb/core/odata/runtime/SMART_BUSINESS.xsodata",remoteId:"HANA_CATALOG"}).done(function(){jQuery.sap.log.info("Tile Added to HOME")}).fail(function(e){jQuery.sap.log.error("Failed to add tile to home : "+e)})},_notifyShell:function(c){var s=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService;if(s){oNotifyShell=s("LaunchPage");if(oNotifyShell&&oNotifyShell.onCatalogTileAdded){oNotifyShell.onCatalogTileAdded(c)}}},publishTile:function(c){this.validate(function(t){var r=sap.suite.smartbusiness.chip.savePersonalizedTile({evaluationId:this.evaluationApi.getId(),tileType:this.drilldownController.TILE_TYPE,dimension:this.drilldownController.DIMENSION,additionalFilters:this.drilldownController.getAdditionFiltersForChipConfiguration(),evaluationValues:t.evaluationValues?t:null,title:t.title,sapSystem:this.SAP_SYSTEM});if(r.status=='Success'){sap.m.MessageToast.show(this.drilldownController.getView().getModel("i18n").getProperty("PERSONALIZED_TILE_CREATED_SUCCESSFULLY"));c.call();this._addTileToHomePage(r.chipId);this._notifyShell(r.chipId)}else{jQuery.sap.log.error(r.message);sap.m.MessageToast.show(this.drilldownController.getView().getModel("i18n").getProperty("PERSONALIZED_TILE_CREATION_FAILED"));c.call()}},function(e){sap.m.MessageBox.show(e.errorMessage,null,this.drilldownController.getView().getModel("i18n").getProperty("VALIDATION_ERROR_HEADER"))})},onAfterRendering:function(){}});
