jQuery.sap.require("sap.ca.scfld.md.controller.ScfldMasterController");jQuery.sap.require("sap.suite.ui.smartbusiness.lib.Util");jQuery.sap.require("sap.m.MessageBox");jQuery.sap.require("sap.m.MessageToast");sap.ca.scfld.md.controller.ScfldMasterController.extend("sap.suite.ui.smartbusiness.designtime.drilldown.view.configureNewView",{onInit:function(){this.DDA_MODEL=null;this.evaluationId=null;this.measureDimensionList=this.byId(sap.ui.core.Fragment.createId('measureDimensionsList','measureDimensionsList'));this._oDimensionList=sap.ui.xmlfragment("sap.suite.ui.smartbusiness.designtime.drilldown.view.list",this);this._oMeasureList=sap.ui.xmlfragment("sap.suite.ui.smartbusiness.designtime.drilldown.view.list",this);try{if(sap.ui.core.Fragment.byId("measureDimensionDialog","measureDimensionDialog")){sap.ui.core.Fragment.byId("measureDimensionDialog","measureDimensionDialog").destroy()}if(sap.ui.core.Fragment.byId("thresholdDialog","dialogRef")){sap.ui.core.Fragment.byId("thresholdDialog","dialogRef").destroy()}if(sap.ui.core.Fragment.byId("editDialog","editDialog")){sap.ui.core.Fragment.byId("editDialog","editDialog").destroy()}if(sap.ui.core.Fragment.byId("dualAxisConfig","dualAxisConfig")){sap.ui.core.Fragment.byId("dualAxisConfig","dualAxisConfig").destroy()}if(sap.ui.core.Fragment.byId("msrDialogForStack1","stack1SelectDialog")){sap.ui.core.Fragment.byId("msrDialogForStack1","stack1SelectDialog").destroy()}if(sap.ui.core.Fragment.byId("additionalLanguageDialog","additionalLanguageDialog")){sap.ui.core.Fragment.byId("additionalLanguageDialog","additionalLanguageDialog").destroy()}if(sap.ui.core.Fragment.byId("chartTypeConfig","chartTypeConfig")){sap.ui.core.Fragment.byId("chartTypeConfig","chartTypeConfig").getParent().destroy()}}catch(e){};this._oShowMeasureDialog=sap.ui.xmlfragment("measureDimensionDialog","sap.suite.ui.smartbusiness.designtime.drilldown.view.measureDimensionDialog",this);this._oShowMeasureDialog.addStyleClass("dialog");this.addThresholdMeasureDialog=sap.ui.xmlfragment("thresholdDialog","sap.suite.ui.smartbusiness.designtime.drilldown.view.addThresholdMeasure",this);this._editMeasureDialog=sap.ui.xmlfragment("editDialog","sap.suite.ui.smartbusiness.designtime.drilldown.view.editDialog",this);this._dualAxisConfig=sap.ui.xmlfragment("dualAxisConfig","sap.suite.ui.smartbusiness.designtime.drilldown.view.dualAxisConfig",this);this._msrDialogForStack1=sap.ui.xmlfragment("msrDialogForStack1","sap.suite.ui.smartbusiness.designtime.drilldown.view.msrDialogForStack1",this);this.AdditionalLanguagesDialog=new sap.ui.xmlfragment("additionalLanguageDialog","sap.suite.ui.smartbusiness.designtime.drilldown.view.additionalLanguagesDialog",this);this._chartTypeConfig=sap.ui.xmlfragment("chartTypeConfig","sap.suite.ui.smartbusiness.designtime.drilldown.view.chartTypeConfig",this);this.oRouter.attachRoutePatternMatched(this.onRoutePatternMatched,this);this.busyIndicator=new sap.m.BusyDialog()},onRoutePatternMatched:function(E){if(E.getParameter("name")==="configureChart"){try{this.evaluationId=E.getParameter("arguments")["evaluationId"];this.currentViewId=E.getParameter("arguments")["viewId"];this.DDA_MODEL=sap.suite.smartbusiness.ddaconfig.Model.getInstance(this.evaluationId,false,this.getView().getModel("i18n"));if(this.currentViewId!=="~NA~"){this.DDA_MODEL.setViewId(this.currentViewId)}this.bindUiToModel();this.EVALUATION=sap.suite.smartbusiness.kpi.parseEvaluation(this.DDA_MODEL.EVALUATION_DATA);this._oModel=this.getView().getModel("SB_DDACONFIG");this.mProperties=sap.suite.smartbusiness.odata.properties(this._oModel.getData().QUERY_SERVICE_URI,this._oModel.getData().QUERY_ENTITY_SET);this.COLUMN_LABEL_MAPPING=this.mProperties.getLabelMappingObject();this._oTextsModel=this.getView().getModel("i18n");this._editMeasureDialog.setModel(this._oTextsModel,"i18n");this._dualAxisConfig.setModel(this._oTextsModel,"i18n");this._msrDialogForStack1.setModel(this._oTextsModel,"i18n");this._oShowMeasureDialog.setModel(this._oTextsModel,"i18n");this.addThresholdMeasureDialog.setModel(this._oTextsModel,"i18n");this.prepareInitialModelData(this._oModel);this.takeConfigMasterSnapShot();this._updateMeasureDimensionBindings();this.refreshChart();this.chartTypeInit()}catch(e){sap.suite.smartbusiness.utils.showErrorMessage(this.oApplicationFacade.getResourceBundle().getText("FAILED_TO_LOAD_ODATA"),e.message)}}},displayLabelsFormatter:function(s){return this.COLUMN_LABEL_MAPPING[s]},bindUiToModel:function(){this.DDA_MODEL.bindModel(this.getView(),"SB_DDACONFIG");this.DDA_MODEL.bindModel(this._editMeasureDialog,"SB_DDACONFIG");this.DDA_MODEL.bindModel(this._editMeasureDialog);this.DDA_MODEL.bindModel(this._oShowMeasureDialog,"SB_DDACONFIG");this.DDA_MODEL.bindModel(this._oShowMeasureDialog);this.DDA_MODEL.bindModel(this.addThresholdMeasureDialog,"SB_DDACONFIG");this.DDA_MODEL.bindModel(this.AdditionalLanguagesDialog,"SB_DDACONFIG")},_cloneObj:function(e){var t;if(e instanceof Array){t=[];for(var i=0;i<e.length;i++){t[i]=this._cloneObj(e[i])}}else if(e instanceof Object){t={};for(var a in e){if(e.hasOwnProperty(a)){t[a]=this._cloneObj(e[a])}}}else{t=e}return t},takeConfigMasterSnapShot:function(){this._masterConfig=this._cloneObj(this._oModel.getData())},restoreFromConfigMasterSnapShot:function(){this._oModel.setData(this._masterConfig)},copyConfigSnapshot:function(){this._config=this._cloneObj(this._oModel.getData());this.enableOrDisableSave()},restorePrevConfig:function(){this._oModel.setData(this._config)},prepareInitialModelData:function(m){var t=m.getData();var d=t.ALL_DIMENSIONS;var a=t.ALL_MEASURES;var b=[],c={};var e=t.COLUMNS;for(var i=0;i<e.length;i++){e[i].SELECTED=true;e[i].LABEL=this.COLUMN_LABEL_MAPPING[e[i].NAME];b.push(e[i]);c[e[i].NAME]=true}for(var i=0;i<d.length;i++){if(c[d[i]])continue;b.push({AXIS:1,NAME:d[i],SORT_BY:d[i],SORT_ORDER:"none",STACKING:0,TYPE:"DIMENSION",VISIBILITY:"BOTH",SELECTED:false,LABEL:this.COLUMN_LABEL_MAPPING[d[i]]})}for(var i=0;i<a.length;i++){if(c[a[i]])continue;b.push({0:Object,AXIS:2,COLOR1:"",COLOR2:"",NAME:a[i],SORT_BY:a[i],SORT_ORDER:"none",STACKING:0,TYPE:"MEASURE",VISIBILITY:"BOTH",SELECTED:false,LABEL:this.COLUMN_LABEL_MAPPING[a[i]]})}t.items=b;m.setData(t)},_updateMeasureDimensionBindings:function(){var f=new sap.ui.model.Filter("SELECTED",sap.ui.model.FilterOperator.EQ,true);var b=this.measureDimensionList.getBinding("items");b.filter(f)},onChartTypeChange:function(e){if(!this._chartTypeConfig){this._chartTypeConfig=sap.ui.xmlfragment("chartTypeConfig","sap.suite.ui.smartbusiness.designtime.drilldown.view.chartTypeConfig",this)}this.getView().byId(sap.ui.core.Fragment.createId("chartTypeConfig","chartTypeConfig"));var c=this.getView().byId(sap.ui.core.Fragment.createId("chartTypeConfig","chartType"));this.getView().byId(sap.ui.core.Fragment.createId("chartTypeConfig","singleDual")).setVisible((c.getSelectedKey().toUpperCase()!="BUBBLE"&&c.getSelectedKey().toUpperCase()!="TABLE"&&c.getSelectedKey().toUpperCase().toUpperCase()!="LINE"&&c.getSelectedKey().toUpperCase()!="COMBINATION")?true:false);this.getView().byId(sap.ui.core.Fragment.createId("chartTypeConfig","isAbsolute")).setVisible((c.getSelectedKey().toUpperCase()!="BUBBLE"&&c.getSelectedKey().toUpperCase()!="TABLE"&&c.getSelectedKey().toUpperCase().toUpperCase()!="LINE"&&c.getSelectedKey().toUpperCase()!="COMBINATION")?true:false);this.updateSemanticColorComboBox(c.getSelectedKey());this.refreshChart();this.enableOrDisableSave()},chartTypeInit:function(e){if(!this._chartTypeConfig){this._chartTypeConfig=sap.ui.xmlfragment("chartTypeConfig","sap.suite.ui.smartbusiness.designtime.drilldown.view.chartTypeConfig",this)}this.getView().byId(sap.ui.core.Fragment.createId("chartTypeConfig","chartTypeConfig"));var c=this.getView().byId(sap.ui.core.Fragment.createId("chartTypeConfig","chartType"));if(c.getSelectedKey().toUpperCase()!="BUBBLE")this.copyConfigSnapshot();this.getView().byId(sap.ui.core.Fragment.createId("chartTypeConfig","singleDual")).setVisible((c.getSelectedKey().toUpperCase()!="BUBBLE"&&c.getSelectedKey().toUpperCase()!="TABLE"&&c.getSelectedKey().toUpperCase().toUpperCase()!="LINE"&&c.getSelectedKey().toUpperCase()!="COMBINATION")?true:false);this.getView().byId(sap.ui.core.Fragment.createId("chartTypeConfig","isAbsolute")).setVisible((c.getSelectedKey().toUpperCase()!="BUBBLE"&&c.getSelectedKey().toUpperCase()!="TABLE"&&c.getSelectedKey().toUpperCase().toUpperCase()!="LINE"&&c.getSelectedKey().toUpperCase()!="COMBINATION")?true:false);this.setSemanticColorComboBox(c.getSelectedKey());this.refreshChart();this.enableOrDisableSave()},updateSemanticColorComboBox:function(c){if(!this._chartTypeConfig){this._chartTypeConfig=sap.ui.xmlfragment("chartTypeConfig","sap.suite.ui.smartbusiness.designtime.drilldown.view.chartTypeConfig",this)}c=c.toUpperCase();var s=this.getView().byId(sap.ui.core.Fragment.createId("chartTypeConfig","semanticColors"));if(c=="BAR"||c=="COLUMN"){s.setVisible(true);s.setEnabled(true);s.getItemByKey("AUTO_SEMANTIC").setEnabled(true);s.getItemByKey("MANUAL_NON_SEMANTIC").setEnabled(true);s.getItemByKey("MANUAL_SEMANTIC").setEnabled(true);if(this.isStackDim){s.setSelectedKey("NONE");s.getItemByKey("AUTO_SEMANTIC").setEnabled(false);s.getItemByKey("MANUAL_NON_SEMANTIC").setEnabled(false);s.getItemByKey("MANUAL_SEMANTIC").setEnabled(false)}}else if(c=="BUBBLE"){s.setSelectedKey("NONE");s.setVisible(false)}else if(c=="TABLE"){s.setVisible(true);s.setEnabled(true);if(!(s.getSelectedKey().toUpperCase()=="NONE"||s.getSelectedKey().toUpperCase()=="AUTO_SEMANTIC"))s.setSelectedKey("NONE");s.getItemByKey("AUTO_SEMANTIC").setEnabled(true);s.getItemByKey("MANUAL_NON_SEMANTIC").setEnabled(false);s.getItemByKey("MANUAL_SEMANTIC").setEnabled(false)}else if(c=="LINE"||c=="COMBINATION"){s.setSelectedKey("MANUAL_NON_SEMANTIC");s.setVisible(true);s.setEnabled(true);s.getItemByKey("MANUAL_NON_SEMANTIC").setEnabled(true);s.getItemByKey("AUTO_SEMANTIC").setEnabled(false);s.getItemByKey("MANUAL_SEMANTIC").setEnabled(true)}},setSemanticColorComboBox:function(c){c=c.toUpperCase();var s=this.getView().byId(sap.ui.core.Fragment.createId("chartTypeConfig","semanticColors"));if(c=="BAR"||c=="COLUMN"){s.setVisible(true);s.setEnabled(true);s.getItemByKey("AUTO_SEMANTIC").setEnabled(true);s.getItemByKey("MANUAL_NON_SEMANTIC").setEnabled(true);s.getItemByKey("MANUAL_SEMANTIC").setEnabled(true);if(this.isStackDim){s.getItemByKey("AUTO_SEMANTIC").setEnabled(false);s.getItemByKey("MANUAL_NON_SEMANTIC").setEnabled(false);s.getItemByKey("MANUAL_SEMANTIC").setEnabled(false)}}else if(c=="BUBBLE"){s.setVisible(false)}else if(c=="TABLE"){s.setVisible(true);s.setEnabled(true);s.getItemByKey("AUTO_SEMANTIC").setEnabled(true);s.getItemByKey("MANUAL_NON_SEMANTIC").setEnabled(false);s.getItemByKey("MANUAL_SEMANTIC").setEnabled(false)}else if(c=="LINE"||c=="COMBINATION"){s.setVisible(true);s.setEnabled(true);s.getItemByKey("MANUAL_NON_SEMANTIC").setEnabled(true);s.getItemByKey("AUTO_SEMANTIC").setEnabled(false);s.getItemByKey("MANUAL_SEMANTIC").setEnabled(true)}},formatcolor:function(s){return s?sap.ui.core.theming.Parameters.get(s):"transparent"},formatEditColor:function(s){return s?sap.ui.core.theming.Parameters.get(s):"black"},sortByMeasureVisibility:function(s){return s?(s.toUpperCase()=="MEASURE"||s.toUpperCase()=="KPI MEASURE"):false},sortByDimensionVisibility:function(s){return s?s.toUpperCase()=="DIMENSION":false},openAllMeasuresDimension:function(){this.copyConfigSnapshot();this._oShowMeasureDialog.open();var b=this._oShowMeasureDialog.getContent()[0];if(b.getSelectedButton()==b.getButtons()[1].getId()){this.showDimensionList()}else{this.showMeasureList()}},_isAddDimensionMode:function(){var b=this._oShowMeasureDialog.getContent()[0];return b.getSelectedButton()==b.getButtons()[1].getId()},onMeasureDimensionSearch:function(e){var m=this._isAddDimensionMode()?"DIMENSION":"MEASURE";var c=this._isAddDimensionMode()?this._oDimensionList:this._oMeasureList;var f=[new sap.ui.model.Filter("TYPE",sap.ui.model.FilterOperator.Contains,m)];var k=e.getSource().getValue();if(k&&k.length>0){f.push(new sap.ui.model.Filter("LABEL",sap.ui.model.FilterOperator.StartsWith,k))}var b=c.getBinding("items");b.filter(f)},onMeasureDimensionAdded:function(){this._updateMeasureDimensionBindings();this._oShowMeasureDialog.close();this.refreshChart();this.enableOrDisableSave()},onMeasureDimensionCancel:function(){this.restorePrevConfig();this._updateMeasureDimensionBindings();this._oShowMeasureDialog.close()},showDimensionList:function(){this._oShowMeasureDialog.removeContent(this._oMeasureList);this._oShowMeasureDialog.addContent(this._oDimensionList);this._oDimensionList.getBinding("items").filter(new sap.ui.model.Filter("TYPE",sap.ui.model.FilterOperator.EQ,"DIMENSION"))},showMeasureList:function(){this._oShowMeasureDialog.removeContent(this._oDimensionList);this._oShowMeasureDialog.addContent(this._oMeasureList);this._oMeasureList.getBinding("items").filter(new sap.ui.model.Filter("TYPE",sap.ui.model.FilterOperator.EQ,"MEASURE"))},formatSortOrder:function(s){if(s=="asc"){return"sap-icon://up"}else if(s=="desc"){return"sap-icon://down"}else{return""}},colorButtonVisiblity:function(s,c){if(s)return(c=="MANUAL_SEMANTIC"||c=="MANUAL_NON_SEMANTIC")&&s.toLowerCase()=='measure'},colorButton1Visiblity:function(s){return s=="MANUAL_NON_SEMANTIC"},colorButton2Visiblity:function(s){return s=="MANUAL_SEMANTIC"},onEditIconPress:function(e){var t=this;this.copyConfigSnapshot();var b=e.getSource().getBindingContext("SB_DDACONFIG");this.columnBeingEdited=b.getObject();this._editMeasureDialog.bindElement(b.getPath());if(b.getObject().TYPE.toLowerCase()=="kpi measure"){sap.ui.core.Fragment.byId("editDialog","typeOf").setText(this.getView().getModel("i18n").getProperty("KPI_MEASURE"))}if(b.getObject().VISIBILITY.toUpperCase()==="CHART")sap.ui.core.Fragment.byId("editDialog","hideInTable").setSelected(true);else sap.ui.core.Fragment.byId("editDialog","hideInTable").setSelected(false);if((((this.dda_config.chartConfig.type).toUpperCase()==="BAR")||((this.dda_config.chartConfig.type).toUpperCase()==="COLUMN"))&&((this.dda_config.chartConfig.axis).toUpperCase()==="DUAL")){sap.ui.core.Fragment.byId("editDialog","Dual_config_1").setVisible(true);sap.ui.core.Fragment.byId("editDialog","Dual_config_2").setVisible(true);var D=new sap.ui.model.json.JSONModel();D.setData({DATA:t.chartMeasures});sap.ui.core.Fragment.byId("editDialog","Dual_config_1").setModel(D,"DUAL_MODEL");sap.ui.core.Fragment.byId("editDialog","axis_1_label_edit").setText(t._oTextsModel.getResourceBundle().getText("AXIS",1));sap.ui.core.Fragment.byId("editDialog","axis_2_label_edit").setText(t._oTextsModel.getResourceBundle().getText("AXIS",2));sap.ui.core.Fragment.byId("editDialog","In_stack1_label_edit").setText(t._oTextsModel.getResourceBundle().getText("IN_STACK",1));var d=this.getMeasuresByAxis(this.chartMeasures);sap.ui.core.Fragment.byId("editDialog","stack1MsrsLabel_edit").setText(d.axis1.nameArr.join(","));sap.ui.core.Fragment.byId("editDialog","stack2MsrsLabel_edit").setText(d.axis2.nameArr.join(","));if(d.axis1.nameArr.length){sap.ui.core.Fragment.byId("editDialog","AxisMsr1_edit").setSelectedKey(d.axis1.nameArr[0])};if(d.axis2.nameArr.length){sap.ui.core.Fragment.byId("editDialog","AxisMsr2_edit").setSelectedKey(d.axis2.nameArr[0])}}else{sap.ui.core.Fragment.byId("editDialog","Dual_config_1").setVisible(false);sap.ui.core.Fragment.byId("editDialog","Dual_config_2").setVisible(false)}var S=t.getStacking(t.chartMeasures,t.chartDimensions);sap.ui.core.Fragment.byId("editDialog","enableStacking").setEnabled(true);if(S.isEnabled){sap.ui.core.Fragment.byId("editDialog","enableStacking").setSelected(true);sap.ui.core.Fragment.byId("editDialog","stackingOptions").setVisible(true);if(S.type==="M"){sap.ui.core.Fragment.byId("editDialog","addMsrToStack").setSelected(true);sap.ui.core.Fragment.byId("editDialog","dimsToStack").setVisible(false)}else if(S.type==="D"){sap.ui.core.Fragment.byId("editDialog","addMsrToStack").setSelected(false);sap.ui.core.Fragment.byId("editDialog","dimStack").setSelected(true);sap.ui.core.Fragment.byId("editDialog","dimsToStack").setVisible(true);var j=new sap.ui.model.json.JSONModel();j.setData({STdata:t.chartDimensions});sap.ui.core.Fragment.byId("editDialog","dimsToStack").setModel(j);var o=new sap.ui.core.Item({key:"{name}",text:"{name}",});sap.ui.core.Fragment.byId("editDialog","dimsToStack").bindItems("/STdata",o);if(t.getDimensionToBeStacked(t.chartDimensions)){sap.ui.core.Fragment.byId("editDialog","dimsToStack").setSelectedKey(t.getDimensionToBeStacked(t.chartDimensions).name)}}}else{sap.ui.core.Fragment.byId("editDialog","enableStacking").setSelected(false);sap.ui.core.Fragment.byId("editDialog","stackingOptions").setVisible(false)}if((((this.dda_config.chartConfig.type).toUpperCase()==="BAR")||((this.dda_config.chartConfig.type).toUpperCase()==="COLUMN"))&&(((this.dda_config.chartConfig.axis).toUpperCase()==="DUAL")||((this.dda_config.chartConfig.value).toUpperCase()==="PERCENTAGE"))){sap.ui.core.Fragment.byId("editDialog","stackingOptions").setVisible(false);sap.ui.core.Fragment.byId("editDialog","enableStacking").setEnabled(false)}if(!(((this.dda_config.chartConfig.type).toUpperCase()==="BAR")||((this.dda_config.chartConfig.type).toUpperCase()==="COLUMN"))){sap.ui.core.Fragment.byId("editDialog","stackingOptions").setVisible(false);sap.ui.core.Fragment.byId("editDialog","enableStacking").setEnabled(false)}if(b.getObject().TYPE.toUpperCase()=="MEASURE"){sap.ui.core.Fragment.byId("editDialog","useAsThreshold").setVisible(true);if(b.getObject().NAME===t._oModel.getData().THRESHOLD_MEASURE)sap.ui.core.Fragment.byId("editDialog","useAsThreshold").setSelected(true);else sap.ui.core.Fragment.byId("editDialog","useAsThreshold").setSelected(false)}else if(b.getObject().TYPE.toUpperCase()=="DIMENSION"){sap.ui.core.Fragment.byId("editDialog","useAsThreshold").setVisible(false)}this._editMeasureDialog.open()},onEnableStacking:function(){var i=sap.ui.core.Fragment.byId("editDialog","enableStacking").getSelected();if(i){sap.ui.core.Fragment.byId("editDialog","stackingOptions").setVisible(true)}else{sap.ui.core.Fragment.byId("editDialog","stackingOptions").setVisible(false)}},onMsrStacking:function(){if(sap.ui.core.Fragment.byId("editDialog","addMsrToStack").getSelected()){sap.ui.core.Fragment.byId("editDialog","dimsToStack").setVisible(false)}},onDimStacking:function(){var t=this;if(sap.ui.core.Fragment.byId("editDialog","dimStack").getSelected()){sap.ui.core.Fragment.byId("editDialog","dimsToStack").setVisible(true);var j=new sap.ui.model.json.JSONModel();j.setData({STdata:t.chartDimensions});sap.ui.core.Fragment.byId("editDialog","dimsToStack").setModel(j);var o=new sap.ui.core.Item({key:"{name}",text:"{name}",});sap.ui.core.Fragment.byId("editDialog","dimsToStack").bindItems("/STdata",o);if(t.getDimensionToBeStacked(t.chartDimensions)){sap.ui.core.Fragment.byId("editDialog","dimsToStack").setSelectedKey(t.getDimensionToBeStacked(t.chartDimensions).name)}}else{sap.ui.core.Fragment.byId("editDialog","dimsToStack").setVisible(false)}},onAfterRendering:function(){this._fixSplitterHeight();sap.ui.Device.resize.attachHandler(this._fixSplitterHeight,this)},_fixSplitterHeight:function(){var _=$(window).height();var a=48;var b=49;this.byId('splitContainer').$().css("height",(_-(a+b))+"px")},showGeneral:function(){sap.ui.core.Fragment.byId("editDialog","FormEditMeasureGeneral").setVisible(true);sap.ui.core.Fragment.byId("editDialog","FormEditMeasureAdvanced").setVisible(false)},showAdvanced:function(){sap.ui.core.Fragment.byId("editDialog","FormEditMeasureGeneral").setVisible(false);sap.ui.core.Fragment.byId("editDialog","FormEditMeasureAdvanced").setVisible(true)},onEditDialogOk:function(e){var t=this;var b=e.getSource().getBindingContext("SB_DDACONFIG");if(sap.ui.core.Fragment.byId("editDialog","hideInTable").getSelected()){t.updateColumnProperty(t._oModel.getData().items,t.columnBeingEdited.NAME,"VISIBILITY","CHART")}else{t.updateColumnProperty(t._oModel.getData().items,t.columnBeingEdited.NAME,"VISIBILITY","BOTH")}if(t.columnBeingEdited.TYPE.toUpperCase()==="MEASURE"){if(sap.ui.core.Fragment.byId("editDialog","useAsThreshold").getSelected()){t._oModel.getData().THRESHOLD_MEASURE=t.columnBeingEdited.NAME}else{if(t.columnBeingEdited.NAME===t._config.THRESHOLD_MEASURE){t._oModel.getData().THRESHOLD_MEASURE=""}}}if(sap.ui.core.Fragment.byId("editDialog","enableStacking").getSelected()){if(sap.ui.core.Fragment.byId("editDialog","addMsrToStack").getSelected()){t.setStacking(true,"M",t._oModel.getData().items);var s=t.getView().byId(sap.ui.core.Fragment.createId("chartTypeConfig","semanticColors"));var c=t.getView().byId(sap.ui.core.Fragment.createId("chartTypeConfig","chartType"));if(c.getSelectedKey().toUpperCase()=="BAR"||c.getSelectedKey().toUpperCase()=="COLUMN"){s.getItemByKey("AUTO_SEMANTIC").setEnabled(true);s.getItemByKey("MANUAL_NON_SEMANTIC").setEnabled(true);s.getItemByKey("MANUAL_SEMANTIC").setEnabled(true)}}else if(sap.ui.core.Fragment.byId("editDialog","dimStack").getSelected()){var d=sap.ui.core.Fragment.byId("editDialog","dimsToStack").getSelectedKey();t.setStacking(true,"D",t._oModel.getData().items);t.setDimensionToBeStacked(t._oModel.getData().items,d);var s=t.getView().byId(sap.ui.core.Fragment.createId("chartTypeConfig","semanticColors"));var c=t.getView().byId(sap.ui.core.Fragment.createId("chartTypeConfig","chartType"));if(c.getSelectedKey().toUpperCase()=="BAR"||c.getSelectedKey().toUpperCase()=="COLUMN"){s.setSelectedKey("NONE");s.getItemByKey("AUTO_SEMANTIC").setEnabled(false);s.getItemByKey("MANUAL_NON_SEMANTIC").setEnabled(false);s.getItemByKey("MANUAL_SEMANTIC").setEnabled(false)}}}else{t.setStacking(false,"N",t._oModel.getData().items);var s=t.getView().byId(sap.ui.core.Fragment.createId("chartTypeConfig","semanticColors"));var c=t.getView().byId(sap.ui.core.Fragment.createId("chartTypeConfig","chartType"));if(c.getSelectedKey().toUpperCase()=="BAR"||c.getSelectedKey().toUpperCase()=="COLUMN"){s.getItemByKey("AUTO_SEMANTIC").setEnabled(true);s.getItemByKey("MANUAL_NON_SEMANTIC").setEnabled(true);s.getItemByKey("MANUAL_SEMANTIC").setEnabled(true)}}if((((this.dda_config.chartConfig.type).toUpperCase()==="BAR")||((this.dda_config.chartConfig.type).toUpperCase()==="COLUMN"))&&((this.dda_config.chartConfig.axis).toUpperCase()==="DUAL")){var a=sap.ui.getCore().byId(sap.ui.core.Fragment.createId("editDialog","AxisMsr1_edit"));var f=sap.ui.getCore().byId(sap.ui.core.Fragment.createId("editDialog","AxisMsr2_edit"));if(a.getSelectedKey()===f.getSelectedKey()){jQuery.sap.log.error("Same measure chosen for both axes")}var g=this._oModel.getData();for(var i=0;i<g.items.length;i++){if(g.items[i].TYPE.toUpperCase()==="MEASURE"){g.items[i].AXIS=2;for(var j=0;j<t.chartMeasures.length;j++){if(g.items[i].NAME===t.chartMeasures[j].name){g.items[i].AXIS=t.chartMeasures[j].axis;break}}}}this._oModel.setData(g)}this._updateMeasureDimensionBindings();this._editMeasureDialog.close();this.refreshChart()},onEditDialogCancel:function(){this.restorePrevConfig();this._updateMeasureDimensionBindings();this._editMeasureDialog.close()},_getColorPaletteTemplate:function(b){var i=new sap.ui.core.Icon({color:{path:"SB_DDACONFIG>color",formatter:this.formatcolor},src:"sap-icon://color-fill",size:"32px",width:"5%",press:function(e){var a=b.getModel("SB_DDACONFIG").getProperty("/COLOR_SCHEME");a=(a=="MANUAL_NON_SEMANTIC")?"COLOR1":(a=="MANUAL_SEMANTIC")?"COLOR2":"";b.getBindingContext().getObject()[a]=this.getBindingContext("SB_DDACONFIG").getProperty("color");b.getModel().refresh()}});var c=new sap.m.Label({text:{path:"SB_DDACONFIG>index",formatter:function(a){var t="";switch(a){case 1:t="Neutral";break;case 4:t="Good";break;case 7:t="Warning";break;case 10:t="Bad"}return t}},visible:{path:"SB_DDACONFIG>/COLOR_SCHEME",formatter:function(s){return s=="MANUAL_SEMANTIC"}}});return new sap.m.HBox({items:[i,c]})},showColorPopUp:function(e){var c;var b=e.getSource();var a=this._oModel.getProperty("/COLOR_SCHEME");var d=new sap.m.VBox();d.bindAggregation("items","SB_DDACONFIG>/"+a,this._getColorPaletteTemplate(b));var f=new sap.m.Popover({visible:{path:"SB_DDACONFIG>/COLOR_SCHEME",formatter:function(s){return s=="MANUAL_SEMANTIC"||s=="MANUAL_NON_SEMANTIC"}},showHeader:false,content:[d],});f.setModel(this._oModel,"SB_DDACONFIG");f.openBy(b)},onEditDialogCloseButton:function(){this._editMeasureDialog.close()},onSingleDualChange:function(){var t=this;var s=((this.getView().byId(sap.ui.core.Fragment.createId("chartTypeConfig","singleDual"))).getSelectedKey()).toUpperCase();switch(s){case"SINGLE":this.refreshChart();break;case"DUAL":if(this.chartMeasures.length<2){sap.m.MessageBox.alert(t._oTextsModel.getResourceBundle().getText("DUAL_AXIS_CHART_MIN_MEASURE"),{onClose:function(){t.getView().byId(sap.ui.core.Fragment.createId("chartTypeConfig","singleDual")).setSelectedKey("SINGLE")}})}else{var D=new sap.ui.model.json.JSONModel();D.setData({DATA:this.chartMeasures});this._dualAxisConfig.setModel(D,"DUAL_AXIS_MODEL");this.setStacking(true,"M",this._oModel.getData().items);sap.ui.core.Fragment.byId("dualAxisConfig","select_msr_for_axis_lbl").setText(t._oTextsModel.getResourceBundle().getText("SELECT_MEASURE_FOR_AXIS"," "));sap.ui.core.Fragment.byId("dualAxisConfig","axis_1_label").setText(t._oTextsModel.getResourceBundle().getText("AXIS",1));sap.ui.core.Fragment.byId("dualAxisConfig","axis_2_label").setText(t._oTextsModel.getResourceBundle().getText("AXIS",2));sap.ui.core.Fragment.byId("dualAxisConfig","In_stack1_label").setText(t._oTextsModel.getResourceBundle().getText("IN_STACK",1));var d=this.getMeasuresByAxis(this.chartMeasures);sap.ui.core.Fragment.byId("dualAxisConfig","stack1MsrsLabel").setText(d.axis1.nameArr.join(","));sap.ui.core.Fragment.byId("dualAxisConfig","stack2MsrsLabel").setText(d.axis2.nameArr.join(","));if(d.axis1.nameArr.length){sap.ui.core.Fragment.byId("dualAxisConfig","AxisMsr1").setSelectedKey(d.axis1.nameArr[0])};if(d.axis2.nameArr.length){sap.ui.core.Fragment.byId("dualAxisConfig","AxisMsr2").setSelectedKey(d.axis2.nameArr[0])};this._dualAxisConfig.open()}break;default:break}},onDualAxisDialogOk:function(){var t=this;var a=sap.ui.getCore().byId(sap.ui.core.Fragment.createId("dualAxisConfig","AxisMsr1"));var b=sap.ui.getCore().byId(sap.ui.core.Fragment.createId("dualAxisConfig","AxisMsr2"));if(a.getSelectedKey()===b.getSelectedKey()){jQuery.sap.log.error("Same measure chosen for both axes")}var c=this._oModel.getData();for(var i=0;i<c.items.length;i++){if(c.items[i].TYPE.toUpperCase()==="MEASURE"){c.items[i].AXIS=2;for(var j=0;j<t.chartMeasures.length;j++){if(c.items[i].NAME===t.chartMeasures[j].name){c.items[i].AXIS=t.chartMeasures[j].axis;break}}}}this._oModel.setData(c);this.refreshChart();this._dualAxisConfig.close()},onDualAxisDialogCancel:function(){this.getView().byId(sap.ui.core.Fragment.createId("chartTypeConfig","singleDual")).setSelectedKey("SINGLE");this._dualAxisConfig.close()},setStackMsrs:function(){var t=this;var a=sap.ui.getCore().byId(sap.ui.core.Fragment.createId("dualAxisConfig","AxisMsr1"));var b=sap.ui.getCore().byId(sap.ui.core.Fragment.createId("dualAxisConfig","AxisMsr2"));if(a.getSelectedKey()===b.getSelectedKey()){sap.m.MessageBox.alert(t._oTextsModel.getResourceBundle().getText("SAME_MEASURE_CHOSEN_FOR_BOTH_AXES"));jQuery.sap.log.error("Same measure chosen for both axes")}else{for(var i=0;i<t.chartMeasures.length;i++){if(t.chartMeasures[i].name===a.getSelectedKey()){t.chartMeasures[i].axis=1}else if(t.chartMeasures[i].name===b.getSelectedKey()){t.chartMeasures[i].axis=2}}var d=this.getMeasuresByAxis(this.chartMeasures);sap.ui.core.Fragment.byId("dualAxisConfig","stack1MsrsLabel").setText(d.axis1.nameArr.join(","));sap.ui.core.Fragment.byId("dualAxisConfig","stack2MsrsLabel").setText(d.axis2.nameArr.join(","))}},setStackMsrs_edit:function(){var t=this;var a=sap.ui.getCore().byId(sap.ui.core.Fragment.createId("editDialog","AxisMsr1_edit"));var b=sap.ui.getCore().byId(sap.ui.core.Fragment.createId("editDialog","AxisMsr2_edit"));if(a.getSelectedKey()===b.getSelectedKey()){sap.m.MessageBox.alert(t._oTextsModel.getResourceBundle().getText("SAME_MEASURE_CHOSEN_FOR_BOTH_AXES"));jQuery.sap.log.error("Same measure chosen for both axes")}else{for(var i=0;i<t.chartMeasures.length;i++){if(t.chartMeasures[i].name===a.getSelectedKey()){t.chartMeasures[i].axis=1}else if(t.chartMeasures[i].name===b.getSelectedKey()){t.chartMeasures[i].axis=2}}var d=this.getMeasuresByAxis(this.chartMeasures);sap.ui.core.Fragment.byId("editDialog","stack1MsrsLabel_edit").setText(d.axis1.nameArr.join(","));sap.ui.core.Fragment.byId("editDialog","stack2MsrsLabel_edit").setText(d.axis2.nameArr.join(","))}},formatAxisToBool:function(a){if(a===1)return true;else return false},openMsrDialogForStack1:function(){var t=this;if(!this._msrDialogForStack1){this._msrDialogForStack1=sap.ui.xmlfragment("msrDialogForStack1","sap.suite.ui.smartbusiness.designtime.drilldown.view.msrDialogForStack1",this)}var S=new sap.ui.model.json.JSONModel();S.setData({DATA:t.chartMeasures});this._msrDialogForStack1.setModel(S);this._msrDialogForStack1.open()},onSearchInStack1SelectDialog:function(e){var v=e.getParameter("value");var f=new sap.ui.model.Filter("name",sap.ui.model.FilterOperator.Contains,v);var b=e.getSource().getBinding("items");b.filter([f])},onStack1SelectDialogOK:function(e){var t=this;var c=e.getParameter("selectedItems");if(c.length){for(var i=0;i<t.chartMeasures.length;i++){t.chartMeasures[i].axis=2;for(var j=0;j<c.length;j++){if(t.chartMeasures[i].name===c[j].getTitle()){t.chartMeasures[i].axis=1;break}}}e.getSource().getBinding("items").filter([]);var d=this.getMeasuresByAxis(this.chartMeasures);sap.ui.core.Fragment.byId("dualAxisConfig","stack1MsrsLabel").setText(d.axis1.nameArr.join(","));sap.ui.core.Fragment.byId("dualAxisConfig","stack2MsrsLabel").setText(d.axis2.nameArr.join(","));if(d.axis1.nameArr.length){sap.ui.core.Fragment.byId("dualAxisConfig","AxisMsr1").setSelectedKey(d.axis1.nameArr[0])};if(d.axis2.nameArr.length){sap.ui.core.Fragment.byId("dualAxisConfig","AxisMsr2").setSelectedKey(d.axis2.nameArr[0])};sap.ui.core.Fragment.byId("editDialog","stack1MsrsLabel_edit").setText(d.axis1.nameArr.join(","));sap.ui.core.Fragment.byId("editDialog","stack2MsrsLabel_edit").setText(d.axis2.nameArr.join(","));if(d.axis1.nameArr.length){sap.ui.core.Fragment.byId("editDialog","AxisMsr1_edit").setSelectedKey(d.axis1.nameArr[0])};if(d.axis2.nameArr.length){sap.ui.core.Fragment.byId("editDialog","AxisMsr2_edit").setSelectedKey(d.axis2.nameArr[0])}}else{sap.suite.smartbusiness.utils.showErrorMessage(t._oTextsModel.getResourceBundle().getText("SELECT_MEASURE_FOR_AXIS",1))}},onStack1SelectDialogCancel:function(){},onDataModeChange:function(){this.refreshChart()},onIsAbsoluteChange:function(){var v=((this.getView().byId(sap.ui.core.Fragment.createId("chartTypeConfig","isAbsolute"))).getSelectedKey()).toUpperCase();if(v==="PERCENTAGE")this.setStacking(true,"M",this._oModel.getData().items);this.refreshChart()},onSemanticColorOptionChange:function(){this.refreshChart();if(this.getView().byId(sap.ui.core.Fragment.createId("chartTypeConfig","semanticColors")).getSelectedKey()=="AUTO_SEMANTIC"){var f=[];var a={"type":(new sap.ui.model.Filter("TYPE",sap.ui.model.FilterOperator.EQ,"MEASURE")),"selected":(new sap.ui.model.Filter("SELECTED",sap.ui.model.FilterOperator.EQ,true)),};for(var i in a){f.push(a[i])}var s=sap.ui.getCore().byId(sap.ui.core.Fragment.createId("thresholdDialog","thresholdMeasure"));var b=s.getItems()?s.getItems():[];if(b.length&&s.getBinding('items')){s.getBinding('items').filter(f)}if(this._oModel.getData().THRESHOLD_MEASURE)s.setSelectedKey(this._oModel.getData().THRESHOLD_MEASURE);this.addThresholdMeasureDialog.open()}},onThresholdMeasureAdded:function(){this._oModel.getData().THRESHOLD_MEASURE=sap.ui.getCore().byId(sap.ui.core.Fragment.createId("thresholdDialog","thresholdMeasure")).getSelectedKey();this.copyConfigSnapshot();this.refreshChart();this.addThresholdMeasureDialog.close()},onThresholdMeasureCancel:function(){this.addThresholdMeasureDialog.close()},getLAISOfromSPRAS:function(k){var a=this.getView().getModel('SB_DDACONFIG').getData().ALL_LANGUAGES;for(var i=0;i<a.length;++i){if(a[i]["SPRAS"]==k)return a[i]["LAISO"]}},getIndexOfDuplicate:function(d,l){for(var i=0;i<d.length;++i){if(d[i]["SAP_LANGUAGE_KEY"]==l)return i}return-1},openAdditionalLanguagesDialog:function(){var a=this;this.AdditionalLanguagesDialog.setModel(this._oTextsModel,"i18n");this.copyConfigSnapshot();sap.ui.core.Fragment.byId("additionalLanguageDialog","newTitle").setValue("");var A=sap.ui.core.Fragment.byId("additionalLanguageDialog","ALTable");A.bindAggregation("items","SB_DDACONFIG>/ADDITIONAL_LANGUAGE_TITLES",new sap.m.ColumnListItem({cells:[new sap.m.Label({text:"{SB_DDACONFIG>TEXT}"}),new sap.m.Label({text:{path:"SB_DDACONFIG>SAP_LANGUAGE_KEY",formatter:function(s){return a.getLAISOfromSPRAS(s)}}}),new sap.ui.core.Icon({src:"sap-icon://decline",press:this.deleteEntry})],visible:{path:"SB_DDACONFIG>SAP_LANGUAGE_KEY",formatter:function(s){return s!=a._oModel.getData()["CURRENT_LANGUAGE"]}}}));this.AdditionalLanguagesDialog.open();return},closeAdditionalLanguagesDialog_OK:function(e){this.copyConfigSnapshot();this.AdditionalLanguagesDialog.close();return},closeAdditionalLanguagesDialog_Cancel:function(e){this.restorePrevConfig();this.AdditionalLanguagesDialog.close();return},deleteEntry:function(e){var b=e.getSource().getParent().getBindingContextPath();var i=parseInt(b.split("/").pop());var A=sap.ui.core.Fragment.byId("additionalLanguageDialog","ALTable");A.getModel("SB_DDACONFIG").getData()["ADDITIONAL_LANGUAGE_TITLES"].splice(i,1);A.getModel("SB_DDACONFIG").refresh();return},addEntry:function(){var n=sap.ui.core.Fragment.byId("additionalLanguageDialog","newTitle").getValue();var a=sap.ui.core.Fragment.byId("additionalLanguageDialog","newTitleLanguage").getSelectedKey();if(n&&a){}else return;var A=sap.ui.core.Fragment.byId("additionalLanguageDialog","ALTable");var t=A.getModel("SB_DDACONFIG").getData();var b={EVALUATION_ID:this.DDA_MODEL.getConfigurator().evaluationId,CONFIGURATION_ID:this._oModel.getData().ID,SAP_LANGUAGE_KEY:a,TEXT:n,IS_ACTIVE:this._oModel.getData()["IS_ACTIVE"]||1};var i;if((i=this.getIndexOfDuplicate(t["ADDITIONAL_LANGUAGE_TITLES"],a))==-1)t["ADDITIONAL_LANGUAGE_TITLES"].push(b);else{t["ADDITIONAL_LANGUAGE_TITLES"].splice(i,1);t["ADDITIONAL_LANGUAGE_TITLES"].push(b)}A.getModel("SB_DDACONFIG").refresh();return},formatName:function(a,b){return a+" "+b},refreshChart:function(){var c=this;this.canSave=false;var b=this.getView().byId("chartToolbar_config").getToolBar().getContentRight();if(b){if(b[0]&&(!(b[0].getVisible()))){b[0].setVisible(true)}if(b[1]&&(!(b[1].getVisible()))){b[1].setVisible(true)}if(b[3]&&(!(b[3].getVisible()))){b[3].setVisible(true)}if(b[0])b[0].firePress()}this.oChartDataModel=new sap.ui.model.json.JSONModel();this.oChartData=[];this.dda_chart=this.getView().byId("oChartRef");this.dda_chart.setStackedChartWidthEnhancer(false);this.dda_table=this.getView().byId("oChartTable");var t=this._oModel.getData();this.dda_config={};this.dda_config.chartConfig={mode:t.DATA_MODE||"DUMMY",title:"",dataLimit:t.DATA_LIMIT||null,dataLimitations:t.DATA_LIMITATIONS||false,type:(t.CHART_TYPE).toUpperCase()||"BAR",axis:t.AXIS_TYPE||"SINGLE",value:t.VALUE_TYPE||"ABSOLUTE",colorScheme:t.COLOR_SCHEME||"NONE",thresholdMeasure:t.THRESHOLD_MEASURE||""};this.dda_config.columnsConfig=[];for(var i=0;i<t.items.length;i++){this.dda_config.columnsConfig.push({name:t.items[i].NAME,type:t.items[i].TYPE,selected:t.items[i].SELECTED||false,visibility:t.items[i].VISIBILITY||"BOTH",sortOrder:t.items[i].SORT_ORDER||"NONE",sortBy:t.items[i].SORT_BY||"",axis:t.items[i].AXIS||2,stacking:t.items[i].STACKING||0,color:t.COLOR_SCHEME=="MANUAL_NON_SEMANTIC"?t.items[i].COLOR1:t.COLOR_SCHEME=="MANUAL_SEMANTIC"?t.items[i].COLOR2:""})}this.oColumns=[];this.oDimensions=[];this.oMeasures=[];this.dimNameArray=[];this.msrNameArray=[];this.chartDimensions=[];this.chartDimNames=[];this.chartMeasures=[];this.chartMsrNames=[];this.tableDimensions=[];this.tableDimNames=[];this.tableMeasures=[];this.tableMsrNames=[];for(var i=0;i<this.dda_config.columnsConfig.length;i++){if(this.dda_config.columnsConfig[i].selected){this.oColumns.push(this.dda_config.columnsConfig[i]);if((this.dda_config.columnsConfig[i].type).toUpperCase()==="DIMENSION"){this.oDimensions.push(this.dda_config.columnsConfig[i]);this.dimNameArray.push(this.dda_config.columnsConfig[i].name);if(((this.dda_config.columnsConfig[i].visibility).toUpperCase()==="CHART")||((this.dda_config.columnsConfig[i].visibility).toUpperCase()==="BOTH")){this.chartDimensions.push(this.dda_config.columnsConfig[i]);this.chartDimNames.push(this.dda_config.columnsConfig[i].name)}if(((this.dda_config.columnsConfig[i].visibility).toUpperCase()==="TABLE")||((this.dda_config.columnsConfig[i].visibility).toUpperCase()==="BOTH")){this.tableDimensions.push(this.dda_config.columnsConfig[i]);this.tableDimNames.push(this.dda_config.columnsConfig[i].name)}}else if((this.dda_config.columnsConfig[i].type).toUpperCase()==="MEASURE"){this.oMeasures.push(this.dda_config.columnsConfig[i]);this.msrNameArray.push(this.dda_config.columnsConfig[i].name);if(((this.dda_config.columnsConfig[i].visibility).toUpperCase()==="CHART")||((this.dda_config.columnsConfig[i].visibility).toUpperCase()==="BOTH")){this.chartMeasures.push(this.dda_config.columnsConfig[i]);this.chartMsrNames.push(this.dda_config.columnsConfig[i].name)}if(((this.dda_config.columnsConfig[i].visibility).toUpperCase()==="TABLE")||((this.dda_config.columnsConfig[i].visibility).toUpperCase()==="BOTH")){this.tableMeasures.push(this.dda_config.columnsConfig[i]);this.tableMsrNames.push(this.dda_config.columnsConfig[i].name)}}}}if((!(this.chartDimensions.length))||(!(this.chartMeasures.length))){this.dda_chart.setDataset(new sap.viz.core.FlattenedDataset({}));return}this.stacking=this.getStacking(this.chartMeasures,this.chartDimensions);this.isStackMsr=false;this.isStackDim=false;if(this.stacking.isEnabled&&(this.stacking.type=="M"))this.isStackMsr=true;else if(this.stacking.isEnabled&&(this.stacking.type=="D"))this.isStackDim=true;this.sapCaChartType=this.getSapCaChartType();this.dda_chart.setAdvancedChartSettings({plotArea:{animation:{dataLoading:false,dataUpdating:false,resizing:false}},legend:{title:{visible:false}}});if((this.dda_config.chartConfig.mode).toUpperCase()==="DUMMY"){this.oChartData=this.getDummyDataForChart(this.dimNameArray,this.msrNameArray);this.oChartDataModel.setData({businessData:c.oChartData})}else if((this.dda_config.chartConfig.mode).toUpperCase()==="RUNTIME"){this.getRuntimeChartData(this.dimNameArray,this.msrNameArray,this.oDimensions,this.oMeasures)}try{var p=sap.suite.smartbusiness.odata.properties(this._oModel.getData().QUERY_SERVICE_URI,this._oModel.getData().QUERY_ENTITY_SET)}catch(e){jQuery.sap.log.error("Failed to instantiate the odata model");throw e}this.column_labels_mapping=p.getLabelMappingObject();this.dimension_text_property_mapping=p.getTextPropertyMappingObject();this.measure_unit_property_mapping=p.getUnitPropertyMappingObject();if((this.sapCaChartType).toUpperCase()==="TABLE"){this.updateTable(this.tableDimensions,this.tableMeasures);if(b){if(b[0]){b[0].setVisible(false)}if(b[1]){b[1].setVisible(true)}if(b[3]){b[3].setVisible(false)}if(b[1]){b[1].firePress()}}this.canSave=true;return}if((((this.dda_config.chartConfig.type).toUpperCase()=="BAR")&&(this.dda_config.chartConfig.axis=="DUAL"))||(((this.dda_config.chartConfig.type).toUpperCase()=="COLUMN")&&(this.dda_config.chartConfig.axis=="DUAL"))){if(this.chartMeasures.length<2){sap.m.MessageBox.alert(c._oTextsModel.getResourceBundle().getText("DUAL_AXIS_CHART_MIN_MEASURE"),{onClose:function(){if(c._config)c.restorePrevConfig();else c.restoreFromConfigMasterSnapShot();c.onChartTypeChange();c.refreshChart()}});return}}if((((this.dda_config.chartConfig.type).toUpperCase()=="BAR")&&(this.dda_config.chartConfig.axis=="DUAL"))||(((this.dda_config.chartConfig.type).toUpperCase()=="COLUMN")&&(this.dda_config.chartConfig.axis=="DUAL"))){var a=false;var d=false;for(var i=0;i<this.chartMeasures.length;i++){if(this.chartMeasures[i].axis==1)a=true;else if(this.chartMeasures[i].axis==2)d=true}if(!(a)||!(d)){sap.m.MessageBox.alert(c._oTextsModel.getResourceBundle().getText("SELECT_MEASURE_FOR_AXIS",(a?2:1)),{onClose:function(){if(c._config)c.restorePrevConfig();else c.restoreFromConfigMasterSnapShot();c.onChartTypeChange();c.refreshChart()}});return}}if(((this.dda_config.chartConfig.type).toUpperCase()==="BUBBLE")&&(this.chartMeasures.length<3)){sap.m.MessageBox.alert(c._oTextsModel.getResourceBundle().getText("BUBBLE_CHART_MEASURE_COUNT"),{onClose:function(){if(c._config&&(((c._config.CHART_TYPE).toUpperCase()!="BUBBLE")||(c.getSelectedMeasuresCount(c._config.COLUMNS)>=3)))c.restorePrevConfig();else c.restoreFromConfigMasterSnapShot();c.onChartTypeChange();c.refreshChart()}});return}if((this.dda_config.chartConfig.type).toUpperCase()==="BUBBLE"){this.oDataset=this.create_Dataset(this.chartDimensions,this.chartMeasures);this.dda_chart.setDataset(this.oDataset)}this.dda_chart.setChartType(this.sapCaChartType);this.oDataset=this.create_Dataset(this.chartDimensions,this.chartMeasures);var f=this.dda_config.chartConfig.type;var g=this.dda_config.chartConfig.axis;var v=this.dda_config.chartConfig.value;var l=new sap.ui.core.Locale(sap.ui.getCore().getConfiguration().getLanguage());var h=sap.ca.ui.model.format.NumberFormat.getInstance({},l);if((f=='BAR')&&(v=="ABSOLUTE")){this.dda_chart.setXAxisLabelFormatter(this.formatChartNumbers.bind(this));this.dda_chart.setYAxisLabelFormatter(this.pseudoChartFormatter);if(g=='DUAL'){this.dda_chart.setXAxis2LabelFormatter(this.formatChartNumbers.bind(this))}}else if(f=='BUBBLE'){this.dda_chart.setXAxisLabelFormatter(this.formatChartNumbers.bind(this));this.dda_chart.setYAxisLabelFormatter(this.formatChartNumbers.bind(this))}else if(((f=='BAR')||(f=='COLUMN'))&&(v=='PERCENTAGE')){if(f=='BAR'){this.dda_chart.setXAxisLabelFormatter(function(r){return h.format_percentage(r)});this.dda_chart.setYAxisLabelFormatter(this.pseudoChartFormatter);if(g=='DUAL'){this.dda_chart.setXAxis2LabelFormatter(function(r){return h.format_percentage(r)})}}else{this.dda_chart.setYAxisLabelFormatter(function(r){return h.format_percentage(r)});this.dda_chart.setXAxisLabelFormatter(this.pseudoChartFormatter);if(g=='DUAL'){this.dda_chart.setYAxis2LabelFormatter(function(r){return h.format_percentage(r)})}}}else{this.dda_chart.setYAxisLabelFormatter(this.formatChartNumbers.bind(this));this.dda_chart.setXAxisLabelFormatter(this.pseudoChartFormatter);if((f=='COLUMN')&&(g=='DUAL')){this.dda_chart.setYAxis2LabelFormatter(this.formatChartNumbers.bind(this))}}this.dda_chart.setDataLabelFormatter([[this.formatChartNumbers.bind(this)],[this.formatChartNumbers.bind(this)],[this.formatChartNumbers.bind(this)]]);var j=[[],[],[]];for(var k=0;k<this.chartMsrNames.length;k++){j[0].push(this.getChartNumberFormatter(true));j[1].push(this.getChartNumberFormatter(true));j[2].push(this.getChartNumberFormatter(true))}this.dda_chart.setPopoverFormatter(j);if(((f=='BAR')||(f=='COLUMN'))&&(v=='PERCENTAGE')){var j=[[],[],[]];for(var k=0;k<this.chartMsrNames.length;k++){j[0].push(c.getChartPercentFormatter(true));j[1].push(c.getChartPercentFormatter(true))}this.dda_chart.setPopoverFormatter(j)}if(((this.dda_config.chartConfig.mode).toUpperCase()==="RUNTIME")&&(this.EVALUATION.getScaling()==-2)&&!(((f=='BAR')||(f=='COLUMN'))&&(v=='PERCENTAGE'))){this.addPercentToChart(this.chartMsrNames)}this.dda_chart.setDataset(this.oDataset);this.dda_chart.setModel(this.oChartDataModel);this.showChartLegendIfApplicable(this.chartDimNames,this.chartMsrNames);if((this.dda_config.chartConfig.type=="BAR")||(this.dda_config.chartConfig.type=="COLUMN")||(this.dda_config.chartConfig.type=="COMBINATION")||(this.dda_config.chartConfig.type=="LINE")){if((this.dda_config.chartConfig.colorScheme).toUpperCase()==="AUTO_SEMANTIC"){var m=this.dda_config.chartConfig.thresholdMeasure||"";var n=[];var o=-1;for(var i=0;i<this.chartMeasures.length;i++){n.push({color:sap.ca.ui.charts.ChartSemanticColor.GoodLight});if(this.chartMeasures[i].name===m)o=i}if(o>=0)n[o].color=sap.ca.ui.charts.ChartSemanticColor.Neutral;this.applyCustomColoring(this.dda_chart,this.dda_config.chartConfig.colorScheme,n,m,this.DDA_MODEL.EVALUATION_DATA.GOAL_TYPE)}else if(((this.dda_config.chartConfig.colorScheme).toUpperCase()==="MANUAL_SEMANTIC")||((this.dda_config.chartConfig.colorScheme).toUpperCase()==="MANUAL_NON_SEMANTIC")){this.applyCustomColoring(this.dda_chart,this.dda_config.chartConfig.colorScheme,this.chartMeasures)}}this.updateTable(this.tableDimensions,this.tableMeasures);this.canSave=true;this.copyConfigSnapshot()},getSapCaChartType:function(){var s=sap.ca.ui.charts.ChartType.Bar;var c=this.dda_config.chartConfig.type;var a=this.dda_config.chartConfig.axis;var v=this.dda_config.chartConfig.value;var b=(this.isStackMsr||(this.isStackDim&&(this.chartDimensions.length>1)))?true:false;switch(c){case"BAR":if(a==="SINGLE"){if(v==="ABSOLUTE"){if(b){s=sap.ca.ui.charts.ChartType.StackedBar}else{s=sap.ca.ui.charts.ChartType.Bar}}else if(v==="PERCENTAGE"){s=sap.ca.ui.charts.ChartType.StackedBar100}}else if(a==="DUAL"){if(v==="ABSOLUTE"){s=sap.ca.ui.charts.ChartType.DualStackedBar}else if(v==="PERCENTAGE"){s=sap.ca.ui.charts.ChartType.DualStackedBar100}}break;case"COLUMN":if(a==="SINGLE"){if(v==="ABSOLUTE"){if(b){s=sap.ca.ui.charts.ChartType.StackedColumn}else{s=sap.ca.ui.charts.ChartType.Column}}else if(v==="PERCENTAGE"){s=sap.ca.ui.charts.ChartType.StackedColumn100}}else if(a==="DUAL"){if(v==="ABSOLUTE"){s=sap.ca.ui.charts.ChartType.DualStackedColumn}else if(v==="PERCENTAGE"){s=sap.ca.ui.charts.ChartType.DualStackedColumn100}}break;case"LINE":s=sap.ca.ui.charts.ChartType.Line;break;case"COMBINATION":s=sap.ca.ui.charts.ChartType.Combination;break;case"BUBBLE":s=sap.ca.ui.charts.ChartType.Bubble;break;case"TABLE":s="TABLE";break;default:s=sap.ca.ui.charts.ChartType.Bar}return s},showChartLegendIfApplicable:function(d,m){var t=this;var o=this.getView().byId("chartToolbar_config");var c=this.dda_config.chartConfig.type;var i=(((c=="BAR")||(c=="COLUMN"))&&(this.isStackDim)&&(this.getDimensionToBeStacked(t.chartDimensions))&&(d.length>1))?true:false;if((m.length>1)||(i)){o.setShowLegend(true)}else{o.setShowLegend(false)}},getStacking:function(m,d){var s={};s.isEnabled=false;s.type="none";for(var i=0;i<m.length;i++){if(m[i].stacking===1){s.isEnabled=true;s.type="M"}}if(!(s.isEnabled)){for(var i=0;i<d.length;i++){if(d[i].stacking===1){s.isEnabled=true;s.type="D"}}}return s},setStacking:function(a,t,c){var b=this;if(a){if(t=="M"){for(var i=0;i<c.length;i++){if((c[i].TYPE).toUpperCase()==="MEASURE"){c[i].STACKING=1}else if((c[i].TYPE).toUpperCase()==="DIMENSION"){c[i].STACKING=0}}}else if(t=="D"){for(var i=0;i<c.length;i++){if((c[i].TYPE).toUpperCase()==="MEASURE"){c[i].STACKING=0}else if((c[i].TYPE).toUpperCase()==="DIMENSION"){c[i].STACKING=1}}}}else{for(var i=0;i<c.length;i++){c[i].STACKING=0}}},getDimensionToBeStacked:function(d){var D=null;for(var i=0;i<d.length;i++){if(d[i].axis===2){D=d[i];break}}return D},setDimensionToBeStacked:function(c,s){if(s){for(var i=0;i<c.length;i++){if((c[i].TYPE).toUpperCase()==="DIMENSION"){c[i].AXIS=1;if(c[i].NAME===s){c[i].AXIS=2}}}}},updateColumnProperty:function(c,n,p,v){for(var i=0;i<c.length;i++){if(c[i].NAME===n){(c[i])[p]=v;break}}},getMeasuresByAxis:function(c){var d={};d.axis1={};d.axis1.objArr=[];d.axis1.nameArr=[];d.axis2={};d.axis2.objArr=[];d.axis2.nameArr=[];for(var i=0;i<c.length;i++){if(c[i].axis===1){d.axis1.objArr.push(c[i]);d.axis1.nameArr.push(c[i].name)}else if(c[i].axis===2){d.axis2.objArr.push(c[i]);d.axis2.nameArr.push(c[i].name)}}return d},getAxisOfMsr:function(m){var a=2;for(var i=0;i<this.chartMeasures.length;i++){if((this.chartMeasures[i]).name===m){a=(this.chartMeasures[i]).axis;break}}return a},getSelectedMeasuresCount:function(m){var c=0;for(var i=0;i<m.length;i++){if((m[i].TYPE).toUpperCase()=="MEASURE"&&(m[i].SELECTED))++c}return c},create_Dataset:function(d,m){var c=this;var a=this.dda_config.chartConfig.type||"BAR";var b=this.dda_config.chartConfig.axis||"SINGLE";var v=this.dda_config.chartConfig.value||"ABSOLUTE";var s=this.isStackMsr;var e=this.getDimensionToBeStacked(d);var f=new sap.viz.core.FlattenedDataset({data:{path:"/businessData"}});for(var i=0;i<d.length;i++){var g=((this.dda_config.chartConfig.mode).toUpperCase()==="RUNTIME")?this.dimension_text_property_mapping[d[i].name]:d[i].name;var A=1;if(((a=="BAR")||(a=="COLUMN"))&&(this.isStackDim)&&(e)&&(g===e.name)&&(d.length>1)){A=2;this.dda_chart.setStackedChartWidthEnhancer(true)}var h=new sap.viz.ui5.data.DimensionDefinition({axis:A,value:"{"+g+"}",name:this.column_labels_mapping[d[i].name]||d[i].name});f.addDimension(h)}if((a=="LINE")||(a=="COMBINATION")||((a=="BAR")&&(b=="SINGLE"))||((a=="COLUMN")&&(b=="SINGLE"))){for(var i=0;i<m.length;i++){var g=m[i].name;var j=new sap.viz.ui5.data.MeasureDefinition({name:this.column_labels_mapping[g]||g,value:"{"+g+"}"});f.addMeasure(j)}}else if(a=="BUBBLE"){for(var i=0;i<3;i++){var g=m[i].name;var j=new sap.viz.ui5.data.MeasureDefinition({group:i+1,name:this.column_labels_mapping[g]||g,value:"{"+g+"}",});f.addMeasure(j)}}else if(((a=="BAR")&&(b=="DUAL"))||((a=="COLUMN")&&(b=="DUAL"))){for(var i=0;i<m.length;i++){var g=m[i].name;var k=(m[i].axis==1||m[i].axis==2)?m[i].axis:2;var j=new sap.viz.ui5.data.MeasureDefinition({group:k,name:this.column_labels_mapping[g]||g,value:"{"+g+"}"});f.addMeasure(j)}}return f},_getValueState:function(a,t){if(!this.EVALUATION.isTargetKpi()){if(a<t){return this.EVALUATION.isMaximizingKpi()?sap.ui.core.ValueState.Error:sap.ui.core.ValueState.Success}else if(a==t){return sap.ui.core.ValueState.None}else{return this.EVALUATION.isMaximizingKpi()?sap.ui.core.ValueState.Success:sap.ui.core.ValueState.Error}}else{return sap.ui.core.ValueState.None}},_getTableCellFormatter:function(o,i,a){var t=this;var f;var c=this.dda_config.chartConfig.type;var v=this.dda_config.chartConfig.value;var b=this.dda_config.chartConfig.axis;if(i){if(c.toUpperCase()=="TABLE"){if(t._isEvaluationThresholdMeasure(o))f=this.getChartPercentFormatter(true);else f=this.getChartNumberFormatter(true)}else if((b=='DUAL')&&(v=="ABSOLUTE")&&(c=='BAR'||c=='COLUMN')){if(a[(t.getAxisOfMsr(o))-1])f=this.getChartPercentFormatter(true);else f=this.getChartNumberFormatter(true)}else{f=this.getChartPercentFormatter(true)}}else f=this.getChartNumberFormatter(true);return f},_getTableCell:function(o,t,i,a){var b=this;if(t&&(o!==t)){return new sap.m.ObjectNumber({number:{path:o,formatter:b._getTableCellFormatter(o,i,a)},state:{parts:[{path:o},{path:t}],formatter:function(m,c){try{m=window.parseFloat(m);c=window.parseFloat(c);return b._getValueState(m,c)}catch(e){return sap.ui.core.ValueState.None}}}})}else{return new sap.m.Label({text:{path:o,formatter:b._getTableCellFormatter(o,i,a)}})}},updateTable:function(d,m){this.dda_table.destroyColumns();this.dda_table.destroyItems();for(var i=0;i<d.length;i++){var v=d[i].name;var L=new sap.m.Label({text:this.column_labels_mapping[v]||v});var c=new sap.m.Column({hAlign:"Left",header:L,minScreenWidth:"Tablet",demandPopin:true,});this.dda_table.addColumn(c)}for(var i=0;i<m.length;i++){var v=m[i].name;var L=new sap.m.Label({text:this.column_labels_mapping[v]||v});var c=new sap.m.Column({hAlign:"Right",header:L,minScreenWidth:"Tablet",demandPopin:true,});this.dda_table.addColumn(c)}var t=new sap.m.ColumnListItem({unread:false,});for(var i=0;i<d.length;i++){var v=((this.dda_config.chartConfig.mode).toUpperCase()==="RUNTIME")?this.dimension_text_property_mapping[d[i].name]:d[i].name;var o=new sap.m.Label({text:"{"+v+"}"});t.addCell(o)}var a=this._oModel.getData()["THRESHOLD_MEASURE"];var b=false;var e=this.dda_config.chartConfig.type;var f=this.dda_config.chartConfig.value;var g=this.dda_config.chartConfig.axis;if((this.sapCaChartType).toUpperCase()==="TABLE")var M=this.tableMsrNames;else var M=this.chartMsrNames;if(((this.dda_config.chartConfig.mode).toUpperCase()==="RUNTIME")&&(this.EVALUATION.getScaling()==-2)&&this.getIsPercentScaled(M)&&!(((e=='BAR')||(e=='COLUMN'))&&(f=='PERCENTAGE'))){b=true}var h=[];if(b){if((g=='DUAL')&&(f=="ABSOLUTE")&&(e=='BAR'||e=='COLUMN')){var j=this.getMeasuresByAxis(this.chartMeasures);h.push(this.getIsPercentScaled(j.axis1.nameArr));h.push(this.getIsPercentScaled(j.axis2.nameArr))}}for(var i=0;i<m.length;i++){var v=m[i].name;if(this._oModel.getData()["COLOR_SCHEME"]=="AUTO_SEMANTIC")var o=this._getTableCell(v,a,b,h);else var o=this._getTableCell(v,v,b,h);t.addCell(o)}this.dda_table.setModel(this.oChartDataModel);this.dda_table.bindAggregation("items","/businessData",t)},applyCustomColoring:function(c,a,b,t,i){var C=this;if((a).toUpperCase()==="AUTO_SEMANTIC"){if(((i=="MA")||(i=="MI"))&&t){C.setCustomColors(c,b,a);c.setChartSemanticColorFormatter(function(o){var d=c.getModel().getData().businessData;var e=o.ctx.path.dii_a1;var f=d[e];var r=f[t];if(r!=null&&typeof r!='undefined'){if(o.val>r){if(i=="MA")return sap.ca.ui.charts.ChartSemanticColor.GoodLight;else if(i=="MI")return sap.ca.ui.charts.ChartSemanticColor.BadLight}else if(o.val<r){if(i=="MA")return sap.ca.ui.charts.ChartSemanticColor.BadLight;else if(i=="MI")return sap.ca.ui.charts.ChartSemanticColor.GoodLight}else{return sap.ca.ui.charts.ChartSemanticColor.Neutral}}else{jQuery.sap.log.error("Threshold Measure:'"+t+"' not in Dataset. Error Applying Semantic Color");return sap.ca.ui.charts.ChartSemanticColor.NeutralLight}})}else{jQuery.sap.log.error("Threshold Measure not available or Goal type is RA . Error Applying Semantic Color")}}else if(((a).toUpperCase()==="MANUAL_SEMANTIC")||((a).toUpperCase()==="MANUAL_NON_SEMANTIC")){C.setCustomColors(c,b,a)}},setCustomColors:function(c,m,a){var d=c.getDataset();var b=d.getMeasures();var e="";if((a).toUpperCase()==="AUTO_SEMANTIC"||(a).toUpperCase()==="MANUAL_SEMANTIC")e=sap.ca.ui.charts.ChartSemanticColor.Neutral;for(var i=0;i<b.length;i++){b[i].addCustomData(new sap.ui.core.CustomData({key:"fillColor",value:m[i].color||e}))}},set_percentCharts_uom:function(){var c=this;var a=this.dda_config.chartConfig.type;var b=this.dda_config.chartConfig.axis;var v=this.dda_config.chartConfig.value;var m=[];for(var i=0;i<this.chartMsrNames.length;i++){m.push(this.column_labels_mapping[this.chartMsrNames[i]]||this.chartMsrNames[i])}var d=this.getMeasuresByAxis(this.chartMeasures);var e=[],f=[];for(var i=0;i<d.axis1.nameArr.length;i++){e.push(this.column_labels_mapping[d.axis1.nameArr[i]]||d.axis1.nameArr[i])}for(var i=0;i<d.axis2.nameArr.length;i++){f.push(this.column_labels_mapping[d.axis2.nameArr[i]]||d.axis2.nameArr[i])}var g=(b=='DUAL')?e.join(" & "):m.join(" & ");var C={};if(this.dda_chart)C=this.dda_chart.getAdvancedChartSettings()?this.dda_chart.getAdvancedChartSettings():{};if(((a=='BAR')||(a=="COLUMN"))&&(v=="PERCENTAGE")){if(a=='COLUMN'){C.yAxis={title:{visible:true,text:(g+" ("+(c._oTextsModel.getResourceBundle().getText("IN_PERCENTAGE"))+")")}};if(b=='DUAL'){C.yAxis2={title:{visible:true,text:(f.join(" & ")+" ("+(c._oTextsModel.getResourceBundle().getText("IN_PERCENTAGE"))+")")}}}}else if(a=='BAR'){C.xAxis={title:{visible:true,text:(g+" ("+(c._oTextsModel.getResourceBundle().getText("IN_PERCENTAGE"))+")")}};if(b=='DUAL'){C.xAxis2={title:{visible:true,text:(g+" ("+(c._oTextsModel.getResourceBundle().getText("IN_PERCENTAGE"))+")")}};C.xAxis={title:{visible:true,text:(f.join(" & ")+" ("+(c._oTextsModel.getResourceBundle().getText("IN_PERCENTAGE"))+")")}}}}if(this.dda_chart)this.dda_chart.setAdvancedChartSettings(C)}},formatChartNumbers:function(v){var l=new sap.ui.core.Locale(sap.ui.getCore().getConfiguration().getLanguage());function i(n){return!isNaN(parseFloat(n))&&isFinite(n)}if(i(v)){if(!this.chartFormatter){var d=1;jQuery.sap.require("sap.ca.ui.model.format.NumberFormat");if(d||d==0){this.chartFormatter=sap.ca.ui.model.format.NumberFormat.getInstance({style:'short',shortDecimals:d},l)}else{this.chartFormatter=sap.ca.ui.model.format.NumberFormat.getInstance({style:'short'},l)}}v=this.chartFormatter.format(v)}return v},pseudoChartFormatter:function(v){return v},getRuntimeChartData:function(d,m,a,b){var t=this;var c=this.getView().byId("chartToolbar_config");c.setBusy(true);var D=[];var M=[];d.forEach(function(x){D.push(x)});m.forEach(function(x){M.push(x)});this.COLUMNS_SORT=[];for(var i=0;i<t.oColumns.length;i++){if(t.oColumns[i].sortBy&&t.oColumns[i].sortOrder){if((t.oColumns[i].sortOrder).toUpperCase()=="ASC"||(t.oColumns[i].sortOrder).toUpperCase()=="DESC"){this.COLUMNS_SORT.push({name:t.oColumns[i].sortBy,order:t.oColumns[i].sortOrder});if(t.oColumns[i].sortBy!=t.oColumns[i].name){if((t.oColumns[i].type).toUpperCase()=="DIMENSION"){if((D.indexOf(t.oColumns[i].sortBy))==-1){D.push(t.oColumns[i].sortBy)}}else if((t.oColumns[i].type).toUpperCase()=="MEASURE"){if((M.indexOf(t.oColumns[i].sortBy))==-1){M.push(t.oColumns[i].sortBy)}}}}}}try{var u=sap.suite.smartbusiness.odata.getUri({serviceUri:this._oModel.getData().QUERY_SERVICE_URI,entitySet:this._oModel.getData().QUERY_ENTITY_SET,dimension:D,measure:M,filter:this.DDA_MODEL.EVALUATION_DATA.FILTERS.results,sort:this.COLUMNS_SORT,dataLimit:(((this.dda_config.chartConfig.dataLimitations)&&(this.dda_config.chartConfig.dataLimit>0))?(this.dda_config.chartConfig.dataLimit):null),});u.model.read(u.uri,null,null,true,function(f){if(f.results.length){t.oChartData=f.results;t.oChartDataModel.setData({businessData:t.oChartData})}else{jQuery.sap.log.info("Chart data Table Returned Empty Results");t.oChartData=[];t.oChartDataModel.setData({businessData:t.oChartData})}c.setBusy(false)},function(){jQuery.sap.log.error("Error fetching data : "+u.uri);t.oChartData=[];t.oChartDataModel.setData({businessData:t.oChartData});c.setBusy(false)})}catch(e){jQuery.sap.log.error(e.toString());t.oChartData=[];t.oChartDataModel.setData({businessData:t.oChartData});c.setBusy(false)}},getChartPercentFormatter:function(i){var l=new sap.ui.core.Locale(sap.ui.getCore().getConfiguration().getLanguage());function a(n){return!isNaN(parseFloat(n))&&isFinite(n)}var f={style:i?'standard':'short'};var c=sap.ca.ui.model.format.NumberFormat.getInstance(f,l);return function(s){return a(s)?c.format_percentage(s):s}},getChartNumberFormatter:function(i){var l=new sap.ui.core.Locale(sap.ui.getCore().getConfiguration().getLanguage());function a(n){return!isNaN(parseFloat(n))&&isFinite(n)}var f={style:i?'standard':'short'};var c=sap.ca.ui.model.format.NumberFormat.getInstance(f,l);return function(s){return a(s)?c.format(s):s}},getIsPercentScaled:function(m){if(this.thresholdMeasuresArray&&this.thresholdMeasuresArray.length){var t=this.thresholdMeasuresArray}else{var t=this._getEvaluationThresholdMeasures()}var a=false;if(t&&t.length){for(var i=0;i<m.length;i++){if(t.indexOf(m[i])!=-1){a=true;break}}}return a},_getEvaluationThresholdMeasures:function(){var t=[];t.push(this.EVALUATION.getKpiMeasureName());if(this.EVALUATION.getThresholdValueType()==="MEASURE"){var a=this.EVALUATION.getValues().results;if(a&&a.length){for(var i=0;i<a.length;i++){if((a[i]).COLUMN_NAME&&!((a[i]).FIXED)){t.push((a[i]).COLUMN_NAME)}}}}return t},_isEvaluationThresholdMeasure:function(m){if(this.thresholdMeasuresArray&&this.thresholdMeasuresArray.length){var t=this.thresholdMeasuresArray}else{var t=this._getEvaluationThresholdMeasures()}if(t&&t.length){if(t.indexOf(m)!=-1){return true}}return false},addPercentToChart:function(m){var t=this;var i=this.getIsPercentScaled(m);if(i){if(this.dda_chart){var c=this.dda_config.chartConfig.type;var a=this.dda_config.chartConfig.axis;var v=this.dda_config.chartConfig.value;if(((c=='BAR')||(c=='COLUMN'))&&(v=="ABSOLUTE")&&(a=='DUAL')){var b=this.getMeasuresByAxis(this.chartMeasures);var d=this.getIsPercentScaled(b.axis1.nameArr);var e=this.getIsPercentScaled(b.axis2.nameArr);var l=[[],[]];var f=[[],[],[]];if(d){l[0].push(t.getChartPercentFormatter());for(var k=0;k<b.axis1.nameArr.length;k++){f[0].push(t.getChartPercentFormatter(true))}}else{l[0].push(t.formatChartNumbers.bind(t));for(var k=0;k<b.axis1.nameArr.length;k++){f[0].push(t.getChartNumberFormatter(true))}}if(e){l[1].push(t.getChartPercentFormatter());for(var k=0;k<b.axis2.nameArr.length;k++){f[1].push(t.getChartPercentFormatter(true))}}else{l[1].push(t.formatChartNumbers.bind(t));for(var k=0;k<b.axis2.nameArr.length;k++){f[1].push(t.getChartNumberFormatter(true))}}this.dda_chart.setDataLabelFormatter(l);this.dda_chart.setPopoverFormatter(f);if(c=='BAR'){this.dda_chart.setXAxisLabelFormatter(d?t.getChartPercentFormatter():t.formatChartNumbers.bind(t));this.dda_chart.setYAxisLabelFormatter(t.pseudoChartFormatter);this.dda_chart.setXAxis2LabelFormatter(e?t.getChartPercentFormatter():t.formatChartNumbers.bind(t));this.dda_chart.setYAxis2LabelFormatter(t.pseudoChartFormatter)}else if(c=='COLUMN'){this.dda_chart.setXAxisLabelFormatter(t.pseudoChartFormatter);this.dda_chart.setYAxisLabelFormatter(d?t.getChartPercentFormatter():t.formatChartNumbers.bind(t));this.dda_chart.setXAxis2LabelFormatter(t.pseudoChartFormatter);this.dda_chart.setYAxis2LabelFormatter(e?t.getChartPercentFormatter():t.formatChartNumbers.bind(t))}}else{this.dda_chart.setDataLabelFormatter([[this.getChartPercentFormatter()],[this.getChartPercentFormatter()],[this.getChartPercentFormatter()]]);var f=[[],[],[]];for(var k=0;k<m.length;k++){f[0].push(t.getChartPercentFormatter(true));f[1].push(t.getChartPercentFormatter(true));f[2].push(t.getChartPercentFormatter(true))}this.dda_chart.setPopoverFormatter(f);if((c=='BAR')&&(v=="ABSOLUTE")){this.dda_chart.setXAxisLabelFormatter(t.getChartPercentFormatter());if(a=='DUAL'){this.dda_chart.setXAxis2LabelFormatter(t.getChartPercentFormatter())}}else if(c=='BUBBLE'){this.dda_chart.setXAxisLabelFormatter(t.getChartPercentFormatter());this.dda_chart.setYAxisLabelFormatter(t.getChartPercentFormatter())}else if(((c=='BAR')||(c=='COLUMN'))&&(v=='PERCENTAGE')){}else{this.dda_chart.setYAxisLabelFormatter(t.getChartPercentFormatter());if((c=='COLUMN')&&(a=='DUAL')){this.dda_chart.setYAxis2LabelFormatter(t.getChartPercentFormatter())}}}}}},getDummyDataForChart:function(d,m,M,D){M=M||5;D=D||10;var c=[];var t,a={};for(var i=0;i<d.length;i++){a[d[i]]=[];for(var j=0;j<M;j++){a[d[i]].push(d[i]+"_"+j)}}for(var i=0;i<D;i++){t={};for(var j=0;j<d.length;j++){var b=a[d[j]].length;var p=sap.suite.smartbusiness.utils.getRandomNumber(b);t[d[j]]=a[d[j]][p]}for(var j=0;j<m.length;j++){t[m[j]]=sap.suite.smartbusiness.utils.getRandomNumber(100)}c.push(t)}c=this.sortChartData(c,d);return c},sortChartData:function(c,d){var e=[];c.sort(function(a,b){var i=0;while(i<d.length){if(a[d[i]]>b[d[i]]){return-1}else if(a[d[i]]<b[d[i]]){return 1}i++}});var t={};for(var i=0,k=0;i<c.length;i++){var s="";for(var j=0;j<d.length;j++){s+=c[i][d[j]]}if(!t[s]){t[s]=true;e[k++]=c[i]}}return e},validateChartId:function(e){var c=e?e.getSource():this.getView().getContent()[0].getContent()[0].getMasterPages()[0].getContent()[2].getItems()[1];var a=c.getValue();if(/^[\w\d\.\_]+$/.test(a)){if(this.DDA_MODEL.getConfigurator().findViewById(a)){if(!this._oModel.getData().ID_EDITABLE){c.setValueState(sap.ui.core.ValueState.None);return true}else{c.setValueState(sap.ui.core.ValueState.Error);c.focus();return false}}else{c.setValueState(sap.ui.core.ValueState.None);return true}}else{c.setValueState(sap.ui.core.ValueState.Error);return false}},validateChartName:function(){var c=this.getView().getContent()[0].getContent()[0].getMasterPages()[0].getContent()[2].getItems()[3];var a=c.getValue();if(a){c.setValueState(sap.ui.core.ValueState.None);return true}else{c.setValueState(sap.ui.core.ValueState.Error);c.focus();return false}},validateDataLimit:function(e){var d=e?e.getSource():this.getView().getContent()[0].getContent()[0].getMasterPages()[0].getContent()[2].getItems()[7];var a=d.getValue();if(/^\d+$/gi.test(a)){var p=parseInt(a,10);if(p>0){d.setValueState(sap.ui.core.ValueState.None);return true}}else{d.setValueState(sap.ui.core.ValueState.Error);return false}},onSave:function(){if(this.validateChartId()&&this.validateChartName()&&this.validateDataLimit()){var s=this;if(this.currentViewId==this.DDA_MODEL.NEW_VIEWID){this.oApplicationFacade.__newViewAdded=true;this.oApplicationFacade.createdViewId=this.getView().getModel("SB_DDACONFIG").getData().SELECTED_VIEW}this.busyIndicator.open()&&this.getView().setBusy(true);var m=this.getView().getModel("SB_DDACONFIG").getData();var a=sap.suite.smartbusiness.ddaconfig.DrilldownSaveService;a.saveViewConfiguration(this.evaluationId,m,"update",function(){jQuery.sap.log.info("all calls success");s.busyIndicator.close()&&s.getView().setBusy(false);sap.m.MessageToast.show(s._oTextsModel.getResourceBundle().getText("CHART_CONFIG_SAVE_SUCCESS"));s.oApplicationFacade.__refreshModel=1;window.history.back();s.takeConfigMasterSnapShot()},function(){jQuery.sap.log.error(x+" failed");s.busyIndicator.close()&&s.getView().setBusy(false);sap.suite.smartbusiness.utils.showErrorMessage(s._oTextsModel.getResourceBundle().getText("SAVE_ERROR"))})}},formatMeasureName:function(s){s=this.COLUMN_LABEL_MAPPING[s];if(s==this.DDA_MODEL.EVALUATION_DATA.COLUMN_NAME){s=s+"("+this.getView().getModel("i18n").getProperty("KPI_MEASURE")+")"}return s},formatMeasureNameInList:function(n,t){if(t=="MEASURE")t=this.getView().getModel("i18n").getProperty("MEASURE");if(t=="DIMENSION")t=this.getView().getModel("i18n").getProperty("DIMENSION");if(n==this.DDA_MODEL.EVALUATION_DATA.COLUMN_NAME){t=this.getView().getModel("i18n").getProperty("KPI_MEASURE")}return t},formatType:function(t){if(t=="MEASURE")t=this.getView().getModel("i18n").getProperty("MEASURE");if(t=="DIMENSION")t=this.getView().getModel("i18n").getProperty("DIMENSION");return t},sortDimensionsAndMeasures:function(){var c=this;new sap.suite.ui.smartbusiness.lib.ListPersona({title:this.getView().getModel("i18n").getProperty("CHANGE_ORDER"),view:this.getView(),context:'/items',listItemContext:'LABEL',formatter:jQuery.proxy(this.formatMeasureName,this),namedModel:'SB_DDACONFIG',filter:{property:'SELECTED',value:true},callback:function(){c.refreshChart()}}).start()},onBack:function(){this.restoreFromConfigMasterSnapShot();window.history.back()},onCancel:function(){var s=this;new sap.m.Dialog({icon:"sap-icon://warning2",title:s._oTextsModel.getResourceBundle().getText("WARNING"),state:"Error",type:"Message",content:[new sap.m.Text({text:s._oTextsModel.getResourceBundle().getText("ARE_YOU_SURE")})],beginButton:new sap.m.Button({text:s._oTextsModel.getResourceBundle().getText("OK"),press:function(){s.restoreFromConfigMasterSnapShot();this.getParent().close();window.history.back()}}),endButton:new sap.m.Button({text:s._oTextsModel.getResourceBundle().getText("CANCEL"),press:function(){this.getParent().close()}})}).open()},onExit:function(){this.restoreFromConfigMasterSnapShot()},enableOrDisableSave:function(){var m=this._config.items.filter(function(s){return s.SELECTED});if(this.dda_config.chartConfig.type.toUpperCase()=="TABLE")this.canSave=true;if(m.length&&this.canSave){this.getView().byId("save-btn").setEnabled(true)}else{this.getView().byId("save-btn").setEnabled(false)}}});
