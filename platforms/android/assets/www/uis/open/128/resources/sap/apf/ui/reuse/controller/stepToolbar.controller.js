/*!
* SAP APF Analysis Path Framework
* 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
*/
sap.ui.controller("sap.apf.ui.reuse.controller.stepToolbar",{chartIconInserted:false,alternateRepresentationIcon:false,alternateRepresentationBool:false,selectedRepresentation:null,alternateRepresentationBtn:{},selectedNumber:null,isSwitchRepresentation:false,viewSettingsIcon:null,onInit:function(){this.oCoreApi=this.getView().getViewData().oCoreApi;this.oUiApi=this.getView().getViewData().uiApi},drawAlternateRepresentation:function(){var t=this;this.alternateRepresentationBtn=new sap.m.Button({icon:this.oCoreApi.getActiveStep().getSelectedRepresentation().getAlternateRepresentation().picture,tooltip:this.oCoreApi.getTextNotHtmlEncoded("TableRepresentation"),press:function(){var s=t.oCoreApi.getActiveStep();var c=s.getSelectedRepresentation();var a=t.oCoreApi.getSteps().indexOf(s);t.selectedRepresentation="table";c.bIsAlternateView=true;if(c.toggleInstance===undefined){c.toggleInstance=t.oUiApi.getStepContainer().getController().createAlternateRepresentation(a)}else{var d=c.getData(),m=c.getMetaData();if(d!==undefined&&m!==undefined){c.toggleInstance.setData(d,m)}c.toggleInstance.adoptSelection(c)}t.oUiApi.getAnalysisPath().getController().refresh(-1);t.oUiApi.getStepContainer().getController().drawStepContent();t.oUiApi.getAnalysisPath().getCarousel().getStepView(a).getController().drawThumbnailContent(true)}}).addStyleClass("alternateButton");this.insertViewSettingsIcon();this.getView().chartToolbar.getToolBar().insertContentRight(this.alternateRepresentationBtn)},insertViewSettingsIcon:function(){var t=this;this.sortButton=new sap.m.Button({icon:"sap-icon://drop-down-list",tooltip:this.oCoreApi.getTextNotHtmlEncoded("view-Settings"),press:function(){if(t.oCoreApi.getActiveStep().getSelectedRepresentation().type!==sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION){t.oCoreApi.getActiveStep().getSelectedRepresentation().toggleInstance.viewSettingsDialog.open()}else{t.oCoreApi.getActiveStep().getSelectedRepresentation().viewSettingsDialog.open()}}}).addStyleClass("sortButton");this.getView().chartToolbar.getToolBar().insertContentRight(this.sortButton)},showSelectionCount:function(){var a=this.oCoreApi.getActiveStep();var s=a.getSelectedRepresentation();var b=typeof(s.getSelectionCount)==="function"?s.getSelectionCount():0;var r=s.getParameter().requiredFilters!==undefined&&s.getParameter().requiredFilters.length!==0;var m=s.getMetaData!==undefined&&s.getMetaData()!==undefined&&s.getMetaData().hasOwnProperty("getPropertyMetadata");var c=r&&m?s.getMetaData().getPropertyMetadata(s.getParameter().requiredFilters[0]).label:null;if(c===null||b===0){jQuery(".showSelection").hide();jQuery(".resetSelection").hide()}else if(b>0){this.selectedNumber.setText("("+this.oCoreApi.getTextNotHtmlEncoded("selected-objects",[c,b])+")");jQuery(".showSelection").show();jQuery(".resetSelection").show()}},insertContentLeft:function(){var t=this;this.currentStepText=new sap.m.Label({wrapping:true,text:this.oCoreApi.getTextNotHtmlEncoded("currentStep")}).addStyleClass("currentStep");this.selectedNumber=new sap.m.Label({wrapping:true}).addStyleClass("showSelection");this.resetSelection=new sap.m.Link({text:this.oCoreApi.getTextNotHtmlEncoded("resetSelection")}).attachPress(function(){jQuery(".showSelection").hide();jQuery(".resetSelection").hide();if(t.oCoreApi.getActiveStep().getSelectedRepresentation().bIsAlternateView){t.oCoreApi.getActiveStep().getSelectedRepresentation().toggleInstance.removeAllSelection()}t.oCoreApi.getActiveStep().getSelectedRepresentation().removeAllSelection()}).addStyleClass("resetSelection");this.getView().chartToolbar.getToolBar().insertContentRight(this.resetSelection);this.getView().chartToolbar.getToolBar().insertContentLeft(this.selectedNumber);this.getView().chartToolbar.getToolBar().insertContentLeft(this.currentStepText)},drawSingleRepresentation:function(){var t=this;var s=new sap.m.Button({icon:t.oCoreApi.getActiveStep().getSelectedRepresentationInfo().picture,tooltip:this.oCoreApi.getTextNotHtmlEncoded(t.oCoreApi.getActiveStep().getSelectedRepresentationInfo().label),press:function(){var S=t.oCoreApi.getActiveStep();var c=S.getSelectedRepresentation();c.bIsAlternateView=false;t.oUiApi.getStepContainer().getController().drawStepContent();var a=t.oCoreApi.getSteps().indexOf(S);t.oUiApi.getAnalysisPath().getCarousel().getStepView(a).getController().drawThumbnailContent(true)}});this.getView().chartToolbar.getToolBar().insertContentRight(s,0);this.insertContentLeft()},drawMultipleRepresentation:function(){var t=this;var a=t.oCoreApi.getActiveStep();a.representationtypes=a.getRepresentationInfo();var r=a.representationtypes.length;var s;var d=function(c){c.oCurrentActiveStep.getSelectedRepresentation().bIsAlternateView=false;c.oCurrentActiveStep.setSelectedRepresentation(c.oRepresentationType.representationId);t.oUiApi.getAnalysisPath().getController().refresh(c.nActiveStepIndex);t.oCoreApi.updatePath(t.oUiApi.getAnalysisPath().getController().callBackForUpdatePath.bind(t.oUiApi.getAnalysisPath().getController()))};this.openList=function(e){var c=e.getParameter("listItem").getCustomData()[0].getValue();d(c);s.setIcon(c.icon);s.setTooltip(t.oCoreApi.getTextNotHtmlEncoded(c.oRepresentationType.label))};var A=new sap.m.List({mode:sap.m.ListMode.SingleSelectMaster,showSeparators:sap.m.ListSeparators.None,includeItemInSelection:true,select:jQuery.proxy(function(e){this.openList(e)},this)});for(var j=0;j<r;j++){A.addItem(new sap.m.StandardListItem({icon:a.representationtypes[j].picture,title:t.oCoreApi.getTextNotHtmlEncoded(a.representationtypes[j].label),customData:[new sap.ui.core.CustomData({key:'data',value:{oCurrentActiveStep:t.oCoreApi.getActiveStep(),oRepresentationType:a.representationtypes[j],nActiveStepIndex:t.oCoreApi.getSteps().indexOf(t.oCoreApi.getActiveStep()),icon:a.representationtypes[j].picture}})]}))}var S=new sap.m.Popover({placement:sap.m.PlacementType.Bottom,showHeader:false,content:[A]}).addStyleClass("sapCaUiChartToolBarShowAllChartListPopover");for(var k=0;k<r;k++){var b=new sap.m.Button({tooltip:t.oCoreApi.getTextNotHtmlEncoded(a.representationtypes[k].label),icon:a.representationtypes[k].picture,customData:[new sap.ui.core.CustomData({key:'data',value:{oCurrentActiveStep:t.oCoreApi.getActiveStep(),oRepresentationType:a.representationtypes[k],nActiveStepIndex:t.oCoreApi.getSteps().indexOf(t.oCoreApi.getActiveStep()),icon:a.representationtypes[k].picture}})],press:function(e){var c=e.getSource().getCustomData()[0].getValue();d(c)}});b.addStyleClass("iconLeft");this.getView().chartToolbar.getToolBar().insertContentRight(b)}s=new sap.m.Button({icon:t.oCoreApi.getActiveStep().getSelectedRepresentationInfo().picture,tooltip:t.oCoreApi.getTextNotHtmlEncoded(t.oCoreApi.getActiveStep().getSelectedRepresentationInfo().label),press:function(){S.openBy(this)}}).addStyleClass("iconList");this.getView().chartToolbar.getToolBar().insertContentRight(s,0);this.insertContentLeft()},drawToolBar:function(){var t=this;this.showAndHideIcons=function(){var t=this;t.isSwitchRepresentation=false;if(t.getView().chartToolbar.getFullScreen()===true){jQuery(".iconList").hide();jQuery(".iconLeft").show()}else{jQuery(".iconList").show();jQuery(".iconLeft").hide()}if((t.oCoreApi.getActiveStep().getSelectedRepresentation().bIsAlternateView&&t.oCoreApi.getActiveStep().getSelectedRepresentation().getAlternateRepresentation().id===sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION)||t.oCoreApi.getActiveStep().getSelectedRepresentation().type===sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION){jQuery(".sortButton").show()}else{jQuery(".sortButton").hide()}if(t.oCoreApi.getSteps().length>=1){t.showSelectionCount()}var a=t.getView().chartToolbar.getId();if(t.oCoreApi.getActiveStep().getSelectedRepresentation().getAlternateRepresentation()!==undefined){if((!t.oCoreApi.getActiveStep().getSelectedRepresentation().bIsAlternateView&&t.oCoreApi.getActiveStep().getSelectedRepresentation().getAlternateRepresentation().id!==sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION)||t.oCoreApi.getActiveStep().getSelectedRepresentation().type!==sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION){if((window.innerWidth===jQuery("#"+a+" > div:first-child > div:nth-child(2)").width())){jQuery(t.getView().chartToolbar._oShowLegendButton.getDomRef()).show()}}}};this.renderIcons=function(){var t=this;var a=t.oCoreApi.getActiveStep();if(a!==undefined){t.getView().chartToolbar._oFullScreenButton.setTooltip(t.oCoreApi.getTextNotHtmlEncoded("toggle-fullscreen"));t.getView().chartToolbar._oFullScreenExitButton.setTooltip(t.oCoreApi.getTextNotHtmlEncoded("toggle-fullscreen"));var s=a.getSelectedRepresentation().chartInstance||{};if(t.alternateRepresentationIcon===false&&t.oCoreApi.getActiveStep().getSelectedRepresentation().type!==sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION){t.drawAlternateRepresentation();t.alternateRepresentationIcon=true}if(t.oCoreApi.getActiveStep().getSelectedRepresentation().type===sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION){if(t.viewSettingsIcon===false){t.insertViewSettingsIcon()}t.viewSettingsIcon=true}if(t.oCoreApi.getActiveStep().getRepresentationInfo().length>1){if(t.chartIconInserted===false){t.drawMultipleRepresentation()}t.chartIconInserted=true}else if(t.oCoreApi.getActiveStep().getSelectedRepresentation().type!==sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION&&t.oCoreApi.getActiveStep().getRepresentationInfo().length===1){if(t.chartIconInserted===false){t.drawSingleRepresentation()}t.chartIconInserted=true}if((t.oCoreApi.getActiveStep().getSelectedRepresentation().bIsAlternateView&&t.oCoreApi.getActiveStep().getSelectedRepresentation().getAlternateRepresentation().id===sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION)||t.oCoreApi.getActiveStep().getSelectedRepresentation().type===(sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION||sap.apf.ui.utils.CONSTANTS.representationTypes.GEO_MAP)){t.getView().chartToolbar._oShowLegendButton.setVisible(false)}else{t.getView().chartToolbar._oShowLegendButton.setVisible(true);t.getView().chartToolbar._oShowLegendButton.setTooltip(t.oCoreApi.getTextNotHtmlEncoded("legend"))}if(t.isSwitchRepresentation===true){t.getView().chartToolbar.setShowLegend(true)}var c=a.getSelectedRepresentation();var f;if(c.bIsLegendVisible===false){if(s.setLegend!==undefined){s.setLegend(new sap.viz.ui5.types.legend.Common({visible:false}))}if(s.setSizeLegend!==undefined){f=s.getSizeLegend().getFormatString();s.setSizeLegend(new sap.viz.ui5.types.legend.Common({visible:false}));if(f!==null){s.getSizeLegend().setFormatString(f)}}}else{if(s.setLegend!==undefined){s.setLegend(new sap.viz.ui5.types.legend.Common({visible:true}))}if(s.setSizeLegend!==undefined){f=s.getSizeLegend().getFormatString();s.setSizeLegend(new sap.viz.ui5.types.legend.Common({visible:true}));if(f!==null){s.getSizeLegend().setFormatString(f)}}}}};this.getView().chartToolbar.addEventDelegate({onAfterRendering:function(){if(t.oCoreApi.getSteps().length>0){t.showAndHideIcons()}},onBeforeRendering:function(){if(t.oCoreApi.getSteps().length>0){t.renderIcons()}}})},drawRepresentation:function(c){var t=this;this.isSwitchRepresentation=true;this.getView().chartToolbar.getToolBar().removeAllContentLeft();this.getView().chartToolbar.getToolBar().removeAllContentRight();this.chartIconInserted=false;this.alternateRepresentationIcon=false;this.viewSettingsIcon=false;this.getView().chartToolbar.removeAllCharts();this.getView().chartToolbar.insertChart(c);if(this.getView().chartToolbar.getFullScreen()===true){this.getView().chartToolbar.rerender()}this.drawToolBar();this.getView().chartToolbar.onAfterRendering=function(){var l=this._oShowLegendButton.getDomRef();var e=sap.ui.Device.browser.mobile?"tap":"click";$(l).on(e,function(){var s=t.oCoreApi.getActiveStep();var a=s.getSelectedRepresentation();if(a.bIsLegendVisible===true||a.bIsLegendVisible===undefined){a.bIsLegendVisible=false}else{a.bIsLegendVisible=true}})}}});
