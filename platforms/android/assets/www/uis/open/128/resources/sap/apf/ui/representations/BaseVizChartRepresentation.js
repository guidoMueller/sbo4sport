/*!
* SAP APF Analysis Path Framework
* 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
*/
jQuery.sap.require('sap.apf.ui.representations.utils.vizHelper');jQuery.sap.require('sap.apf.ui.representations.utils.formatter');jQuery.sap.declare("sap.apf.ui.representations.BaseVizChartRepresentation");
sap.apf.ui.representations.BaseVizChartRepresentation=function(a,p){this.oMessageObject="";this.legendBoolean=true;this.aDataResponse=undefined;this.dataset={};this.oModel=new sap.ui.model.json.JSONModel();this.bDataHasBeenSelected=false;this.parameter=p;this.sort=p.sort;this.dimension=p.dimensions;this.measure=p.measures;this.alternateRepresentation=p.alternateRepresentationType;this.requiredFilters=p.requiredFilters;this.vizHelper=new sap.apf.ui.representations.utils.vizHelper(a,p);this.chartInstance={};this.chartParam="";this.thumbnailChartParam="";this.disableSelectEvent=false;this.oApi=a;var s=this;this.showXaxisLabel=true;this.axisType="axis"};
sap.apf.ui.representations.BaseVizChartRepresentation.prototype={getParameter:function(){return this.parameter},setData:function(d,m){this.vizHelper.init(d,m,this.axisType);this.formatter=new sap.apf.ui.representations.utils.formatter(this.oApi,m,d);this.aDataResponse=d||[];this.metadata=m;if(!this.metadata){this.oMessageObject=this.oApi.createMessageObject({code:"6004",aParameters:[this.oApi.getTextNotHtmlEncoded("step")]});this.oApi.putMessage(this.oMessageObject)}},getAlternateRepresentation:function(){return this.alternateRepresentation},getMetaData:function(){return this.metadata},getData:function(){return this.aDataResponse},getRequestOptions:function(){if(this.sort){return{orderby:[{property:this.sort.sortField,descending:this.sort.descending}]}}else return{}},createDataset:function(){this.dataset=this.vizHelper.getDataset();this.oModel=this.vizHelper.getModel()},getMainContent:function(s,w,h){var a=this;if(!s){this.oMessageObject=this.oApi.createMessageObject({code:"6002",aParameters:["title",this.oApi.getTextNotHtmlEncoded("step")]});this.oApi.putMessage(this.oMessageObject)}if(this.dimension.length===0){this.oMessageObject=this.oApi.createMessageObject({code:"6002",aParameters:["dimensions",s]});this.oApi.putMessage(this.oMessageObject)}if(this.measure.length===0){this.oMessageObject=this.oApi.createMessageObject({code:"6002",aParameters:["measures",s]});this.oApi.putMessage(this.oMessageObject)}if(!this.aDataResponse||this.aDataResponse.length===0){this.oMessageObject=this.oApi.createMessageObject({code:"6000",aParameters:[s]});this.oApi.putMessage(this.oMessageObject)}var c=h||600;c=c+"px";var b=w||1000;b=b+"px";a.title=s;a.createDataset();a.chartParam={width:b,title:{visible:true,text:a.title},xAxis:{title:{visible:true},label:{visible:a.showXaxisLabel}},yAxis:{title:{visible:true}},legend:{visible:a.legendBoolean,title:{visible:a.legendBoolean}},plotArea:{animation:{dataLoading:false,dataUpdating:false}},dataset:a.dataset};a.chart=new sap.viz.ui5[a.chartType](a.chartParam);a.setFormatString(a.measure);a.chart.attachInitialized(function(){a.drawSelection()});a.chart.attachSelectData(function(e){a.handleSelection(e)});a.chart.attachDeselectData(function(e){a.handleDeselection(e)});a.chart.setModel(a.oModel);a.vizHelper.validateSelectionModes(a.chart);a.chartInstance=a.chart;return a.chart},setFormatString:function(m){var f=[];var t=[];var l=[];var a=true;var i=0;var s=this;if(m.length===1){f=this.formatter.getFormatString(m[0]);if(f!==undefined){if(this.chart.getYAxis!==undefined&&f.label!==undefined){this.chart.getYAxis().getLabel().setFormatString(f.label)}if(this.chart.getToolTip!==undefined&&f.tooltip!==undefined){this.chart.getToolTip().setFormatString([[f.tooltip]])}}}else{var b=s.metadata.getPropertyMetadata(m[0].fieldName).unit?s.metadata.getPropertyMetadata(s.metadata.getPropertyMetadata(m[0].fieldName).unit).semantics:undefined;var c;m.forEach(function(d,e){c=s.metadata.getPropertyMetadata(m[0].fieldName).unit?s.metadata.getPropertyMetadata(s.metadata.getPropertyMetadata(d.fieldName).unit).semantics:undefined;if(a&&b!==undefined&&c&&(b!==c)){a=false}f[e]=s.formatter.getFormatString(d);if(f[e].label!==undefined&&f[e].tooltip!==undefined){t.push([f[e].tooltip]);l.push(f[e].label)}});if(a){if(f.length!==0&&this.chart.getYAxis!==undefined&&l.length!==0){this.chart.getYAxis().getLabel().setFormatString(l[0])}}if(f.length!==0&&this.chart.getToolTip!==undefined&&t.length!==0){this.chart.getToolTip().setFormatString(t)}}},drawSelection:function(){var s=this.vizHelper.getSelectionFromFilter(this.filter);if(s.length>0){this.disableSelectEvent=true;this.chart.selection(s)}},drawThumbnailSelection:function(){var s=this;var S=this.vizHelper.getSelectionFromFilter(this.filter);if(S.length>0){s.thumbnailChart.selection([],{clearSelection:true});s.thumbnailChart.selection(S)}},handleSelection:function(e){var s=this;if(!s.disableSelectEvent){var c=s.vizHelper.getHighlightPointsFromSelectionEvent(s.chart.selection());s.chart.selection(c);s.thumbnailChart.selection(c);s.bDataHasBeenSelected=true;s.oApi.selectionChanged()}else{s.disableSelectEvent=false}},handleDeselection:function(e){var s=this;if(!s.disableSelectEvent){s.disableSelectEvent=true;var n=s.vizHelper.getHighlightPointsFromDeselectionEvent(s.chart.selection());s.chart.selection([],{clearSelection:true});s.thumbnailChart.selection([],{clearSelection:true});s.chart.selection(n);s.thumbnailChart.selection(n);if(!n.length){s.disableSelectEvent=false}s.bDataHasBeenSelected=true;s.oApi.selectionChanged()}else{s.disableSelectEvent=false}},getSelectionCount:function(){return this.vizHelper.getFilterCount()},hasSelection:function(){return this.bDataHasBeenSelected},removeAllSelection:function(){this.chart.selection([],{clearSelection:true});this.thumbnailChart.selection([],{clearSelection:true})},getFilterMethodType:function(){return sap.apf.core.constants.filterMethodTypes.filter},getFilter:function(){this.filter=this.vizHelper.getFilterFromSelection();return this.filter},setFilter:function(f){this.filter=f;this.bDataHasBeenSelected=false},adoptSelection:function(s){if(s&&s.getFilter){this.vizHelper.filterValues=s.getFilter().getInternalFilter().getFilterTerms().map(function(t){return[t.getValue()]})}},getThumbnailContent:function(){var s=this;var h=sap.apf.ui.utils.CONSTANTS.thumbnailDimensions.HEIGHT;var w=sap.apf.ui.utils.CONSTANTS.thumbnailDimensions.WIDTH;s.createDataset();s.thumbnailChartParam={width:w,height:h,title:{visible:false},xAxis:{visible:false,title:{visible:false}},yAxis:{visible:false,title:{visible:false}},legend:{visible:false,title:{visible:false}},sizeLegend:{visible:false,title:{visible:false}},toolTip:{visible:false},interaction:{selectability:{axisLabelSelection:false,legendSelection:false,plotLassoSelection:false,plotStdSelection:false},enableHover:false},background:{visible:false},general:{layout:{padding:0}},plotArea:{animation:{dataLoading:false,dataUpdating:false}},dataset:s.dataset};s.thumbnailChart=new sap.viz.ui5[s.chartType](s.thumbnailChartParam);s.thumbnailChart.attachInitialized(function(){s.drawThumbnailSelection()});s.thumbnailLayout=new sap.ui.layout.HorizontalLayout().addStyleClass('thumbnailLayout');if(this.aDataResponse!==undefined&&this.aDataResponse.length!==0){s.thumbnailChart.setModel(s.oModel);s.thumbnailLayout.removeAllContent();s.thumbnailLayout.addContent(s.thumbnailChart)}else{var n=new sap.m.Text({text:s.oApi.getTextNotHtmlEncoded("noDataText")}).addStyleClass('noDataText');s.thumbnailLayout.removeAllContent();s.thumbnailLayout.addContent(n)}return s.thumbnailLayout},serialize:function(){return{oFilter:this.vizHelper.filterValues,bIsAlternateView:this.bIsAlternateView}},deserialize:function(s){this.vizHelper.filterValues=s.oFilter;this.bIsAlternateView=s.bIsAlternateView},getPrintContent:function(s){var c;c=this.getMainContent(s,1000,600);c.getPlotArea().getAnimation().setDataLoading(false);c.getPlotArea().getAnimation().setDataUpdating(false);return c}};
