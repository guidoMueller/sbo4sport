sap.ui.getCore().loadLibrary("sap.suite.ui.commons");jQuery.sap.require("sap.ca.scfld.md.controller.BaseDetailController");jQuery.sap.require("sap.suite.ui.smartbusiness.tiles.Bullet");jQuery.sap.require("sap.suite.ui.smartbusiness.tiles.Comparison");jQuery.sap.require("sap.suite.ui.smartbusiness.tiles.AreaChart");jQuery.sap.require("sap.suite.ui.smartbusiness.tiles.Numeric");jQuery.sap.require("sap.suite.ui.smartbusiness.tiles.MeasureComparison");jQuery.sap.require("sap.ca.scfld.md.controller.BaseDetailController");jQuery.sap.require("sap.m.MessageBox");sap.ca.scfld.md.controller.BaseDetailController.extend("sap.suite.ui.smartbusiness.designtime.drilldown.view.S3",{onInit:function(){this.DDA_MODEL=null;this.evaluationId=null;this.viewId=null;this.ddaFilter=this.byId("ddaFilter");this.initializeTileHeader();this.defineHeaderFooterOptions();this.oRouter.attachRoutePatternMatched(this.onRoutePatternMatched,this);this.busyIndicator=new sap.m.BusyDialog()},tileTypeMapping:{NT:"Numeric",AT:"Bullet",CT:"Comparison",TT:"AreaChart",CM:"MeasureComparison"},headerNumberFormatter:function(s){return s?"12,345.67":""},headerNumberUnitFormatter:function(s){return s?"EUR":""},bindUiToModel:function(){this.DDA_MODEL.bindModel(this.getView(),"SB_DDACONFIG")},initializeTileHeader:function(){var t=this;var a=this.byId("tileContainer");a.bindAggregation("items",{path:"SB_DDACONFIG>/HEADERS_VISIBLE",factory:function(i,b){var c=b.getProperty("VISUALIZATION_TYPE");return new sap.suite.ui.smartbusiness.tiles[t.tileTypeMapping[c]]({evaluationId:t.evaluationId,mode:"DUMMY",header:"{SB_DDACONFIG>TITLE}",subheader:"{SB_DDACONFIG>SUBTITLE}"}).addStyleClass("drilldownKpiTiles")},})},lauchConfigurator:function(){this.oRouter.navTo("configurator",{evaluationId:this.evaluationId,viewId:this.viewId})},onRoutePatternMatched:function(E){var v=this.getView();if(E.getParameter("name")==="detail"){try{if(this.oApplicationFacade.__refreshModel&&this.oApplicationFacade.__refreshModel===1){this.getView().getModel()&&this.getView().getModel().refresh()}var a=E.getParameter("arguments").contextPath;var c=new sap.ui.model.Context(v.getModel(),'/'+a);v.setBindingContext(c);try{this.evaluationId=v.getBindingContext().getObject()["ID"]}catch(e){try{this.evaluationId=a.match(/ID=[^,]+/g)[0].replace(/(ID=')|(')/g,"")}catch(e){this.evaluationId=a.replace(/EVALUATIONS_DDA\('|'\)/g,"")}}var b=E.getParameter("arguments")["evaluationId"];if(b!==this.evaluationId){this.DDA_MODEL=sap.suite.smartbusiness.ddaconfig.Model.getInstance(this.evaluationId,true,this.getView().getModel("i18n"));this.EVALUATION=sap.suite.smartbusiness.kpi.parseEvaluation(this.DDA_MODEL.EVALUATION_DATA);var n=this.DDA_MODEL.NEW_VIEWID;var d=this.DDA_MODEL.getConfigurator().getDefaultViewId();if(d!=null){this.viewId=d;this.DDA_MODEL.setViewId(d)}else{this.viewId=n}this.bindUiToModel();this.ddaFilter.setEvaluationData(this.EVALUATION);this.ddaFilter.setEvaluationId(this.evaluationId);var f=[];this.getView().getModel("SB_DDACONFIG").getProperty("/FILTERS").forEach(function(s){f.push(s.name)});this.ddaFilter.setDimensions(f)}else{this.bindUiToModel();if(this.viewId==n&&this.getView().getModel("SB_DDACONFIG").getProperty("/ID")!=n){}}this.INIT_COUNT_HEADERS=this.getView().getModel("SB_DDACONFIG").getData()["HEADERS"].length;this.INIT_COUNT_FILTERS=this.getView().getModel("SB_DDACONFIG").getData()["FILTERS"].length;this._oTextsModel=this.getView().getModel("i18n");var o=this.getView().byId("chartToolbar");o._oFirstDimensionSelect.bindProperty("selectedKey","SB_DDACONFIG>/ID");this._oModel=this.getView().getModel("SB_DDACONFIG").getData();this.refreshChart();if(this.copyClipboard&&Object.keys(this.copyClipboard)&&Object.keys(this.copyClipboard).length){this.checkEvaluationForPaste()}if(this.getPage().getFooter()){this.checkForCopy()}}catch(e){sap.suite.smartbusiness.utils.showErrorMessage(this.oApplicationFacade.getResourceBundle().getText("FAILED_TO_LOAD_ODATA"),e.message)}}},defineHeaderFooterOptions:function(){var t=this;this.oHeaderFooterOptions={bSuppressBookmarkButton:true,sI18NDetailTitle:"DRILLDOWN_CONFIG_DETAILS",oEditBtn:{sI18nBtnTxt:"CONFIGURE",onBtnPressed:function(e){t.lauchConfigurator()},bEnabled:false,},buttonList:[{sId:"Delete",sI18nBtnTxt:"DELETE",onBtnPressed:function(e){t.onDeleteConfiguration()}},{sId:"Copy",sI18nBtnTxt:"COPY",onBtnPressed:function(e){t.copyEvaluationToClipboard()}},{sId:"Paste",sI18nBtnTxt:"PASTE",onBtnPressed:function(e){t.copyDDAConfiguration()}}]}},getHeaderFooterOptions:function(){return this.oHeaderFooterOptions},refreshChart:function(){var c=this;var b=this.getView().byId("chartToolbar").getToolBar().getContentRight();if(b){if(b[0]&&(!(b[0].getVisible()))){b[0].setVisible(true)}if(b[1]&&(!(b[1].getVisible()))){b[1].setVisible(true)}if(b[3]&&(!(b[3].getVisible()))){b[3].setVisible(true)}if(b[0])b[0].firePress()}this.oChartDataModel=new sap.ui.model.json.JSONModel();this.oChartData=[];this.dda_chart=this.getView().byId("chartRef");this.dda_chart.setStackedChartWidthEnhancer(false);this.dda_table=this.getView().byId("chartTable");var t=this._oModel;this.dda_config={};this.dda_config.chartConfig={mode:t.DATA_MODE||"DUMMY",title:"",dataLimit:t.DATA_LIMIT||null,dataLimitations:t.DATA_LIMITATIONS||false,type:(t.CHART_TYPE).toUpperCase()||"BAR",axis:t.AXIS_TYPE||"SINGLE",value:t.VALUE_TYPE||"ABSOLUTE",colorScheme:t.COLOR_SCHEME||"NONE",thresholdMeasure:t.THRESHOLD_MEASURE||""};this.dda_config.columnsConfig=[];for(var i=0;i<t.COLUMNS.length;i++){this.dda_config.columnsConfig.push({name:t.COLUMNS[i].NAME,type:t.COLUMNS[i].TYPE,visibility:t.COLUMNS[i].VISIBILITY||"BOTH",sortOrder:t.COLUMNS[i].SORT_ORDER||"NONE",sortBy:t.COLUMNS[i].SORT_BY||"",axis:t.COLUMNS[i].AXIS||1,stacking:t.COLUMNS[i].STACKING||0,color:t.COLOR_SCHEME=="MANUAL_NON_SEMANTIC"?t.COLUMNS[i].COLOR1:t.COLOR_SCHEME=="MANUAL_SEMANTIC"?t.COLUMNS[i].COLOR2:""})}this.oColumns=[];this.oDimensions=[];this.oMeasures=[];this.dimNameArray=[];this.msrNameArray=[];this.chartDimensions=[];this.chartDimNames=[];this.chartMeasures=[];this.chartMsrNames=[];this.tableDimensions=[];this.tableDimNames=[];this.tableMeasures=[];this.tableMsrNames=[];for(var i=0;i<this.dda_config.columnsConfig.length;i++){this.oColumns.push(this.dda_config.columnsConfig[i]);if((this.dda_config.columnsConfig[i].type).toUpperCase()==="DIMENSION"){this.oDimensions.push(this.dda_config.columnsConfig[i]);this.dimNameArray.push(this.dda_config.columnsConfig[i].name);if(((this.dda_config.columnsConfig[i].visibility).toUpperCase()==="CHART")||((this.dda_config.columnsConfig[i].visibility).toUpperCase()==="BOTH")){this.chartDimensions.push(this.dda_config.columnsConfig[i]);this.chartDimNames.push(this.dda_config.columnsConfig[i].name)}if(((this.dda_config.columnsConfig[i].visibility).toUpperCase()==="TABLE")||((this.dda_config.columnsConfig[i].visibility).toUpperCase()==="BOTH")){this.tableDimensions.push(this.dda_config.columnsConfig[i]);this.tableDimNames.push(this.dda_config.columnsConfig[i].name)}}else if((this.dda_config.columnsConfig[i].type).toUpperCase()==="MEASURE"){this.oMeasures.push(this.dda_config.columnsConfig[i]);this.msrNameArray.push(this.dda_config.columnsConfig[i].name);if(((this.dda_config.columnsConfig[i].visibility).toUpperCase()==="CHART")||((this.dda_config.columnsConfig[i].visibility).toUpperCase()==="BOTH")){this.chartMeasures.push(this.dda_config.columnsConfig[i]);this.chartMsrNames.push(this.dda_config.columnsConfig[i].name)}if(((this.dda_config.columnsConfig[i].visibility).toUpperCase()==="TABLE")||((this.dda_config.columnsConfig[i].visibility).toUpperCase()==="BOTH")){this.tableMeasures.push(this.dda_config.columnsConfig[i]);this.tableMsrNames.push(this.dda_config.columnsConfig[i].name)}}}if((!(this.chartDimensions.length))||(!(this.chartMeasures.length))){this.dda_chart.setDataset(new sap.viz.core.FlattenedDataset({}));return}this.stacking=this.getStacking(this.chartMeasures,this.chartDimensions);this.isStackMsr=false;this.isStackDim=false;if(this.stacking.isEnabled&&(this.stacking.type=="M"))this.isStackMsr=true;else if(this.stacking.isEnabled&&(this.stacking.type=="D"))this.isStackDim=true;this.sapCaChartType=this.getSapCaChartType();this.dda_chart.setAdvancedChartSettings({plotArea:{animation:{dataLoading:false,dataUpdating:false,resizing:false}},legend:{title:{visible:false}}});if((this.dda_config.chartConfig.mode).toUpperCase()==="DUMMY"){this.oChartData=this.getDummyDataForChart(this.dimNameArray,this.msrNameArray);this.oChartDataModel.setData({businessData:c.oChartData})}else if((this.dda_config.chartConfig.mode).toUpperCase()==="RUNTIME"){this.getRuntimeChartData(this.dimNameArray,this.msrNameArray)}try{var p=sap.suite.smartbusiness.odata.properties(this._oModel.QUERY_SERVICE_URI,this._oModel.QUERY_ENTITY_SET)}catch(e){jQuery.sap.log.error("Failed to instantiate the odata model");throw e}this.column_labels_mapping=p.getLabelMappingObject();this.dimension_text_property_mapping=p.getTextPropertyMappingObject();this.measure_unit_property_mapping=p.getUnitPropertyMappingObject();if((this.sapCaChartType).toUpperCase()==="TABLE"){this.updateTable(this.tableDimensions,this.tableMeasures);if(b){if(b[0]){b[0].setVisible(false)}if(b[1]){b[1].setVisible(true)}if(b[3]){b[3].setVisible(false)}if(b[1]){b[1].firePress()}}return}if((((this.dda_config.chartConfig.type).toUpperCase()=="BAR")&&(this.dda_config.chartConfig.axis=="DUAL"))||(((this.dda_config.chartConfig.type).toUpperCase()=="COLUMN")&&(this.dda_config.chartConfig.axis=="DUAL"))){var a=false;var d=false;for(var i=0;i<this.chartMeasures.length;i++){if(this.chartMeasures[i].axis==1)a=true;else if(this.chartMeasures[i].axis==2)d=true}if(!(a)||!(d)){sap.m.MessageBox.alert(c._oTextsModel.getResourceBundle().getText("SELECT_MEASURE_FOR_AXIS",(a?2:1)));return}}if(((this.dda_config.chartConfig.type).toUpperCase()==="BUBBLE")&&(this.chartMeasures.length<3)){sap.m.MessageBox.alert(c._oTextsModel.getResourceBundle().getText("BUBBLE_CHART_MEASURE_COUNT"));return}this.dda_chart.setChartType(this.sapCaChartType);this.oDataset=this.create_Dataset(this.chartDimensions,this.chartMeasures);var f=this.dda_config.chartConfig.type;var g=this.dda_config.chartConfig.axis;var v=this.dda_config.chartConfig.value;var l=new sap.ui.core.Locale(sap.ui.getCore().getConfiguration().getLanguage());var h=sap.ca.ui.model.format.NumberFormat.getInstance({},l);if((f=='BAR')&&(v=="ABSOLUTE")){this.dda_chart.setXAxisLabelFormatter(this.formatChartNumbers.bind(this));this.dda_chart.setYAxisLabelFormatter(this.pseudoChartFormatter);if(g=='DUAL'){this.dda_chart.setXAxis2LabelFormatter(this.formatChartNumbers.bind(this))}}else if(f=='BUBBLE'){this.dda_chart.setXAxisLabelFormatter(this.formatChartNumbers.bind(this));this.dda_chart.setYAxisLabelFormatter(this.formatChartNumbers.bind(this))}else if(((f=='BAR')||(f=='COLUMN'))&&(v=='PERCENTAGE')){if(f=='BAR'){this.dda_chart.setXAxisLabelFormatter(function(r){return h.format_percentage(r)});this.dda_chart.setYAxisLabelFormatter(this.pseudoChartFormatter);if(g=='DUAL'){this.dda_chart.setXAxis2LabelFormatter(function(r){return h.format_percentage(r)})}}else{this.dda_chart.setYAxisLabelFormatter(function(r){return h.format_percentage(r)});this.dda_chart.setXAxisLabelFormatter(this.pseudoChartFormatter);if(g=='DUAL'){this.dda_chart.setYAxis2LabelFormatter(function(r){return h.format_percentage(r)})}}}else{this.dda_chart.setYAxisLabelFormatter(this.formatChartNumbers.bind(this));this.dda_chart.setXAxisLabelFormatter(this.pseudoChartFormatter);if((f=='COLUMN')&&(g=='DUAL')){this.dda_chart.setYAxis2LabelFormatter(this.formatChartNumbers.bind(this))}}this.dda_chart.setDataLabelFormatter([[this.formatChartNumbers.bind(this)]]);if(((f=='BAR')||(f=='COLUMN'))&&(v=='PERCENTAGE')){var j=[[],[],[]];for(var k=0;k<this.chartMsrNames.length;k++){j[0].push(c.getChartPercentFormatter(true));j[1].push(c.getChartPercentFormatter(true))}this.dda_chart.setPopoverFormatter(j)}this.dda_chart.setDataset(this.oDataset);this.dda_chart.setModel(this.oChartDataModel);this.showChartLegendIfApplicable(this.chartDimNames,this.chartMsrNames);if((this.dda_config.chartConfig.type=="BAR")||(this.dda_config.chartConfig.type=="COLUMN")||(this.dda_config.chartConfig.type=="COMBINATION")||(this.dda_config.chartConfig.type=="LINE")){if((this.dda_config.chartConfig.colorScheme).toUpperCase()==="AUTO_SEMANTIC"){var m=this.dda_config.chartConfig.thresholdMeasure||"";var n=[];var o=-1;for(var i=0;i<this.chartMeasures.length;i++){n.push({color:sap.ca.ui.charts.ChartSemanticColor.GoodLight});if(this.chartMeasures[i].name===m)o=i}if(o>=0)n[o].color=sap.ca.ui.charts.ChartSemanticColor.Neutral;this.applyCustomColoring(this.dda_chart,this.dda_config.chartConfig.colorScheme,n,m,this.DDA_MODEL.EVALUATION_DATA.GOAL_TYPE)}else if(((this.dda_config.chartConfig.colorScheme).toUpperCase()==="MANUAL_SEMANTIC")||((this.dda_config.chartConfig.colorScheme).toUpperCase()==="MANUAL_NON_SEMANTIC")){this.applyCustomColoring(this.dda_chart,this.dda_config.chartConfig.colorScheme,this.chartMeasures)}}this.updateTable(this.tableDimensions,this.tableMeasures)},getSapCaChartType:function(){var s=sap.ca.ui.charts.ChartType.Bar;var c=this.dda_config.chartConfig.type;var a=this.dda_config.chartConfig.axis;var v=this.dda_config.chartConfig.value;var b=(this.isStackMsr||(this.isStackDim&&(this.chartDimensions.length>1)))?true:false;switch(c){case"BAR":if(a==="SINGLE"){if(v==="ABSOLUTE"){if(b){s=sap.ca.ui.charts.ChartType.StackedBar}else{s=sap.ca.ui.charts.ChartType.Bar}}else if(v==="PERCENTAGE"){s=sap.ca.ui.charts.ChartType.StackedBar100}}else if(a==="DUAL"){if(v==="ABSOLUTE"){s=sap.ca.ui.charts.ChartType.DualStackedBar}else if(v==="PERCENTAGE"){s=sap.ca.ui.charts.ChartType.DualStackedBar100}}break;case"COLUMN":if(a==="SINGLE"){if(v==="ABSOLUTE"){if(b){s=sap.ca.ui.charts.ChartType.StackedColumn}else{s=sap.ca.ui.charts.ChartType.Column}}else if(v==="PERCENTAGE"){s=sap.ca.ui.charts.ChartType.StackedColumn100}}else if(a==="DUAL"){if(v==="ABSOLUTE"){s=sap.ca.ui.charts.ChartType.DualStackedColumn}else if(v==="PERCENTAGE"){s=sap.ca.ui.charts.ChartType.DualStackedColumn100}}break;case"LINE":s=sap.ca.ui.charts.ChartType.Line;break;case"COMBINATION":s=sap.ca.ui.charts.ChartType.Combination;break;case"BUBBLE":s=sap.ca.ui.charts.ChartType.Bubble;break;case"TABLE":s="TABLE";break;default:s=sap.ca.ui.charts.ChartType.Bar}return s},showChartLegendIfApplicable:function(d,m){var t=this;var o=this.getView().byId("chartToolbar");var c=this.dda_config.chartConfig.type;var i=(((c=="BAR")||(c=="COLUMN"))&&(this.isisStackDim)&&(this.getDimensionToBeStacked(t.chartDimensions))&&(d.length>1))?true:false;if((m.length>1)||(i)){o.setShowLegend(true)}else{o.setShowLegend(false)}},getChartPercentFormatter:function(i){var l=new sap.ui.core.Locale(sap.ui.getCore().getConfiguration().getLanguage());function a(n){return!isNaN(parseFloat(n))&&isFinite(n)}var f={style:i?'standard':'short'};var c=sap.ca.ui.model.format.NumberFormat.getInstance(f,l);return function(s){return a(s)?c.format_percentage(s):s}},getStacking:function(m,d){var s={};s.isEnabled=false;s.type="none";for(var i=0;i<m.length;i++){if(m[i].stacking===1){s.isEnabled=true;s.type="M"}}if(!(s.isEnabled)){for(var i=0;i<d.length;i++){if(d[i].stacking===1){s.isEnabled=true;s.type="D"}}}return s},setStacking:function(a,t,c){var b=this;if(a){if(t=="M"){for(var i=0;i<c.length;i++){if((c[i].TYPE).toUpperCase()==="MEASURE"){c[i].STACKING=1}else if((c[i].TYPE).toUpperCase()==="DIMENSION"){c[i].STACKING=0}}}else if(t=="D"){for(var i=0;i<c.length;i++){if((c[i].TYPE).toUpperCase()==="MEASURE"){c[i].STACKING=0}else if((c[i].TYPE).toUpperCase()==="DIMENSION"){c[i].STACKING=1}}}}else{for(var i=0;i<c.length;i++){c[i].STACKING=0}}},getDimensionToBeStacked:function(d){var D=null;for(var i=0;i<d.length;i++){if(d[i].axis===2){D=d[i];break}}return D},setDimensionToBeStacked:function(c,s){if(s){for(var i=0;i<c.length;i++){if((c[i].TYPE).toUpperCase()==="DIMENSION"){c[i].AXIS=1;if(c[i].NAME===s){c[i].AXIS=2}}}}},updateColumnProperty:function(c,n,p,v){for(var i=0;i<c.length;i++){if(c[i].NAME===n){(c[i])[p]=v;break}}},getMeasuresByAxis:function(c){var d={};d.axis1={};d.axis1.objArr=[];d.axis1.nameArr=[];d.axis2={};d.axis2.objArr=[];d.axis2.nameArr=[];for(var i=0;i<c.length;i++){if(c[i].axis===1){d.axis1.objArr.push(c[i]);d.axis1.nameArr.push(c[i].name)}else if(c[i].axis===2){d.axis2.objArr.push(c[i]);d.axis2.nameArr.push(c[i].name)}}return d},create_Dataset:function(d,m){var c=this;var a=this.dda_config.chartConfig.type||"BAR";var b=this.dda_config.chartConfig.axis||"SINGLE";var v=this.dda_config.chartConfig.value||"ABSOLUTE";var s=this.isStackMsr;var e=this.getDimensionToBeStacked(d);var f=new sap.viz.core.FlattenedDataset({data:{path:"/businessData"}});for(var i=0;i<d.length;i++){var g=((this.dda_config.chartConfig.mode).toUpperCase()==="RUNTIME")?this.dimension_text_property_mapping[d[i].name]:d[i].name;var A=1;if(((a=="BAR")||(a=="COLUMN"))&&(this.isStackDim)&&(e)&&(g===e.name)&&(d.length>1)){A=2;this.dda_chart.setStackedChartWidthEnhancer(true)}var h=new sap.viz.ui5.data.DimensionDefinition({axis:A,value:"{"+g+"}",name:this.column_labels_mapping[d[i].name]||d[i].name});f.addDimension(h)}if((a=="LINE")||(a=="COMBINATION")||((a=="BAR")&&(b=="SINGLE"))||((a=="COLUMN")&&(b=="SINGLE"))){for(var i=0;i<m.length;i++){var g=m[i].name;var j=new sap.viz.ui5.data.MeasureDefinition({name:this.column_labels_mapping[g]||g,value:"{"+g+"}"});f.addMeasure(j)}}else if(a=="BUBBLE"){for(var i=0;i<3;i++){var g=m[i].name;var j=new sap.viz.ui5.data.MeasureDefinition({group:i+1,name:this.column_labels_mapping[g]||g,value:"{"+g+"}",});f.addMeasure(j)}}else if(((a=="BAR")&&(b=="DUAL"))||((a=="COLUMN")&&(b=="DUAL"))){for(var i=0;i<m.length;i++){var g=m[i].name;var k=(m[i].axis==1||m[i].axis==2)?m[i].axis:2;var j=new sap.viz.ui5.data.MeasureDefinition({group:k,name:this.column_labels_mapping[g]||g,value:"{"+g+"}"});f.addMeasure(j)}}return f},_getValueState:function(a,t){if(!this.EVALUATION.isTargetKpi()){if(a<t){return this.EVALUATION.isMaximizingKpi()?sap.ui.core.ValueState.Error:sap.ui.core.ValueState.Success}else if(a==t){return sap.ui.core.ValueState.None}else{return this.EVALUATION.isMaximizingKpi()?sap.ui.core.ValueState.Success:sap.ui.core.ValueState.Error}}else{return sap.ui.core.ValueState.None}},_getTableCell:function(o,t){var a=this;if(t&&(o!==t)){return new sap.m.ObjectNumber({number:{path:o},state:{parts:[{path:o},{path:t}],formatter:function(m,b){try{m=window.parseFloat(m);b=window.parseFloat(b);return a._getValueState(m,b)}catch(e){return sap.ui.core.ValueState.None}}}})}else{return new sap.m.Label({text:{path:o}})}},updateTable:function(d,m){this.dda_table.destroyColumns();this.dda_table.destroyItems();for(var i=0;i<d.length;i++){var v=d[i].name;var L=new sap.m.Label({text:this.column_labels_mapping[v]||v});var c=new sap.m.Column({hAlign:"Left",header:L,minScreenWidth:"Tablet",demandPopin:true,});this.dda_table.addColumn(c)}for(var i=0;i<m.length;i++){var v=m[i].name;var L=new sap.m.Label({text:this.column_labels_mapping[v]||v});var c=new sap.m.Column({hAlign:"Right",header:L,minScreenWidth:"Tablet",demandPopin:true,});this.dda_table.addColumn(c)}var t=new sap.m.ColumnListItem({unread:false,});for(var i=0;i<d.length;i++){var v=((this.dda_config.chartConfig.mode).toUpperCase()==="RUNTIME")?this.dimension_text_property_mapping[d[i].name]:d[i].name;var o=new sap.m.Label({text:"{"+v+"}"});t.addCell(o)}var a=this._oModel["THRESHOLD_MEASURE"];for(var i=0;i<m.length;i++){var v=m[i].name;if(this._oModel["COLOR_SCHEME"]=="AUTO_SEMANTIC")var o=this._getTableCell(v,a);else var o=this._getTableCell(v,v);t.addCell(o)}this.dda_table.setModel(this.oChartDataModel);this.dda_table.bindAggregation("items","/businessData",t)},applyCustomColoring:function(c,a,b,t,i){var C=this;if((a).toUpperCase()==="AUTO_SEMANTIC"){if(((i=="MA")||(i=="MI"))&&t){C.setCustomColors(c,b,a);c.setChartSemanticColorFormatter(function(o){var d=c.getModel().getData().businessData;var e=o.ctx.path.dii_a1;var f=d[e];var r=f[t];if(r!=null&&typeof r!='undefined'){if(o.val>r){if(i=="MA")return sap.ca.ui.charts.ChartSemanticColor.GoodLight;else if(i=="MI")return sap.ca.ui.charts.ChartSemanticColor.BadLight}else if(o.val<r){if(i=="MA")return sap.ca.ui.charts.ChartSemanticColor.BadLight;else if(i=="MI")return sap.ca.ui.charts.ChartSemanticColor.GoodLight}else{return sap.ca.ui.charts.ChartSemanticColor.Neutral}}else{jQuery.sap.log.error("Threshold Measure:'"+t+"' not in Dataset. Error Applying Semantic Color");return sap.ca.ui.charts.ChartSemanticColor.NeutralLight}})}else{jQuery.sap.log.error("Threshold Measure not available or Goal type is RA . Error Applying Semantic Color")}}else if(((a).toUpperCase()==="MANUAL_SEMANTIC")||((a).toUpperCase()==="MANUAL_NON_SEMANTIC")){C.setCustomColors(c,b,a)}},setCustomColors:function(c,m,a){var d=c.getDataset();var b=d.getMeasures();var e="";if((a).toUpperCase()==="AUTO_SEMANTIC"||(a).toUpperCase()==="MANUAL_SEMANTIC")e=sap.ca.ui.charts.ChartSemanticColor.Neutral;for(var i=0;i<b.length;i++){b[i].addCustomData(new sap.ui.core.CustomData({key:"fillColor",value:m[i].color||e}))}},set_percentCharts_uom:function(){var c=this;var a=this.dda_config.chartConfig.type;var b=this.dda_config.chartConfig.axis;var v=this.dda_config.chartConfig.value;var m=[];for(var i=0;i<this.chartMsrNames.length;i++){m.push(this.column_labels_mapping[this.chartMsrNames[i]]||this.chartMsrNames[i])}var d=this.getMeasuresByAxis(this.chartMeasures);var e=[],f=[];for(var i=0;i<d.axis1.nameArr.length;i++){e.push(this.column_labels_mapping[d.axis1.nameArr[i]]||d.axis1.nameArr[i])}for(var i=0;i<d.axis2.nameArr.length;i++){f.push(this.column_labels_mapping[d.axis2.nameArr[i]]||d.axis2.nameArr[i])}var g=(b=='DUAL')?e.join(" & "):m.join(" & ");var C={};if(this.dda_chart)C=this.dda_chart.getAdvancedChartSettings()?this.dda_chart.getAdvancedChartSettings():{};if(((a=='BAR')||(a=="COLUMN"))&&(v=="PERCENTAGE")){if(a=='COLUMN'){C.yAxis={title:{visible:true,text:(g+" ("+(c._oTextsModel.getResourceBundle().getText("IN_PERCENTAGE"))+")")}};if(b=='DUAL'){C.yAxis2={title:{visible:true,text:(f.join(" & ")+" ("+(c._oTextsModel.getResourceBundle().getText("IN_PERCENTAGE"))+")")}}}}else if(a=='BAR'){C.xAxis={title:{visible:true,text:(g+" ("+(c._oTextsModel.getResourceBundle().getText("IN_PERCENTAGE"))+")")}};if(b=='DUAL'){C.xAxis2={title:{visible:true,text:(g+" ("+(c._oTextsModel.getResourceBundle().getText("IN_PERCENTAGE"))+")")}};C.xAxis={title:{visible:true,text:(f.join(" & ")+" ("+(c._oTextsModel.getResourceBundle().getText("IN_PERCENTAGE"))+")")}}}}if(this.dda_chart)this.dda_chart.setAdvancedChartSettings(C)}},formatChartNumbers:function(v){var l=new sap.ui.core.Locale(sap.ui.getCore().getConfiguration().getLanguage());function i(n){return!isNaN(parseFloat(n))&&isFinite(n)}if(i(v)){if(!this.chartFormatter){var d=1;jQuery.sap.require("sap.ca.ui.model.format.NumberFormat");if(d||d==0){this.chartFormatter=sap.ca.ui.model.format.NumberFormat.getInstance({style:'short',shortDecimals:d},l)}else{this.chartFormatter=sap.ca.ui.model.format.NumberFormat.getInstance({style:'short'},l)}}v=this.chartFormatter.format(v)}return v},pseudoChartFormatter:function(v){return v},getRuntimeChartData:function(d,m){var t=this;var c=this.getView().byId("chartToolbar");c.setBusy(true);this.COLUMNS_SORT=[];for(var i=0;i<t.oColumns.length;i++){if(t.oColumns[i].sortBy&&t.oColumns[i].sortOrder){if((t.oColumns[i].sortOrder).toUpperCase()=="ASC"||(t.oColumns[i].sortOrder).toUpperCase=="DESC"){this.COLUMNS_SORT.push({name:t.oColumns[i].sortBy,order:t.oColumns[i].sortOrder})}}}try{var u=sap.suite.smartbusiness.odata.getUri({serviceUri:this._oModel.QUERY_SERVICE_URI,entitySet:this._oModel.QUERY_ENTITY_SET,dimension:d,measure:m,filter:this.DDA_MODEL.EVALUATION_DATA.FILTERS.results,sort:this.COLUMNS_SORT,dataLimit:(((this.dda_config.chartConfig.dataLimitations)&&(this.dda_config.chartConfig.dataLimit>0))?(this.dda_config.chartConfig.dataLimit):null),});u.model.read(u.uri,null,null,true,function(a){if(a.results.length){t.oChartData=a.results;t.oChartDataModel.setData({businessData:t.oChartData})}else{jQuery.sap.log.info("Chart data Table Returned Empty Results");t.oChartData=[];t.oChartDataModel.setData({businessData:t.oChartData})}c.setBusy(false)},function(){jQuery.sap.log.error("Error fetching data : "+u.uri);t.oChartData=[];t.oChartDataModel.setData({businessData:t.oChartData});c.setBusy(false)})}catch(e){jQuery.sap.log.error(e.toString());t.oChartData=[];t.oChartDataModel.setData({businessData:t.oChartData});c.setBusy(false)}},getDummyDataForChart:function(d,m,M,D){M=M||5;D=D||10;var c=[];var t,a={};for(var i=0;i<d.length;i++){a[d[i]]=[];for(var j=0;j<M;j++){a[d[i]].push(d[i]+"_"+j)}}for(var i=0;i<D;i++){t={};for(var j=0;j<d.length;j++){var b=a[d[j]].length;var p=sap.suite.smartbusiness.utils.getRandomNumber(b);t[d[j]]=a[d[j]][p]}for(var j=0;j<m.length;j++){t[m[j]]=sap.suite.smartbusiness.utils.getRandomNumber(100)}c.push(t)}c=this.sortChartData(c,d);return c},sortChartData:function(c,d){var e=[];c.sort(function(a,b){var i=0;while(i<d.length){if(a[d[i]]>b[d[i]]){return-1}else if(a[d[i]]<b[d[i]]){return 1}i++}});var t={};for(var i=0,k=0;i<c.length;i++){var s="";for(var j=0;j<d.length;j++){s+=c[i][d[j]]}if(!t[s]){t[s]=true;e[k++]=c[i]}}return e},onDeleteConfiguration:function(){var t=this;var s=t;this.confirmDialog=new sap.m.Dialog({icon:"sap-icon://warning2",title:s._oTextsModel.getResourceBundle().getText("WARNING"),state:"Error",type:"Message",content:[new sap.m.Text({text:s._oTextsModel.getResourceBundle().getText("DELETE_ALL_CONFIGURATIONS")})],beginButton:new sap.m.Button({text:s._oTextsModel.getResourceBundle().getText("OK"),press:function(){t.busyIndicator.open()&&t.getView().setBusy(true);s.deleteMaster()}}),endButton:new sap.m.Button({text:s._oTextsModel.getResourceBundle().getText("CANCEL"),press:function(){this.getParent().close()}})});this.confirmDialog.open()},deleteMaster:function(){var t=this;var m=this.getView().getModel("SB_DDACONFIG").getData();this.busyIndicator.open()&&this.getView().setBusy(true);var s=sap.suite.smartbusiness.ddaconfig.DrilldownSaveService;s.saveEvalConfiguration(this.evaluationId,m,"delete",function(){jQuery.sap.log.info("Deleted master configuration for the evaluation");t.busyIndicator.close()&&t.getView().setBusy(false);sap.m.MessageToast.show(t._oTextsModel.getResourceBundle().getText("EVAL_CONFIG_DELETE_SUCCESS"));t.confirmDialog.close();t.DDA_MODEL.removeAllViews();t.DDA_MODEL.setViewId("");t.bindUiToModel();t._oModel=t.DDA_MODEL.getModelDataForDDAConfiguration();t.refreshChart();t.getView().getModel().refresh()},function(e){jQuery.sap.log.error(e+" failed");t.busyIndicator.close()&&t.getView().setBusy(false);sap.suite.smartbusiness.utils.showErrorMessage(t._oTextsModel.getResourceBundle().getText("DELETE_ERROR"))})},onViewSwitch:function(e){var k=e.getParameter("selectedKey");this.viewId=k;this.DDA_MODEL.setViewId(this.viewId);this._oModel=this.DDA_MODEL.getModelDataForDDAConfiguration();this.bindUiToModel();this.refreshChart()},updateHeaderFooterOptions:function(p){this.setBtnEnabled("Paste",p)},checkEvaluationForPaste:function(){var c=this.EVALUATION.evaluationData;var a=this.getView().getModel("SB_DDACONFIG").getData();if((this.copyClipboard.evaluationData.ID==c.ID)||this.checkEvaluationForPaste1()){this.updateHeaderFooterOptions(false)}else{this.updateHeaderFooterOptions(true)}},checkEvaluationForPaste1:function(){var b=this.copyClipboard.masterData;var d={};var f={};if(this.getView().getModel("SB_DDACONFIG").getData().ALL_MEASURES.length){if(this.getView().getModel("SB_DDACONFIG").getData().ALL_MEASURES.length==1){d[this.getView().getModel("SB_DDACONFIG").getData().ALL_MEASURES[0]]="M"}else{d=this.getView().getModel("SB_DDACONFIG").getData().ALL_MEASURES.reduce(function(p,c,i,a){d=d||{};if(i==1){d[a[0]]="M"}d[a[i]]="M";return d})}}if(this.getView().getModel("SB_DDACONFIG").getData().ALL_DIMENSIONS.length){if(this.getView().getModel("SB_DDACONFIG").getData().ALL_DIMENSIONS.length==1){f[this.getView().getModel("SB_DDACONFIG").getData().ALL_DIMENSIONS[0]]="D"}else{f=this.getView().getModel("SB_DDACONFIG").getData().ALL_DIMENSIONS.reduce(function(p,c,i,a){f=f||{};if(i==1){f[a[0]]="D"}f[a[i]]="D";return f})}}var g=null;this.diffHeaders=[];for(var i=0,l=b.FILTERS.length;i<l;i++){delete b.FILTERS[i].__metadata;if(f[b.FILTERS[i].DIMENSION]!="D"){if(g==null){g={}}if(g.DIMENSIONS==undefined){g.DIMENSIONS={}}if(g.DIMENSIONS[b.FILTERS[i].DIMENSION]==undefined){g.DIMENSIONS[b.FILTERS[i].DIMENSION]=[]}b.FILTERS[i].entityType="FILTER";g.DIMENSIONS[b.FILTERS[i].DIMENSION].push(b.FILTERS[i])}}for(var i=0,l=b.CHART.length;i<l;i++){delete b.CHART[i].__metadata;if(b.CHART[i].THRESHOLD_MEASURE){if(d[b.CHART[i].THRESHOLD_MEASURE]!="M"){if(g==null){g={}}if(g.MEASURES==undefined){g.MEASURES={}}if(g.MEASURES[b.CHART[i].THRESHOLD_MEASURE]==undefined){g.MEASURES[b.CHART[i].THRESHOLD_MEASURE]=[]}b.CHART[i].entityType="THRESHOLD_MEASURE";g.MEASURES[b.CHART[i].THRESHOLD_MEASURE].push(b.CHART[i])}}}for(var i=0,l=b.COLUMNS.length;i<l;i++){delete b.COLUMNS[i].__metadata;var h=null;var k=null;if(b.COLUMNS[i].TYPE=="MEASURE"){if((d[b.COLUMNS[i].NAME]!="M")){if(g==null){g={}}if(g.MEASURES==undefined){g.MEASURES={}}if(g.MEASURES[b.COLUMNS[i].NAME]==undefined){g.MEASURES[b.COLUMNS[i].NAME]=[]}b.COLUMNS[i].entityType="MEASURE";g.MEASURES[b.COLUMNS[i].NAME].push(b.COLUMNS[i])}if((d[b.COLUMNS[i].SORT_BY]!="M")){if(g==null){g={}}if(g.MEASURES==undefined){g.MEASURES={}}if(g.MEASURES[b.COLUMNS[i].SORT_BY]==undefined){g.MEASURES[b.COLUMNS[i].SORT_BY]=[]}h=jQuery.extend(true,{},b.COLUMNS[i],{});h.entityType="SORT_BY";g.MEASURES[b.COLUMNS[i].SORT_BY].push(h)}}else if(b.COLUMNS[i].TYPE=="DIMENSION"){if((f[b.COLUMNS[i].NAME]!="D")){if(g==null){g={}}if(g.DIMENSIONS==undefined){g.DIMENSIONS={}}if(g.DIMENSIONS[b.COLUMNS[i].NAME]==undefined){g.DIMENSIONS[b.COLUMNS[i].NAME]=[]}b.COLUMNS[i].entityType="DIMENSION";g.DIMENSIONS[b.COLUMNS[i].NAME].push(b.COLUMNS[i])}if((f[b.COLUMNS[i].SORT_BY]!="D")){if(g==null){g={}}if(g.DIMENSIONS==undefined){g.DIMENSIONS={}}if(g.DIMENSIONS[b.COLUMNS[i].SORT_BY]==undefined){g.DIMENSIONS[b.COLUMNS[i].SORT_BY]=[]}k=jQuery.extend(true,{},b.COLUMNS[i],{});k.entityType="SORT_BY";g.DIMENSIONS[b.COLUMNS[i].SORT_BY].push(k)}}}for(var i=0,l=b.HEADER.length;i<l;i++){if(b.HEADER[i].EVALUATION_ID!==b.HEADER[i].REFERENCE_EVALUATION_ID){this.diffHeaders.push(b.HEADER[i])}else{if((b.HEADER[i].VISUALIZATION_TYPE!="NT")&&(b.HEADER[i].VISUALIZATION_TYPE!="AT")){if((b.HEADER[i].VISUALIZATION_TYPE==="CM")){var n=undefined;try{n=JSON.parse(JSON.parse(b.HEADER[i].CONFIGURATION).MEASURES)}catch(e){throw new Error("Failed to parse multiple measures of Comparison Chart Multiple Measures")}for(var j=0,m=n.length;i<m;i++){if(d[n[j]["name"]]!="M"){b.HEADER[i].entityType="HEADERS";if(g==null){g={}}if(g.MEASURES==undefined){g.MEASURES={}}if(g.MEASURES[n[j]["name"]]==undefined){g.MEASURES[n[j]["name"]]=[]}g.MEASURES[n[j]["name"]].push(b.HEADER[i]);break}}}else{if(f[b.HEADER[i].DIMENSION]!="D"){b.HEADER[i].entityType="HEADERS";if(g==null){g={}}if(g.DIMENSIONS==undefined){g.DIMENSIONS={}}if(g.DIMENSIONS[b.HEADER[i].DIMENSION]==undefined){g.DIMENSIONS[b.HEADER[i].DIMENSION]=[]}g.DIMENSIONS[b.HEADER[i].DIMENSION].push(b.HEADER[i])}}}}}return g},copyEvaluationToClipboard:function(){var t=this;var c=function(){t.copyClipboard={};t.copyClipboard.MasterData=t.getView().getModel("SB_DDACONFIG").getData();t.copyClipboard.masterData=sap.suite.smartbusiness.ddaconfig.MasterData;t.copyClipboard.evaluationData=t.EVALUATION.evaluationData;sap.m.MessageToast.show(t.oApplicationFacade.getResourceBundle().getText("COPY_DDA_TO_CLIPBOARD",t.EVALUATION.evaluationData.TITLE||(t.EVALUATION.evaluationData.ID+"*")));t.updateHeaderFooterOptions(false)};if(sap.suite.smartbusiness.ddaconfig.MasterData.HEADER&&sap.suite.smartbusiness.ddaconfig.MasterData.HEADER.length){var d=[];for(var i=0,l=sap.suite.smartbusiness.ddaconfig.MasterData.HEADER.length;i<l;i++){if(sap.suite.smartbusiness.ddaconfig.MasterData.HEADER[i].EVALUATION_ID!=sap.suite.smartbusiness.ddaconfig.MasterData.HEADER[i].REFERENCE_EVALUATION_ID){d.push(sap.suite.smartbusiness.ddaconfig.MasterData.HEADER[i])}}if(d&&d.length){t.warnDialog=t.warnDialog||new sap.m.Dialog({icon:"sap-icon://warning2",title:t.oApplicationFacade.getResourceBundle().getText("WARNING"),state:"Warning",type:"Message",content:[new sap.m.Text({text:t.oApplicationFacade.getResourceBundle().getText("RELATED_KPIS_HEADER_TILES_EXIST_WARN")})],beginButton:new sap.m.Button({text:t.oApplicationFacade.getResourceBundle().getText("CONTINUE"),press:function(){t.warnDialog.close();c()}})});t.warnDialog.open()}else{c()}}else{c()}},copyDDAConfiguration:function(){var t=this;if(this.copyClipboard&&this.copyClipboard.evaluationData){var p={sourceEvaluationId:this.copyClipboard.evaluationData.ID,targetEvaluationId:this.EVALUATION.evaluationData.ID};var c=function(){sap.suite.smartbusiness.utils.create(sap.suite.smartbusiness.utils.serviceUrl("COPY_DDA_CONFIGURATION_SERVICE_URI"),p,null,function(d){sap.m.MessageToast.show(t.oApplicationFacade.getResourceBundle().getText("DDA_COPY_SUCCESS"));t.getView().getModel().refresh();var e={getParameter:function(a){var b={name:"detail",arguments:{contextPath:"EVALUATIONS_DDA('"+t.evaluationId+"')"}};return b[a]}};t.onRoutePatternMatched(e)},function(e){sap.suite.smartbusiness.utils.showErrorMessage(t.oApplicationFacade.getResourceBundle().getText("DDA_COPY_ERROR"),e.responseText)})};if(sap.suite.smartbusiness&&sap.suite.smartbusiness.ddaconfig&&sap.suite.smartbusiness.ddaconfig&&sap.suite.smartbusiness.ddaconfig.MasterData&&sap.suite.smartbusiness.ddaconfig.MasterData.MASTER&&sap.suite.smartbusiness.ddaconfig.MasterData.MASTER.length){this.warnOverwriteDialog=this.warnOverwriteDialog||new sap.m.Dialog({icon:"sap-icon://warning2",title:t.oApplicationFacade.getResourceBundle().getText("WARNING"),state:"Warning",type:"Message",content:[new sap.m.Text({text:t.oApplicationFacade.getResourceBundle().getText("DDA_CONFIG_EXISTING_WARN")})],beginButton:new sap.m.Button({text:t.oApplicationFacade.getResourceBundle().getText("CONTINUE"),press:function(){t.warnOverwriteDialog.close();c()}}),endButton:new sap.m.Button({text:t.oApplicationFacade.getResourceBundle().getText("CANCEL"),press:function(){t.warnOverwriteDialog.close()}})});this.warnOverwriteDialog.open()}else{c()}}},checkForCopy:function(){if(sap.suite.smartbusiness.ddaconfig&&sap.suite.smartbusiness.ddaconfig.MasterData&&sap.suite.smartbusiness.ddaconfig.MasterData.MASTER&&sap.suite.smartbusiness.ddaconfig.MasterData.MASTER.length){this.setBtnEnabled("Copy",true)}else{this.setBtnEnabled("Copy",false)}},onAfterRendering:function(){this.setBtnEnabled("Paste",false);this.checkForCopy()}});
