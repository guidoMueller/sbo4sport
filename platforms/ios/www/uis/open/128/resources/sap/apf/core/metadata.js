/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.apf.core.metadata");jQuery.sap.require("sap.apf.utils.utils");
sap.apf.core.Metadata=function(I,a){this.type="metadata";var c=I.coreApi;var m;var A;var e;var h=new I.hashtable(I.messageHandler);var H=new I.hashtable(I.messageHandler);var o=new I.hashtable(I.messageHandler);var b=new I.hashtable(I.messageHandler);var d=new I.hashtable(I.messageHandler);this.getPropertyMetadata=function(E,P){I.messageHandler.check(E!==undefined&&typeof E==="string","sap.apf.core.Metadata:getPropertyMetadata incorrect EntityType name or type");I.messageHandler.check(P!==undefined&&typeof P==="string","sap.apf.core.Metadata:getPropertyMetadata incorrect sPropertyName name or type");if(h.hasItem(E+P)===true){return h.getItem(E+P)}else{u();var i=p(E,true);var j=n(E,true);if(i.property.length===0){i=p(E,false);j=n(E.substring(0,E.lastIndexOf("type")),false)}if(!j[P]){j=n(E.substring(0,E.lastIndexOf("resultstype")),true)}var k=q(i,P);var l=r(j,P);var M=s(l,k);h.setItem(E+P,t(M));return h.getItem(E+P)}};this.getFilterableProperties=function(E){I.messageHandler.check(E!==undefined&&typeof E==="string","sap.apf.core.Metadata:getFilterableProperties incorrect EntityType name or type");if(H.hasItem(E)===true){return H.getItem(E)}else{u();var R=[];var k=p(E,true);var l=n(E,true);for(var i=0;i<k.property.length;i++){var P=k.property[i];if(P.extensions&&P.extensions){var F=true;for(var j=0;j<P.extensions.length;j++){var w=P.extensions[j];if(w.name==="filterable"&&w.value==="false"){F=false;break}}if(F){R.push(P.name)}}}for(var x in l){if(l[x]&&l[x].filterable&&l[x].filterable==="true"){R.push(x)}}H.setItem(E,R);return H.getItem(E)}};this.getAllPropertiesFromEntityType=function(E){I.messageHandler.check(E!==undefined&&typeof E==="string","sap.apf.core.Metadata:getAllProperties incorrect EntityType name or type");if(o.hasItem(E)===true){return o.getItem(E)}else{var j=[];var P=[];var k=[];var l=p(E,true);for(var i=0;i<l.property.length;i++){P.push(l.property[i].name)}var w=this.getHanaViewParameters(E);for(var i=0;i<w.length;i++){k.push(w[i].name)}j=P.concat(k);o.setItem(E,j);return o.getItem(E)}};this.getAllProperties=function(){var j=[];var e=g();for(var i=0;i<e.length;i++){j=j.concat(this.getAllPropertiesFromEntityType(e[i]))}j=sap.apf.utils.eliminateDuplicatesInArray(I.messageHandler,j);return j};this.getAllHanaViewParameters=function(){var k=[];var l=[];var e=g();for(var i=0;i<e.length;i++){l=this.getHanaViewParameters(e[i]);for(var j=0;j<l.length;j++){k.push(l[j].name)}}k=sap.apf.utils.eliminateDuplicatesInArray(I.messageHandler,k);return k};this.getAllKeys=function(){var k=[];var K=[];var e=g();for(var i=0;i<e.length;i++){var E=p(e[i],true);if(!E.name){E=p(e[i],false)}for(var j=0;j<E.key.propertyRef.length;j++){K.push(E.key.propertyRef[j].name)}k=k.concat(K)}k=sap.apf.utils.eliminateDuplicatesInArray(I.messageHandler,k);return k};this.getAttributes=function(P){var e=g();var j;for(var i=0;i<e.length;i++){j=this.getPropertyMetadata(e[i],P);if(j.name){break}}return j};this.getHanaViewParameters=function(E){I.messageHandler.check(E!==undefined&&typeof E==="string","sap.apf.core.Metadata:getHanaViewParameters incorrect EntityType name or type");if(b.hasItem(E)===true){return b.getItem(E)}else{u();var j=p(E,false);var k=n(E,false);var M={};var R=[];for(var i=0;i<j.property.length;i++){var P=j.property[i];var l=k[P.name];if(l!==undefined){P=jQuery.extend(P,l)}M[P.name]=P}for(var w in M){R.push(t(M[w]))}b.setItem(E,R);return b.getItem(E)}};this.getEntityTypeMetadata=function(E){I.messageHandler.check(E!==undefined&&typeof E==="string","sap.apf.core.Metadata:getEntityTypeMetadata incorrect EntityType name or type");if(d.hasItem(E)===true){return d.getItem(E)}else{u();var i=f(E);var j={};for(var A in i){var k=A.split(".").pop();k=k.replace(/^./,k[0].toLowerCase());for(var l in i[A]){j[k]=i[A][l]}}d.setItem(E,j);return d.getItem(E)}};this.getUriSuffix=function(E){var M=p(E+"Results",true);if(M&&M.property&&M.property.length>0){return"Results"}else{return""}};function g(){if(!e){e=[];for(var i=0;i<m.dataServices.schema.length;i++){for(var j=0;j<m.dataServices.schema[i].entityType.length;j++){e.push(m.dataServices.schema[i].entityType[j].name.toLowerCase())}}}return e}function f(E){for(var i in A){if(i.split(".").pop().toString().toLowerCase().indexOf(E.toLowerCase())>-1){return A[i]}}return{}}function n(E,i){for(var j in A.propertyAnnotations){if(i){if(j.split(".").pop().toString().toLowerCase().indexOf((E+"ResultsType").toLowerCase())>-1){return A.propertyAnnotations[j]}}else{if(j.split(".").pop().toString().toLowerCase().indexOf((E+"Type").toLowerCase())>-1){return A.propertyAnnotations[j]}}}return{}}function p(E,w){for(var i=0;i<m.dataServices.schema.length;i++){for(var j=0;j<m.dataServices.schema[i].entityType.length;j++){var x=m.dataServices.schema[i].entityType[j].extensions;if(m.dataServices.schema[i].entityType[j].name.toLowerCase().indexOf(E.toLowerCase())>-1){if(w){for(var k=0;k<x.length;k++){if(x[k].name.toLowerCase()==="semantics"&&x[k].value.toLowerCase()==="aggregate"){return m.dataServices.schema[i].entityType[j]}}}else{for(var l=0;l<x.length;l++){if(x[l].name.toLowerCase()==="semantics"&&x[l].value.toLowerCase()==="parameters"){return m.dataServices.schema[i].entityType[j]}}}}}}return{property:[]}}function q(E,P){for(var i=0;i<E.property.length;i++){if(E.property[i].name.toLowerCase()===P.toLowerCase()){return E.property[i]}}return{}}function r(E,P){for(var i in E){if(i.toLowerCase()===P.toLowerCase()){return E[i]}}return{}}function s(F,S){for(var i in S){F[i]=S[i]}return F}function t(l){function w(j){if(!l.dataType){l.dataType={}}if(j){l.dataType[j]=l[i]}else{l.dataType[i]=l[i]}delete l[i]}function x(y){if(jQuery.isArray(l[i])===true){for(var j=0;j<l[i].length;j++){l[l[i][j].name]=l[i][j].value}delete l[i]}else if(i!=="dataType"&&typeof(l[i])==="object"){if(Object.keys(l[i]).length===0){l[y]="true"}for(var k in l[i]){l[y]=l[i][k]}delete l[i]}else{l[y]=l[i]}}for(var i in l){switch(i){case'type':w();break;case'maxLength':w();break;case'precision':w();break;default:var P=i.split(".").pop();if(P.search("ISO")===0){x(P)}else{x(P.replace(/^./,P[0].toLowerCase()))}break}}return l}function u(){I.messageHandler.check(m!==undefined,'sap.apf.metadata - oMetadata is undefined');I.messageHandler.check(m.dataServices,'sap.apf.metadata - oMetadata.dataServices is undefined');I.messageHandler.check(m.dataServices.schema!==undefined,'sap.apf.metadata - oMetadata.dataServices.schema is undefined');I.messageHandler.check(A!==undefined,'sap.apf.metadata - oAnnotation is undefined')}function v(){function i(D,k){try{m=D;var l=c.getUriGenerator().getODataPath(a)+"annotation.xml";A=I.annotation.parse(m,l)}catch(E){I.messageHandler.putMessage(I.messageHandler.createMessageObject({code:"5017",aParameters:[E.message],oCallingObject:this}));A={}}}function j(E){if(E.messageObject&&E.messageObject.type==="messageObject"){I.messageHandler.putMessage(E.messageObject)}else{I.messageHandler.putMessage(I.messageHandler.createMessageObject({code:"5018",aParameters:[E.response.statusCode,E.sMessage,E.response.statusText,E.response.requestUri]}))}A={}}var R={method:'GET',headers:{"x-csrf-token":c.getXsrfToken(a)},requestUri:c.getUriGenerator().getAbsolutePath(a)+"$metadata",async:false};c.odataRequest(R,i,j,I.datajs.metadataHandler)}v()};
