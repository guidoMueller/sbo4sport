// Copyright (c) 2013 SAP AG, All Rights Reserved
(function(){"use strict";jQuery.sap.require("sap.ui.thirdparty.signals");jQuery.sap.require("sap.ui.thirdparty.hasher");jQuery.sap.require("sap.ui.core.routing.HashChanger");jQuery.sap.declare("sap.ushell.services.ShellNavigation");sap.ui.core.routing.HashChanger.extend("sap.ushell.services.ShellNavigationHashChanger",{constructor:function(){sap.ui.core.routing.HashChanger.apply(this);this.priv_initializedByShellNav=false;this.oURLShortening=sap.ushell.Container.getService("URLShortening");this.privfnShellCallback=null;this.privappHashPrefix="&/";this.privhashPrefix="#";this.privgetCurrentShellHash=function(){var r=this.privsplitHash(hasher.getHash());return{hash:"#"+((r&&r.shellPart)?r.shellPart:"")}};this.privconstructHash=function(a){var o=this.privgetCurrentShellHash();o.hash=o.hash+a;return o};this.privconstructShellHash=function(s){return sap.ushell.Container.getService("URLParsing").constructShellHash(s)};this.privsplitHash=function(h){var s,a;if(h===undefined||h===null||h===""){return{shellPart:null,appSpecificRoute:null}}s=sap.ushell.Container.getService("URLParsing").parseShellHash(h);if(s===undefined||s===null){return null}a=s.appSpecificRoute;s.appSpecificRoute=undefined;return{shellPart:(s&&this.privstripLeadingHash(this.privconstructShellHash(s)))||null,appSpecificRoute:(s&&a)||null}};this.privsetHash=function(f,a,w){hasher.prependHash="";f=this.privstripLeadingHash(f);a=a||"";if(w===undefined){w=true}if(w){this.fireEvent("hashSet",{sHash:a});hasher.setHash(f)}else{this.fireEvent("hashReplaced",{sHash:a});hasher.replaceHash(f)}};this.privstripLeadingHash=function(h){if(h[0]==='#'){return h.substring(1)}return h};this.hrefForExternal=function(a,v){var t;if(v===true){t=this.privhrefForExternalNoEnc(a);return{hash:encodeURI(t.hash),params:t.params,skippedParams:t.skippedParams}}return encodeURI(this.privhrefForExternalNoEnc(a).hash)};this.privhrefForExternalNoEnc=function(a,v){var r;if(a===undefined){return this.privgetCurrentShellHash()}if(a&&a.target&&(typeof a.target.semanticObject==="string"||typeof a.target.shellHash==="string")){r="#"+this.privconstructShellHash(a);return this.oURLShortening.checkHashLength(r)}return this.privgetCurrentShellHash()};this.privgetAppHash=function(a){var A,s;if(a&&a.target&&(typeof a.target.shellHash==="string")){s=sap.ushell.Container.getService("URLParsing").parseShellHash(a.target.shellHash);A=s&&s.appSpecificRoute;A=A&&A.substring(2)}return A};this.hrefForAppSpecificHash=function(a){return encodeURI(this.privconstructHash(this.privappHashPrefix+a).hash)};this.toExternal=function(a){var h=this.privhrefForExternalNoEnc(a).hash,A=this.privgetAppHash(a);this.privsetHash(h,A)};this.toAppHash=function(a,w){var h=this.privconstructHash(this.privappHashPrefix+a).hash;this.privsetHash(h,a,w)}}});sap.ushell.services.ShellNavigationHashChanger.prototype.initShellNavigation=function(s){if(this.priv_initializedByShellNav){jQuery.sap.log.info("initShellNavigation already called on this ShellNavigationHashChanger instance.");return false}this.privfnShellCallback=s;hasher.changed.add(this.treatHashChanged,this);if(!hasher.isActive()){hasher.initialized.addOnce(this.treatHashChanged,this);hasher.init()}else{this.treatHashChanged(hasher.getHash())}this.priv_initializedByShellNav=true;return true};sap.ushell.services.ShellNavigationHashChanger.prototype.init=function(){if(this.priv_initialized){jQuery.sap.log.info("init already called on this ShellNavigationHashChanger instance.");return false}var n=this.privsplitHash(hasher.getHash()),a=n&&(n.appSpecificRoute||"  ").substring(2);this.fireEvent("hashChanged",{newHash:a});this.priv_initialized=true;return true};sap.ushell.services.ShellNavigationHashChanger.prototype.treatHashChanged=function(n,o){var a,O,N,b,e;n=this.oURLShortening.expandHash(n);o=this.oURLShortening.expandHash(o);N=this.privsplitHash(n);b=this.privsplitHash(o);if(!N){e=new Error("Illegal new hash - cannot be parsed: '"+n+"'");this.fireEvent("shellHashChanged",{newShellHash:n,newAppSpecificRoute:null,oldShellHash:(b?b.shellPart:o),error:e});this.privfnShellCallback(n,null,(b?b.shellPart:o),e);return}if(!b){b={shellPart:o,appSpecificRoute:null}}if(N.shellPart===b.shellPart&&(o!==undefined)){a=(N.appSpecificRoute||"  ").substring(2);O=(b.appSpecificRoute||"  ").substring(2);this.fireEvent("hashChanged",{newHash:a,oldHash:O});return}this.fireEvent("shellHashChanged",{newShellHash:N.shellPart,newAppSpecificRoute:N.appSpecificRoute,oldShellHash:b.shellPart});this.privfnShellCallback(N.shellPart,N.appSpecificRoute,b.shellPart)};sap.ushell.services.ShellNavigationHashChanger.prototype.setHash=function(h){this.toAppHash(h,true)};sap.ushell.services.ShellNavigationHashChanger.prototype.replaceHash=function(h){this.toAppHash(h,false)};sap.ushell.services.ShellNavigationHashChanger.prototype.getHash=function(){return this.getAppHash()};sap.ushell.services.ShellNavigationHashChanger.prototype.getAppHash=function(){var n=this.privsplitHash(hasher.getHash()),a=n&&(n.appSpecificRoute||"  ").substring(2);return a};sap.ushell.services.ShellNavigationHashChanger.prototype.destroy=function(){hasher.changed.remove(this.treatHashChanged,this);sap.ui.core.routing.HashChanger.prototype.destroy.apply(this,arguments)};function S(){this.hashChanger=new sap.ushell.services.ShellNavigationHashChanger();this.hrefForExternal=function(a,v){return this.hashChanger.hrefForExternal(a,v)};this.hrefForAppSpecificHash=function(a){return this.hashChanger.hrefForAppSpecificHash(a)};this.toExternal=function(a){this.hashChanger.toExternal(a)};this.toAppHash=function(a,w){this.hashChanger.toAppHash(a,w)};this.init=function(s){hasher.prependHash="";sap.ui.core.routing.HashChanger.replaceHashChanger(this.hashChanger);this.hashChanger.initShellNavigation(s);return this}}sap.ushell.services.ShellNavigation=S;sap.ushell.services.ShellNavigation.hasNoAdapter=true}());
