/*
 * Copyright (C) 2009-2014 SAP SE or an SAP affiliate company. All rights reserved
 */
jQuery.sap.declare("sap.ca.scfld.md.app.ConnectionManager");jQuery.sap.require("sap.ca.ui.message.message");jQuery.sap.require("sap.ca.ui.utils.busydialog");sap.ui.base.ManagedObject.extend("sap.ca.scfld.md.app.ConnectionManager",{metadata:{properties:{identity:"string",configuration:"object",defaultConfiguration:"object",component:"object"}},initModels:function(){function a(p,A){(A||"").split("&").forEach(function(P){var i=P.indexOf("="),K=P,v="";if(i>=0){v=decodeURIComponent(K.slice(i+1));K=K.slice(0,i)}K=decodeURIComponent(K);if(K){p[K]=v}})}this.modelList={};this.mockServerList={};this.iRequestCount=0;var s=jQuery.isArray(this.getConfiguration().getServiceList())?this.getConfiguration().getServiceList().slice():null;var e=this.getConfiguration().getExcludedQueryStringParameters()||[];var b=this.getConfiguration().isMock();var t=this;var c=jQuery.sap.getUriParameters().get("sap-server");var d=jQuery.sap.getUriParameters().get("sap-host");var f=jQuery.sap.getUriParameters().get("sap-host-http");var g=jQuery.sap.getUriParameters().get("sap-client");var C=t.getComponent();this.sErrorInStartMessage="";this.bIsComponentBase=!!C.setRouterSetCloseDialogs;this.bIsShowingMessage=false;if(!sap.ui.getCore().getConfiguration().getDisableCustomizing()&&C&&C.getMetadata()){var o=C.getMetadata().getConfig();var h=o["sap.ca.serviceConfigs"];var m=function(S,E){var l,n;var p=jQuery.isArray(E)?E.slice():[];for(var i=0;i<S.length;i++){l=S[i];for(var j=0;j<p.length;j++){n=p[j];if(l.name==n.name){for(var q in n){l[q]=n[q]}p.splice(j,1);j--}}};S=S.concat(p);return S};if(h!=undefined&&h.length>0&&s!=null){var k=m(s,h);s=k}}if(s!=null){jQuery.each(s,function(i,j){function l(E,S){var P=E.getParameters(),r="Cannot load meta data for service "+S.serviceUrl,D=P.getParameter("statusCode"),v=t.getIdentity()||"sap.ca.scfld.md.app.ConnectionManager";D+=" (";D+=P.getParameter("statusText");D+=") - ";D+=P.getParameter("message");D+="\n";D+=P.getParameter("responseText");jQuery.sap.log.error(r,D,v)}var u=URI(j.serviceUrl);if(c!=null&&(jQuery.inArray("sap-server",e)==-1)){u.addSearch("sap-server",c)}else if(d!=null&&(jQuery.inArray("sap-host",e)==-1)){u.addSearch("sap-host",d)}else if(f!=null&&(jQuery.inArray("sap-host-http",e)==-1)){u.addSearch("sap-host-http",f)}if(g!=null&&(jQuery.inArray("sap-client",e)==-1)){u.addSearch("sap-client",g)}var U=u.toString();if(b){jQuery.sap.require("sap.ui.core.util.MockServer");var M=(U.split("?")[0]).replace(/\/?$/,"/");var n=new sap.ui.core.util.MockServer({rootUri:M});if(j.mockedDataSource){n.simulate(j.mockedDataSource,{sMockdataBaseUrl:j.mockedDataSource.replace(/[^\/]+$/,""),bGenerateMissingMockData:true})}else{n.simulate(M+"$metadata")}n.start();t.mockServerList[j.name]=n;if(j.isDefault){t.mockServerList[undefined]=n}}var o={metadataUrlParams:{},json:true,loadMetadataAsync:j.loadMetadataAsync===true};a(o.metadataUrlParams,j.metadataParams);if(j.serviceUrl.indexOf("/sap/opu/")===0){var p=sap.ushell&&sap.ushell.Container?sap.ushell.Container.getUser().getLanguage():jQuery.sap.getUriParameters().get("sap-language");if(p&&e.indexOf("sap-language")<0){o.metadataUrlParams["sap-language"]=p}}var q=new sap.ui.model.odata.ODataModel(U,o);if(o.loadMetadataAsync){q.attachMetadataLoaded({oModel:q,oService:j},function(E,P){t.checkModelMetaData(P.oModel,P.oService)},this);q.attachMetadataFailed({oModel:q,oService:j},function(E,P){l(E,P.oService);t.checkModelMetaData(P.oModel,P.oService)},this)}else{q.attachMetadataFailed(j,l,this);t.checkModelMetaData(q,j)}if(j.overrideGetPropertyMetadata&&q.oMetadata){q.oMetadata._getPropertyMetadata=function(E,P){P=P.replace(/^\/|\/$|\)$|\w*\(/g,"");return sap.ui.model.odata.ODataMetadata.prototype._getPropertyMetadata.apply(this,[E,P])}}if((j.useBatch)&&!b){q.setUseBatch(true)}if(j.countSupported){q.setCountSupported(true)}else{q.setCountSupported(false)}if(j.sDefaultBindingMode){q.setDefaultBindingMode(j.sDefaultBindingMode)}if(j.fRequestFailed){q.attachRequestFailed(null,j.fRequestFailed)}else{q.attachRequestFailed(null,jQuery.proxy(t.handleRequestFailed,t))}if(j.noBusyIndicator==true){q.attachRequestSent(null,jQuery.proxy(t.handleRequestSentInner,t));q.attachRequestCompleted(null,jQuery.proxy(t.handleRequestCompletedInner,t))}else{q.attachRequestSent(null,jQuery.proxy(t.handleRequestSent,t));q.attachRequestCompleted(null,jQuery.proxy(t.handleRequestCompleted,t))}if(j.isDefault){t.modelList[undefined]=q;t.setDefaultConfiguration(j)}else{t.modelList[j.name]=q}})}},checkModelMetaData:function(m,s){if(!m.getServiceMetadata()){var i=this.getProperty("configuration").oApplicationFacade.oApplicationImplementation.UilibI18nModel.getResourceBundle();this.sErrorInStartMessage=i.getText("ERROR_MSG_NO_METADATA",[s.name]);var S={type:sap.ca.ui.message.Type.ERROR,message:this.sErrorInStartMessage,details:i.getText("ERROR_DETAIL_NO_METADATA",[s.serviceUrl])};this.showMessageBox(S);return}},setIdentity:function(i){var o=this.getIdentity();if(o!=i){this.setProperty("identity",i)}},getModel:function(n){return this.modelList[n]},handleRequestSent:function(e){sap.ca.ui.utils.busydialog.requireBusyDialog();this.handleRequestSentInner(e)},handleRequestSentInner:function(e){this.iRequestCount++;jQuery.sap.log.info("Connection Manager","Request sent")},handleRequestFailed:function(e){jQuery.sap.log.error("Connection Manager","Failed to load data");var s={type:sap.ca.ui.message.Type.ERROR,message:e.getParameter("message"),details:e.getParameter("responseText")};this.showMessageBox(s)},handleRequestCompleted:function(e){sap.ca.ui.utils.busydialog.releaseBusyDialog();this.handleRequestCompletedInner(e)},handleRequestCompletedInner:function(e){if(e.getParameter("success")){jQuery.sap.log.info("Connection Manager","Request succesfully completed")}else{jQuery.sap.log.info("Connection Manager","Request completed with errors",e.getParameter("message"))}},showMessageBox:function(s){if(this.bIsShowingMessage){return}this.bIsShowingMessage=true;if(this.bIsComponentBase){var c=this.getComponent();var i=c._bRouterCloseDialogs;c.setRouterSetCloseDialogs(false)}sap.ca.ui.message.showMessageBox(s,jQuery.proxy(function(){this.bIsShowingMessage=false;if(this.bIsComponentBase){c.setRouterSetCloseDialogs(i)}},this))}});
sap.ca.scfld.md.app.ConnectionManager.getNewInstance=function(i,c,d,C){var o=new sap.ca.scfld.md.app.ConnectionManager({identity:i,configuration:c,defaultConfiguration:d,component:C});o.initModels();return o};
