/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.apf.ui.utils.print");
sap.apf.ui.utils.PrintHelper=function(I){"use strict";this.oCoreApi=I.oCoreApi;this.oUiApi=I.uiApi;this.oPathContextHandler=I.oPathContextHandler;this.printLayout=function(s,i,a){var m;var d=new Date();var b=this.oCoreApi.getApplicationConfigProperties().appName;if(!b){m=this.oCoreApi.createMessageObject({code:"6003",aParameters:["appName"]});this.oCoreApi.putMessage(m)}var c=this.oUiApi.getAnalysisPath().oSavedPathName.getTitle();var h=new sap.ui.core.HTML({content:['<div class="subHeaderPrintWrapper"><p class="printHeaderTitle"> '+this.oCoreApi.getTextHtmlEncoded(b)+' : '+jQuery.sap.encodeHTML(c)+'</p>','<p class="printHeaderDate"> '+d.toTimeString()+' </p></div><div class="clear"></div>','<div class="printChipName"><p>'+this.oCoreApi.getTextHtmlEncoded("print-step-number",[i,a])+'</p></div>'].join("")});var e=new sap.ui.layout.VerticalLayout();var S=this.oCoreApi.getTextNotHtmlEncoded(s.title);var f=s.getSelectedRepresentation();var g=f.bIsAlternateView?f.toggleInstance:f;if(f.bIsAlternateView){var j=s.getSelectedRepresentation().getData();var k=s.getSelectedRepresentation().getMetaData();g.setData(j,k)}var r={};if(g.type==="TableRepresentation"){r=g.getPrintContent(S);r.setWidth("1000px")}else{r=g.getPrintContent(S)}if(g.bIsLegendVisible===false){if(r.setLegend!==undefined){r.setLegend(new sap.viz.ui5.types.legend.Common({visible:false}))}if(r.setSizeLegend!==undefined){r.setSizeLegend(new sap.viz.ui5.types.legend.Common({visible:false}))}}else{if(r.setLegend!==undefined){r.setLegend(new sap.viz.ui5.types.legend.Common({visible:true}))}if(r.setSizeLegend!==undefined){r.setSizeLegend(new sap.viz.ui5.types.legend.Common({visible:true}))}}e.addContent(r);var p=new sap.ui.layout.VerticalLayout({content:[h,e]}).addStyleClass("representationContent");return p};this.formatter=function(m,v){var d=function(o){var p=this.oCoreApi.getTextNotHtmlEncoded("month-1-shortName");var r=this.oCoreApi.getTextNotHtmlEncoded("month-2-shortName");var s=this.oCoreApi.getTextNotHtmlEncoded("month-3-shortName");var t=this.oCoreApi.getTextNotHtmlEncoded("month-4-shortName");var u=this.oCoreApi.getTextNotHtmlEncoded("month-5-shortName");var x=this.oCoreApi.getTextNotHtmlEncoded("month-6-shortName");var z=this.oCoreApi.getTextNotHtmlEncoded("month-7-shortName");var A=this.oCoreApi.getTextNotHtmlEncoded("month-8-shortName");var B=this.oCoreApi.getTextNotHtmlEncoded("month-9-shortName");var C=this.oCoreApi.getTextNotHtmlEncoded("month-10-shortName");var D=this.oCoreApi.getTextNotHtmlEncoded("month-11-shortName");var E=this.oCoreApi.getTextNotHtmlEncoded("month-12-shortName");var F=[p,r,s,t,u,x,z,A,B,C,D,E];var G=o.substr(0,4);var H=F[o.substr(4,6)-1];return H+" "+G};var f,y,q,a,b,w,c;if(m.getAttribute("isCalendarYearMonth")){if(originalFieldValue===null){return""}f=d(v)}else if(m.type==="Edm.DateTime"){if(v===null){return"-"}c=new Date(parseInt(v.slice(6,v.length-2),10));c=c.toLocaleDateString();if(c==="Invalid Date"){return"-"}f=c}else if(m.getAttribute("isCalendarDate")){if(v===null){return"-"}y=v.substr(0,4);var e=v.substr(4,2);var g=v.substr(6,2);c=new Date(y,e,g);c=c.toLocaleDateString();if(c==="Invalid Date"){return"-"}f=c}else if(m.getAttribute("isCalendarYearQuarter")){if(v===null){return""}y=v.substr(0,4);q=v.substr(4,1);a=new Date(y);b=a.getFullYear();var h;h="Q"+q;var i=h+" "+b;f=i}else if(m.getAttribute("isCalendarYearWeek")){if(v===null){return""}y=v.substr(0,4);w=v.substr(4,2);a=new Date(y);b=a.getFullYear();var j;j="CW"+w;var k=j+" "+b;f=k}else{if(v===null){return"null"}f=v}var l=this.oUiApi.getEventCallback(sap.apf.core.constants.eventTypes.format);if(typeof l==="function"){var n=l.apply(this.oUiApi,[m,m.name,v,f]);if(n!==undefined){f=n}if(n===null){f=""}}return f};this.doPrint=function(){this.oUiApi.createApplicationLayout(false).setBusy(true);var a=this.oCoreApi.getSteps();var s=new sap.ui.layout.VerticalLayout();var d="";var p=2000;var t=this;var b=new Date();var c=this.oCoreApi.getApplicationConfigProperties().appName;var e=this.oUiApi.getAnalysisPath().oSavedPathName.getTitle();jQuery('#apfPrintArea').remove();jQuery("body").append('<div id="apfPrintArea"></div>');var f;var g=this.oUiApi.getEventCallback(sap.apf.core.constants.eventTypes.printTriggered);var h=this.oPathContextHandler?this.oPathContextHandler.getAllIds():[];var l=[];if(h.length>0){for(var i=0;i<h.length;i++){var F=this.oPathContextHandler.get(h[i]).getExpressions();l.push(F[0])}}else{l=this.oCoreApi.getContext().getExpressions()}var m=function(A){var B=[];var C=[];for(var i=0;i<l.length;i++){for(var j=0;j<l[i].length;j++){var D=l[i][j];var w="";var E="";A.oCoreApi.getMetadataFacade().getProperty(l[i][j].name,function(o){w=o.label;E=A.formatter(o,l[i][j].value)});D["name"]=w;D["value"]=E;B.push(D)}C.push(B);B=[]}return C};var n={getTextNotHtmlEncoded:t.oCoreApi.getTextNotHtmlEncoded};if(g!==undefined){var q=g.apply(n,[l])||[];f=(q.length>0)?q:m(this)}else{f=m(this)}var r=new sap.ui.core.HTML({content:['<div class="subHeaderPrintWrapper"><p class="printHeaderTitle"> '+this.oCoreApi.getTextHtmlEncoded(c)+' : '+jQuery.sap.encodeHTML(e)+'</p>','<p class="printHeaderDate"> '+b.toTimeString()+' </p></div><div class="clear"></div>'].join("")});var u=new sap.ui.layout.VerticalLayout();var v="";var w="";var i,j;for(i=0;i<f.length;i++){for(j=0;j<f[i].length;j++){w=f[i][j].name;if(j!==f[i].length-1){v+=f[i][j].value+", "}else{v+=f[i][j].value}}var x=new sap.m.Text({text:w}).addStyleClass("printFilterName");var y=new sap.m.Text({text:v}).addStyleClass("printFilterValue");u.addContent(x);u.addContent(y);v=""}var P=new sap.ui.layout.VerticalLayout({content:[r,u]}).addStyleClass("representationContent");s.addContent(P);var k;for(k=0;k<a.length;k++){var z=parseInt(k,10)+1;s.addContent(this.printLayout(a[k],z,a.length))}s.placeAt("apfPrintArea");if(jQuery(".v-geo-container").length){p=4000}window.setTimeout(function(){t.oUiApi.createApplicationLayout(false).setBusy(false)},p-150);window.setTimeout(function(){jQuery("#"+s.sId+" > div").after("<div class='page-break'> </div>");d=s.getDomRef();var o=jQuery('#apfPrintArea .sapUiTable');if(o.length){var A=jQuery('#apfPrintArea .printTable .sapMListTblHeader .sapMListTblCell').length;if(A>11){jQuery("#setPrintMode").remove();jQuery("<style id='setPrintMode' > @media print and (min-resolution: 300dpi) { @page {size : landscape;}}</style>").appendTo("head")}else{jQuery("#setPrintMode").remove();jQuery("<style id='setPrintMode'>@media print and (min-resolution: 300dpi) { @page {size : portrait;}}</style>").appendTo("head")}}jQuery("#apfPrintArea").empty();jQuery("#sap-ui-static > div").hide();jQuery("#apfPrintArea").append(jQuery(d).html());var i;for(i=0;i<jQuery("#apfPrintArea").siblings().length;i++){jQuery("#apfPrintArea").siblings()[i].hidden=true}window.print();window.setTimeout(function(){for(i=0;i<jQuery("#apfPrintArea").siblings().length;i++){jQuery("#apfPrintArea").siblings()[i].hidden=false}s.destroy()},10)},p)}};
