;(function(){"use strict";jQuery.sap.declare("sap.ushell.touchSupport");sap.ushell.touchSupport=function(c){if(!c||!c.rootSelector||!c.containerSelector||!c.draggableSelector){throw new Error("No configuration object to initialize User Interaction module.")}this.animationDuration;this.captureStart;this.captureMove;this.captureEnd;this.clickEvent;this.clickHandler;this.clone;this.cloneClass;this.container;this.contextMenuEvent;this.debug;this.dragAndScrollCallback;this.dragAndScrollDuration;this.dragAndScrollTimer;this.draggable;this.placeHolderClass;this.draggableSelector;this.draggableSelectorExclude;this.doubleTapCallback;this.doubleTapDelay;this.element;this.endEvent;this.endX;this.endY;this.isTouch;this.lastElement;this.lastTapTime;this.log;this.mode;this.moveEvent;this.moveTolerance;this.moveX;this.moveY;this.noop;this.preventClickFlag;this.preventClickTimeoutId;this.startEvent;this.startX;this.startY;this.switchModeDelay;this.tapsNumber;this.timer;this.touchCancelEvent;this.touchDragCallback;this.touchEndCallback;this.touchStartCallback;this.wrapper;this.init=function(c){var i;this.startX=-1;this.startY=-1;this.moveX=-1;this.moveY=-1;this.endX=-1;this.endY=-1;this.container=document.querySelector(c.containerSelector);this.switchModeDelay=c.switchModeDelay||1500;this.dragAndScrollDuration=c.dragAndScrollDuration||230;this.moveTolerance=c.moveTolerance===0?0:c.moveTolerance||10;this.draggableSelector=c.draggableSelector;this.draggableSelectorExclude=c.draggableSelectorExclude;this.mode='normal';this.debug=c.debug||false;this.root=document.querySelector(c.rootSelector);this.animationDuration=c.animationDuration||330;this.noop=function(){};this.tapsNumber=0;this.lastTapTime=0;this.log=this.debug?this.logToConsole:this.noop;this.placeHolderClass=c.placeHolderClass||"";this.cloneClass=c.cloneClass||"";this.wrapper=c.wrapperSelector?document.querySelector(c.wrapperSelector):this.container.parentNode;this.touchStartCallback=typeof c.touchStartCallback==='function'?c.touchStartCallback:this.noop;this.doubleTapCallback=typeof c.doubleTapCallback==='function'?c.doubleTapCallback:this.noop;this.touchEndCallback=typeof c.touchEndCallback==='function'?c.touchEndCallback:this.noop;this.touchDragCallback=typeof c.touchDragCallback==='function'?c.touchDragCallback:this.noop;this.dragAndScrollCallback=typeof c.dragAndScrollCallback==='function'?c.dragAndScrollCallback:this.noop;this.doubleTapDelay=c.doubleTapDelay||500;if(i=('ontouchstart'in window)){this.startEvent='touchstart';this.moveEvent='touchmove';this.endEvent='touchend';this.contextMenuEvent='contextmenu';this.touchCancelEvent='touchcancel';this.clickEvent='click';this.captureStart=this.captureTouchStart;this.captureMove=this.captureTouchMove;this.captureEnd=this.captureTouchEnd}else{throw new Error('Not supported!')}};this.forEach=function(s,a){return Array.prototype.forEach.call(s,a)};this.indexOf=function(s,i){return Array.prototype.indexOf.call(s,i)};this.insertBefore=function(s,i,r){var a,b,d;d=Array.prototype.splice;a=this.indexOf(s,i);b=this.indexOf(s,r);d.call(s,b-(a<b?1:0),0,d.call(s,a,1)[0])};this.logToConsole=function(){console.log.apply(console,arguments)};this.getDraggableElement=function(t){var a=t.target;var e=undefined;this.draggable=jQuery(this.draggableSelector,this.container);while(typeof e==='undefined'&&a!==this.root){if(this.indexOf(this.draggable,a)>=0&&jQuery(a).not(this.draggableSelectorExclude).length>0){e=a}a=a.parentNode}return e};this.captureTouchStart=function(e){var t;this.endHandler(e);this.element=undefined;if(e.touches.length===1){t=e.touches[0];this.element=this.getDraggableElement(t);this.startX=t.pageX;this.startY=t.pageY;this.lastMoveX=0;this.lastMoveY=0;if(this.lastTapTime&&this.lastElement&&this.element&&(this.lastElement===this.element)&&Math.abs(Date.now()-this.lastTapTime)<this.doubleTapDelay){this.lastTapTime=0;this.tapsNumber=2}else{this.lastTapTime=Date.now();this.tapsNumber=1;this.lastElement=this.element}}this.log('captureTouchStart('+this.startX+', '+this.startY+')')};this.startHandler=function(e){this.log('startHandler');clearTimeout(this.timer);delete this.timer;this.captureStart(e);if(this.element){this.touchStartCallback(e,this.element);if(this.tapsNumber===2){this.mode='double-tap';return}this.timer=setTimeout(function(){this.log('mode switched to drag');this.mode='drag';this.createClone()}.bind(this),this.switchModeDelay)}}.bind(this);this.captureTouchMove=function(e){var t;if(e.touches.length===1){t=e.touches[0];this.moveX=t.pageX;this.moveY=t.pageY}this.log('captureTouchMove('+this.moveX+', '+this.moveY+')')};this.moveHandler=function(e){this.log('moveHandler');this.captureMove(e);switch(this.mode){case'normal':if(Math.abs(this.startX-this.moveX)>this.moveTolerance||Math.abs(this.startY-this.moveY)>this.moveTolerance){this.log('-> normal');this.mode='scroll';clearTimeout(this.timer);delete this.timer}break;case'scroll':this.log('-> scroll');break;case'drag':e.preventDefault();this.log('-> drag');this.mode='drag-and-scroll';this.translateClone();this.dragAndScroll();this.touchDragCallback(e,this.element);break;case'drag-and-scroll':e.stopPropagation();e.preventDefault();this.log('-> drag-and-scroll');this.translateClone();this.dragAndScroll();this.moveDraggable();this.dragAndScrollCallback(e,this.clone);break}}.bind(this);this.captureTouchEnd=function(e){var t;if(e.changedTouches.length===1){t=e.changedTouches[0];this.endX=t.pageX;this.endY=t.pageY}this.log('captureTouchEnd('+this.endX+', '+this.endY+')')};this.contextMenuHandler=function(e){e.preventDefault()}.bind(this);this.clickHandler=function(e){if(this.preventClickFlag){this.preventClickFlag=false;e.preventDefault();e.stopPropagation();e.stopImmediatePropagation();clearTimeout(this.preventClickTimeoutId)}}.bind(this);this.preventClick=function(){this.preventClickFlag=true;this.preventClickTimeoutId=setTimeout(function(){this.preventClickFlag=false},100)};this.endHandler=function(e){this.log('endHandler');this.captureEnd(e);switch(this.mode){case'normal':this.log('-> normal');break;case'scroll':this.log('-> scroll');break;case'drag':this.log('-> drag');this.removeClone();this.touchEndCallback(e,this.element);this.preventClick();break;case'drag-and-scroll':this.log('-> drag-and-scroll');this.removeClone();this.touchEndCallback(e,this.element);this.preventClick();e.stopPropagation();e.preventDefault();break;case'double-tap':this.log('-> double-tap');this.doubleTapCallback(e,this.element);break}clearTimeout(this.timer);delete this.timer;this.lastMoveX=0;this.lastMoveY=0;this.mode='normal'}.bind(this);this.createClone=function(){var s,r;r=this.element.getBoundingClientRect();this.clone=this.element.cloneNode(true);this.clone.className+=(' '+this.cloneClass);this.element.className+=(' '+this.placeHolderClass);s=this.clone.style;s.position='fixed';s.display='block';s.top=r.top+'px';s.left=r.left+'px';s.width=r.width+'px';s.zIndex='100';s.webkitTransition='-webkit-transform 0ms cubic-bezier(0.33, 0.66, 0.66, 1)';s.transition='-webkit-transform 0ms cubic-bezier(0.33, 0.66, 0.66, 1)';s.webkitTransform='translate3d(0px, 0px, 0px) ';this.root.appendChild(this.clone);this.log('createClone')};this.removeClone=function(){this.element.className=this.element.className.split(' '+this.placeHolderClass).join('');this.clone.parentElement.removeChild(this.clone);this.clone=null;this.log('removeClone')};this.translateClone=function(){var d,a;d=this.moveX-this.startX;a=this.moveY-this.startY;this.clone.style.webkitTransform='translate3d('+d+'px, '+a+'px, 0px)';this.log('translateClone ('+d+', '+a+')')};this.dragAndScroll=function(){var d,a,s,t;function b(){s.webkitTransition='-webkit-transform '+a+'ms linear';s.transition='-webkit-transform '+a+'ms linear';s.webkitTransform='translate(0px, '+d+'px) scale(1) translateZ(0px)'}function e(){s.webkitTransition='';s.transition='';s.webkitTransform='';t.wrapper.scrollTop-=d}function g(){var r,h;if(t.clone){r=t.clone.getBoundingClientRect();h=t.wrapper.offsetTop-r.top;if(h>0){return h}h=t.wrapper.offsetTop+t.wrapper.offsetHeight-(r.top+t.clone.offsetHeight);if(h<0){return h}}return 0}function i(){if(d<0){return t.wrapper.getBoundingClientRect().top-(t.container.getBoundingClientRect().top+t.container.offsetHeight)+t.wrapper.offsetHeight<0}return t.container.getBoundingClientRect().top-(t.wrapper.getBoundingClientRect().top+t.container.offsetTop)<0}function f(){b();t.dragAndScrollTimer=setTimeout(function(){e();t.dragAndScrollTimer=undefined;if((d=g())!==0&&i()){f()}},a)}t=this;d=g();if(d!==0&&!this.dragAndScrollTimer&&i()){a=this.dragAndScrollDuration;s=this.container.style;f()}this.log('dragAndScroll ('+d+')')};this.moveDraggable=function(){var e,h,a,i,b,r,s;this.forEach(this.draggable,function(d,f){if(!h){r=d.getBoundingClientRect();s=window.getComputedStyle(d);i=!(r.right<this.moveX||r.left>this.moveX);b=!(r.bottom<this.moveY||r.top>this.moveY);if(i&&b){h=d;a=f}}}.bind(this));if(h&&this.element!==h){e=this.indexOf(this.draggable,this.element);if(Math.abs(this.lastMoveX-this.moveX)>=this.moveTolerance&&Math.abs(this.lastMoveY-this.moveY)>=this.moveTolerance){if(a<e){h.parentNode.insertBefore(this.element,h);this.insertBefore(this.draggable,this.element,h)}else if(a>e){h.parentNode.insertBefore(this.element,h.nextSibling);this.insertBefore(this.draggable,this.element,this.draggable[a+1])}this.lastMoveX=this.moveX;this.lastMoveY=this.moveY}}this.log('moveDraggable')};this.enable=function(){this.log('enable');this.root.addEventListener(this.startEvent,this.startHandler,false);this.root.addEventListener(this.moveEvent,this.moveHandler,true);this.root.addEventListener(this.endEvent,this.endHandler,false);this.root.addEventListener(this.contextMenuEvent,this.contextMenuHandler,false);this.root.addEventListener(this.clickEvent,this.clickHandler,true);this.root.addEventListener(this.touchCancelEvent,this.endHandler,false);return this};this.disable=function(){this.log('disable');this.root.removeEventListener(this.startEvent,this.startHandler,false);this.root.removeEventListener(this.moveEvent,this.moveHandler,true);this.root.removeEventListener(this.endEvent,this.endHandler,false);this.root.removeEventListener(this.contextMenuEvent,this.contextMenuHandler,false);this.root.removeEventListener(this.clickEvent,this.clickHandler,true);this.root.removeEventListener(this.touchCancelEvent,this.endHandler,false);return this};this.init(c)}})();
