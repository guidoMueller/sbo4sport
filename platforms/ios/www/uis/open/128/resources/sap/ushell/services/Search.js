// Copyright (c) 2013 SAP AG, All Rights Reserved
(function(){"use strict";jQuery.sap.declare("sap.ushell.services.Search");sap.ushell.services.Search=function(a,c){this.init.apply(this,arguments)};sap.ushell.services.Search.prototype={init:function(a,c){this.oAdapter=a;this.oContainerInterface=c;this.oLpdService=sap.ushell.Container.getService("LaunchPage")},isSearchAvailable:function(){return this.oAdapter.isSearchAvailable()},getSina:function(){return this.oAdapter.getSina()},_getCatalogTiles:function(){var s=this;if(s.allTilesDeferred){return s.allTilesDeferred}var c=[];s.allTilesDeferred=s.oLpdService.getCatalogs().then(function(a){var d=[];for(var i=0;i<a.length;i++){d.push(s.oLpdService.getCatalogTiles(a[i]))}return jQuery.when.apply(jQuery,d).then(function(){var t=arguments;for(var i=0;i<t.length;i++){var T=t[i];for(var j=0;j<T.length;j++){try{var o=T[j],b=s.oLpdService.getCatalogTileView(o),k=s.oLpdService.getCatalogTileKeywords(o),f=s.oLpdService.getCatalogTileTargetURL(o),g=s.oLpdService.getCatalogTilePreviewTitle(o)||s.oLpdService.getCatalogTileTitle(o),S=s.oLpdService.getCatalogTileSize(o),I=s.oLpdService.getCatalogTilePreviewIcon(o)||"sap-icon://business-objects-experience";c.push({tile:o,keywords:k,url:f,title:g,icon:I,size:S});b.destroy()}catch(e){jQuery.sap.log.error(e)}}}c=s._removeDuplicateTiles(c);return c})});return s.allTilesDeferred},_removeDuplicateTiles:function(t){var I={},u=[];for(var i=0;i<t.length;++i){var T=t[i];if(!T.url){continue}var f=new RegExp('DisplayFactSheet','i');if(f.test(T.url)){continue}if(I[T.url]===undefined){I[T.url]=T;u.push(T)}}return u},_searchTiles:function(p){var s=p.searchTerm;var c=p.aCatalogTiles;var t=p.top||10;var S=p.searchInKeywords||false;var f=[],T,l;s=s.replace(/([.+?^=!:${}()|\[\]\/\\])/g,"\\$1");s=s.replace(/\*/g,".*");s=new RegExp('\\b'+s,'i');var a=function(T){if(f.length<t){l=T.title.replace(s,"<b>$&</b>");f.push(T)}};for(var j=0;j<c.length;j++){T=c[j];if(s.test(T.title)){a(T);continue}if(S){for(var i=0,b=T.keywords.length;i<b;i++){var k=T.keywords[i];if(s.test(k)){a(T);break}}}}return f},_makeSInAResultSet:function(f,o){return{totalResults:f.length,searchTerm:o,getElements:function(){return f}}},queryApplications:function(p){var s=this,o=p.searchTerm;return this._getCatalogTiles().then(function(c){p.aCatalogTiles=c;var f=s._searchTiles(p);var S=s._makeSInAResultSet(f,o);return S})},queryApplicationsByTarget:function(s,r){this._getCatalogTiles().done(function(c){var R=[];for(var j=0,l=s&&s.length||0;j<l;j++){var S=s[j],u=sap.ushell.Container.getService("URLParsing");for(var i=0;i<c.length;i++){var t=u.parseShellHash(c[i].url);if(t&&(t.semanticObject===S.semanticObject)&&(t.action===S.action)){R.push(c[i]);break}}}r(R)})}}}());
