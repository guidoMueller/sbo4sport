//Copyright (c) 2013 SAP AG, All Rights Reserved
(function(g){"use strict";sap.ui.jsview("sap.ushell.renderers.fiori2.search.container.App",{createContent:function(){var s=this;s.aDanglingControls=[];s.suggestionsEnabled=true;sap.ui.getCore().getEventBus().subscribe("search",function(){this.onSearch()},this);sap.ui.getCore().getEventBus().subscribe("allSearchFinished",function(){this.onSearchFinished()},this);var a=sap.ui.getCore().getModel("searchModel");if(!a){a=new sap.ushell.renderers.fiori2.search.SearchModel();a.setSizeLimit(200);sap.ui.getCore().setModel(a,"searchModel");a.searchInit()}a.setSkip(0,false);s.setModel(a,"searchModel");s.setModel(sap.ushell.resources.i18nModel,"i18n");if(!s.oSearchSelect){s.oSearchSelect=new sap.m.Select("containerSs",{name:"SearchSelect",autoAdjustWidth:true,items:{path:"searchModel>/connectors",template:new sap.ui.core.Item({key:"{searchModel>labelRaw}",text:"{searchModel>label}"})}}).addStyleClass('sapUshellContainerSearchSelect');s.oSearchSelect.addEventDelegate({onAfterRendering:function(){s.oSearchSelect.setSelectedKey(a.getProperty("/dataSourceLabelRaw"))}},s.oSearchSelect)}s.oSearchSelect.attachChange(function(e){var b=s.oSearchSelect.getSelectedItem();var j={};if(b.getKey()==="$$ALL$$"){j=a.createAllDataSource()}else if(b.getKey()==="$$APP$$"){j=a.createAppDataSource()}else{j=a.sina.createDataSource({objectName:{label:b.getText(),value:b.getKey()},packageName:{label:"",value:""},schemaName:{label:"",value:""},label:""})}if(b.getKey()!=="$$ALL$$"){s.oSearchInput.setPlaceholder(sap.ushell.resources.i18n.getText("searchIn")+": "+b.getText())}else{s.oSearchInput.setPlaceholder(sap.ushell.resources.i18n.getText("search"))}a.setProperty("/dataSource",j);s.handleHash(a);s.oSearchInput.destroySuggestionRows()},this);if(!s.oSearchInput){s.oSearchInput=new sap.m.Input("containerSi",{name:"SearchInput",width:"50%",showValueStateMessage:false,showTableSuggestionValueHelp:false,showSuggestion:true,filterSuggests:true,suggestionColumns:[new sap.m.Column({})],liveChange:function(e){s.inputLiveChange(e)},suggest:function(e){s.handleSuggest(e)},suggestionItemSelected:function(e){if(s.changeTimer){window.clearTimeout(s.changeTimer);s.changeTimer=null}s.selectSuggest(e)},change:function(e){s.changeTimer=window.setTimeout(function(){var a=s.getModel("searchModel");s.handleHash(a);s.oSearchInput.destroySuggestionRows();s.changeTimer=null},100)}}).addStyleClass('sapUshellContainerSearchInput').setFilterFunction(function(){return s.suggestionsEnabled});s.oSearchInput.addEventDelegate({onAfterRendering:function(){var b=s.oSearchSelect.getSelectedItem();if(b){if(b.getKey()!=="$$ALL$$"){s.oSearchInput.setPlaceholder(sap.ushell.resources.i18n.getText("searchIn")+": "+b.getText())}else{s.oSearchInput.setPlaceholder(sap.ushell.resources.i18n.getText("search"))}}}},s.oSearchInput)}s.oSearchInput.bindAggregation("suggestionRows","searchModel>/mixedSection",function(p,d){var l=new sap.m.Label({text:"{searchModel>mixedLabel}"}).addStyleClass('sapUshellSuggestText').addStyleClass('sapUshellSearchSuggestionNavItem');l.addEventDelegate({onAfterRendering:function(){s.bTagUnescaper(this.getDomRef())}},l);l.data("labelRaw","{searchModel>labelRaw}");l.data("targetURL","{searchModel>targetURL}");l.data("dataSource","{searchModel>dataSource}");l.data("suggestType","{searchModel>suggestType}");var i=new sap.ui.core.Icon({src:"{searchModel>icon}"}).addStyleClass('sapUshellSuggestIcon');var b=new sap.m.Label({text:{path:"searchModel>icon",formatter:function(v){if(v){return"<i>"+sap.ushell.resources.i18n.getText("label_app")+"</i>"}return""}}}).addStyleClass('sapUshellSuggestText').addStyleClass('sapUshellSearchSuggestionNavItem');b.addEventDelegate({onAfterRendering:function(){s.bTagUnescaper(this.getDomRef())}},b);var c=new sap.m.CustomListItem({type:sap.m.ListType.Active,content:[b,i,l]});c.getText=function(){return l.data("labelRaw")};if(!s.oSearchInput.getValue())return null;return new sap.m.ColumnListItem({cells:[c],type:"Active"})});s.oSearchInput.addEventDelegate({onfocusin:function(e){s.closeHeadSearchBox()}},s.oSearchInput);if(!s.oSearchBtn){s.oSearchBtn=new sap.m.Button("containerSb",{name:"SearchBtn",icon:sap.ui.core.IconPool.getIconURI("search"),press:function(e){s.handleHash(a);s.oSearchInput.destroySuggestionRows()}})}s.oSearchResults=sap.ui.getCore().byId("searchContainerResultsView");if(!s.oSearchResults){s.oSearchResults=sap.ui.view({id:"searchContainerResultsView",tooltip:"{i18n>searchResultsView_tooltip}",viewName:"sap.ushell.renderers.fiori2.search.Search",type:sap.ui.core.mvc.ViewType.JS})}s.oSearchResults.viewSwitcher=s.getController();s.aDanglingControls.push(s.oSearchResults);s.oSearchResults.setModel(a);s.oPage=s.pageFactory("searchPage",[s.oSearchSelect,s.oSearchInput,s.oSearchBtn,s.oSearchResults]);s.updateSearchModelFromURL(a);return s.oPage},onSearch:function(){var s=this;s.suggestionsEnabled=false},onSearchFinished:function(){var s=this;s.suggestionsEnabled=true},bTagUnescaper:function(d){var i=d.innerHTML;while(i.indexOf('&lt;b&gt;')+i.indexOf('&lt;/b&gt;')>=-1){i=i.replace('&lt;b&gt;','<b>');i=i.replace('&lt;/b&gt;','</b>')}while(i.indexOf('&lt;i&gt;')+i.indexOf('&lt;/i&gt;')>=-1){i=i.replace('&lt;i&gt;','<i>');i=i.replace('&lt;/i&gt;','</i>')}d.innerHTML=i},closeHeadSearchBox:function(){if(sap.ui.getCore().byId('headSearchBox')!==undefined){if(sap.ui.getCore().byId('headSearchBox').getVisible()){jQuery('.headSearchDiv').animate({'maxWidth':'38rem'},{duration:100,complete:function(){sap.ui.getCore().byId('headSearchBox').setVisible(false)}})}}},handleHash:function(s){var a=this;if(a.oSearchInput.getValue()==="")return;var h="#Action-search&/searchTerm="+encodeURIComponent(a.oSearchInput.getValue())+"&dataSource="+encodeURIComponent(JSON.stringify(s.getDataSourceJson()));if(window.location.hash===h){return}else{window.location.href=h;s.setProperty("/searchBoxTerm",a.oSearchInput.getValue());a.closeHeadSearchBox()}},inputLiveChange:function(e){var s=this.getModel("searchModel");if(!this.oSearchInput.getValue()){s.setProperty("/appSection",[]);s.setProperty("/suggestSection",[]);s.setProperty("/mixedSection",[])}},handleSuggest:function(e){this.oSearchInput.destroySuggestionItems();var s=this.oSearchInput.getValue();var a=this.getModel("searchModel");a.setProperty("/searchBoxTerm",s);a.doSuggestion()},selectSuggest:function(e){var s=sap.ui.getCore().getModel("searchModel");var a=e.getParameter("selectedRow").getCells()[0].getContent()[2].data("suggestType");var b=e.getParameter("selectedRow").getCells()[0].getContent()[2].data("labelRaw");var d=e.getParameter("selectedRow").getCells()[0].getContent()[2].data("dataSource");var t=e.getParameter("selectedRow").getCells()[0].getContent()[2].data("targetURL");if(a==="dataSourceSuggest"){s.setProperty("/searchBoxTerm","");this.oSearchInput.setValue("");this.oSearchSelect.setSelectedKey(b);var c=this.oSearchSelect.getSelectedItem();var j={};if(c.getKey()==="$$ALL$$"){j=s.createAllDataSource()}else if(c.getKey()==="$$APP$$"){j=s.createAppDataSource()}else{j=s.sina.createDataSource({objectName:{label:c.getText(),value:c.getKey()},packageName:{label:"",value:""},schemaName:{label:"",value:""},label:""})}s.setProperty("/dataSource",j);if(c.getKey()!=="$$ALL$$"){this.oSearchInput.setPlaceholder(sap.ushell.resources.i18n.getText("searchIn")+": "+c.getText())}else{this.oSearchInput.setPlaceholder(sap.ushell.resources.i18n.getText("search"))}return}var h;if(t){h=t}else{s.setSearchTerm(b,false);s.setDataSource(d,false);h="#Action-search&/searchTerm="+encodeURIComponent(s.getProperty("/searchBoxTerm"))+"&dataSource="+encodeURIComponent(JSON.stringify(s.getDataSourceJson()))}if(window.location.hash!==h){if(h.charAt(0)==='#')window.location.href=h;else window.open(h)}},updateSearchModelFromURL:function(s){var u=sap.ushell.Container.getService("URLParsing");var a=u.splitHash(window.location.hash).appSpecificRoute;if(!a)return;var p=u.parseParameters("?"+a.substring(2));if(!p.searchTerm)return;var b=decodeURI(p.searchTerm[0]);s.setSearchTerm(b,false);var d;if(p.dataSource){var c=JSON.parse(decodeURI(p.dataSource[0]));d=s.sina.createDataSource(c);s.setDataSource(d,false)}else{s.resetDataSource(false)}this.oSearchResults.searchLayout.setShowBottomList(s.getProperty("/isNormalSearchEnable"));if(!s.getProperty("/isNormalSearchEnable"))this.oSearchResults.searchLayout.setBottomCount(0);this.oSearchInput.setValue(s.getProperty('/searchBoxTerm'));s._searchFireQuery()},containerFactory:function(i,c,d){var C=new sap.m.ScrollContainer({id:i,content:c});C.addStyleClass('sapUshellSubContainer');return C},pageFactory:function(i,c,d){var p=new sap.m.Page({id:i,showNavButton:true,content:c,enableScrolling:true,navButtonPress:function(a){window.history.back(1)}}),e=["onAfterHide","onAfterShow","onBeforeFirstShow","onBeforeHide","onBeforeShow"],D={};jQuery.each(e,function(I,E){D[E]=jQuery.proxy(function(a){jQuery.each(this.getContent(),function(I,c){c._handleEvent(a)})},p)});p.addEventDelegate(D);if(!sap.ui.Device.system.desktop){p._bUseIScroll=true}if(d){this.disableBouncing(p)}p.setTitle("{i18n>search}");return p},getControllerName:function(){return"sap.ushell.renderers.fiori2.search.container.App"}})}(window));
