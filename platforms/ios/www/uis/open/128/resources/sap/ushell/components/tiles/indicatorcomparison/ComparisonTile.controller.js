sap.ui.controller("tiles.indicatorcomparison.ComparisonTile",{onInit:function(){var t=this;this.firstTimeVisible=false;this.oComparisonTileView=this.getView();this.oChip=this.oComparisonTileView.getViewData().chip;if(this.oChip.visible){this.oChip.visible.attachVisible(this.visibleHandler.bind(this))}this.system=this.oChip.url.getApplicationSystem();this.oComparisonTileView.oGenericTile.setState(sap.suite.ui.commons.LoadState.Loading);try{sap.ushell.components.tiles.indicatorTileUtils.util.getParsedChip(this.oChip.configuration.getParameterValueAsString("tileConfiguration"),function(c){t.oConfig=c;if(t.oChip.preview){t.oChip.preview.setTargetUrl(sap.ushell.components.tiles.indicatorTileUtils.util.getNavigationTarget(t.oConfig,t.system))}if(t.oChip.preview.isEnabled()){t.setTitle();t._updateTileModel({value:8888,size:sap.suite.ui.commons.InfoTileSize.Auto,frameType:"OneByOne",state:sap.suite.ui.commons.LoadState.Loading,valueColor:sap.suite.ui.commons.InfoTileValueColor.Error,indicator:sap.suite.ui.commons.DeviationIndicator.None,title:"Liquidity Structure",footer:"Current Quarter",description:"Apr 1st 2013 (B$)",data:[{title:"Measure 1",value:1.2,color:"Good"},{title:"Measure 2",value:0.78,color:"Good"},{title:"Measure 3",value:1.4,color:"Error"}],});t.oComparisonTileView.oGenericTile.setState(sap.suite.ui.commons.LoadState.Loaded)}else{t.oConfig.TILE_PROPERTIES.FINALVALUE;t.setTitle();t.oComparisonTileView.oGenericTile.attachPress(function(){sap.ushell.components.tiles.indicatorTileUtils.util.abortPendingODataCalls(t.comparisionChartODataRef);sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,null);window.location.hash=sap.ushell.components.tiles.indicatorTileUtils.util.getNavigationTarget(t.oConfig,t.system)});if(Number(t.oChip.configuration.getParameterValueAsString("isSufficient"))){sap.ushell.components.tiles.indicatorTileUtils.cache.setEvaluationById(t.oConfig.TILE_PROPERTIES.id,t.oConfig);t.flowWithoutDesignTimeCall()}else{t.flowWithDesignTimeCall()}}})}catch(e){this.logError(e)}},getTile:function(){return this.oComparisonTileView.oGenericTile},setTitle:function(){var t=this;this._updateTileModel({header:t.oChip.preview.getTitle()||sap.ushell.components.tiles.indicatorTileUtils.util.getChipTitle(t.oConfig),subheader:t.oChip.preview.getDescription()||sap.ushell.components.tiles.indicatorTileUtils.util.getChipSubTitle(t.oConfig)})},_updateTileModel:function(n){var m=this.getTile().getModel().getData();jQuery.extend(m,n);this.getTile().getModel().setData(m)},flowWithoutDesignTimeCall:function(){var t=this;this.DEFINITION_DATA=this.oConfig;this._updateTileModel(this.DEFINITION_DATA);if(this.oChip.visible.isVisible()&&!this.firstTimeVisible){this.firstTimeVisible=true;this.fetchKpiValue(function(k){this.CALCULATED_KPI_VALUE=k;if(t.oConfig.TILE_PROPERTIES.frameType=="TwoByOne"){t.oComparisonTileView.oGenericTile.setFrameType("TwoByOne");t.oComparisonTileView.oGenericTile.removeAllTileContent();t.oComparisonTileView.oGenericTile.addTileContent(t.oComparisonTileView.oNumericTile);t.oComparisonTileView.oGenericTile.addTileContent(t.oComparisonTileView.oComparisonTile)}else{t.oComparisonTileView.oGenericTile.setFrameType("OneByOne");t.oComparisonTileView.oGenericTile.removeAllTileContent();t.oComparisonTileView.oGenericTile.addTileContent(t.oComparisonTileView.oComparisonTile)}this._updateTileModel({data:this.CALCULATED_KPI_VALUE});var n=sap.ushell.components.tiles.indicatorTileUtils.util.getNavigationTarget(t.oConfig,t.system);t.oComparisonTileView.oGenericTile.$().wrap("<a href ='"+n+"'/>");this.oComparisonTileView.oGenericTile.setState(sap.suite.ui.commons.LoadState.Loaded)},this.logError)}},flowWithDesignTimeCall:function(){var t=this;try{var a=sap.ushell.components.tiles.indicatorTileUtils.cache.getEvaluationById(this.oConfig.EVALUATION.ID);if(a){t.oConfig.EVALUATION_FILTERS=a.EVALUATION_FILTERS;t.flowWithoutDesignTimeCall()}else{sap.ushell.components.tiles.indicatorTileUtils.util.getFilterFromRunTimeService(this.oConfig,function(f){t.oConfig.EVALUATION_FILTERS=f;sap.ushell.components.tiles.indicatorTileUtils.cache.setEvaluationById(t.oConfig.TILE_PROPERTIES.id,t.oConfig);t.flowWithoutDesignTimeCall()})}}catch(e){this.logError(e)}},fetchKpiValue:function(s,E){var t=this;try{var u=this.oConfig.EVALUATION.ODATA_URL;var a=this.oConfig.EVALUATION.ODATA_ENTITYSET;if(this.oConfig.TILE_PROPERTIES.semanticMeasure){var m=this.oConfig.EVALUATION.COLUMN_NAME+","+this.oConfig.TILE_PROPERTIES.semanticMeasure}else{var m=this.oConfig.EVALUATION.COLUMN_NAME;var b=m;for(var j=0;j<this.oConfig.EVALUATION.COLUMN_NAMES.length;j++){if(this.oConfig.EVALUATION.COLUMN_NAMES[j].COLUMN_NAME!=this.oConfig.EVALUATION.COLUMN_NAME)b=b+","+this.oConfig.EVALUATION.COLUMN_NAMES[j].COLUMN_NAME}}var d=this.oConfig.EVALUATION_VALUES;var c=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(t.oConfig.TILE_PROPERTIES.id);if(!c){var v=sap.ushell.components.tiles.indicatorTileUtils.util.prepareFilterStructure(this.oConfig.EVALUATION_FILTERS,this.oConfig.ADDITIONAL_FILTERS);var o={};o["0"]=m+",asc";o["1"]=m+",desc";var f=o[this.oConfig.TILE_PROPERTIES.sortOrder||"0"].split(",");var g=sap.ushell.components.tiles.indicatorTileUtils.util.prepareQueryServiceUri(t.oChip.url.addSystemToServiceUrl(u),a,b,null,v,3);if(this.oConfig.TILE_PROPERTIES.semanticMeasure)g.uri+="&$top=3&$orderby="+f[0]+" "+f[2];else g.uri+="&$top=3&$orderby="+f[0]+" "+f[1];this.comparisionChartODataRef=g.model.read(g.uri,null,null,false,function(d){var w={};if(g.unit){t._updateTileModel({unit:d.results[0][g.unit.name]});w.unit=g.unit;w.unit.name=g.unit.name}if(d&&d.results&&d.results.length){t.oConfig.TILE_PROPERTIES.FINALVALUE=d;t.oConfig.TILE_PROPERTIES.FINALVALUE=t._processDataForComparisonChart(t.oConfig.TILE_PROPERTIES.FINALVALUE,b.split(",")[0]);w.data=d;sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,w);s.call(t,t.oConfig.TILE_PROPERTIES.FINALVALUE)}else if(d.results.length==0){t.oConfig.TILE_PROPERTIES.FINALVALUE=d;w.data=d;sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,w);s.call(t,t.oConfig.TILE_PROPERTIES.FINALVALUE)}else{E.call(t,"no Response from QueryServiceUri")}},function(h){if(h&&h.response){jQuery.sap.log.error(h.message+" : "+h.request.requestUri);E.call(t,h)}})}else{if(c.unit){t._updateTileModel({unit:c.data.results[0][c.unit.name]})}if(c.data&&c.data.results&&c.data.results.length){t.oConfig.TILE_PROPERTIES.FINALVALUE=c.data;t.oConfig.TILE_PROPERTIES.FINALVALUE=t._processDataForComparisonChart(t.oConfig.TILE_PROPERTIES.FINALVALUE,b);s.call(t,t.oConfig.TILE_PROPERTIES.FINALVALUE)}else if(d.results.length==0){t.oConfig.TILE_PROPERTIES.FINALVALUE=c.data;s.call(t,t.oConfig.TILE_PROPERTIES.FINALVALUE)}else{E.call(t,"no Response from QueryServiceUri")}}}catch(e){E.call(t,e)}},_processDataForComparisonChart:function(d,m){var f=[],L={},i,t,l;var a;var T=[];var b=this;for(i=0;i<d.results.length;i++){var e=d.results[i]}T=sap.ushell.components.tiles.indicatorTileUtils.util.getAllMeasuresWithLabelText(this.oConfig.EVALUATION.ODATA_URL,this.oConfig.EVALUATION.ODATA_ENTITYSET);for(i=0,l=T.length;i<l;i++){t=T[i];L[t.key]=t.value}for(i=0;i<b.oConfig.EVALUATION.COLUMN_NAMES.length;i++){var c={};var g=b.oConfig.EVALUATION.COLUMN_NAMES[i];c.value=Number(e[g.COLUMN_NAME]);var h=Number(e[g.COLUMN_NAME]);if(b.oConfig.EVALUATION.SCALING==-2)h*=100;a=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(h,b.oConfig.EVALUATION.SCALING);if(b.oConfig.EVALUATION.SCALING==-2)a+=" %";c.displayValue=a.toString();c.color=g.semanticColor;c.title=L[g.COLUMN_NAME]||g.COLUMN_NAME;f.push(c)}return f},logError:function(e){this.oComparisonTileView.oGenericTile.setState(sap.suite.ui.commons.LoadState.Failed);this.oComparisonTileView.oGenericTile.setState(sap.suite.ui.commons.LoadState.Failed);sap.ushell.components.tiles.indicatorTileUtils.util.logError(e)},refreshHandler:function(c){if(!c.firstTimeVisible){if(Number(this.oChip.configuration.getParameterValueAsString("isSufficient")))c.flowWithoutDesignTimeCall();else c.flowWithDesignTimeCall()}},visibleHandler:function(i){if(!i){this.firstTimeVisible=false;sap.ushell.components.tiles.indicatorTileUtils.util.abortPendingODataCalls(this.comparisionChartODataRef)}if(i){this.refreshHandler(this)}},onExit:function(){sap.ushell.components.tiles.indicatorTileUtils.util.abortPendingODataCalls(this.comparisionChartODataRef)}});
