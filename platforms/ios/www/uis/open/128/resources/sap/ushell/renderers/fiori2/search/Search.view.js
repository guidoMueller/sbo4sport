// Copyright (c) 2013 SAP AG, All Rights Reserved
(function(g){"use strict";jQuery.sap.require("sap.ushell.renderers.fiori2.search.SearchResultListItem");jQuery.sap.require("sap.ushell.renderers.fiori2.search.SearchResultListItemDetail");jQuery.sap.require("sap.ushell.renderers.fiori2.search.SearchLayout");jQuery.sap.require("sap.ushell.ui.launchpad.SearchResultApps");jQuery.sap.require("sap.ushell.ui.launchpad.SearchResultAppItem");sap.ui.jsview("sap.ushell.renderers.fiori2.search.Search",{createContent:function(c){var s=this;var l={growing:true,threshold:2,inset:false,showUnread:true,width:"auto",showNoData:false};sap.ui.getCore().getEventBus().subscribe("appSearchFinished",s.appSearchFinished,s);sap.ui.getCore().getEventBus().subscribe("searchFinished",s.onSearchFinished,s);sap.ui.getCore().getEventBus().subscribe("searchStarted",s.onAllSearchStarted,s);sap.ui.getCore().getEventBus().subscribe("allSearchFinished",s.onAllSearchFinished,s);s.resultList=new sap.m.List(l);s.resultList.setGrowingThreshold(2000);s.resultList.bindAggregation("items","/results",function(p,d){return s.assembleListItem(d)});s.appSearchResult=s.assembleAppSearch();s.resultListWithDetail=new SearchResultListWithDetail({resultList:s.resultList});if(sap.ui.getCore().getModel("searchModel").isNormalSearchEnable()){s.showBottomList=true}else{s.showBottomList=false}s.searchLayout=new SearchLayout({showMainHeader:true,searchTerm:sap.ushell.resources.i18n.getText(""),topHeader:'{i18n>apps}',topList:s.appSearchResult,bottomHeader:sap.ushell.resources.i18n.getText("business_objects"),bottomHeaderIsUnspecific:true,bottomList:s.resultListWithDetail,facets:s.facets,searchBusy:false,showBottomList:s.showBottomList});s.searchContainer=new sap.search.DivContainer({content:s.searchLayout,cssClass:'searchContainer'});return s.searchContainer},assembleAppSearch:function(){var s=this;var t=new sap.ushell.ui.launchpad.SearchResultApps({showNoData:false,growing:true,growingThreshold:2,growingTriggerText:{path:"i18n>showMore"},results:{path:"/tiles",template:new sap.ushell.ui.launchpad.SearchResultAppItem({icon:"{icon}",text:"{title}",targetUrl:"{url}"})}});this.oTilesContainer=t;var a=new sap.search.DivContainer({content:[t],cssClass:'appSearchResults'});return a},_assembleDataSourceFacetList:function(){var s=this;var c=function(){var i=new sap.m.FacetFilterItem({text:"{text}",key:"{id}",count:"{count}",selected:"{selected}"});i.data("dataSource","{dataSource}");return i};var j=new sap.ui.model.json.JSONModel({values:s.getModel().getDataSources()});var d=new sap.m.FacetFilterList({title:"All Categories",multiSelect:false,allCount:s.getModel().getProperty("/count"),items:{path:"/values",template:c()},listClose:function(){if(this.getSelectedItems()&&this.getSelectedItems().length>0){var n=this.getSelectedItems()[0].data("dataSource");s.getModel().setDataSource(n);s.getModel().resetAttributeFacets(false);s.getModel().resetFilterConditions()}}});d.setModel(j);return d},_assembleAttributeFacetList:function(f){var s=this;var c=function(){var i=new sap.m.FacetFilterItem({text:"{text}",count:"{count}",selected:"{selected}"});i.data("filterCondition","{filterCondition}");return i};var j=new sap.ui.model.json.JSONModel({values:f.items});var a=new sap.m.FacetFilterList({title:f.title,multiSelect:true,allCount:f.allCount,items:{path:"/values",template:c()},listClose:function(){if(this.getSelectedItems()){for(var i=0,l=this.getSelectedItems().length;i<l;i++){var b=this.getSelectedItems()[i].data("filterCondition");if(b.attribute&&b.operator&&b.value){s.getModel().addFilterCondition(b.attribute,b.operator,b.value,false)}else if(b.conditions){s.getModel().addFilterConditionGroup(b,false)}}s.getModel()._searchFireQuery()}}});a.data("facet",f);a.setModel(j);return a},assembleFacets:function(){var s=this;if(s.getModel()){var d=s._assembleDataSourceFacetList();var l=[d];for(var i=0,a=s.getModel().getProperty("/facets/attributes").length;i<a;i++){var f=s.getModel().getProperty("/facets/attributes")[i];var b=s._assembleAttributeFacetList(f);l.push(b)}var c=new sap.m.FacetFilter({lists:l,reset:function(){s.getModel().resetAttributeFacets(false);s.getModel().resetFilterConditions(false);s.getModel().resetDataSources(false);s.getModel().resetDataSource()}});if(s.searchLayout){s.searchLayout.setFacets(c)}return c}},assembleTitleItem:function(d){var i=new sap.m.CustomListItem();var t=new sap.m.Label({text:"{title}"});t.addStyleClass('bucketTitle');i.addStyleClass('bucketTitleContainer');i.addContent(new sap.m.HBox({items:[t]}));return i},assembleFooterItem:function(d){var s=this;s.footerItem=new SearchResultListItemFooter({text:"{i18n>showMore}",showMore:function(){var n=s.getModel().getSkip()+10;s.getModel().setSkip(n)}});return s.footerItem},assembleResultListItem:function(d,p){var s=this;var i=new SearchResultListItem({title:"{$$Name$$}",titleUrl:"{uri}",type:"{dataSourceName}",imageUrl:"{imageUrl}",data:d,visibleAttributes:3,navigate:function(){},previewOpen:function(){s.selectItem(i,d,p)},previewClose:function(){}});i.addEventDelegate({onAfterRendering:function(){$(this.getDomRef()).find(".searchResultListItem-main").bind('click',this.fireNavigate(this.getTitleUrl()));this.setSafeText($(this.getDomRef()).find(".searchResultListItem-title, .searchResultListItem-attribute-value, .searchResultListItem-type"))}},i);if(s.selectedPath===p){s.selectItem(i,d,p)}return i},selectItem:function(i,d,p){var s=this;if(i===s.selectedItem){return}s.selectedPath=p;s.getModel().setProperty("/detail/title",d?d.$$Name$$:undefined);s.getModel().setProperty("/detail/titleUrl",d?d.uri:undefined);s.getModel().setProperty("/detail/type",d?d.dataSourceName:undefined);s.getModel().setProperty("/detail/data",d);s.resultListWithDetail.setPreview(s.assembleDetail());if(i){i.setStatus("open")}if(s.selectedItem){s.selectedItem.setStatus("closed")}s.selectedItem=i},assembleDetail:function(){var s=this;var d=new SearchResultListItemDetail({headerLabel:"{i18n>more_information_on}",itemTitle:{path:"/detail/title"},itemTitleUrl:"{/detail/titleUrl}",itemType:"{/detail/type}",itemData:"{/detail/data}",firstDetailAttribute:4,maxDetailAttributes:8});d.addEventDelegate({onAfterRendering:function(){this.setSafeText($(this.getDomRef()).find(".searchResultListItemDetail-title, .searchResultListItemDetail-attribute-value"))}},d);return d},assembleListItem:function(d){var s=this;var D=d.getObject();if(D.type==='title'){return s.assembleTitleItem(D)}else if(D.type==='footer'){return s.assembleFooterItem(D)}else{return s.assembleResultListItem(D,d.getPath())}},onAllSearchStarted:function(){var s=this;if(s.getModel().getProperty("/isResultAppended")){s.footerItem.setShowSpinner(true);return}this.searchLayout.setEnableNoResults(false);s.searchLayout.setSearchBusy(true);if(s.selectedItem){s.selectedItem.setStatus("closed");if(s.resultListWithDetail.getPreview()){s.resultListWithDetail.getPreview().destroy()}}this.selectedPath=null;this.oTilesContainer.resetGrowing();s.searchLayout.setBottomList(s.resultListWithDetail)},onAllSearchFinished:function(){this.searchLayout.setSearchTerm(this.getModel().getSearchTerm());this.searchLayout.setEnableNoResults(true);this.searchLayout.setSearchBusy(false)},onSearchFinished:function(){var s=this;var S=this.getModel();if(s.getModel().getProperty("/isResultAppended")){s.footerItem.setShowSpinner(false);return}s.searchLayout.setSearchTerm(s.getModel().getSearchTerm());s.searchLayout.setBottomCount(s.getModel().getProperty("/count"));var d=S.getDataSource();var b=this.getModel().getProperty('/dataSourceName');if(!d||d.objectName.value.toLowerCase()==='$$all$$'){s.searchLayout.setBottomHeaderIsUnspecific(true);s.searchLayout.setBottomHeader(sap.ushell.resources.i18n.getText("business_objects"))}else{s.searchLayout.setBottomHeaderIsUnspecific(false);s.searchLayout.setBottomHeader(b)}var i=s.resultList.getItems();if(s.getModel().getProperty("/count")!==0&&!s.getModel().getProperty("/isResultAppended")){s.searchLayout.setBottomList(s.resultListWithDetail);var p='/results/0';s.selectItem(i[0],this.getModel().getProperty(p),p)}else{}sap.ui.getCore().getEventBus().publish("closeCurtain")},onSearchFailed:function(){var s=this;if(s.getModel().getProperty("/isResultAppended")){s.footerItem.setShowSpinner(false);return}s.searchLayout.setSearchBusy(false)},appSearchFinished:function(b,a,r){var s=this;var c=s.getModel().getSearchTerm();if(!r.totalResults||r.totalResults===0){s.appsFound=false;s.searchLayout.setTopCount(r.totalResults);s.searchLayout.setTopList(undefined)}else{s.appsFound=true;s.searchLayout.setTopCount(r.totalResults);s.searchLayout.setTopList(s.appSearchResult)}},getControllerName:function(){return"sap.ushell.renderers.fiori2.search.Search"}});sap.ui.core.Control.extend("sap.search.DivLayout",{metadata:{aggregations:{content:{singularName:"content",multiple:true}}},renderer:function(r,c){var C=c.getContent();for(var i=0;i<C.length;i++){r.renderControl(C[i])}}});sap.ui.core.Control.extend("sap.search.DivContainer",{metadata:{properties:{"cssClass":"string"},aggregations:{"content":{singularName:"content",multiple:true}},},renderer:function(r,c){r.write('<div');r.writeControlData(c);r.addClass(c.getCssClass());r.writeClasses();r.write('>');var C=c.getContent();for(var i=0;i<C.length;i++){r.renderControl(C[i])}r.write('</div>')}})}(window));
