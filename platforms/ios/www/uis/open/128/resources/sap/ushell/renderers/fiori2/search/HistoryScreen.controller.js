// Copyright (c) 2013 SAP AG, All Rights Reserved
(function(){"use strict";jQuery.sap.require("sap.ushell.ui.launchpad.Tile");jQuery.sap.require("sap.ushell.ui.launchpad.TileContainer");jQuery.sap.require("sap.ushell.services.LaunchPage");jQuery.sap.require("sap.ushell.services.Search");jQuery.sap.require("sap.ushell.services.UserRecents");sap.ui.controller("sap.ushell.renderers.fiori2.search.HistoryScreen",{onInit:function(){var s=this;this.oLaunchPageService=sap.ushell.Container.getService("LaunchPage");this.oUserRecentsService=sap.ushell.Container.getService("UserRecents");this.oSearchService=sap.ushell.Container.getService("Search");this.oCurrentSearch=null;var t=this,e=sap.ui.getCore().getEventBus(),r=new sap.ui.model.json.JSONModel();r.setProperty("/apps",[]);r.setProperty("/searches",[]);r.setProperty("/dataSources",[]);this.getView().setModel(r);e.subscribe("search",this.newSearchInvoked,this);e.subscribe("searchDataSourceChange",this.newSearchCategory,this);e.subscribe("closeCurtain",this.saveSearch,this);e.subscribe("openApp",this.appOpened,this);e.subscribe("openHistoryScreen",this.updateView,this)},onExit:function(){if(this.oCurrentSearch){this.oUserRecentsService.noticeSearch(this.oCurrentSearch)}var e=sap.ui.getCore().getEventBus();e.unsubscribe("search",this.newSearchInvoked,this);e.unsubscribe("searchDataSourceChange",this.newSearchCategory,this);e.unsubscribe("closeCurtain",this.saveSearch,this);e.unsubscribe("openApp",this.appOpened,this);e.unsubscribe("openHistoryScreen",this.updateView,this)},updateView:function(c,e,d){var s=this;var m=this.getView().getModel();var r=function(a){return a.replace(/<b>/g,"").replace(/<\/b>/g,"")};this.oUserRecentsService.getRecentSearches().done(function(R){for(var i=0;i<R.length;i++){var S=R[i];if(S&&S.oDataSource&&S.oDataSource.objectName){S.oDataSource.objectName.label=r(S.oDataSource.objectName.label)}}R=R.filter(function(a){if(a&&a.sTerm&&a.sTerm!=="")return true;else return false});m.setProperty("/searches",R)});$.when(this.oUserRecentsService.getRecentDataSources()).done(function(R){if(!R)R=[];for(var i=0;i<R.length;i++){var D=R[i];if(D&&D.objectName){D.objectName.label=r(D.objectName.label)}}var f=function(a){for(var i=0;i<R.length;i++){var b=R[i];if(b.objectName.value===a.objectName.value)return true}return false};if(R.length>=6){R.length=6}else{R.sort(function(a,b){var l=a.label||a.objectName.label;var g=b.label||b.objectName.label;if(l<g)return-1;if(l>g)return 1;return 0})}m.setProperty("/dataSources",R);s.getView().dsRequestFinished()})},newSearchInvoked:function(c,e,d){var s=this;if(d.dataSource){this.oCurrentSearch={sTerm:d.searchTerm,oDataSource:d.dataSource}}else{this.oCurrentSearch={sTerm:d.searchTerm,oDataSource:this.getView().getModel("search").getDataSource()}}},newSearchCategory:function(c,e,d){if(this.oCurrentSearch){this.oCurrentSearch.oObjectName=d}},saveSearch:function(c,e,d){if(this.oCurrentSearch){var s=this.getView().getModel("searchModel");if(s&&s.perspective&&s.perspective.getSearchResultSet&&s.perspective.getSearchResultSet().totalcount>0){this.oUserRecentsService.noticeSearch(this.oCurrentSearch);this.oCurrentSearch=null}}},searchAgain:function(d){},appOpened:function(c,e,d){var t=this,n={},r;this.saveSearch(c,e,d);if(!d.semanticObject||!d.action||!d.oMetadata||!d.oMetadata.title||d.oMetadata.libraryName==="factSheet"){return}n.semanticObject=d.semanticObject;n.action=d.action;n.sTargetHash=d.sShellHash;n.title=d.oMetadata.title;n.icon=d.oMetadata.icon;n.url=d.sShellHash+(d.sAppPart||"");this.oUserRecentsService.noticeApp(n)}})}());
