sap.ui.getCore().loadLibrary("sap.suite.ui.commons");jQuery.sap.require("sap.ca.scfld.md.controller.BaseDetailController");jQuery.sap.require("sap.suite.ui.smartbusiness.tiles.Bullet");jQuery.sap.require("sap.suite.ui.smartbusiness.tiles.Comparison");jQuery.sap.require("sap.suite.ui.smartbusiness.tiles.MeasureComparison");jQuery.sap.require("sap.suite.ui.smartbusiness.tiles.AreaChart");jQuery.sap.require("sap.suite.ui.smartbusiness.tiles.Numeric");jQuery.sap.require("sap.m.MessageBox");sap.ca.scfld.md.controller.BaseDetailController.extend("sap.suite.ui.smartbusiness.designtime.drilldown.view.configurator",{onInit:function(){this.DDA_MODEL=null;this.evaluationId=null;this.viewId=null;this.ddaFilter=this.byId("ddaFilter");try{if(sap.ui.core.Fragment.byId("addTileDialog","addTileDialog")){sap.ui.core.Fragment.byId("addTileDialog","addTileDialog").destroy()}if(sap.ui.core.Fragment.byId("addRelatedTilesDialog","evaluationTilesList")){sap.ui.core.Fragment.byId("addRelatedTilesDialog","evaluationTilesList").getParent().destroy()}if(sap.ui.core.Fragment.byId("configureTileDialog","multipleMeasureDialog")){sap.ui.core.Fragment.byId("configureTileDialog","multipleMeasureDialog").destroy()}}catch(e){}this._addTileDialog=sap.ui.xmlfragment("addTileDialog","sap.suite.ui.smartbusiness.designtime.drilldown.view.addTileDialog",this);this._addRelatedTilesDialog=sap.ui.xmlfragment("addRelatedTilesDialog","sap.suite.ui.smartbusiness.designtime.drilldown.view.addRelatedTilesDialog",this);this._configureTileDialog=sap.ui.xmlfragment("configureTileDialog","sap.suite.ui.smartbusiness.designtime.drilldown.view.multipleMeasureDialog",this);this.initializeTileHeader();this.initializeAddTileDialog();this.defineHeaderFooterOptions();this.oRouter.attachRoutePatternMatched(this.onRoutePatternMatched,this);this.viewsReordered=false;this.busyIndicator=new sap.m.BusyDialog();var h=this.byId("headerRibbon");this.HeaderRibbonModel=new sap.ui.model.json.JSONModel();h.setModel(this.HeaderRibbonModel);var s=this;window.onbeforeunload=function(){return s._oTextsModel.getResourceBundle().getText("ARE_YOU_SURE")}},leftArrowAction:function(){var t=this;var i,a;var h=t.getView().getModel("SB_DDACONFIG").getData().HEADERS_VISIBLE;var v=t.byId("tileContainer").getAggregation("scrollContainer").getAggregation("content");try{var s=this._getSelectedTile().tile.getBindingContext("SB_DDACONFIG").getObject()}catch(e){s=null}for(i=0;i<h.length;i++){if(h[i]==s){a=h.splice(i,1);h.splice(i-1,0,a[0]);break}}t.getView().getModel("SB_DDACONFIG").setProperty("/HEADERS_VISIBLE",h);t.getView().getModel("SB_DDACONFIG").updateBindings();t._setSelectedTile(t._getSelectedTile().index-1)},rightArrowAction:function(){var t=this;var i,a;var h=t.getView().getModel("SB_DDACONFIG").getData().HEADERS_VISIBLE;var v=t.byId("tileContainer").getAggregation("scrollContainer").getAggregation("content");try{var s=this._getSelectedTile().tile.getBindingContext("SB_DDACONFIG").getObject()}catch(e){s=null}for(i=0;i<h.length;i++){if(h[i]==s){a=h.splice(i,1);h.splice(i+1,0,a[0]);break}}t.getView().getModel("SB_DDACONFIG").setProperty("/HEADERS_VISIBLE",h);t.getView().getModel("SB_DDACONFIG").updateBindings();t._setSelectedTile(t._getSelectedTile().index+1)},selectedTilesFormatter:function(c,a){var b="";var t={NT:"Numeric",CT:"Comparison",AT:"Bullet",TT:"Trend"};a.forEach(function(s){if(s.REFERENCE_EVALUATION_ID==c&&s.visible)b+=t[s.VISUALIZATION_TYPE]+", "});return b?"Selected: "+b.replace(/, $/g,""):""},_cloneObj:function(e){var t;if(e instanceof Array){t=[];for(var i=0;i<e.length;i++){t[i]=this._cloneObj(e[i])}}else if(e instanceof Object){t={};for(var a in e){if(e.hasOwnProperty(a)){t[a]=this._cloneObj(e[a])}}}else{t=e}return t},takeConfigSnapShot:function(){this._configSnapShot=this._cloneObj(this.getView().getModel("SB_DDACONFIG").getData())},restoreFromConfigSnapShot:function(){this.getView().getModel("SB_DDACONFIG").setData(this._configSnapShot)},bindUiToModel:function(){this.DDA_MODEL.bindModel(this.getView(),"SB_DDACONFIG");this.DDA_MODEL.bindModel(this._addTileDialog,"SB_DDACONFIG");this.DDA_MODEL.bindModel(this._addRelatedTilesDialog,"SB_DDACONFIG");this.DDA_MODEL.bindModel(this._configureTileDialog,"SB_DDACONFIG")},onRoutePatternMatched:function(E){var t=this;if(E.getParameter("name")==="configurator"){try{var a=E.getParameter("arguments")["evaluationId"];var v=E.getParameter("arguments")["viewId"];if(t.oApplicationFacade.__newViewAdded&&t.oApplicationFacade.createdViewId){v=t.oApplicationFacade.createdViewId;t.oApplicationFacade.createdViewId=null;t.oApplicationFacade.__newViewAdded=false;window.location.replace(window.location.hash.substring(0,window.location.hash.lastIndexOf("/"))+"/"+v)}t.oApplicationFacade.createdViewId=null;t.oApplicationFacade.__newViewAdded=false;t._setSelectedTile(-1);if(a!==this.evaluationId){this.evaluationId=a;this.DDA_MODEL=sap.suite.smartbusiness.ddaconfig.Model.getInstance(this.evaluationId,true,this.getView().getModel("i18n"));this.EVALUATION=sap.suite.smartbusiness.kpi.parseEvaluation(this.DDA_MODEL.EVALUATION_DATA);var n=this.DDA_MODEL.NEW_VIEWID;if(!v){v=this.DDA_MODEL.getConfigurator().getDefaultViewId()}this._oTextsModel=this.getView().getModel("i18n");this._addTileDialog.setModel(this._oTextsModel,"i18n");this._addRelatedTilesDialog.setModel(this._oTextsModel,"i18n");this._configureTileDialog.setModel(this._oTextsModel,"i18n");if(v!=null){this.viewId=v;this.DDA_MODEL.setViewId(v)}else{this.viewId=n}this.bindUiToModel();this.ddaFilter.setEvaluationData(this.EVALUATION);this.ddaFilter.setEvaluationId(this.evaluationId);var f=[];this.getView().getModel("SB_DDACONFIG").getProperty("/FILTERS").forEach(function(s){f.push(s.name)});this.ddaFilter.setDimensions(f);try{this.ddaFilter.rerender()}catch(e){}}else{if(this.viewId==n&&this.getView().getModel("SB_DDACONFIG").getProperty("/ID")!=n){}}this.INIT_COUNT_HEADERS=function(){h=t.getView().getModel("SB_DDACONFIG").getData()["HEADERS"];var c=0;for(var i=0;i<h.length;++i){if(h[i]["visible"]==true)++c}return c}();this.INIT_COUNT_FILTERS=this.getView().getModel("SB_DDACONFIG").getData()["FILTERS"].length;if(!this.init_filters){this.init_filters=[];this.getView().getModel("SB_DDACONFIG").getData()["FILTERS"].forEach(function(x){t.init_filters.push(x.name)})}this._oModel=this.getView().getModel("SB_DDACONFIG").getData();this.refreshChart();this.fetchAndRenderHeaderRibbon();this.displayAggregate()}catch(e){sap.suite.smartbusiness.utils.showErrorMessage(this.oApplicationFacade.getResourceBundle().getText("FAILED_TO_LOAD_ODATA"),e.message)}}},changeViewOrder:function(){var t=this;new sap.suite.ui.smartbusiness.lib.ListPersona({view:this.getView(),context:'/ALL_VIEWS',listItemContext:'TITLE',namedModel:'SB_DDACONFIG',callback:function(){var c=t.DDA_MODEL.selectedView.getId();t.byId('chartToolbar')._oFirstDimensionSelect.setSelectedItem(t.byId('chartToolbar')._oFirstDimensionSelect.getItemByKey(c));t.viewsReordered=true}}).start()},SaveConfig:function(){var s=this;this.warn_header=false;var m=this.getView().getModel("SB_DDACONFIG").getData();m.CURRENT_FILTERS=this.getView().byId("ddaFilter").getActiveDimensions();var a=sap.suite.smartbusiness.ddaconfig.DrilldownSaveService;if(m.ALL_VIEWS.length>0){this.busyIndicator.open()&&this.getView().setBusy(true);a.saveEvalConfiguration(this.evaluationId,m,"update",function(){jQuery.sap.log.info("all calls success");s.busyIndicator.close()&&s.getView().setBusy(false);sap.m.MessageToast.show(s._oTextsModel.getResourceBundle().getText("EVAL_CONFIG_SAVE_SUCCESS"));s.oRouter.navTo("detail",{"contextPath":"EVALUATIONS_DDA('"+s.evaluationId+"')"});s.oApplicationFacade.__refreshModel=1},function(e){jQuery.sap.log.error(e+" failed");s.busyIndicator.close()&&s.getView().setBusy(false);sap.suite.smartbusiness.utils.showErrorMessage(s._oTextsModel.getResourceBundle().getText("SAVE_ERROR"))})}else{sap.suite.smartbusiness.utils.showErrorMessage(s._oTextsModel.getResourceBundle().getText("SAVE_ERROR_NO_VIEW_CONFIGURED"));jQuery.sap.log.error("No Views Configured. Please configure Views before adding filters/headers")}},defineHeaderFooterOptions:function(){var t=this;this.oHeaderFooterOptions={onBack:function(){var s=t;new sap.m.Dialog({icon:"sap-icon://warning2",title:s._oTextsModel.getResourceBundle().getText("WARNING"),state:"Error",type:"Message",content:[new sap.m.Text({text:s._oTextsModel.getResourceBundle().getText("ARE_YOU_SURE")})],beginButton:new sap.m.Button({text:s._oTextsModel.getResourceBundle().getText("OK"),press:function(){s.evaluationId=null;this.getParent().close();window.history.back()}}),endButton:new sap.m.Button({text:s._oTextsModel.getResourceBundle().getText("CANCEL"),press:function(){this.getParent().close()}})}).open()},sI18NDetailTitle:"SB_GENERIC_DRILLDOWN",bSuppressBookmarkButton:true,buttonList:[{sI18nBtnTxt:"Save",onBtnPressed:function(e){jQuery.sap.log.info("Save button pressed");t.SaveConfig()},},{sId:"Delete",sI18nBtnTxt:"Delete",onBtnPressed:function(e){new sap.m.Dialog({icon:"sap-icon://warning2",title:t._oTextsModel.getResourceBundle().getText("WARNING"),state:"Error",type:"Message",content:[new sap.m.Text({text:t._oTextsModel.getResourceBundle().getText("DELETE_ALL_CONFIGURATIONS")})],beginButton:new sap.m.Button({text:t._oTextsModel.getResourceBundle().getText("OK"),press:function(){this.getParent().close();t.busyIndicator.open()&&t.getView().setBusy(true);t.deleteMaster()}}),endButton:new sap.m.Button({text:t._oTextsModel.getResourceBundle().getText("CANCEL"),press:function(){this.getParent().close()}})}).open()}},{sId:"cancel",sI18nBtnTxt:"Cancel",onBtnPressed:function(e){var s=t;new sap.m.Dialog({icon:"sap-icon://warning2",title:s._oTextsModel.getResourceBundle().getText("WARNING"),state:"Error",type:"Message",content:[new sap.m.Text({text:s._oTextsModel.getResourceBundle().getText("ARE_YOU_SURE")})],beginButton:new sap.m.Button({text:s._oTextsModel.getResourceBundle().getText("OK"),press:function(){this.getParent().close();s.evaluationId=null;window.history.back()}}),endButton:new sap.m.Button({text:s._oTextsModel.getResourceBundle().getText("CANCEL"),press:function(){this.getParent().close()}})}).open()}},]}},getHeaderFooterOptions:function(){return this.oHeaderFooterOptions},onBeforeRendering:function(){},navigateToConfigureChart:function(){var r={evaluationId:this.evaluationId,viewId:this.viewId+""};this.evaluationId=null;this.oRouter.navTo('configureChart',r)},onAddView:function(){var s=this;var c=this.getView().byId("ddaFilter").getActiveDimensions();if(this.warn_header||String(this.init_filters)!=String(c)){new sap.m.Dialog({icon:"sap-icon://warning2",title:s._oTextsModel.getResourceBundle().getText("WARNING"),state:"Error",type:"Message",content:[new sap.m.Text({text:s._oTextsModel.getResourceBundle().getText("ARE_YOU_SURE")})],beginButton:new sap.m.Button({text:s._oTextsModel.getResourceBundle().getText("OK"),press:function(){s.warn_header=false;s.viewId=s.DDA_MODEL.NEW_VIEWID;s.DDA_MODEL.setViewId(s.viewId);s.bindUiToModel();this.getParent().close();s.navigateToConfigureChart()}}),endButton:new sap.m.Button({text:s._oTextsModel.getResourceBundle().getText("CANCEL"),press:function(){this.getParent().close()}})}).open()}else{this.viewId=this.DDA_MODEL.NEW_VIEWID;this.DDA_MODEL.setViewId(this.viewId);this.bindUiToModel();this.navigateToConfigureChart()}},onEditView:function(){var s=this;var c=this.getView().byId("ddaFilter").getActiveDimensions();if(this.warn_header||String(this.init_filters)!=String(c)){new sap.m.Dialog({icon:"sap-icon://warning2",title:s._oTextsModel.getResourceBundle().getText("WARNING"),state:"Error",type:"Message",content:[new sap.m.Text({text:s._oTextsModel.getResourceBundle().getText("ARE_YOU_SURE")})],beginButton:new sap.m.Button({text:s._oTextsModel.getResourceBundle().getText("OK"),press:function(){s.warn_header=false;this.getParent().close();s.navigateToConfigureChart()}}),endButton:new sap.m.Button({text:s._oTextsModel.getResourceBundle().getText("CANCEL"),press:function(){this.getParent().close()}})}).open()}else{this.navigateToConfigureChart()}},tileTypeMapping:{NT:"Numeric",AT:"Bullet",CT:"Comparison",TT:"AreaChart",CM:"MeasureComparison"},_getSelectedTile:function(){var t=this.byId("tileContainer").getItems()||[];return{tile:t[this._selectedTileIndex],index:this._selectedTileIndex}},_setSelectedTile:function(i){this._selectedTileIndex=i;var t=this.byId("tileContainer").getItems()||[];for(j=0;j<t.length;j++){t[j].getTileControl().removeStyleClass("mySelectedStyle")}this.byId("deleteTile").setEnabled(i!=-1);if(i!=-1){t[i].getTileControl().addStyleClass("mySelectedStyle")}this.byId("leftMoveArrow").setEnabled((i!=-1)&&i!=0);this.byId("rightMoveArrow").setEnabled((i!=-1)&&i!=t.length-1)},deleteTile:function(){var t=this;var c=new sap.m.Dialog({title:"Delete",type:"Message",content:[new sap.m.Text({text:t.oApplicationFacade.getResourceBundle().getText("DELETE_CONFIRMATION")})],beginButton:new sap.m.Button({text:"Ok",press:function(e){c.close();var a=t._getSelectedTile().tile;var v=a.getModel("SB_DDACONFIG").getData().HEADERS_VISIBLE;v.splice(t._getSelectedTile().index,1);t._setSelectedTile(-1);t.refreshTileBindings()}}),endButton:new sap.m.Button({text:t.oApplicationFacade.getResourceBundle().getText("CANCEL"),press:function(){c.close()}})});c.open()},initializeTileHeader:function(){var t=this;var a=this.byId("tileContainer");a.bindAggregation("items",{path:"SB_DDACONFIG>/HEADERS_VISIBLE",factory:function(i,b){var c=b.getProperty("VISUALIZATION_TYPE");return new sap.suite.ui.smartbusiness.tiles[t.tileTypeMapping[c]]({evaluationId:t.evaluationId,mode:"DUMMY",header:"{SB_DDACONFIG>TITLE}",subheader:"{SB_DDACONFIG>SUBTITLE}"}).addStyleClass("drilldownKpiTiles").attachBrowserEvent("click",function(e){var v=this.getParent().getAggregation("content");t._setSelectedTile(v.indexOf(this))})},})},initializeAddTileDialog:function(){var t=this;this._tileEvaluationList=sap.ui.core.Fragment.byId("addRelatedTilesDialog","evaluationTilesList");var a={NT:"NUMBER_TILE",AT:"ACTUAL_VS_TARGET_TILE",CT:"COMPARISON_TILE",TT:"TREND_TILE",CM:"COMPARISON_MM_TILE"};var b=new sap.ui.model.Sorter('SB_DDACONFIG>GROUPING_TITLE',false,function(C){return C.getProperty('GROUPING_TITLE')});var c=new sap.ui.model.Sorter('SB_DDACONFIG>VISUALIZATION_TYPE_INDEX',false);this._tileEvaluationList.bindAggregation("items",{path:"SB_DDACONFIG>/HEADERS",factory:function(i,B){var d=B.getProperty("VISUALIZATION_TYPE");var m=new sap.suite.ui.smartbusiness.tiles[t.tileTypeMapping[d]]({evaluationId:t.evaluationId,mode:"DUMMY",header:"TITLE",subheader:"SUBTITLE",contentOnly:true});var f=new sap.suite.ui.smartbusiness.tiles[t.tileTypeMapping[d]]({evaluationId:t.evaluationId,mode:"DUMMY",header:"TITLE",subheader:"SUBTITLE",contentOnly:true});var g=new sap.m.HBox({justifyContent:"Start",width:"98%",items:[m,new sap.m.Label({text:{path:"SB_DDACONFIG>VISUALIZATION_TYPE",formatter:function(s){return t._oTextsModel.getResourceBundle().getText(a[s])}}})]});return new sap.m.CustomListItem({type:(d=='NT'||d=='AT')?'Active':'Navigation',press:function(){var o=this.getBindingContext('SB_DDACONFIG').getObject();o['visible']=true;if(o.VISUALIZATION_TYPE=='NT'||o.VISUALIZATION_TYPE=='AT'){t.getView().getModel("SB_DDACONFIG").getData().HEADERS_VISIBLE.push(t._cloneObj(o));t.onAddTileOk();t.refreshTileBindings()}else{t._addRelatedTilesDialog.close();try{var h=o.VISUALIZATION_TYPE=='CM'?1:0;t._configureTileDialog.getContent()[h].getItems()[1].removeAllContent();t._configureTileDialog.getContent()[h].getItems()[1].addContent(f)}catch(e){}t._configureTileDialog.bindElement('SB_DDACONFIG>'+this.getBindingContextPath());t._configureTileDialog.open();var I=t.getView().getModel("i18n");var j=new sap.ui.core.Item({key:"_none^",text:I.getResourceBundle().getText("SELECT_NONE"),});if(!sap.ui.core.Fragment.byId("configureTileDialog","measuresForTile3").getItemByKey("_none^"))sap.ui.core.Fragment.byId("configureTileDialog","measuresForTile3").insertItem(j,"0")}},content:[new sap.m.HBox({justifyContent:"SpaceAround",items:[g]})]})},sorter:[b,c]})},onMiniChartConfigureOk:function(){var b=this._configureTileDialog.getBindingContext("SB_DDACONFIG").getObject();b['visible']=true;this.getView().getModel("SB_DDACONFIG").getData().HEADERS_VISIBLE.push(this._cloneObj(b));this.onAddTileOk();this.refreshTileBindings()},showConfigureTileMeasure:function(v){return v!='CT'&&v!='TT'},showConfigureTileDimension:function(v){return v=='CT'||v=='TT'},showConfigureTileSortOrder:function(v){return v=='CT'},showThirdMeasure:function(v){return!!v},refreshTileBindings:function(){try{var t=this.byId("tileContainer");t.getModel("SB_DDACONFIG").refresh()}catch(e){}},_refreshEvaluationsBinding:function(){},onAddTileOk:function(E){this.takeConfigSnapShot();this._setSelectedTile(-1);this.refreshTileBindings();try{this._configureTileDialog.close();this._addRelatedTilesDialog.close()}catch(e){}this._refreshEvaluationsBinding();this.warn_header=true},onAddTileCancel:function(E){this.restoreFromConfigSnapShot();this._setSelectedTile(-1);this.refreshTileBindings();try{this._configureTileDialog.close();this._addRelatedTilesDialog.close()}catch(e){}this._refreshEvaluationsBinding()},_getEvalData:function(i){try{var a=sap.suite.smartbusiness.kpi.getEvaluationById({id:i,cache:true,filters:false,thresholds:false,getDDAEvaluation:true});return a}catch(e){return{}}},createTileMenuForCurrentEvaluation:function(a){var t=this;var b=['NT','AT','CT','TT','CM'];function _(I){try{var k=t._getEvalData(I);return sap.suite.smartbusiness.odata.getAllDimensions(k.ODATA_URL,k.ODATA_ENTITYSET)}catch(e){return[]}}function c(I){try{var k=t._getEvalData(I);return sap.suite.smartbusiness.odata.getAllMeasures(k.ODATA_URL,k.ODATA_ENTITYSET)}catch(e){return[]}}function d(I){return t._getEvalData(I).INDICATOR_TITLE}function f(I){return t._getEvalData(I).TITLE}function g(I){return t._getEvalData(I).INDICATOR}var m=this.getView().getModel("SB_DDACONFIG");var h=c(a);if(!m.getProperty("/HEADER_EVALUATIONID")[a]){m.getProperty("/HEADER_EVALUATIONID")[a]=true;var i=m.getProperty("/HEADERS");for(var j in this.tileTypeMapping){i.push({EVALUATION_ID:this.evaluationId,CONFIGURATION_ID:this.viewId,REFERENCE_EVALUATION_ID:a,VISUALIZATION_TYPE:j,VISUALIZATION_TYPE_INDEX:b.indexOf(j),VISUALIZATION_ORDER:1,ALL_DIMENSIONS:_(a),DIMENSION:_(a)[0]||'',SORT_BY:'',SORT_ORDER:'MD',MEASURE1:h[0],MEASURE2:h[1]||h[0],MEASURE3:h[2]||"",COLOR1:"Good",COLOR2:"Critical",COLOR3:"Error",ALL_MEASURES:h,VISIBILITY:1,visible:false,TITLE:d(a),SUBTITLE:f(a),INDICATOR:g(a)})}}},openEvaluationsDialog:function(){this._addRelatedTilesDialog.open();sap.ui.core.Fragment.byId('addRelatedTilesDialog','showCurrentKpiEvals').firePress()},evaluationGroupTextFormatter:function(c){return{text:c.getProperty("GROUPING_TEXT"),key:c.getProperty("GROUPING_TEXT")}},relatedEvalGroupTextFormatter:function(c){var r=this.getView().getModel("i18n").getResourceBundle();return{text:(r.getText("KPI")+": "+c.getProperty("INDICATOR")),key:c.getProperty("INDICATOR")}},showCurrentKPIEvals:function(){var t=this;var m=this.getView().getModel('SB_DDACONFIG');var r=this.getView().getModel("i18n").getResourceBundle();if(!m.getProperty('/SIBLING_EVALUATIONS').length){var a=sap.suite.smartbusiness.kpi.getSiblingEvaluations({indicator:m.getProperty('/INDICATOR'),id:this.evaluationId,cache:false,filters:false,thresholds:false,getDDAEvaluation:true});a.forEach(function(s){t.createTileMenuForCurrentEvaluation(s.ID)});m.getData().SIBLING_EVALUATIONS=a;m.getData().HEADERS.forEach(function(s){var p=s.REFERENCE_EVALUATION_ID==s.EVALUATION_ID?'('+t._oTextsModel.getResourceBundle().getText('CURRENT_EVALUATION')+')':'';s.GROUPING_TITLE=p+s.TITLE+" "+s.SUBTITLE})}this.takeConfigSnapShot();var b=this._tileEvaluationList.getBinding("items");var c=this.getView().getModel("SB_DDACONFIG").getProperty("/INDICATOR");b.filter(new sap.ui.model.Filter("INDICATOR",sap.ui.model.FilterOperator.EQ,c));m.refresh()},showAssociatedEvals:function(){var t=this;var m=this.getView().getModel('SB_DDACONFIG');if(!m.getProperty('/ASSOCIATED_EVALUATIONS').length){m.getData().ASSOCIATED_EVALUATIONS=sap.suite.smartbusiness.kpi.getAssociatedEvaluations({indicator:m.getProperty('/INDICATOR'),id:this.evaluationId,cache:true});m.getData().ASSOCIATED_EVALUATIONS.forEach(function(s){t.createTileMenuForCurrentEvaluation(s.ID)});m.getData().HEADERS.forEach(function(s){s.GROUPING_TITLE=s.TITLE+" "+s.SUBTITLE})}this.takeConfigSnapShot();var b=this._tileEvaluationList.getBinding("items");var c=this.getView().getModel("SB_DDACONFIG").getProperty("/INDICATOR");b.filter(new sap.ui.model.Filter("INDICATOR",sap.ui.model.FilterOperator.NE,c));m.refresh()},refreshChart:function(){var c=this;var b=this.getView().byId("chartToolbar").getToolBar().getContentRight();if(b){if(b[0]&&(!(b[0].getVisible()))){b[0].setVisible(true)}if(b[1]&&(!(b[1].getVisible()))){b[1].setVisible(true)}if(b[3]&&(!(b[3].getVisible()))){b[3].setVisible(true)}if(b[0])b[0].firePress()}this.oChartDataModel=new sap.ui.model.json.JSONModel();this.oChartData=[];this.dda_chart=this.getView().byId("chartRef");this.dda_chart.setStackedChartWidthEnhancer(false);this.dda_table=this.getView().byId("chartTable");var t=this._oModel;this.dda_config={};this.dda_config.chartConfig={mode:t.DATA_MODE||"DUMMY",title:"",dataLimit:t.DATA_LIMIT||null,dataLimitations:t.DATA_LIMITATIONS||false,type:(t.CHART_TYPE).toUpperCase()||"BAR",axis:t.AXIS_TYPE||"SINGLE",value:t.VALUE_TYPE||"ABSOLUTE",colorScheme:t.COLOR_SCHEME||"NONE",thresholdMeasure:t.THRESHOLD_MEASURE||""};this.dda_config.columnsConfig=[];for(var i=0;i<t.COLUMNS.length;i++){this.dda_config.columnsConfig.push({name:t.COLUMNS[i].NAME,type:t.COLUMNS[i].TYPE,visibility:t.COLUMNS[i].VISIBILITY||"BOTH",sortOrder:t.COLUMNS[i].SORT_ORDER||"NONE",sortBy:t.COLUMNS[i].SORT_BY||"",axis:t.COLUMNS[i].AXIS||1,stacking:t.COLUMNS[i].STACKING||0,color:t.COLOR_SCHEME=="MANUAL_NON_SEMANTIC"?t.COLUMNS[i].COLOR1:t.COLOR_SCHEME=="MANUAL_SEMANTIC"?t.COLUMNS[i].COLOR2:""})}this.oColumns=[];this.oDimensions=[];this.oMeasures=[];this.dimNameArray=[];this.msrNameArray=[];this.chartDimensions=[];this.chartDimNames=[];this.chartMeasures=[];this.chartMsrNames=[];this.tableDimensions=[];this.tableDimNames=[];this.tableMeasures=[];this.tableMsrNames=[];for(var i=0;i<this.dda_config.columnsConfig.length;i++){this.oColumns.push(this.dda_config.columnsConfig[i]);if((this.dda_config.columnsConfig[i].type).toUpperCase()==="DIMENSION"){this.oDimensions.push(this.dda_config.columnsConfig[i]);this.dimNameArray.push(this.dda_config.columnsConfig[i].name);if(((this.dda_config.columnsConfig[i].visibility).toUpperCase()==="CHART")||((this.dda_config.columnsConfig[i].visibility).toUpperCase()==="BOTH")){this.chartDimensions.push(this.dda_config.columnsConfig[i]);this.chartDimNames.push(this.dda_config.columnsConfig[i].name)}if(((this.dda_config.columnsConfig[i].visibility).toUpperCase()==="TABLE")||((this.dda_config.columnsConfig[i].visibility).toUpperCase()==="BOTH")){this.tableDimensions.push(this.dda_config.columnsConfig[i]);this.tableDimNames.push(this.dda_config.columnsConfig[i].name)}}else if((this.dda_config.columnsConfig[i].type).toUpperCase()==="MEASURE"){this.oMeasures.push(this.dda_config.columnsConfig[i]);this.msrNameArray.push(this.dda_config.columnsConfig[i].name);if(((this.dda_config.columnsConfig[i].visibility).toUpperCase()==="CHART")||((this.dda_config.columnsConfig[i].visibility).toUpperCase()==="BOTH")){this.chartMeasures.push(this.dda_config.columnsConfig[i]);this.chartMsrNames.push(this.dda_config.columnsConfig[i].name)}if(((this.dda_config.columnsConfig[i].visibility).toUpperCase()==="TABLE")||((this.dda_config.columnsConfig[i].visibility).toUpperCase()==="BOTH")){this.tableMeasures.push(this.dda_config.columnsConfig[i]);this.tableMsrNames.push(this.dda_config.columnsConfig[i].name)}}}if((!(this.chartDimensions.length))||(!(this.chartMeasures.length))){this.dda_chart.setDataset(new sap.viz.core.FlattenedDataset({}));return}this.stacking=this.getStacking(this.chartMeasures,this.chartDimensions);this.isStackMsr=false;this.isStackDim=false;if(this.stacking.isEnabled&&(this.stacking.type=="M"))this.isStackMsr=true;else if(this.stacking.isEnabled&&(this.stacking.type=="D"))this.isStackDim=true;this.sapCaChartType=this.getSapCaChartType();this.dda_chart.setAdvancedChartSettings({plotArea:{animation:{dataLoading:false,dataUpdating:false,resizing:false}},legend:{title:{visible:false}}});if((this.dda_config.chartConfig.mode).toUpperCase()==="DUMMY"){this.oChartData=this.getDummyDataForChart(this.dimNameArray,this.msrNameArray);this.oChartDataModel.setData({businessData:c.oChartData})}else if((this.dda_config.chartConfig.mode).toUpperCase()==="RUNTIME"){this.getRuntimeChartData(this.dimNameArray,this.msrNameArray)}try{var p=sap.suite.smartbusiness.odata.properties(this._oModel.QUERY_SERVICE_URI,this._oModel.QUERY_ENTITY_SET)}catch(e){jQuery.sap.log.error("Failed to instantiate the odata model");throw e}this.column_labels_mapping=p.getLabelMappingObject();this.dimension_text_property_mapping=p.getTextPropertyMappingObject();this.measure_unit_property_mapping=p.getUnitPropertyMappingObject();if((this.sapCaChartType).toUpperCase()==="TABLE"){this.updateTable(this.tableDimensions,this.tableMeasures);if(b){if(b[0]){b[0].setVisible(false)}if(b[1]){b[1].setVisible(true)}if(b[3]){b[3].setVisible(false)}if(b[1]){b[1].firePress()}}return}if((((this.dda_config.chartConfig.type).toUpperCase()=="BAR")&&(this.dda_config.chartConfig.axis=="DUAL"))||(((this.dda_config.chartConfig.type).toUpperCase()=="COLUMN")&&(this.dda_config.chartConfig.axis=="DUAL"))){var a=false;var d=false;for(var i=0;i<this.chartMeasures.length;i++){if(this.chartMeasures[i].axis==1)a=true;else if(this.chartMeasures[i].axis==2)d=true}if(!(a)||!(d)){sap.m.MessageBox.alert(c._oTextsModel.getResourceBundle().getText("SELECT_MEASURE_FOR_AXIS",(a?2:1)));return}}if(((this.dda_config.chartConfig.type).toUpperCase()==="BUBBLE")&&(this.chartMeasures.length<3)){sap.m.MessageBox.alert(c._oTextsModel.getResourceBundle().getText("BUBBLE_CHART_MEASURE_COUNT"));return}this.dda_chart.setChartType(this.sapCaChartType);this.oDataset=this.create_Dataset(this.chartDimensions,this.chartMeasures);var f=this.dda_config.chartConfig.type;var g=this.dda_config.chartConfig.axis;var v=this.dda_config.chartConfig.value;var l=new sap.ui.core.Locale(sap.ui.getCore().getConfiguration().getLanguage());var h=sap.ca.ui.model.format.NumberFormat.getInstance({},l);if((f=='BAR')&&(v=="ABSOLUTE")){this.dda_chart.setXAxisLabelFormatter(this.formatChartNumbers.bind(this));this.dda_chart.setYAxisLabelFormatter(this.pseudoChartFormatter);if(g=='DUAL'){this.dda_chart.setXAxis2LabelFormatter(this.formatChartNumbers.bind(this))}}else if(f=='BUBBLE'){this.dda_chart.setXAxisLabelFormatter(this.formatChartNumbers.bind(this));this.dda_chart.setYAxisLabelFormatter(this.formatChartNumbers.bind(this))}else if(((f=='BAR')||(f=='COLUMN'))&&(v=='PERCENTAGE')){if(f=='BAR'){this.dda_chart.setXAxisLabelFormatter(function(r){return h.format_percentage(r)});this.dda_chart.setYAxisLabelFormatter(this.pseudoChartFormatter);if(g=='DUAL'){this.dda_chart.setXAxis2LabelFormatter(function(r){return h.format_percentage(r)})}}else{this.dda_chart.setYAxisLabelFormatter(function(r){return h.format_percentage(r)});this.dda_chart.setXAxisLabelFormatter(this.pseudoChartFormatter);if(g=='DUAL'){this.dda_chart.setYAxis2LabelFormatter(function(r){return h.format_percentage(r)})}}}else{this.dda_chart.setYAxisLabelFormatter(this.formatChartNumbers.bind(this));this.dda_chart.setXAxisLabelFormatter(this.pseudoChartFormatter);if((f=='COLUMN')&&(g=='DUAL')){this.dda_chart.setYAxis2LabelFormatter(this.formatChartNumbers.bind(this))}}this.dda_chart.setDataLabelFormatter([[this.formatChartNumbers.bind(this)]]);if(((f=='BAR')||(f=='COLUMN'))&&(v=='PERCENTAGE')){var j=[[],[],[]];for(var k=0;k<this.chartMsrNames.length;k++){j[0].push(c.getChartPercentFormatter(true));j[1].push(c.getChartPercentFormatter(true))}this.dda_chart.setPopoverFormatter(j)}this.dda_chart.setDataset(this.oDataset);this.dda_chart.setModel(this.oChartDataModel);this.showChartLegendIfApplicable(this.chartDimNames,this.chartMsrNames);if((this.dda_config.chartConfig.type=="BAR")||(this.dda_config.chartConfig.type=="COLUMN")||(this.dda_config.chartConfig.type=="COMBINATION")||(this.dda_config.chartConfig.type=="LINE")){if((this.dda_config.chartConfig.colorScheme).toUpperCase()==="AUTO_SEMANTIC"){var m=this.dda_config.chartConfig.thresholdMeasure||"";var n=[];var o=-1;for(var i=0;i<this.chartMeasures.length;i++){n.push({color:sap.ca.ui.charts.ChartSemanticColor.GoodLight});if(this.chartMeasures[i].name===m)o=i}if(o>=0)n[o].color=sap.ca.ui.charts.ChartSemanticColor.Neutral;this.applyCustomColoring(this.dda_chart,this.dda_config.chartConfig.colorScheme,n,m,this.DDA_MODEL.EVALUATION_DATA.GOAL_TYPE)}else if(((this.dda_config.chartConfig.colorScheme).toUpperCase()==="MANUAL_SEMANTIC")||((this.dda_config.chartConfig.colorScheme).toUpperCase()==="MANUAL_NON_SEMANTIC")){this.applyCustomColoring(this.dda_chart,this.dda_config.chartConfig.colorScheme,this.chartMeasures)}}this.updateTable(this.tableDimensions,this.tableMeasures)},getSapCaChartType:function(){var s=sap.ca.ui.charts.ChartType.Bar;var c=this.dda_config.chartConfig.type;var a=this.dda_config.chartConfig.axis;var v=this.dda_config.chartConfig.value;var b=(this.isStackMsr||(this.isStackDim&&(this.chartDimensions.length>1)))?true:false;switch(c){case"BAR":if(a==="SINGLE"){if(v==="ABSOLUTE"){if(b){s=sap.ca.ui.charts.ChartType.StackedBar}else{s=sap.ca.ui.charts.ChartType.Bar}}else if(v==="PERCENTAGE"){s=sap.ca.ui.charts.ChartType.StackedBar100}}else if(a==="DUAL"){if(v==="ABSOLUTE"){s=sap.ca.ui.charts.ChartType.DualStackedBar}else if(v==="PERCENTAGE"){s=sap.ca.ui.charts.ChartType.DualStackedBar100}}break;case"COLUMN":if(a==="SINGLE"){if(v==="ABSOLUTE"){if(b){s=sap.ca.ui.charts.ChartType.StackedColumn}else{s=sap.ca.ui.charts.ChartType.Column}}else if(v==="PERCENTAGE"){s=sap.ca.ui.charts.ChartType.StackedColumn100}}else if(a==="DUAL"){if(v==="ABSOLUTE"){s=sap.ca.ui.charts.ChartType.DualStackedColumn}else if(v==="PERCENTAGE"){s=sap.ca.ui.charts.ChartType.DualStackedColumn100}}break;case"LINE":s=sap.ca.ui.charts.ChartType.Line;break;case"COMBINATION":s=sap.ca.ui.charts.ChartType.Combination;break;case"BUBBLE":s=sap.ca.ui.charts.ChartType.Bubble;break;case"TABLE":s="TABLE";break;default:s=sap.ca.ui.charts.ChartType.Bar}return s},showChartLegendIfApplicable:function(d,m){var t=this;var o=this.getView().byId("chartToolbar");var c=this.dda_config.chartConfig.type;var i=(((c=="BAR")||(c=="COLUMN"))&&(this.isStackDim)&&(this.getDimensionToBeStacked(t.chartDimensions))&&(d.length>1))?true:false;if((m.length>1)||(i)){o.setShowLegend(true)}else{o.setShowLegend(false)}},getChartPercentFormatter:function(i){var l=new sap.ui.core.Locale(sap.ui.getCore().getConfiguration().getLanguage());function a(n){return!isNaN(parseFloat(n))&&isFinite(n)}var f={style:i?'standard':'short'};var c=sap.ca.ui.model.format.NumberFormat.getInstance(f,l);return function(s){return a(s)?c.format_percentage(s):s}},getStacking:function(m,d){var s={};s.isEnabled=false;s.type="none";for(var i=0;i<m.length;i++){if(m[i].stacking===1){s.isEnabled=true;s.type="M"}}if(!(s.isEnabled)){for(var i=0;i<d.length;i++){if(d[i].stacking===1){s.isEnabled=true;s.type="D"}}}return s},setStacking:function(a,t,c){var b=this;if(a){if(t=="M"){for(var i=0;i<c.length;i++){if((c[i].TYPE).toUpperCase()==="MEASURE"){c[i].STACKING=1}else if((c[i].TYPE).toUpperCase()==="DIMENSION"){c[i].STACKING=0}}}else if(t=="D"){for(var i=0;i<c.length;i++){if((c[i].TYPE).toUpperCase()==="MEASURE"){c[i].STACKING=0}else if((c[i].TYPE).toUpperCase()==="DIMENSION"){c[i].STACKING=1}}}}else{for(var i=0;i<c.length;i++){c[i].STACKING=0}}},getDimensionToBeStacked:function(d){var D=null;for(var i=0;i<d.length;i++){if(d[i].axis===2){D=d[i];break}}return D},setDimensionToBeStacked:function(c,s){if(s){for(var i=0;i<c.length;i++){if((c[i].TYPE).toUpperCase()==="DIMENSION"){c[i].AXIS=1;if(c[i].NAME===s){c[i].AXIS=2}}}}},updateColumnProperty:function(c,n,p,v){for(var i=0;i<c.length;i++){if(c[i].NAME===n){(c[i])[p]=v;break}}},getMeasuresByAxis:function(c){var d={};d.axis1={};d.axis1.objArr=[];d.axis1.nameArr=[];d.axis2={};d.axis2.objArr=[];d.axis2.nameArr=[];for(var i=0;i<c.length;i++){if(c[i].axis===1){d.axis1.objArr.push(c[i]);d.axis1.nameArr.push(c[i].name)}else if(c[i].axis===2){d.axis2.objArr.push(c[i]);d.axis2.nameArr.push(c[i].name)}}return d},create_Dataset:function(d,m){var c=this;var a=this.dda_config.chartConfig.type||"BAR";var b=this.dda_config.chartConfig.axis||"SINGLE";var v=this.dda_config.chartConfig.value||"ABSOLUTE";var s=this.isStackMsr;var e=this.getDimensionToBeStacked(d);var f=new sap.viz.core.FlattenedDataset({data:{path:"/businessData"}});for(var i=0;i<d.length;i++){var g=((this.dda_config.chartConfig.mode).toUpperCase()==="RUNTIME")?this.dimension_text_property_mapping[d[i].name]:d[i].name;var A=1;if(((a=="BAR")||(a=="COLUMN"))&&(this.isStackDim)&&(e)&&(g===e.name)&&(d.length>1)){A=2;this.dda_chart.setStackedChartWidthEnhancer(true)}var h=new sap.viz.ui5.data.DimensionDefinition({axis:A,value:"{"+g+"}",name:this.column_labels_mapping[d[i].name]||d[i].name});f.addDimension(h)}if((a=="LINE")||(a=="COMBINATION")||((a=="BAR")&&(b=="SINGLE"))||((a=="COLUMN")&&(b=="SINGLE"))){for(var i=0;i<m.length;i++){var g=m[i].name;var j=new sap.viz.ui5.data.MeasureDefinition({name:this.column_labels_mapping[g]||g,value:"{"+g+"}"});f.addMeasure(j)}}else if(a=="BUBBLE"){for(var i=0;i<3;i++){var g=m[i].name;var j=new sap.viz.ui5.data.MeasureDefinition({group:i+1,name:this.column_labels_mapping[g]||g,value:"{"+g+"}",});f.addMeasure(j)}}else if(((a=="BAR")&&(b=="DUAL"))||((a=="COLUMN")&&(b=="DUAL"))){for(var i=0;i<m.length;i++){var g=m[i].name;var k=(m[i].axis==1||m[i].axis==2)?m[i].axis:2;var j=new sap.viz.ui5.data.MeasureDefinition({group:k,name:this.column_labels_mapping[g]||g,value:"{"+g+"}"});f.addMeasure(j)}}return f},_getValueState:function(a,t){if(!this.EVALUATION.isTargetKpi()){if(a<t){return this.EVALUATION.isMaximizingKpi()?sap.ui.core.ValueState.Error:sap.ui.core.ValueState.Success}else if(a==t){return sap.ui.core.ValueState.None}else{return this.EVALUATION.isMaximizingKpi()?sap.ui.core.ValueState.Success:sap.ui.core.ValueState.Error}}else{return sap.ui.core.ValueState.None}},_getTableCell:function(o,t){var a=this;if(t&&(o!==t)){return new sap.m.ObjectNumber({number:{path:o},state:{parts:[{path:o},{path:t}],formatter:function(m,b){try{m=window.parseFloat(m);b=window.parseFloat(b);return a._getValueState(m,b)}catch(e){return sap.ui.core.ValueState.None}}}})}else{return new sap.m.Label({text:{path:o}})}},updateTable:function(d,m){this.dda_table.destroyColumns();this.dda_table.destroyItems();for(var i=0;i<d.length;i++){var v=d[i].name;var L=new sap.m.Label({text:this.column_labels_mapping[v]||v});var c=new sap.m.Column({hAlign:"Left",header:L,minScreenWidth:"Tablet",demandPopin:true,});this.dda_table.addColumn(c)}for(var i=0;i<m.length;i++){var v=m[i].name;var L=new sap.m.Label({text:this.column_labels_mapping[v]||v});var c=new sap.m.Column({hAlign:"Right",header:L,minScreenWidth:"Tablet",demandPopin:true,});this.dda_table.addColumn(c)}var t=new sap.m.ColumnListItem({unread:false,});for(var i=0;i<d.length;i++){var v=((this.dda_config.chartConfig.mode).toUpperCase()==="RUNTIME")?this.dimension_text_property_mapping[d[i].name]:d[i].name;var o=new sap.m.Label({text:"{"+v+"}"});t.addCell(o)}var a=this._oModel["THRESHOLD_MEASURE"];for(var i=0;i<m.length;i++){var v=m[i].name;if(this._oModel["COLOR_SCHEME"]=="AUTO_SEMANTIC")var o=this._getTableCell(v,a);else var o=this._getTableCell(v,v);t.addCell(o)}this.dda_table.setModel(this.oChartDataModel);this.dda_table.bindAggregation("items","/businessData",t)},applyCustomColoring:function(c,a,b,t,i){var C=this;if((a).toUpperCase()==="AUTO_SEMANTIC"){if(((i=="MA")||(i=="MI"))&&t){C.setCustomColors(c,b,a);c.setChartSemanticColorFormatter(function(o){var d=c.getModel().getData().businessData;var e=o.ctx.path.dii_a1;var f=d[e];var r=f[t];if(r!=null&&typeof r!='undefined'){if(o.val>r){if(i=="MA")return sap.ca.ui.charts.ChartSemanticColor.GoodLight;else if(i=="MI")return sap.ca.ui.charts.ChartSemanticColor.BadLight}else if(o.val<r){if(i=="MA")return sap.ca.ui.charts.ChartSemanticColor.BadLight;else if(i=="MI")return sap.ca.ui.charts.ChartSemanticColor.GoodLight}else{return sap.ca.ui.charts.ChartSemanticColor.Neutral}}else{jQuery.sap.log.error("Threshold Measure:'"+t+"' not in Dataset. Error Applying Semantic Color");return sap.ca.ui.charts.ChartSemanticColor.NeutralLight}})}else{jQuery.sap.log.error("Threshold Measure not available or Goal type is RA . Error Applying Semantic Color")}}else if(((a).toUpperCase()==="MANUAL_SEMANTIC")||((a).toUpperCase()==="MANUAL_NON_SEMANTIC")){C.setCustomColors(c,b,a)}},setCustomColors:function(c,m,a){var d=c.getDataset();var b=d.getMeasures();var e="";if((a).toUpperCase()==="AUTO_SEMANTIC"||(a).toUpperCase()==="MANUAL_SEMANTIC")e=sap.ca.ui.charts.ChartSemanticColor.Neutral;for(var i=0;i<b.length;i++){b[i].addCustomData(new sap.ui.core.CustomData({key:"fillColor",value:m[i].color||e}))}},set_percentCharts_uom:function(){var c=this;var a=this.dda_config.chartConfig.type;var b=this.dda_config.chartConfig.axis;var v=this.dda_config.chartConfig.value;var m=[];for(var i=0;i<this.chartMsrNames.length;i++){m.push(this.column_labels_mapping[this.chartMsrNames[i]]||this.chartMsrNames[i])}var d=this.getMeasuresByAxis(this.chartMeasures);var e=[],f=[];for(var i=0;i<d.axis1.nameArr.length;i++){e.push(this.column_labels_mapping[d.axis1.nameArr[i]]||d.axis1.nameArr[i])}for(var i=0;i<d.axis2.nameArr.length;i++){f.push(this.column_labels_mapping[d.axis2.nameArr[i]]||d.axis2.nameArr[i])}var g=(b=='DUAL')?e.join(" & "):m.join(" & ");var C={};if(this.dda_chart)C=this.dda_chart.getAdvancedChartSettings()?this.dda_chart.getAdvancedChartSettings():{};if(((a=='BAR')||(a=="COLUMN"))&&(v=="PERCENTAGE")){if(a=='COLUMN'){C.yAxis={title:{visible:true,text:(g+" ("+(c._oTextsModel.getResourceBundle().getText("IN_PERCENTAGE"))+")")}};if(b=='DUAL'){C.yAxis2={title:{visible:true,text:(f.join(" & ")+" ("+(c._oTextsModel.getResourceBundle().getText("IN_PERCENTAGE"))+")")}}}}else if(a=='BAR'){C.xAxis={title:{visible:true,text:(g+" ("+(c._oTextsModel.getResourceBundle().getText("IN_PERCENTAGE"))+")")}};if(b=='DUAL'){C.xAxis2={title:{visible:true,text:(g+" ("+(c._oTextsModel.getResourceBundle().getText("IN_PERCENTAGE"))+")")}};C.xAxis={title:{visible:true,text:(f.join(" & ")+" ("+(c._oTextsModel.getResourceBundle().getText("IN_PERCENTAGE"))+")")}}}}if(this.dda_chart)this.dda_chart.setAdvancedChartSettings(C)}},formatChartNumbers:function(v){var l=new sap.ui.core.Locale(sap.ui.getCore().getConfiguration().getLanguage());function i(n){return!isNaN(parseFloat(n))&&isFinite(n)}if(i(v)){if(!this.chartFormatter){var d=1;jQuery.sap.require("sap.ca.ui.model.format.NumberFormat");if(d||d==0){this.chartFormatter=sap.ca.ui.model.format.NumberFormat.getInstance({style:'short',shortDecimals:d},l)}else{this.chartFormatter=sap.ca.ui.model.format.NumberFormat.getInstance({style:'short'},l)}}v=this.chartFormatter.format(v)}return v},pseudoChartFormatter:function(v){return v},getRuntimeChartData:function(d,m){var t=this;var c=this.getView().byId("chartToolbar");c.setBusy(true);this.COLUMNS_SORT=[];for(var i=0;i<t.oColumns.length;i++){if(t.oColumns[i].sortBy&&t.oColumns[i].sortOrder){if((t.oColumns[i].sortOrder).toUpperCase()=="ASC"||(t.oColumns[i].sortOrder).toUpperCase=="DESC"){this.COLUMNS_SORT.push({name:t.oColumns[i].sortBy,order:t.oColumns[i].sortOrder})}}}try{var u=sap.suite.smartbusiness.odata.getUri({serviceUri:this._oModel.QUERY_SERVICE_URI,entitySet:this._oModel.QUERY_ENTITY_SET,dimension:d,measure:m,filter:this.DDA_MODEL.EVALUATION_DATA.FILTERS.results,sort:this.COLUMNS_SORT,dataLimit:(((this.dda_config.chartConfig.dataLimitations)&&(this.dda_config.chartConfig.dataLimit>0))?(this.dda_config.chartConfig.dataLimit):null),});u.model.read(u.uri,null,null,true,function(a){if(a.results.length){t.oChartData=a.results;t.oChartDataModel.setData({businessData:t.oChartData})}else{jQuery.sap.log.info("Chart data Table Returned Empty Results");t.oChartData=[];t.oChartDataModel.setData({businessData:t.oChartData})}c.setBusy(false)},function(){jQuery.sap.log.error("Error fetching data : "+u.uri);t.oChartData=[];t.oChartDataModel.setData({businessData:t.oChartData});c.setBusy(false)})}catch(e){jQuery.sap.log.error(e.toString());t.oChartData=[];t.oChartDataModel.setData({businessData:t.oChartData});c.setBusy(false)}},getDummyDataForChart:function(d,m,M,D){M=M||5;D=D||10;var c=[];var t,a={};for(var i=0;i<d.length;i++){a[d[i]]=[];for(var j=0;j<M;j++){a[d[i]].push(d[i]+"_"+j)}}for(var i=0;i<D;i++){t={};for(var j=0;j<d.length;j++){var b=a[d[j]].length;var p=sap.suite.smartbusiness.utils.getRandomNumber(b);t[d[j]]=a[d[j]][p]}for(var j=0;j<m.length;j++){t[m[j]]=sap.suite.smartbusiness.utils.getRandomNumber(100)}c.push(t)}c=this.sortChartData(c,d);return c},sortChartData:function(c,d){var e=[];c.sort(function(a,b){var i=0;while(i<d.length){if(a[d[i]]>b[d[i]]){return-1}else if(a[d[i]]<b[d[i]]){return 1}i++}});var t={};for(var i=0,k=0;i<c.length;i++){var s="";for(var j=0;j<d.length;j++){s+=c[i][d[j]]}if(!t[s]){t[s]=true;e[k++]=c[i]}}return e},onDeleteView:function(){var t=this;this.warn_header=false;var a=this.getView().getModel("SB_DDACONFIG").getData();var s=sap.suite.smartbusiness.ddaconfig.DrilldownSaveService;if(a.ALL_VIEWS.length>0){this.busyIndicator.open()&&this.getView().setBusy(true);s.saveViewConfiguration(this.evaluationId,a,"delete",function(){jQuery.sap.log.info("view delete success");t.busyIndicator.close()&&t.getView().setBusy(false);sap.m.MessageToast.show(t._oTextsModel.getResourceBundle().getText("CHART_CONFIG_DELETE_SUCCESS"));for(var i=0,b;i<a.ALL_VIEWS.length;i++){if(a.ALL_VIEWS[i].ID==t.viewId){b=i;break}}if(b||(b==0)){a.ALL_VIEWS.splice(b,1)}t.viewId=(a.ALL_VIEWS.length<=0?"":(a.ALL_VIEWS.length==(b)?a.ALL_VIEWS[0].ID:a.ALL_VIEWS[b].ID));t.DDA_MODEL.getConfigurator().removeViewById(a.ID);t.DDA_MODEL.setViewId(t.viewId);t.bindUiToModel();t._oModel=t.DDA_MODEL.getModelDataForDDAConfiguration();t.refreshChart()},function(e){jQuery.sap.log.error(e+" failed");t.busyIndicator.close()&&t.getView().setBusy(false);sap.suite.smartbusiness.utils.showErrorMessage(t._oTextsModel.getResourceBundle().getText("DELETE_ERROR"))})}},onViewSwitch:function(e){var k=e.getParameter("selectedKey");this.viewId=k;this.DDA_MODEL.setViewId(this.viewId);this.bindUiToModel();this._oModel=this.DDA_MODEL.getModelDataForDDAConfiguration();this.refreshChart();window.location.replace(window.location.hash.substring(0,window.location.hash.lastIndexOf("/"))+"/"+this.viewId)},deleteMaster:function(){var t=this;this.warn_header=false;var m=this.getView().getModel("SB_DDACONFIG").getData();var s=sap.suite.smartbusiness.ddaconfig.DrilldownSaveService;this.busyIndicator.open()&&this.getView().setBusy(true);s.saveEvalConfiguration(this.evaluationId,m,"delete",function(){jQuery.sap.log.info("Deleted master configuration for the evaluation");t.busyIndicator.close()&&t.getView().setBusy(false);t.DDA_MODEL.removeAllViews();sap.m.MessageToast.show(t._oTextsModel.getResourceBundle().getText("EVAL_CONFIG_DELETE_SUCCESS"));t.oRouter.navTo("detail",{"contextPath":"EVALUATIONS_DDA('"+t.evaluationId+"')"});t.evaluationId=null;t.oApplicationFacade.__refreshModel=1},function(e){jQuery.sap.log.error(e+" failed");t.busyIndicator.close()&&t.getView().setBusy(false);sap.suite.smartbusiness.utils.showErrorMessage(t._oTextsModel.getResourceBundle().getText("DELETE_ERROR"))})},fetchAndRenderHeaderRibbon:function(f){var s=this;var E=this.DDA_MODEL.EVALUATION_DATA;var p=sap.suite.smartbusiness.odata.properties(E.ODATA_URL,E.ODATA_ENTITYSET);var M=p.getUnitPropertyMappingObject();var u=sap.suite.smartbusiness.odata.getUri({serviceUri:E.ODATA_URL,entitySet:E.ODATA_ENTITYSET,measure:E.COLUMN_NAME,filter:E.FILTERS["results"]});u.model.read(u.uri,null,null,true,function(d){if(d){s.HeaderRibbonModel.setData({data:d.results[0]})}else{jQuery.sap.log.error("Couldn't fetch Aggregate Value. Response was "+d+" for uri : "+u.uri)}});var k=M[E.COLUMN_NAME];var i=this.getView().getModel("i18n");this.byId("aggregate_number").bindProperty("text","/data/"+E.COLUMN_NAME,function(v){if(v==""||v==null){v=i.getResourceBundle().getText("NO_DATA")}return v});if(k){this.byId("aggregate_number_unit").bindProperty("text","/data/"+k,function(v){return v})}},displayAggregate:function(){var i=this.getView().getModel("i18n");if(this.byId("enableAggregate").getSelected()==false){this.byId("enableAggregate").setText(i.getResourceBundle().getText("ENABLE_KPI_AGGREGATE"));this.byId("enableAggregate").invalidate()}else if(this.byId("enableAggregate").getSelected()==true){this.byId("enableAggregate").setText("")}}});
