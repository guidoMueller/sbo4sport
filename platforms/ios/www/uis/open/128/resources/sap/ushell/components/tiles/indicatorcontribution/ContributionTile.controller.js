sap.ui.controller("tiles.indicatorcontribution.ContributionTile",{onInit:function(){var t=this;this.firstTimeVisible=false;this.oContributionTileView=this.getView();this.oChip=this.oContributionTileView.getViewData().chip;if(this.oChip.visible){this.oChip.visible.attachVisible(this.visibleHandler.bind(this))}this.system=this.oChip.url.getApplicationSystem();this.oContributionTileView.oGenericTile.setState(sap.suite.ui.commons.LoadState.Loading);try{sap.ushell.components.tiles.indicatorTileUtils.util.getParsedChip(this.oChip.configuration.getParameterValueAsString("tileConfiguration"),function(c){t.oConfig=c;if(t.oChip.preview){t.oChip.preview.setTargetUrl(sap.ushell.components.tiles.indicatorTileUtils.util.getNavigationTarget(t.oConfig,t.system))}if(t.oChip.preview.isEnabled()){t.setTitle();t._updateTileModel({value:8888,size:sap.suite.ui.commons.InfoTileSize.Auto,frameType:"OneByOne",state:sap.suite.ui.commons.LoadState.Loading,valueColor:sap.suite.ui.commons.InfoTileValueColor.Error,indicator:sap.suite.ui.commons.DeviationIndicator.None,title:"US Profit Margin",footer:"Current Quarter",description:"Maximum deviation",data:[{title:"Americas",value:10,color:"Neutral"},{title:"EMEA",value:50,color:"Neutral"},{title:"APAC",value:-20,color:"Neutral"}],});t.oContributionTileView.oGenericTile.setState(sap.suite.ui.commons.LoadState.Loaded)}else{t.oConfig.TILE_PROPERTIES.FINALVALUE;t.setTitle();t.oContributionTileView.oGenericTile.attachPress(function(){sap.ushell.components.tiles.indicatorTileUtils.util.abortPendingODataCalls(t.comparisionChartODataRef);sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,null);window.location.hash=sap.ushell.components.tiles.indicatorTileUtils.util.getNavigationTarget(t.oConfig,t.system)});if(Number(t.oChip.configuration.getParameterValueAsString("isSufficient"))){sap.ushell.components.tiles.indicatorTileUtils.cache.setEvaluationById(t.oConfig.TILE_PROPERTIES.id,t.oConfig);t.flowWithoutDesignTimeCall()}else{t.flowWithDesignTimeCall()}}})}catch(e){this.logError(e)}},getTile:function(){return this.oContributionTileView.oGenericTile},setTitle:function(){var t=this;this._updateTileModel({header:t.oChip.preview.getTitle()||sap.ushell.components.tiles.indicatorTileUtils.util.getChipTitle(t.oConfig),subheader:t.oChip.preview.getDescription()||sap.ushell.components.tiles.indicatorTileUtils.util.getChipSubTitle(t.oConfig)})},_updateTileModel:function(n){var m=this.getTile().getModel().getData();jQuery.extend(m,n);this.getTile().getModel().setData(m)},flowWithoutDesignTimeCall:function(){var t=this;this.DEFINITION_DATA=this.oConfig;this._updateTileModel(this.DEFINITION_DATA);if(this.oChip.visible.isVisible()&&!this.firstTimeVisible){this.firstTimeVisible=true;this.fetchKpiValue(function(k){this.CALCULATED_KPI_VALUE=k;if(t.oConfig.TILE_PROPERTIES.frameType=="TwoByOne"){t.oContributionTileView.oGenericTile.setFrameType("TwoByOne");t.oContributionTileView.oGenericTile.removeAllTileContent();t.oContributionTileView.oGenericTile.addTileContent(t.oContributionTileView.oNumericTile);t.oContributionTileView.oGenericTile.addTileContent(t.oContributionTileView.oComparisonTile)}else{t.oContributionTileView.oGenericTile.setFrameType("OneByOne");t.oContributionTileView.oGenericTile.removeAllTileContent();t.oContributionTileView.oGenericTile.addTileContent(t.oContributionTileView.oComparisonTile)}this._updateTileModel({data:this.CALCULATED_KPI_VALUE});var n=sap.ushell.components.tiles.indicatorTileUtils.util.getNavigationTarget(t.oConfig,t.system);t.oContributionTileView.oGenericTile.$().wrap("<a href ='"+n+"'/>");this.oContributionTileView.oGenericTile.setState(sap.suite.ui.commons.LoadState.Loaded)},this.logError)}},flowWithDesignTimeCall:function(){var t=this;try{var a=sap.ushell.components.tiles.indicatorTileUtils.cache.getEvaluationById(this.oConfig.EVALUATION.ID);if(a){t.oConfig.EVALUATION_FILTERS=a.EVALUATION_FILTERS;t.flowWithoutDesignTimeCall()}else{sap.ushell.components.tiles.indicatorTileUtils.util.getFilterFromRunTimeService(this.oConfig,function(f){t.oConfig.EVALUATION_FILTERS=f;sap.ushell.components.tiles.indicatorTileUtils.cache.setEvaluationById(t.oConfig.TILE_PROPERTIES.id,t.oConfig);t.flowWithoutDesignTimeCall()})}}catch(e){this.logError(e)}},fetchKpiValue:function(s,E){var t=this;try{var u=this.oConfig.EVALUATION.ODATA_URL;var a=this.oConfig.EVALUATION.ODATA_ENTITYSET;if(this.oConfig.TILE_PROPERTIES.semanticMeasure){var m=this.oConfig.EVALUATION.COLUMN_NAME+","+this.oConfig.TILE_PROPERTIES.semanticMeasure}else{var m=this.oConfig.EVALUATION.COLUMN_NAME}var d=this.oConfig.TILE_PROPERTIES.dimension;var b=this.oConfig.EVALUATION_VALUES;var c=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(t.oConfig.TILE_PROPERTIES.id);if(!c){var v=sap.ushell.components.tiles.indicatorTileUtils.util.prepareFilterStructure(this.oConfig.EVALUATION_FILTERS,this.oConfig.ADDITIONAL_FILTERS);var o={};o["0"]=m+",asc";o["1"]=m+",desc";o["2"]=d+",asc";o["3"]=d+",desc";var f=o[this.oConfig.TILE_PROPERTIES.sortOrder||"0"].split(",");var g=sap.ushell.components.tiles.indicatorTileUtils.util.prepareQueryServiceUri(t.oChip.url.addSystemToServiceUrl(u),a,m,d,v,3);if(this.oConfig.TILE_PROPERTIES.semanticMeasure)g.uri+="&$top=3&$orderby="+f[0]+" "+f[2];else g.uri+="&$top=3&$orderby="+f[0]+" "+f[1];this.comparisionChartODataRef=g.model.read(g.uri,null,null,false,function(b){var w={};if(g.unit){t._updateTileModel({unit:b.results[0][g.unit.name]});w.unit=g.unit;w.unit.name=g.unit.name}if(b&&b.results&&b.results.length){d=sap.ushell.components.tiles.indicatorTileUtils.util.findTextPropertyForDimension(t.oChip.url.addSystemToServiceUrl(u),a,d);w.dimension=d;t.oConfig.TILE_PROPERTIES.FINALVALUE=b;t.oConfig.TILE_PROPERTIES.FINALVALUE=t._processDataForComparisonChart(t.oConfig.TILE_PROPERTIES.FINALVALUE,m.split(",")[0],d);w.data=b;sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,w);s.call(t,t.oConfig.TILE_PROPERTIES.FINALVALUE)}else if(b.results.length==0){t.oConfig.TILE_PROPERTIES.FINALVALUE=b;w.data=b;sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,w);s.call(t,t.oConfig.TILE_PROPERTIES.FINALVALUE)}else{E.call(t,"no Response from QueryServiceUri")}},function(h){if(h&&h.response){jQuery.sap.log.error(h.message+" : "+h.request.requestUri);E.call(t,h)}})}else{if(c.unit){t._updateTileModel({unit:c.data.results[0][c.unit.name]})}if(c.data&&c.data.results&&c.data.results.length){d=c.dimension;t.oConfig.TILE_PROPERTIES.FINALVALUE=c.data;t.oConfig.TILE_PROPERTIES.FINALVALUE=t._processDataForComparisonChart(t.oConfig.TILE_PROPERTIES.FINALVALUE,m.split(",")[0],d);s.call(t,t.oConfig.TILE_PROPERTIES.FINALVALUE)}else if(b.results.length==0){t.oConfig.TILE_PROPERTIES.FINALVALUE=c.data;s.call(t,t.oConfig.TILE_PROPERTIES.FINALVALUE)}else{E.call(t,"no Response from QueryServiceUri")}}}catch(e){E.call(t,e)}},_processDataForComparisonChart:function(d,m,a){var s=this.oConfig.TILE_PROPERTIES.semanticColorContribution;var f=[];var t;var b=this;for(var i=0;i<d.results.length;i++){var c=d.results[i];var g={};try{g.title=c[a].toString()}catch(e){g.title=""};g.value=Number(c[m]);var h=Number(c[m]);if(this.oConfig.EVALUATION.SCALING==-2)h*=100;t=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(h,this.oConfig.EVALUATION.SCALING);if(this.oConfig.EVALUATION.SCALING==-2)t+=" %";g.displayValue=t.toString();if(typeof s==='undefined'){g.color="Neutral"}else{g.color=s}f.push(g)}return f},logError:function(e){this.oContributionTileView.oGenericTile.setState(sap.suite.ui.commons.LoadState.Failed);this.oContributionTileView.oGenericTile.setState(sap.suite.ui.commons.LoadState.Failed);sap.ushell.components.tiles.indicatorTileUtils.util.logError(e)},refreshHandler:function(c){if(!c.firstTimeVisible){if(Number(this.oChip.configuration.getParameterValueAsString("isSufficient")))c.flowWithoutDesignTimeCall();else c.flowWithDesignTimeCall()}},visibleHandler:function(i){if(!i){this.firstTimeVisible=false;sap.ushell.components.tiles.indicatorTileUtils.util.abortPendingODataCalls(this.comparisionChartODataRef)}if(i){this.refreshHandler(this)}},onExit:function(){sap.ushell.components.tiles.indicatorTileUtils.util.abortPendingODataCalls(this.comparisionChartODataRef)}});
