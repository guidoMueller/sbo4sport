// Copyright (c) 2013 SAP AG, All Rights Reserved
(function(){"use strict";jQuery.sap.require("sap.ui.core.IconPool");setTimeout(function(){jQuery.sap.require("sap.ushell.renderers.fiori2.launchpad.DashboardManager")},10);jQuery.sap.require("sap.ushell.services.Message");jQuery.sap.require("sap.ushell.services.ShellNavigation");jQuery.sap.require("sap.ushell.services.AppConfiguration");jQuery.sap.require("sap.ushell.renderers.fiori2.History");jQuery.sap.require("sap.ushell.ui.launchpad.LoadingDialog");jQuery.sap.require("sap.ushell.renderers.fiori2.AccessKeysHandler");var a=true,m=sap.ui.Device.system.phone,u,M=new sap.ui.model.json.JSONModel({groups:[],animationRendered:false,title:"My demo title",searchAvailable:false,rtl:false,personalization:true,searchTerm:"",states:{"home":{"stateName":"home","showCurtain":false,"headerHiding":false,"headerVisible":true,"showCatalog":false,"showPane":false,"headItems":["configBtn"],"headEndItems":["sf"],"search":"","paneContent":[],"actions":["ContactSupportBtn","loginDetails","hideGroupsBtn","logoutBtn"]},"app":{"stateName":"app","showCurtain":false,"headerHiding":true,"headerVisible":true,"headEndItems":["sf"],"showCatalog":false,"showPane":false,"search":"","headItems":["homeBtn"],"actions":["ContactSupportBtn","aboutBtn","loginDetails","logoutBtn"],"shellActions":["ContactSupportBtn","aboutBtn","loginDetails","logoutBtn"]},"minimal":{"stateName":"minimal","showCurtain":false,"headerHiding":false,"headerVisible":true,"headEndItems":[],"showCatalog":false,"showPane":false,"headItems":[],"actions":["ContactSupportBtn","aboutBtn","loginDetails","logoutBtn"],"shellActions":["ContactSupportBtn","aboutBtn","loginDetails","logoutBtn"]},"standalone":{"stateName":"standalone","showCurtain":false,"headerHiding":true,"headerVisible":true,"headEndItems":[],"showCatalog":false,"showPane":false,"headItems":[],"actions":["ContactSupportBtn","aboutBtn"],"shellActions":["ContactSupportBtn","aboutBtn"]},"embedded":{"stateName":"embedded","showCurtain":false,"headerHiding":true,"headerVisible":true,"headEndItems":["standardActionsBtn"],"showCatalog":false,"showPane":false,"headItems":[],"actions":["ContactSupportBtn","aboutBtn"],"shellActions":["ContactSupportBtn","aboutBtn"]},"headerless":{"stateName":"headerless","showCurtain":false,"headerHiding":true,"headerVisible":false,"headEndItems":[],"showCatalog":false,"showPane":false,"headItems":[],"actions":[],"shellActions":[]},"catalog":{"stateName":"catalog","showCurtain":false,"headerHiding":true,"headerVisible":true,"headEndItems":["sf"],"showCatalog":true,"showPane":false,"search":"","headItems":["homeBtn"],"actions":["ContactSupportBtn","loginDetails","logoutBtn"]},"catalogApp":{"stateName":"catalogApp","showCurtain":false,"headerHiding":true,"headerVisible":true,"headEndItems":["sf"],"showCatalog":false,"showPane":false,"search":"","headItems":["backBtn"],"actions":["ContactSupportBtn","aboutBtn","loginDetails","logoutBtn"],"shellActions":["ContactSupportBtn","aboutBtn","loginDetails","logoutBtn"]}}}),c=false,C={},b=['minimal','app','standalone','embedded','headerless'];M.setSizeLimit(10000);sap.ui.controller("sap.ushell.renderers.fiori2.Shell",{catalogPageId:"catalogPage",onInit:function(){this.getView().setModel(M);var v=this.getView().getViewData();if(v){C=v.config||{}}this.getView().setModel(sap.ushell.resources.i18nModel,"i18n");sap.ui.getCore().getEventBus().subscribe("externalSearch",this.externalSearchTriggered,this);sap.ui.getCore().getEventBus().subscribe("showCatalog",this.showCatalog,this);sap.ui.getCore().getEventBus().subscribe("openApp",this.openApp,this);sap.ui.getCore().getEventBus().subscribe("launchpad","contentRendered",this.loadCoreExt);if(C){if(C.appState==="headerless"){M.setProperty("/personalization",false);M.setProperty("/states/home/headerVisible",false)}else{if(C.enablePersonalization!==undefined){M.setProperty("/personalization",C.enablePersonalization)}if(C.enableSetTheme!==undefined){M.setProperty("/setTheme",C.enableSetTheme)}}}u=sap.ushell.Container.getService("UserRecents");this.history=new sap.ushell.renderers.fiori2.History();this.oNavContainer=sap.ui.getCore().byId("navContainer");this.oLoadingDialog=sap.ui.getCore().byId("loadingDialog");this.toggleRtlMode(sap.ui.getCore().getConfiguration().getRTL());this.oShellNavigation=sap.ushell.Container.getService("ShellNavigation");this.oShellNavigation.init(jQuery.proxy(this.doHashChange,this));sap.ushell.Container.getService("Message").init(jQuery.proxy(this.doShowMessage,this));sap.ushell.Container.setLogonFrameProvider(this._getLogonFrameProvider());this.bContactSupportEnabled=sap.ushell.Container.getService("SupportTicket").isEnabled();if(this.bContactSupportEnabled){sap.ushell.UserActivityLog.activate()}if(C&&C.enableHideGroups!==undefined){M.setProperty("/enableHideGroups",C.enableHideGroups)}},_getLogonFrameProvider:function(){var v=this.getView();return{create:function(){return v.createIFrameDialog()},show:function(){v.showIFrameDialog()},destroy:function(){v.destroyIFrameDialog()}}},onExit:function(){sap.ui.getCore().getEventBus().unsubscribe("externalSearch",this.externalSearchTriggered,this);sap.ui.getCore().getEventBus().unsubscribe("showCatalog",this.showCatalog,this);sap.ui.getCore().getEventBus().unsubscribe("openApp",this.openApp,this);this.oShellNavigation.hashChanger.destroy();this.getView().aDanglingControls.forEach(function(o){if(o.destroyContent){o.destroyContent()}o.destroy()});this.getView().oDashboardManager.destroy();sap.ushell.UserActivityLog.deactivate()},getModel:function(){return M},showCatalog:function(s,e,d){if(!this.isCatalogExist()){var o=sap.ui.view({id:this.catalogPageId,viewName:"sap.ushell.renderers.fiori2.launchpad.catalog.Catalog",viewData:{},type:sap.ui.core.mvc.ViewType.JS});this.oNavContainer.addPage(o)}this.switchViewState("catalog");this.oNavContainer.to(this.catalogPageId,this.getAnimationType());this.setAppIcons({title:sap.ushell.resources.i18n.getText("tile_catalog")});this.oLoadingDialog.closeLoadingScreen();sap.ui.getCore().getEventBus().publish("showCatalogEvent",d);jQuery(document).off('keydown.dashboard');jQuery(document).off('keydown.catalog');jQuery(document).on('keydown.catalog',sap.ushell.renderers.fiori2.AccessKeysHandler.catalogKeydownHandler)},isCatalogExist:function(){return(sap.ui.getCore().byId(this.catalogPageId))?true:false},getAnimationType:function(){return sap.ui.Device.os.android?"show":"slide"},openShellOverlay:function(d){},closeShellOverlay:function(){},onCurtainClose:function(e){jQuery.sap.log.warning("Closing Curtain",e);c=false},doShowMessage:function(t,s,p){jQuery.sap.require("sap.m.MessageToast");jQuery.sap.require("sap.m.MessageBox");if(t===sap.ushell.services.Message.Type.ERROR){if(sap.ushell.Container.getService("SupportTicket").isEnabled()){jQuery.sap.require("sap.ushell.ui.launchpad.EmbeddedSupportErrorMessage");var e=new sap.ushell.ui.launchpad.EmbeddedSupportErrorMessage("EmbeddedSupportErrorMessage",{title:p.title||sap.ushell.resources.i18n.getText("error"),content:new sap.m.Text({text:s})});e.open()}else{sap.m.MessageBox.show(s,sap.m.MessageBox.Icon.ERROR,p.title||sap.ushell.resources.i18n.getText("error"))}}else if(t===sap.ushell.services.Message.Type.CONFIRM){if(p.actions){sap.m.MessageBox.show(s,sap.m.MessageBox.Icon.QUESTION,p.title,p.actions,p.callback)}else{sap.m.MessageBox.confirm(s,p.callback,p.title)}}else{sap.m.MessageToast.show(s,{duration:p.duration||3000})}},ignoreHashChange:function(s,A,o){},doHashChange:function(s,A,o,p){if(!a){a=true;return}s=this.fixShellHash(s);var d=this.history.getHistoryLength();if(p){this.hashChangeFailure(d,p.message,null,"sap.ushell.renderers.fiori2.Shell.controller");return}this.history.hashChange(s,o);var U=sap.ushell.Container.getService("URLParsing");var S=U.parseShellHash(s);var e=M.getProperty("/currentState");var i=e&&e.stateName==="catalog";var O=S&&S.action!==sap.ushell.renderers.fiori2.Navigation.CATALOG.ACTION;if(!i||O){this.oLoadingDialog.setText("");this.oLoadingDialog.openLoadingScreen()}if(S&&S.contextRaw&&S.contextRaw==="navResCtx"){var f={};f.additionalInformation=S.params.additionalInformation[0];f.url=S.params.url[0];f.applicationType=S.params.applicationType[0];this.openSomething(s,o,A,f)}else{sap.ushell.Container.getService("NavTargetResolution").resolveHashFragment(s).done(jQuery.proxy(this.openSomething,this,s,o,A)).fail(jQuery.proxy(function(g){this.hashChangeFailure(d,"Failed to resolve navigation target: "+s,g,"sap.ushell.renderers.fiori2.Shell.controller")},this))}},hashChangeFailure:function(h,s,d,e){this.reportError(s,d,e);this.oLoadingDialog.closeLoadingScreen();this.delayedMessageError(sap.ushell.resources.i18n.getText("fail_to_start_app_config_err"));if(h===0){this.cleanHash()}else{this.historyBack()}},reportError:function(s,d,e){jQuery.sap.log.error(s,d,e)},delayedMessageError:function(s){setTimeout(function(){sap.ushell.Container.getService("Message").error(s)},0)},fixShellHash:function(s){if(!s){s='#'}else if(s.charAt(0)!=='#'){s='#'+s}return(s)},cleanHash:function(){window.location.hash=""},changeHash:function(h){window.location.hash=h},historyBack:function(){window.history.back(1)},openSomething:function(s,o,A,d){var f;if(!this.oNavContainer.getParent()){sap.ui.getCore().byId("shell").addContent(this.oNavContainer)}if(d){try{f=sap.ushell.Container.getService("URLParsing").parseShellHash(s)}catch(e){f=undefined}if(f===undefined){jQuery.sap.log.warning("Could not parse shell hash: "+s);f={}}f.sShellHash=s;f.sOldShellHash=o;f.sAppPart=A;f.oApplication=d;if(d.applicationType===sap.ushell.renderers.fiori2.Navigation.CATALOG.ID){if(M.getProperty("/personalization")){sap.ui.getCore().getEventBus().publish("showCatalog",f)}else{this.openDashboard();this.cleanHash();this.oLoadingDialog.closeLoadingScreen()}}else{try{jQuery.sap.require('sap.fiori.core-ext')}catch(g){jQuery.sap.log.warning("failed to load sap.fiori.core-ext!")}f.oMetadata=sap.ushell.services.AppConfiguration.getMetadata(d);sap.ui.getCore().getEventBus().publish("openApp",f)}}else{var h=M.getProperty("/currentState");if(h&&h.stateName==="catalogApp"){this.showCatalog()}else{this.openDashboard()}}},openDashboard:function(){var o=M.getProperty("/currentState")&&M.getProperty("/currentState").stateName==="catalog";this.switchViewState("home");this.oNavContainer.backToTop();sap.ushell.services.AppConfiguration.setCurrentApplication(null);this.setAppIcons(null);if(o){sap.ushell.utils.addBottomSpace()}try{sap.ushell.utils.handleTilesVisibility()}catch(e){}jQuery(document).off('keydown.dashboard');jQuery(document).off('keydown.catalog');jQuery(document).on('keydown.dashboard',sap.ushell.renderers.fiori2.AccessKeysHandler.dashboardKeydownHandler);var U=sap.ui.getCore().byId('shell');U.focusOnConfigBtn()},openApp:function(s,E,d){this.getView().showDemoPopover=false;jQuery.sap.log.warning("Triggering navigation to ",d);var A,o=d.oApplication,f=d.oMetadata||{},I=null,g=d.sShellHash.replace(/\W/g,"-"),O,h=f.title||"",j=f.icon||null,k=sap.ushell.Container.getService('Message');if(!C||!C.changeOpacity||C.changeOpacity!=='off'){setTimeout(function(){u.addAppUsage(d.sShellHash)},700)}if(o){try{if(o.applicationType==="NWBC"&&!(d&&d.contextRaw&&d.contextRaw==="navResCtx")&&this.history.getHistoryLength()>1){a=false;window.history.back(1);var t=d;var S=d;var l;S.params.additionalInformation=o.additionalInformation;S.params.url=o.url;S.params.applicationType=o.applicationType;S.target=t;t.contextRaw=S.contextRaw="navResCtx";var n=sap.ushell.Container.getService("ShellNavigation").hrefForExternal(S,true);if(n.skippedParams){l="#"+d.semanticObject+"-"+d.action}else{l=n.hash}this.openAppNewWindow(l);this.oLoadingDialog.closeLoadingScreen();return}if(!this.oNavContainer.getPage("application"+g)&&!this.oNavContainer.getPage("shellPage"+g)){jQuery.sap.require('sap.ushell.components.container.ApplicationContainer');A=new sap.ushell.components.container.ApplicationContainer("application"+g,o);var p=A.onAfterRendering;A.onAfterRendering=function(){if(p){p.apply(this,arguments)}setTimeout(function(){sap.ui.getCore().getEventBus().publish("launchpad","appOpened",o);jQuery.sap.log.info('app was opened')},0)};var q=A.exit;A.exit=function(){if(q){q.apply(this,arguments)}setTimeout(function(){sap.ui.getCore().getEventBus().publish("launchpad","appClosed",o);jQuery.sap.log.info('app was closed')},0)};sap.ushell.services.AppConfiguration.setCurrentApplication(o);this.oLoadingDialog.showAppInfo(h,j);if(!f.fullWidth&&o.applicationType!=="NWBC"){I=new sap.m.Shell("shellPage"+g,{logo:sap.ui.resource('sap.ui.core','themes/base/img/1x1.gif'),title:h,showLogout:false,app:A}).addStyleClass("sapUshellApplicationPage");if(!h){I.addStyleClass("sapUshellApplicationPageNoHdr")}}else{A.addStyleClass('sapMShellGlobalInnerBackground');I=A}this.oNavContainer.addPage(I)}else if(this.oNavContainer.getPage("application"+g)||this.oNavContainer.getPage("shellPage"+g)){I=this.oNavContainer.getPage("application"+g)||this.oNavContainer.getPage("shellPage"+g)}this.setAppIcons(f);if(o.applicationType[0]==="NWBC"||o.applicationType==="NWBC"){this.switchViewState("minimal");a=false;this.changeHash(d.semanticObject+"-"+d.action)}else{var r=M.getProperty("/currentState");if(r&&r.stateName==="catalog"){this.switchViewState("catalogApp")}else{var w="app";if(b.indexOf(C.appState)>=0){w=C.appState}this.switchViewState(w)}}if(this.history.backwards&&this.oNavContainer.getInitialPage()!==this.oNavContainer.getCurrentPage().getId()){this.oNavContainer.to(I,"slideBack")}else{this.oNavContainer.to(I,this.oNavContainer.getInitialPage()?"slide":"show")}setTimeout(function(){this.oLoadingDialog.closeLoadingScreen()}.bind(this),300)}catch(e){this.reportError(e.name,e.message,h);this.oNavContainer.removePage(this.oNavContainer.getCurrentPage()).destroy();O=this.oNavContainer.removeAllPages();this.oNavContainer.destroy();this.oNavContainer=this.getView().initNavContainer(this);jQuery.each(O,jQuery.proxy(function(i,v){if(!this.oNavContainer.getPage(v.getId())){this.oNavContainer.addPage(v)}if(v.getId()===this.oNavContainer.getInitialPage()){v.removeStyleClass("sapMNavItemHidden")}},this));this.navigateToHome();this.oLoadingDialog.closeLoadingScreen();k.error(sap.ushell.resources.i18n.getText("fail_to_start_app_runtime_err"))}}if(this.history.getHistoryLength()<1){this.oLoadingDialog.closeLoadingScreen()}},openAppNewWindow:function(U){window.open(U)},setAppIcons:function(o){var s=jQuery.sap.getModulePath("sap.ushell");var l=(o&&o.homeScreenIconPhone)||(s+'/themes/base/img/launchicons/57_iPhone_Desktop_Launch.png'),L=(o&&o["homeScreenIconPhone@2"])||(s+'/themes/base/img/launchicons/114_iPhone-Retina_Web_Clip.png'),d=(o&&o.homeScreenIconTablet)||(s+'/themes/base/img/launchicons/72_iPad_Desktop_Launch.png'),e=(o&&o["homeScreenIconTablet@2"])||(s+'/themes/base/img/launchicons/144_iPad_Retina_Web_Clip.png'),f=(o&&o.favIcon)||(s+'/themes/base/img/launchpad_favicon.ico'),t=(o&&o.title)||sap.ushell.resources.i18n.getText("homeBtn_tooltip"),g=this.getFavIconHref();if(sap.ui.Device.os.ios){jQuery.sap.setIcons({'phone':l,'phone@2':L,'tablet':d,'tablet@2':e,'favicon':f,'precomposed':true})}else if(g!==f){jQuery.sap.setIcons({'phone':'','phone@2':'','tablet':'','tablet@2':'','favicon':f,'precomposed':true})}window.document.title=t},getFavIconHref:function(){return jQuery('link').filter('[rel="shortcut icon"]').attr('href')||''},externalSearchTriggered:function(s,e,d){M.setProperty("/searchTerm",d.searchTerm);d.query=d.searchTerm},onAfterNavigate:function(e){var h=this.oNavContainer.getInitialPage(),f=e.getParameter("fromId");if(f!==h&&f!==this.catalogPageId){this.oNavContainer.removeAggregation("pages",f,true);sap.ui.getCore().byId(f).destroy()}this.oLoadingDialog.closeLoadingScreen()},onAfterRendering:function(){if(window.f2p){f2p.add(f2p.m.endHomePage)}},navigateToHome:function(e){if(!e||(e&&e.getParameter("id")==='homeBtn')){location.hash='';this.openDashboard()}else{sap.ushell.renderers.fiori2.Navigation.openCatalogByHash({groupContext:null})}},toggleSearch:function(i){M.setProperty("/searchAvailable",i)},toggleRtlMode:function(r){M.setProperty("/rtl",r)},togglePane:function(e){var s=e.getSource(),S=s.getSelected();if(!sap.ui.getCore().byId('groupList')){var g=this.getView().oDashboardManager.getGroupListView();if(sap.ui.Device.system.desktop){g.addStyleClass("sapUshellGroupListDesktopScrollbar")}this.getModel().setProperty('/states/home/paneContent',[g.getId()]);this.getModel().setProperty('/currentState/paneContent',[g.getId()])}if(e.getParameter("id")==="categoriesBtn"){s.getModel().setProperty("/currentState/showCurtainPane",!S)}else{s.getModel().setProperty("/currentState/showPane",!S);setTimeout(function(){var o=sap.ui.getCore().byId("shell");if(o){o.setFocusOnFirstGroupInList()}},1500)}setTimeout(function(){$("li.sapUshellOver").click()},400)},getActiveViews:function(){var d=this.getModel().getProperty("/currentState/curtainContent"),p=sap.ui.getCore().byId(d[0]),A=[];jQuery.each(p.getContent(),function(i,v){A.push(v.getId())});return A},getLastSearchScreen:function(){return M.getProperty("/lastSearchScreen")},saveSearchScreen:function(s){if(s==='historyScreen'||s==='searchResults'||s==='suggestions'){M.setProperty("/lastSearchScreen",s)}},switchViewState:function(s,S){var p=s[0]==="/"?s:"/states/"+s,o=M.getProperty(p),d=sap.ui.getCore().byId("shell"),e=M.getProperty("/currentState")||{};if(!d.getSearch()||o.search!==d.getSearch().getId()){d.setSearch(sap.ui.getCore().byId(o.search))}this.saveSearchScreen(s);if(!!S){M.setProperty("/lastState",e)}o=jQuery.extend({},e,o);M.setProperty("/currentState",o);if(s==="searchResults"){M.setProperty("/lastSearchScreen",'');if(window.location.href.indexOf("#Action-search")>-1){this.closeShellOverlay()}else{var f=sap.ui.getCore().getModel("searchModel");window.location.href="#Action-search&/searchTerm="+encodeURI(f.getProperty("/searchBoxTerm"))+"&dataSource="+encodeURI(JSON.stringify(f.getDataSourceJson()))}}else{if(!!o.showCurtain){this.openShellOverlay()}else{this.closeShellOverlay()}}},pressActionBtn:function(e){if(!sap.ui.Device.system.desktop){this.getModel().setProperty("/headerHiding",false)}var A=sap.ui.getCore().byId('headActions');if(!A){var l=new sap.ushell.ui.footerbar.LoginDetailsButton("loginDetails"),L=new sap.ushell.ui.footerbar.LogoutButton("logoutBtn"),o=new sap.ushell.ui.footerbar.AboutButton("aboutBtn");var h=new sap.ushell.ui.footerbar.HideGroupsButton("hideGroupsBtn");if(!this.getModel().getProperty('/enableHideGroups')){h.setVisible(false)}var d=new sap.ushell.ui.footerbar.ContactSupportButton("ContactSupportBtn",{visible:this.bContactSupportEnabled});A=new sap.m.ActionSheet("headActions",{placement:sap.m.PlacementType.Bottom,buttons:{path:"/currentState/actions",factory:function(i,f){return sap.ui.getCore().byId(f.getObject())}}});A.updateAggregation=this.getView().updateShellAggregation;A.setModel(this.getModel());this.getView().aDanglingControls.push(A,l,L,o,d,h)}A.openBy(e.getSource());A.attachAfterClose(A,function(){if(!sap.ui.Device.system.desktop){var f=sap.ui.getCore().byId('shell').getModel().getProperty("/currentState"),g=f.headerHiding;this.getModel().setProperty("/headerHiding",g)}})},loadCoreExt:function(){var A=jQuery.sap.isDeclared('sap.fiori.core',true)||jQuery.sap.isDeclared('sap.fiori.core-ext',true),l,p='';if(A){return}if(window.Worker){p=jQuery.sap.getModulePath('sap.ushell.loader','.js');l=new window.Worker(p);l.onmessage=function(E){if(E.data&&!E.data.error){try{window.eval(E.data);jQuery.sap.declare('sap.fiori.core-ext'+'')}catch(e){jQuery.sap.log.warning('failed to load sap.fiori.core-ext')}}else{jQuery.sap.log.warning('failed to load sap.fiori.core-ext')}l.terminate()};l.postMessage({action:'loadResource',url:window['sap-ui-debug']?'../fiori/core-ext-dbg.js':'../fiori/core-ext.js'})}else{setTimeout(function(){try{jQuery.sap.require('sap.fiori.core-ext')}catch(e){jQuery.sap.log.warning("failed to load sap.fiori.core-ext")}},0)}}})}());
