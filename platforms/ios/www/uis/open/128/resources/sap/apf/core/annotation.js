/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.apf.core.annotation");(function(){"use strict";sap.apf.core.annotation={};sap.apf.core.annotation.initialized=[];sap.apf.core.annotation.parse=function(m,a){var x={},g,b,s,c,d,r,f,h,n,o,q,A,t={},u,v,S={},i,w,y={},z={},B="",C,D,E,F,G,H,I,T,J,K,L,M,N,j,O,P,Q,R,U,V,W,X,Y,Z,$,_,a1,b1,c1,d1,e1,f1,g1;if(sap.ui.Device.browser.internet_explorer){x={setNameSpace:function(e){e.setProperty("SelectionNamespaces",'xmlns:edmx="http://docs.oasis-open.org/odata/ns/edmx" xmlns:d="http://docs.oasis-open.org/odata/ns/edm"');e.setProperty("SelectionLanguage","XPath");return e},selectNodes:function(e,x,k){return k.selectNodes(x)},nextNode:function(e){return e.nextNode()},getNodeText:function(e){return e.text}}}else{x={setNameSpace:function(e){return e},nsResolver:function(p){var e={"edmx":"http://docs.oasis-open.org/odata/ns/edmx","d":"http://docs.oasis-open.org/odata/ns/edm"};return e[p]||null},selectNodes:function(e,p,k){var l=e.evaluate(p,k,this.nsResolver,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);l.length=l.snapshotLength;return l},nextNode:function(e,k){return e.snapshotItem(k)},getNodeText:function(e){return e.textContent}}}g=function(k){var l;var p;if(sap.ui.Device.browser.internet_explorer&&sap.ui.Device.browser.version>=10){try{var h1={url:k,async:false};var i1=function(k1,l1){l={success:false,data:{}};throw new Error(l1)};var j1=function(k1,l1,m1){l={success:true,data:{}};var n1=m1.responseText;l.data=new ActiveXObject("Microsoft.XMLDOM");l.data.loadXML(n1)};jQuery.ajax(h1).done(j1).fail(i1)}catch(e){}}else{l=jQuery.sap.sjax({url:k})}if(l.success){return l.data}};b=function(m){var e={},h1={},i1={},j1=false,i,k1,l1,m1,n1={},j,o1={},p1={},q1=false,r1,l,k,s1,t1,u1,v1,p,w1;for(i=m.dataServices.schema.length-1;i>=0;i-=1){e=m.dataServices.schema[i];if(e.entityType){k1=e.namespace;l1=e.entityType;m1=e.complexType;for(j in l1){if(l1.hasOwnProperty(j)){n1=l1[j];p1={};if(n1.hasStream&&n1.hasStream==="true"){continue}for(k in n1.property){r1=n1.property[k];if(r1.type.substring(0,k1.length)===k1){for(l in m1){if(m1[l].name===r1.type.substring(k1.length+1)){for(k in m1[l].property){s1=m1[l].property[k];o1[m1[l].name+"/"+s1.name]=s1.type}}}}else{t1=r1.name;u1=r1.type;for(p in r1.extensions){v1=r1.extensions[p];if((v1.name==="display-format")&&(v1.value==="Date")){u1="Edm.Date"}else{q1=true;if(!p1[t1]){p1[t1]={}}if(v1.namespace&&!p1[t1][v1.namespace]){p1[t1][v1.namespace]={}}p1[t1][v1.namespace][v1.name]=v1.value}}o1[t1]=u1}}if(!h1[k1+"."+n1.name]){h1[k1+"."+n1.name]={}}h1[k1+"."+n1.name]=o1;if(q1){if(!i1[k1+"."+n1.name]){j1=true}i1[k1+"."+n1.name]={};i1[k1+"."+n1.name]=p1}}}}}if(j1){w1={types:h1,extensions:i1}}else{w1={types:h1}}return w1};s=function(p,e,k,S){var l,h1,i1='';for(l in p){if(p.hasOwnProperty(l)){if(p[l]){h1=p[l];if(h1.Value&&h1.Value.Path){i1=c(h1.Value.Path,e,k,S);if(i1){p[l].EdmType=i1}continue}if(h1.Path){i1=c(h1.Path,e,k,S);if(i1){p[l].EdmType=i1}continue}if(h1.Facets){p[l].Facets=s(h1.Facets,e,k,S);continue}if(h1.Data){p[l].Data=s(h1.Data,e,k,S);continue}if(l==="Data"){p.Data=s(h1,e,k,S);continue}if(h1.Value&&h1.Value.Apply){p[l].Value.Apply.Parameters=s(h1.Value.Apply.Parameters,e,k,S);continue}if(h1.Value&&h1.Type&&(h1.Type==="Path")){i1=c(h1.Value,e,k,S);if(i1){p[l].EdmType=i1}}}}}return p};c=function(p,e,k,S){var l;if((p.charAt(0)==="@")&&(p.indexOf(S.Alias)===1)){p=p.slice(S.Alias.length+2)}if(p.indexOf("/")>=0){if(e[p.slice(0,p.indexOf("/"))]){k=p.slice(0,p.indexOf("/"));p=p.slice(p.indexOf("/")+1)}}for(l in e[k]){if(e[k].hasOwnProperty(l)){if(p===l){return e[k][l]}}}};d=function(e){var k="",l="",i,p={};for(i=0;i<e.attributes.length;i+=1){if((e.attributes[i].name!=="Property")&&(e.attributes[i].name!=="Term")){k=e.attributes[i].name;l=e.attributes[i].value}}if(k.length>0){p[k]=r(l)}return p};f=function(u,e){var k={},l,p,h1,i1,j1,k1;if(e.hasChildNodes()){l=x.selectNodes(u,"./d:String",e);if(l.length>0){p=x.nextNode(l,0);k["String"]=x.getNodeText(p)}else{h1=x.selectNodes(u,"./d:Path",e);if(h1.length>0){i1=x.nextNode(h1,0);k["Path"]=x.getNodeText(i1)}else{j1=x.selectNodes(u,"./d:Apply",e);if(j1.length>0){k1=x.nextNode(j1,0);k["Apply"]=o(u,k1)}}}}return k};h=function(u,e,k){var p={},l,h1,J,i1,j1,k1,l1,m1,n1={},N,O,X,o1,p1;if(e.hasChildNodes()){l=x.selectNodes(u,"./d:Record | ./d:Collection/d:Record | ./d:Collection/d:If/d:Record",e);if(l.length){h1=0;for(J=0;J<l.length;J+=1){i1=x.nextNode(l,J);j1=n(u,i1,k);if(i1.getAttribute("Type")){j1["RecordType"]=r(i1.getAttribute("Type"))}if(h1===0){if(i1.nextElementSibling||(i1.parentNode.nodeName==="Collection")||(i1.parentNode.nodeName==="If")){p=[];p.push(j1)}else{p=j1}}else{p.push(j1)}h1+=1}}else{k1=x.selectNodes(u,"./d:UrlRef",e);if(k1.length>0){for(J=0;J<k1.length;J+=1){l1=x.nextNode(k1,J);p["UrlRef"]=f(u,l1)}}else{k1=x.selectNodes(u,"./d:Url",e);if(k1.length>0){for(J=0;J<k1.length;J+=1){l1=x.nextNode(k1,J);p["Url"]=f(u,l1)}}else{p1=x.selectNodes(u,"./d:Collection/d:AnnotationPath | ./d:Collection/d:PropertyPath",e);if(p1.length>0){p=[];for(J=0;J<p1.length;J+=1){m1=x.nextNode(p1,J);n1={};n1[m1.nodeName]=x.getNodeText(m1);p.push(n1)}}else{p=d(e);N=x.selectNodes(u,"./d:Annotation",e);O={};for(X=0;X<N.length;X+=1){O=x.nextNode(N,X);if(O.hasChildNodes()===false){o1=r(O.getAttribute("Term"));p[o1]=d(O)}}}}}}}else{p=d(e)}return p};n=function(u,e,k){var p={},O={},N,X,l,h1,J,i1,j1,k1,l1,m1;N=x.selectNodes(u,"./d:Annotation",e);for(X=0;X<N.length;X+=1){O=x.nextNode(N,X);if(O.hasChildNodes()===false){l=r(O.getAttribute("Term"));p[l]=d(O)}}h1=x.selectNodes(u,"./d:PropertyValue",e);if(h1.length>0){for(J=0;J<h1.length;J+=1){i1=x.nextNode(h1,J);j1=i1.getAttribute("Property");p[j1]=h(u,i1,k);k1=x.selectNodes(u,"./d:Apply",i1);l1=null;for(m1=0;m1<k1.length;m1+=1){l1=x.nextNode(k1,m1);if(l1){p[j1]={};p[j1]['Apply']=o(u,l1)}}}}else{p=h(u,e,k)}return p};o=function(u,e){var k={},p,l=null,h1=[],i;p=x.selectNodes(u,"./d:*",e);for(i=0;i<p.length;i+=1){l=x.nextNode(p,i);switch(l.nodeName){case"Apply":h1.push({"Type":"Apply","Value":o(u,l)});break;case"LabeledElement":h1.push({"Name":l.getAttribute("Name"),"Value":f(u,l)});break;default:h1.push({"Type":l.nodeName,"Value":x.getNodeText(l)});break}}k['Name']=e.getAttribute('Function');k['Parameters']=h1;return k};q=function(e,p,l){var h1,i,i1,j1,j,k;for(i=m.dataServices.schema.length-1;i>=0;i-=1){h1=m.dataServices.schema[i];if(h1.entityType){i1=h1.namespace+".";j1=h1.entityType;for(k=j1.length-1;k>=0;k-=1){if(i1+j1[k].name===e&&j1[k].navigationProperty){for(j=0;j<j1[k].navigationProperty.length;j+=1){if(j1[k].navigationProperty[j].name===p){return true}}}}}}return false};r=function(e){for(A in y){if(y.hasOwnProperty(A)){if(e.indexOf(A+".")>=0){e=e.replace(A+".",y[A]+".");return e}}}return e};if(this.initialized[a]){return this.initialized[a]}u=g(a);u=x.setNameSpace(u);v=x.selectNodes(u,"//d:Schema",u);for(i=0;i<v.length;i+=1){w=x.nextNode(v,i);S.Alias=w.getAttribute("Alias");S.Namespace=w.getAttribute("Namespace")}C=x.selectNodes(u,"//edmx:Reference",u);for(i=0;i<C.length;i+=1){D=x.nextNode(C,i);E=x.selectNodes(u,"./edmx:Include",D);if(E&&E.length>0){F=x.nextNode(E,0);if(F.getAttribute("Alias")){y[F.getAttribute("Alias")]=F.getAttribute("Namespace")}else{y[F.getAttribute("Namespace")]=F.getAttribute("Namespace")}}G=x.selectNodes(u,"./edmx:IncludeAnnotations",D);if(G.length>0){for(j=0;j<G.length;j+=1){H=x.nextNode(G,j);if(H.getAttribute("TargetNamespace")){B=H.getAttribute("TargetNamespace");if(!z[B]){z[B]={}}z[B][H.getAttribute("TermNamespace")]=D.getAttribute("Uri")}else{z[H.getAttribute("TermNamespace")]=D.getAttribute("Uri")}}}}if(z){t.annotationReferences=z}t.aliasDefinitions=y;I=x.selectNodes(u,"//d:Term",u);if(I.length>0){T={};for(J=0;J<I.length;J+=1){K=x.nextNode(I,J);L=r(K.getAttribute("Type"));T["@"+S.Alias+"."+K.getAttribute("Name")]=L}t.termDefinitions=T}M=b(m);if(M.extensions){t.propertyExtensions=M.extensions}N=x.selectNodes(u,"//d:Annotations ",u);for(J=0;J<N.length;J+=1){O=x.nextNode(N,J);if(O.hasChildNodes()===false){continue}P=O.getAttribute("Target");Q=P.split(".")[0];if(Q&&y[Q]){P=P.replace(new RegExp(Q,""),y[Q])}R=P;U=null;if(P.indexOf("/")>0){R=P.split("/")[0];U=P.replace(R+"/","")}if(!t[R]){t[R]={}}if(U){if(!t.propertyAnnotations){t.propertyAnnotations={}}if(!t.propertyAnnotations[R]){t.propertyAnnotations[R]={}}t.propertyAnnotations[R][U]={};V=x.selectNodes(u,"./d:Annotation",O);for(X=0;X<V.length;X+=1){W=x.nextNode(V,X);if(W.hasChildNodes()===false){Y=r(W.getAttribute("Term"));t.propertyAnnotations[R][U][Y]=d(W)}}}else{$=R.replace(y[Q],Q);V=x.selectNodes(u,"./d:Annotation",O);for(Z=0;Z<V.length;Z+=1){W=x.nextNode(V,Z);_=W.getAttribute("Qualifier");a1=r(W.getAttribute("Term"));if(_){a1+="#"+_}b1=h(u,W,$);b1=s(b1,M.types,R,S);t[R][a1]=b1}c1=x.selectNodes(u,"//d:Annotations[contains(@Target, '"+$+"')]//d:PropertyValue[contains(@Path, '/')]//@Path",u);for(i=0;i<c1.length;i+=1){d1=x.nextNode(c1,i);e1=d1.value;if(t.propertyAnnotations){if(t.propertyAnnotations[R]){if(t.propertyAnnotations[R][e1]){continue}}}f1=e1.split('/');if(q(R,f1[0],m)){if(!t.expand){t.expand={}}if(!t.expand[R]){t.expand[R]={}}t.expand[R][f1[0]]=f1[0]}}g1=x.selectNodes(u,"//d:Annotations[contains(@Target, '"+$+"')]//d:Path[contains(., '/')]",u);for(i=0;i<g1.length;i+=1){d1=x.nextNode(g1,i);e1=x.getNodeText(d1);if(t.propertyAnnotations[R]){if(t.propertyAnnotations[R][e1]){continue}}if(!t.expand){t.expand={}}if(!t.expand[R]){t.expand[R]={}}f1=e1.split('/');if(q(R,f1[0],m)){if(!t.expand){t.expand={}}if(!t.expand[R]){t.expand[R]={}}t.expand[R][f1[0]]=f1[0]}}}this.initialized[a]=t}return t}}());
