// Copyright (c) 2013 SAP AG, All Rights Reserved
(function(){"use strict";sap.ui.controller("sap.ushell.renderers.fiori2.launchpad.catalog.Catalog",{onInit:function(){sap.ui.getCore().getEventBus().subscribe("showCatalogEvent",this.onShow,this);sap.ui.getCore().byId("catalogSelect").addEventDelegate({onBeforeRendering:this.onBeforeSelectRendering},this)},onExit:function(){sap.ui.getCore().getEventBus().unsubscribe("showCatalogEvent",this.onShow);this.getView().aDanglingControls.forEach(function(c){c.destroy()})},onAfterRendering:function(){var m=sap.ui.getCore().byId("navContainer").getModel(),t=this;if(!m.getProperty('/catalogs').length){m.setProperty('/catalogs',[{title:sap.ushell.resources.i18n.getText('catalogsLoading'),"static":true,tiles:[],numIntentSupportedTiles:-1}])}sap.ui.getCore().byId("catalogSelect").setSelectedItemId();if(!this.PagingManager){this.lastCatalogId=0;jQuery.sap.require("sap.ushell.renderers.fiori2.launchpad.PagingManager");this.PagingManager=new sap.ushell.renderers.fiori2.launchpad.PagingManager('catalogPaging',{elementClassName:'sapUshellTile',containerHeight:window.innerHeight,containerWidth:window.innerWidth})}if(this.PagingManager.currentPageIndex===0){t.allocateNextPage()}if(sap.ui.Device.system.desktop){jQuery("#catalogTilesPage-cont").scroll(function(e){var p=sap.ui.getCore().byId('catalogTilesPage'),s=p.getScrollDelegate(),c=s.getScrollTop(),a=s.getMaxScrollTop();if(a-c<=30+t.PagingManager.getTileHeight()){t.allocateNextPage()}})}else{setTimeout(function(){var t=this;this.oCatalogTilesPage=sap.ui.getCore().byId("catalogTilesPage");this.oScroller=this.oCatalogTilesPage.getScrollDelegate();if(this.oScroller&&this.oScroller._scroller){if(!this.oOriginalScrollMove){this.oOriginalScrollMove=this.oScroller._scroller.options.onScrollMove}this.oScroller._scroller.options.onScrollMove=function(e){t.oOriginalScrollMove.apply(t.oScroller);var c=t.oScroller.getScrollTop(),a=t.oScroller.getMaxScrollTop();if(a-c<=30+t.PagingManager.getTileHeight()){t.allocateNextPage()}}}else{jQuery("#catalogTilesPage-cont").scroll(function(e){var p=sap.ui.getCore().byId('catalogTilesPage'),s=p.getScrollDelegate(),c=s.getScrollTop(),a=s.getMaxScrollTop();if(a-c<=30+t.PagingManager.getTileHeight()){t.allocateNextPage()}})}}.bind(this),1500)}},onShow:function(c,e,d){var l=sap.ui.getCore().byId('loadingDialog');l.close();var m=sap.ui.getCore().byId("navContainer").getModel(),C=m.getProperty("/catalogTiles")||[],D=d.params,p=(D&&D.targetGroup&&D.targetGroup.length&&D.targetGroup[0])||"/groups/0",i;d.groupContext=m.getContext(p);$.extend(this.getView().getViewData(),d);if(this.PagingManager){this.resetPageFilter()}this.categoryFilter=(D&&D.catalogSelector&&D.catalogSelector.length&&D.catalogSelector[0])||null;this.searchFilter=(D&&D.tileFilter&&D.tileFilter.length&&D.tileFilter[0])||"";m.setProperty("/showCatalogHeaders",true);m.setProperty("/catalogSearchFilter",this.searchFilter);for(i=0;i<C.length;i=i+1){C[i].active=false}if(this.categoryFilter||this.searchFilter){sap.ui.getCore().byId("catalogSelect").rerender()}else{sap.ui.getCore().byId("catalogSelect").setSelectedItemId("")}this.oRenderingFilter=new sap.ui.model.Filter('','EQ','a');this.oRenderingFilter.fnTest=function(v){if(v.catalogIndex<this.lastCatalogId){return true}if(this.allocateTiles>0){this.lastCatalogId=v.catalogIndex;this.allocateTiles--;return true}return false}.bind(this);if(this.PagingManager){this.applyTileFilters()}},resetPageFilter:function(){this.lastCatalogId=0;this.allocateTiles=this.PagingManager.getNumberOfAllocatedElements()},allocateNextPage:function(){this.PagingManager.moveToNextPage();this.allocateTiles=this.PagingManager._calcElementsPerPage();this.applyTileFilters()},onBeforeSelectRendering:function(){var s=sap.ui.getCore().byId("catalogSelect"),i=jQuery.grep(s.getItems(),jQuery.proxy(function(I){return I.getBindingContext().getObject().id===this.categoryFilter},this));if(!i.length){i.push(s.getItemAt(0))}if(i[0]&&s.getSelectedItemId()!==i[0].getId()){window.setTimeout($.proxy(s.setSelectedItem,s,i[0].getId()),500)}},setCategoryFilter:function(f){sap.ushell.renderers.fiori2.Navigation.openCatalogByHash({groupContext:this.getView().getViewData().groupContext,categoryFilter:f,searchFilter:this.searchFilter},false)},setSearchFilter:function(f){sap.ushell.renderers.fiori2.Navigation.openCatalogByHash({groupContext:this.getView().getViewData().groupContext,categoryFilter:this.categoryFilter,searchFilter:f},false)},applyTileFilters:function(){var f=[],s,c;if(this.searchFilter){s=new sap.ui.model.Filter($.map(this.searchFilter.split(/[\s,]+/),function(v){return(v&&new sap.ui.model.Filter("keywords",sap.ui.model.FilterOperator.Contains,v))||(v&&new sap.ui.model.Filter("title",sap.ui.model.FilterOperator.Contains,v))||undefined}),true);f.push(s)}if(this.categoryFilter){c=new sap.ui.model.Filter("catalogId",sap.ui.model.FilterOperator.EQ,this.categoryFilter);f.push(c)}f.push(new sap.ui.model.Filter("isTileIntentSupported",sap.ui.model.FilterOperator.EQ,true));if(this.oRenderingFilter){f.push(this.oRenderingFilter)}sap.ui.getCore().byId("catalogTiles").getBinding("tiles").filter(f)},onLiveFilter:function(e){var q=e.getParameter("newValue");if(q){this.setSearchFilter(q)}else{this.setSearchFilter()}},onCategoryFilter:function(e){var s=e.getParameter("selectedItem"),S=s.getBindingContext(),m=S.getModel();if(m.getProperty("static",S)){m.setProperty("/showCatalogHeaders",true);this.setCategoryFilter();this.selectedCategory=undefined}else{m.setProperty("/showCatalogHeaders",false);this.setCategoryFilter(s.getBindingContext().getObject().id);this.selectedCategory=s.getId()}},onTileAfterRendering:function(e){var f=e.getSource().getFootItems()[0];if(f!==undefined){if(f.getIcon()=="sap-icon://add"){f.addStyleClass("sapUshellCatalogPlusIcon")}else{f.addStyleClass("sapUshellCatalogVIcon")}}},onTileFooterClick:function(E){var s=E.getSource(),S=s.getBindingContext(),t=this,o,O,c,h,p,a,b=E.oSource,d=b.getDomRef(),n,f=this.createPopoverData(E),g=192,i=sap.ui.getCore().byId("mainShell"),j=i.oDashboardManager,l=new sap.m.List({mode:sap.m.ListMode.MultiSelect}),L=new sap.m.DisplayListItem({label:"{title}",selected:"{selected}",tooltip:"{title}"});var k=null;if(this.getView().getModel().getProperty('/enableHideGroups')){k=[new sap.ui.model.Filter("isGroupVisible",sap.ui.model.FilterOperator.EQ,true)]}l.bindItems("/",L,null,k);o=new sap.ui.model.json.JSONModel(f.userGroupList);l.setModel(o);l.addEventDelegate({onsapup:function(E){try{E.preventDefault();if(sap.ui.getCore().byId('shell').getModel().getData().groups.length){var u=jQuery(":focus");if(u.index()==0){var v=jQuery("#newGroupItem");v.focus();E._bIsStopHandlers=true}}}catch(e){}}});n=new sap.m.Input({id:"newGroupNameInput",type:"Text",placeholder:sap.ushell.resources.i18n.getText("newGroupPlaceholder")});var B=new sap.m.Button({icon:sap.ui.core.IconPool.getIconURI("nav-back"),press:function(E){p.removeAllContent();if(!sap.ui.Device.system.phone){p.setContentHeight(g+"px")}else{p.setContentHeight("100%")}p.setVerticalScrolling(true);p.addContent(r);p.setTitle(sap.ushell.resources.i18n.getText("addTileToGroups_popoverTitle"));p.setCustomHeader();n.enabled=false;n.setValue('')},tooltip:sap.ushell.resources.i18n.getText("newGroupGoBackBtn_tooltip")});B.addStyleClass("catalogNewGroupBackButton");var N=new sap.m.Label({text:sap.ushell.resources.i18n.getText("newGroup_popoverTitle")}),H=new sap.m.Bar({contentLeft:[B],contentMiddle:[N]}),m=new sap.m.StandardListItem({id:"newGroupItem",title:sap.ushell.resources.i18n.getText("newGroup_listItemText"),type:"Navigation",press:function(){t._navigateToCreateNewGroupPanel(p,n,H)}}),q=new sap.m.List({});q.addItem(m);q.addEventDelegate({onsapdown:function(E){try{E.preventDefault();E._bIsStopHandlers=true;if(sap.ui.getCore().byId('shell').getModel().getData().groups.length){var u=jQuery("#popoverContainer .sapMListModeMultiSelect li").first();u.focus()}}catch(e){}},onsaptabnext:function(E){try{E.preventDefault();E._bIsStopHandlers=true;var u=jQuery("#okButton");u.focus()}catch(e){}}});var r=this._setPopoverContainer(q,l,g);if(document.body.clientHeight-d.getBoundingClientRect().bottom>=310){a="Bottom"}else{a="Auto"}p=new sap.m.ResponsivePopover({id:"groupsPopover",placement:a,content:[r],enableScrolling:true,title:sap.ushell.resources.i18n.getText("addTileToGroups_popoverTitle"),contentWidth:'20rem',afterClose:function(){p.destroy();n.destroy();m.destroy();O.destroy();c.destroy();r.destroy()}});if(!sap.ui.Device.system.phone){p.setContentHeight(g+"px")}else{p.setContentHeight("100%")}O=this.createOkButton(S,o,f,t,p,n,H);O.addEventDelegate({onsaptabprevious:function(E){try{E.preventDefault();E._bIsStopHandlers=true;var u=jQuery("#newGroupItem");if(!u.length){u=jQuery("#newGroupNameInput input")}u.focus()}catch(e){}}});c=new sap.m.Button({id:"cancelButton",press:function(E){E.preventDefault();E._bIsStopHandlers=true;p.close()},text:sap.ushell.resources.i18n.getText("cancelBtn")});p.setBeginButton(O);p.setEndButton(c);p.setInitialFocus('newGroupItem');p.openBy(b)},_navigateToCreateNewGroupPanel:function(p,n,h){p.removeAllContent();p.addContent(n.addStyleClass("catalogNewGroupInput"));p.setCustomHeader(h);p.setContentHeight("");n.setValueState(sap.ui.core.ValueState.None);n.setPlaceholder(sap.ushell.resources.i18n.getText("newGroupPlaceholder"));n.enabled=true;n.focus()},createOkButton:function(s,o,p,g,P,n,h){var O=new sap.m.Button({id:"okButton",press:function(e){e.preventDefault();e._bIsStopHandlers=true;var a=[],d=[],b={},c=sap.ushell.Container.getService("LaunchPage"),f,i,t,j,r,k=0,l=0,m,q,u=s.getModel().getProperty(s.getPath()).id,E=sap.ui.getCore().getEventBus(),v,w=n.getValue().trim(),x=sap.ushell.resources.i18n.getText("newGroup_listItemText"),y=[],z=this;for(i=0;i<p.userGroupList.length;i=i+1){t=this.oData[i];r=c.getGroupId(t.object);b[r]=t.title;if(t.selected){a.push(r);j=new sap.ui.model.Context(s.getModel(),"/groups/"+i);if(!o.oData[i].initiallySelected){y.push(g._addTile(s,j));o.oData[i].initiallySelected=true;k=k+1;if(k==1){m=t.title}}}else if((!t.selected)&&(o.oData[i].initiallySelected)){y.push(g._removeTile(u,i));o.oData[i].initiallySelected=false;l=l+1;if(l==1){q=t.title}}}if(n.enabled){if(w.length>0){v=w}else{v=x}y.push(g._createGroupAndSaveTile(s,v));k++;m=v}jQuery.when.apply(jQuery,y).then(function(){if(!(k==0&&l==0)){var A=false,B=false,C=[];for(i=0;i<arguments.length&&(!A||!B);i++){if(arguments[i].action=="addTileToNewGroup"&&arguments[i].status==1){var t=z.oData[z.oData.length-1],c=sap.ushell.Container.getService("LaunchPage"),r=c.getGroupId(t.object);a.push(r);B=true}if(!arguments[i].status){A=true;C.push(arguments[i])}}if(A){var D=sap.ui.getCore().byId("mainShell"),F=g.prepareErrorMessage(C,p.tileTitle),G=D.oDashboardManager;G._resetGroupsOnFailure(F.messageId,F.parameters)}else{s.getModel().setProperty("/catalogTiles/"+p.tileIndex+"/associatedGroups",a);f=g.prepareDetailedMessage(p.tileTitle,k,l,m,q);sap.m.MessageToast.show(f,{duration:3000,width:"15em",my:"center bottom",at:"center bottom",of:window,offset:"0 -50",collision:"fit fit"})}}});P.close()}.bind(o),text:sap.ushell.resources.i18n.getText("okBtn")});return O},prepareErrorMessage:function(e,t){var g,a,f,F,n=0,N=0,c=false,m;for(var i in e){g=e[i].group;a=e[i].action;if(a=='add'){n++;if(n==1){f=g.title}}else if(a=='remove'){N++;if(N==1){F=g.title}}else if(a=='addTileToNewGroup'){n++;if(n==1){f=g.title}}else{c=true}}if(c){if(e.length==1){m=sap.ushell.resources.i18n.getText({messageId:"fail_tile_operation_create_new_group"})}else{m=sap.ushell.resources.i18n.getText({messageId:"fail_tile_operation_some_actions"})}}else if(e.length==1){if(n){m=sap.ushell.resources.i18n.getText({messageId:"fail_tile_operation_add_to_group",parameters:[t,f]})}else{m=sap.ushell.resources.i18n.getText({messageId:"fail_tile_operation_remove_from_group",parameters:[t,F]})}}else{if(N==0){m=sap.ushell.resources.i18n.getText({messageId:"fail_tile_operation_add_to_several_groups",parameters:[t]})}else if(n==0){m=sap.ushell.resources.i18n.getText({messageId:"fail_tile_operation_remove_from_several_groups",parameters:[t]})}else{m=sap.ushell.resources.i18n.getText({messageId:"fail_tile_operation_some_actions"})}}return m},prepareDetailedMessage:function(t,n,a,f,b){var m;if(n==0){if(a==1){m=sap.ushell.resources.i18n.getText("tileRemovedFromSingleGroup",[t,b])}else if(a>1){m=sap.ushell.resources.i18n.getText("tileRemovedFromSeveralGroups",[t,a])}}else if(n==1){if(a==0){m=sap.ushell.resources.i18n.getText("tileAddedToSingleGroup",[t,f])}else if(a==1){m=sap.ushell.resources.i18n.getText("tileAddedToSingleGroupAndRemovedFromSingleGroup",[t,f,b])}else if(a>1){m=sap.ushell.resources.i18n.getText("tileAddedToSingleGroupAndRemovedFromSeveralGroups",[t,f,a])}}else if(n>1){if(a==0){m=sap.ushell.resources.i18n.getText("tileAddedToSeveralGroups",[t,n])}else if(a==1){m=sap.ushell.resources.i18n.getText("tileAddedToSeveralGroupsAndRemovedFromSingleGroup",[t,n,b])}else if(a>1){m=sap.ushell.resources.i18n.getText("tileAddedToSeveralGroupsAndRemovedFromSeveralGroups",[t,n,a])}}return m},createPopoverData:function(e){var s=e.getSource(),S=s.getBindingContext(),a=sap.ushell.Container.getService("LaunchPage"),i,m,p,t,r,u=S.getModel().getProperty("/groups"),c=this.getCatalogTileDataFromModel(S),b=c.tileData.associatedGroups,d=c.tileIndex;for(i=0;i<u.length;i=i+1){r=a.getGroupId(u[i].object);u[i].selected=!($.inArray(r,b)==-1);u[i].initiallySelected=u[i].selected}p=S.getPath(0);m=S.getModel();t=m.getProperty(p).title;return{userGroupList:u,catalogTile:c,tileTitle:t,tileIndex:d}},getCatalogTileDataFromModel:function(s){var t=s.sPath,a=t.split("/"),b=a[a.length-1];return{tileData:s.getModel().getProperty("/catalogTiles/"+b),tileIndex:b}},onAddTile:function(e){var s=e.getParameter("control").getBindingContext();if(!s.getProperty("active")){this._addTile(s,e.getSource().getBindingContext())}},onNavButtonPress:function(e){var n=sap.ui.getCore().byId("navContainer");if(location.hash===''||location.hash==='#'){n.to("dashboardPage")}else{location.hash=''}},_addTile:function(t,g){var s=sap.ui.getCore().byId("mainShell"),d=s.oDashboardManager,a=jQuery.Deferred(),p=d._createTile({catalogTileContext:t,groupContext:g});p.done(function(b){a.resolve(b)});return a},_removeTile:function(t,i){var s=sap.ui.getCore().byId("mainShell"),d=s.oDashboardManager,a=jQuery.Deferred(),p=d._deleteCatalogTileFromGroup({tileId:t,groupIndex:i});p.done(function(b){a.resolve(b)});return a},_createGroupAndSaveTile:function(t,n){var s=sap.ui.getCore().byId("mainShell"),d=s.oDashboardManager,a=jQuery.Deferred(),p=d._createGroupAndSaveTile({catalogTileContext:t,newGroupName:n});p.done(function(b){a.resolve(b)});return a},_setPopoverContainer:function(n,l,p){var a="popoverContainer",b=new sap.m.ScrollContainer({id:a,horizontal:false,vertical:true});if(!sap.ui.Device.system.phone){b.setHeight((p-2)+"px")}else{b.setHeight("100%")}b.addContent(n);b.addContent(l);return b}})}());
