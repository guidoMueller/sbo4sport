// Copyright (c) 2013 SAP AG, All Rights Reserved
(function(){"use strict";sap.ui.controller("sap.ushell.renderers.fiori2.launchpad.group_list.GroupList",{onInit:function(){this.sViewId="#"+this.getView().getId();this.sGroupListId="#"+this.getView().oGroupList.getId();jQuery(".sapUshellGroupList").data("dropGroup",null);this.iOutEventCounter=0;this.iOverEventCounter=0;this.iOutEventFlag=false;this.oDashboard=document.getElementById('dashboard');this.handleMobileScroll=this._fHandleMobileScroll.bind(this)},onAfterRendering:function(){this.jqView=jQuery(this.sViewId);this.jgGroupList=jQuery(this.sGroupListId);var e=sap.ui.getCore().getEventBus();e.unsubscribe("grouplist","ScrollAnimationEnd",this._handleScrollAnimationEnd,this);e.subscribe("grouplist","ScrollAnimationEnd",this._handleScrollAnimationEnd,this);jQuery("#__area1").appendTo("#shellPage");if(sap.ui.Device.browser.internet_explorer){this._bindResizeHandler()}var d=jQuery("#dashboardPage-cont"),t=this;if(sap.ui.Device.system.desktop){var a;d.unbind('scroll');d.scroll(function(){clearTimeout(a);a=setTimeout(function(){var n=jQuery("#dashboardPage-cont").scrollTop();t._fHandleScroll(n)},300)})}else{this.oDashboard.addEventListener('scroll',t.handleMobileScroll)}},onGroupTitleChange:function(e){this._publishAsync("launchpad","changeGroupTitle",{groupId:e.getSource().getGroupId(),newTitle:e.getParameter("newTitle")});e.getSource().addStyleClass('sapUshellOver')},makeSortable:function(){this.jgGroupList=jQuery(this.sGroupListId);this._sortable()},_getJqAllListItems:function(){this.jqView=jQuery(this.sViewId);return this.jqView.find(".sapUshellGroupListItem")},_getJqGroupListItems:function(){this.jgGroupList=jQuery(this.sGroupListId);return this.jgGroupList.find(".sapUshellGroupListItem")},_getGroupTopOffset:function(g){var G=0,d=sap.ui.getCore().byId("groupListPage");G+=g.parent().parent().position().top;G+=g.position().top;G-=g.parent().parent().parent().position().top;return G},_sortable:function(){var t=this,j=jQuery("#shell-container");t.bActive=false;this.jgGroupList.find(".sapMListUl").sortable({containment:j,items:'>:not(.sapUshellDefaultGroupItem)',placeholder:"sapUshellGroupLI-placeholder",helper:function(e,a){var c=a.clone(),b=jQuery(".sapUshellGroupListItem");c.addClass("sapUshellSortableHelperClone");c.addClass("sapUshellClonedGrouplistItem");c.removeClass("li");c.css("font-size",a.css("font-size"));c.css("width",b.first().parent().width());c.css("height",b.first().height()+parseInt(b.first().css("border-bottom-width")));c.hide();window.setTimeout(function(){c.appendTo('body');c.show()},1);return c},revert:jQuery.proxy(this._handleSortableRevert,this),start:jQuery.proxy(this._handleSortableStart,this),stop:jQuery.proxy(this._handleSortableStop,this),change:jQuery.proxy(this._handleSortableChange,this)});if(!sap.ui.Device.system.desktop){this.jgGroupList.find(".sapMListUl").sortable('disable')}},_bindGroupListItemEvents:function(e){var g=e.getSource();if(!sap.ui.Device.system.tablet){return}var t=this;jQuery.sap.byId(g.sId).bind("mousedown",function(a){var _=jQuery(this);if(t.bActive===false&&!_.hasClass("sapUshellDefaultGroupItem")){var b=a;jQuery(".sapUshellGroupItemList").find(".ui-sortable").sortable('disable');clearTimeout(this.fdownTimer);this.fdownTimer=setTimeout(function(){t.bActive=true;jQuery(_).effect("shake",{times:1,distance:5,complete:function(){if(!t.bActive){return}jQuery(".sapUshellGroupItemList").find(".ui-sortable").sortable('enable');var G=sap.ui.getCore().byId("groupListPage"),s=G.getScrollDelegate();if(s&&s._scroller){s._scroller.disable()}_.trigger(b)}},50)},150)}});jQuery.sap.byId(g.sId).bind("mouseup",function(a){clearTimeout(this.fdownTimer);t.bActive=false;if(!sap.ui.Device.system.desktop){var G=sap.ui.getCore().byId("groupListPage"),s=G.getScrollDelegate();if(s&&s._scroller){if(!s._scroller.enabled){s._scroller.enable();s._scroller.scrollTo(s._scroller.absStartX,s._scroller.absStartY)}}}});jQuery.sap.byId(g.sId).bind("mousemove",function(a){clearTimeout(this.fdownTimer);t.bActive=false})},_handleSortableRevert:function(e,u){return 250},_handleSortableStart:function(e,u){var U=this.getView().oGroupList;var a=U.getItems();var t=this;this.sortableInfo={jqGroupPage:jQuery(this.getView().getDomRef()),jqGroupList:jQuery(U.getDomRef())};this.sortableInfo.jqCloneArea=this.sortableInfo.jqGroupPage.find(".sapUshellCloneArea");if(!this.sortableInfo.jqCloneArea.length){this.sortableInfo.jqCloneArea=jQuery("<div id='cloneArea' class='sapUshellCloneArea'></div>").appendTo(this.sortableInfo.jqGroupList)}this.sortableInfo.jqGroupListItems=[];for(var i=0,l=a.length;i<l;i++){var b=a[i].getDomRef();if(b.id==u.item.id)continue;this.sortableInfo.jqGroupListItems.push(jQuery(b))}this.sortableInfo.jqFirstItem=this.sortableInfo.jqGroupListItems[0];this.sortableInfo.fontSize=this.sortableInfo.jqFirstItem.css("font-size");this.sortableInfo.width=this.sortableInfo.jqFirstItem.parent().width();this.sortableInfo.height=this.sortableInfo.jqFirstItem.height()+parseInt(this.sortableInfo.jqFirstItem.css("border-bottom-width"));sap.ui.getCore().getEventBus().publish("launchpad","sortableStart");this.sortableInfo.cloneGroupsArr=[];for(var i=0,l=this.sortableInfo.jqGroupListItems.length;i<l;i++){var j=this.sortableInfo.jqGroupListItems[i];var c=j.clone();var g=t._getGroupTopOffset(j);c.addClass("sapUshellClonedGrouplistItem");j.data("clone",c);c.css("top",g+"px");c.css({"font-size":this.sortableInfo.fontSize,"width":this.sortableInfo.width,"height":this.sortableInfo.height});t.sortableInfo.jqCloneArea.append(c);j.css("visibility","hidden");this.sortableInfo.cloneGroupsArr.push(c)}u.item.startPos=u.item.index();this.oView.oGrouplistDeleteArea.show()},_updateGroupSelection:function(){var m=this.getView().getModel();if(!m||!m.getProperty("/currentState/showPane")){return}if(jQuery(".ui-sortable-helper").length>0){return}if(sap.ui.Device.system.desktop){var n=jQuery("#dashboardPage-cont").scrollTop()}else{var n=this.oDashboard.scrollTop}this._fHandleScroll(n)},_fHandleMobileScroll:function(){var n=this.oDashboard.scrollTop;this._fHandleScroll(n)},_fHandleScroll:function(n){var j=jQuery('#dashboardGroups').find('.sapUshellTileContainer'),o=jQuery('#dashboardGroups').offset(),f=o&&o.top||0,e=o&&o.top,a=1200,c=[],m=this.getView().getModel();if(!j||!o){return}j.each(function(){var b=jQuery(this).parent().offset().top;c.push([b,b+jQuery(this).parent().height()])});if(!m.getProperty("/groupList-skipScrollToGroup")){var w=n+f;jQuery.each(c,function(i,b){if(b[0]<=w&&w<=b[1]){jQuery('#groupList .sapUshellDefaultGroupItem, #groupList .sapUshellGroupListItem').removeClass('sapUshellOver').eq(i).addClass('sapUshellOver')}})}sap.ushell.utils.handleTilesVisibility()},_handleSortableStop:function(e,u){for(var i=0,l=this.sortableInfo.cloneGroupsArr.length;i<l;i++){this.sortableInfo.cloneGroupsArr[i].remove()}this.oView.oGrouplistDeleteArea.hide();var g=sap.ui.getCore().byId(u.item[0].id),t=u.item.index();if(g){if(!g.bDeletionFlag){this._handleGroupMove(e,u)}else{g.bDeletionFlag=false}}for(var i=0,l=this.sortableInfo.jqGroupListItems.length;i<l;i++){this.sortableInfo.jqGroupListItems[i].css("visibility","")}this.jgGroupList.find(".sapMListUl").sortable('cancel');if(!sap.ui.Device.system.desktop){this.bActive=false;this.jgGroupList.find(".sapMListUl").sortable('disable')}if(e.scrollToGroup===undefined||e.scrollToGroup==true){window.setTimeout(jQuery.proxy(function(){this._handleScrollToGroup(this.oView.oGroupList.getItems()[t],true)},this),500)}delete this.sortableInfo;sap.ui.getCore().getEventBus().publish("launchpad","sortableStop")},_handleDrop:function(e,u){var j=jQuery(u);this.oView.oGrouplistDeleteArea.hide();var g=sap.ui.getCore().byId(j.attr("id")),G=g.getParent(),w,r,d=jQuery(".sapUshellDeleteArea_grouplist_functional"),E=sap.ui.getCore().getEventBus(),n=j.index();if(g){if(d.data("groupOver")===true){r=g.getRemovable();E.publish("launchpad",r?"deleteGroup":"resetGroup",{groupId:g.getGroupId()});d.data("groupOver",false)}else{j.startPos=parseInt(j.attr('startPos'));G.removeItem(g,true);G.insertItem(g,n,true);this.getView().getModel().setProperty("/groupList-skipScrollToGroup",true);w={item:j};this._handleGroupMove(e,w);setTimeout(function(){g.firePress()},1)}}},_handleSortableChange:function(e,u){for(var i=0,l=this.sortableInfo.jqGroupListItems.length;i<l;i++){var j=this.sortableInfo.jqGroupListItems[i];var c=j.data("clone");var g=this._getGroupTopOffset(j);if(c){c.stop(true,false);c.animate({top:g+"px"},{duration:250},{easing:"swing"})}}},_handleGroupCreate:function(){var f=jQuery(':focus');if(f){f.blur()}this._publishAsync("launchpad","createGroup",{title:sap.ushell.resources.i18n.getText("new_group_name")})},_handleGroupListItemPress:function(e){var s=e.getSource();var f=e.getParameter("action")==="sapenter";this._handleScrollToGroup(s,false,f);this._updateGroupSelection()},_handleScrollToGroup:function(g,a,f){if(!g){return}var t=this;this.oDashboard.removeEventListener('scroll',t.handleMobileScroll);this._publishAsync("launchpad","scrollToGroup",{group:g,groupChanged:a,focus:f})},_handleScrollAnimationEnd:function(){var t=this;this.oDashboard.addEventListener('scroll',t.handleMobileScroll)},_handleGroupMove:function(e,u){var f=u.item.startPos,t=u.item.index();if(f!==t&&t!==-1){this._publishAsync("launchpad","moveGroup",{fromIndex:f,toIndex:t})}},onCategoryFilter:function(e){var b=sap.ui.getCore().getEventBus(),q=e.getParameter("selectedItem").getText();window.setTimeout(jQuery.proxy(b.publish,b,"catalog","categoryFilter",{category:(q!=="All")?q:null}),1)},_publishAsync:function(c,e,d){var b=sap.ui.getCore().getEventBus();window.setTimeout($.proxy(b.publish,b,c,e,d),1)},_handleGroupListItemOver:function(e){if(this.iOutEventCounter===0&&this.iOverEventCounter===0){this._handleGroupListOver(e)}this.iOutEventFlag=true;var E=sap.ui.getCore().getEventBus();E.publish("grouplist","GroupListItemOver",e);this.iOutEventCounter++},_handleGroupListItemOut:function(e){this.iOutEventCounter--;this.iOutEventFlag=false;var t=this;setTimeout(function(){if(t.iOutEventFlag===false){if(t.iOutEventCounter===0&&t.iOverEventCounter===1){t._handleGroupListOut(e)}}},1);var E=sap.ui.getCore().getEventBus();E.publish("grouplist","GroupListItemOut",e)},_handleGroupListItemDrop:function(e){this.iOutEventCounter=0;this.iOverEventCounter=0;this.iOutEventFlag=false;var E=sap.ui.getCore().getEventBus();E.publish("grouplist","GroupListItemDrop",e)},_handleGroupListOver:function(e){this.iOverEventCounter++;var E=sap.ui.getCore().getEventBus();E.publish("grouplist","GroupListOver",e)},_handleGroupListOut:function(e){this.iOverEventCounter=0;var E=sap.ui.getCore().getEventBus();E.publish("grouplist","GroupListOut",e)},_bindResizeHandler:function(){var r=function(e){var j=jQuery("#groupList"),a=jQuery(".sapMSLITitleOnly"),b=jQuery(".sapUshellGroupLI").find(".sapMInput");a.css("width",(j.width()-parseInt(a.css("padding-left"),10))+"px");b.css("width",(j.width()-(2*parseInt(b.css("margin-left"),10)))+"px")};jQuery(window).unbind("resize",r);jQuery(window).bind("resize",r)}})}());
