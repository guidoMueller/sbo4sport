// Copyright (c) 2013 SAP AG, All Rights Reserved
(function(){"use strict";sap.ui.controller("sap.ushell.renderers.fiori2.search.SearchSuggestions",{onInit:function(){},onExit:function(){sap.ui.getCore().getEventBus().unsubscribe("searchSuggest",this.doSuggestion,this);sap.ui.getCore().getEventBus().unsubscribe("search",this.closeSuggestions,this)},removeFocus:function(){sap.ui.getCore().byId("sfOverlay").getFocusDomRef().blur()},closeSuggestions:function(c,e,d){var a=[];for(var i=0;i<this.objSuggestionLimit;++i){a.push({visible:false,type:"suggestion"})}a.push({visible:false,type:"suggestion",isGroupFooter:true});a.push({visible:false,type:"app",isGroupHeader:true,label:sap.ushell.resources.i18n.getText("suggestion_found_apps")});for(i=0;i<this.appSuggestionLimit;++i){a.push({visible:false,type:"app"})}this.getView().getModel("suggestions").setData({items:a,suggestionsVisible:false,visible:false})},dataSourceSelected:function(c,e,d){if(this.getView().getModel("suggestions").getProperty("/visible")){this.doSuggestion(null,null,{searchTerm:this.lastSearchTerm})}},onClickSuggestion:function(e){var s=e.getSource().getBindingContext("suggestions").getObject(),d,S,c=false;if(s.type==="app"){if(s.targetURL){window.location=s.targetURL}}else{if(s.data){S=s.data.labelRaw;d=s.data.dataSource;d.label=d.objectName.label;c=true}else{S=s.labelRaw;d={label:"All",level:0,objectName:{label:"ALL",value:"$$ALL$$"},packageName:{label:"ABAP",value:"ABAP"},schemaName:{label:"",value:""},type:{label:"Category",value:"Category"}}}sap.ui.getCore().getEventBus().publish("externalSearch",{searchTerm:S,dataSource:d,categorySuggested:c})}},doSuggestion:function(c,e,d){var f=new sap.ui.model.Filter("visible",sap.ui.model.FilterOperator.EQ,true),m=this.getView().getModel("suggestions"),a,q;if(d.activeViews&&d.activeViews.indexOf(this.getView().getId())===-1){return}if(d.searchTerm.length===0){this.closeSuggestions();return}m.setProperty("/visible",true);this.lastSearchTerm=d.searchTerm;this.doAppSuggestions(d);if(d.searchTerm.length>=3&&this.objSuggestionsActive()){this.doObjSuggestions(d)}else{this.clearObjSuggestions(m)}},objSuggestionsActive:function(){if(window.searchConfig&&window.searchConfig.objSuggestions!==undefined){return window.searchConfig.objSuggestions}else{return true}},clearObjSuggestions:function(m){var f=new sap.ui.model.Filter("visible",sap.ui.model.FilterOperator.EQ,true);for(var i=0;i<=this.objSuggestionLimit;i=i+1){m.setProperty("/items/"+i+"/visible",false)}this.getView().getContent()[0].getBinding("items").filter([f])},doAppSuggestions:function(d){var f=new sap.ui.model.Filter("visible",sap.ui.model.FilterOperator.EQ,true),m=this.getView().getModel("suggestions"),a;a=sap.ushell.Container.getService("Search").queryApplications(d.searchTerm,jQuery.proxy(function(r){var b=r.getElements();for(var i=0;i<this.appSuggestionLimit;++i){if(i<b.length){var c=b[i];m.setProperty("/items/"+(this.objSuggestionLimit+2+i),{label:c.label,icon:c.icon,targetURL:c.targetURL,app:c,visible:true,type:"app"})}else{m.setProperty("/items/"+(this.objSuggestionLimit+2+i)+"/visible",false)}}if(b.length>0){m.setProperty("/items/"+(this.objSuggestionLimit+1)+"/visible",true)}else{m.setProperty("/items/"+(this.objSuggestionLimit+1)+"/visible",false)}this.getView().getContent()[0].getBinding("items").filter([f])},this),this.appSuggestionLimit)},doObjSuggestions:function(d){var f=new sap.ui.model.Filter("visible",sap.ui.model.FilterOperator.EQ,true),m=this.getView().getModel("suggestions"),s=this;s.query.setSuggestionTerm(d.searchTerm);s.query.dataSource({objectName:"$$ALL$$",packageName:"ABAP",type:"Category"});s.query.getResultSet(jQuery.proxy(function(r){var a=r.getElements(),S=[],i=0;if(a.length>0){S=this.buildSuggestions(a,d);m.setProperty("/suggestionsVisible",true)}else{m.setProperty("/suggestionsVisible",false)}for(i;i<this.objSuggestionLimit;i=i+1){if(S[i]&&i<this.objSuggestionLimit){m.setProperty("/items/"+i,S[i])}else{m.setProperty("/items/"+i+"/visible",false)}}if(S.length>0){m.setProperty("/items/"+(this.objSuggestionLimit),{visible:true,type:"suggestion",isGroupFooter:true})}else{m.setProperty("/items/"+(this.objSuggestionLimit)+"/visible",false)}this.getView().getContent()[0].getBinding("items").filter([f])},this))},buildSuggestions:function(s,d){var r={};var t=d.searchTerm;var a=t.split(" ");var n=[];$.each(a,function(i,c){c=$.trim(c);if(c.length>0){var e=c.split("*");$.each(e,function(i,f){if(f.length>0){f=f.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&");n.push(f)}})}});t=n;var b=/<b>[^<]+<\/b>/igm;jQuery.each(s,function(i,v){if(v.filter.attribute!=="$$AllAttributes$$"){return}if(!r[v.labelRaw]){r[v.labelRaw]=v;r[v.labelRaw].categories=[];r[v.labelRaw].visible=true;r[v.labelRaw].type="suggestion"}var c=r[v.labelRaw].label;if(c.length===0){r[v.labelRaw].label=v.labelRaw;c=r[v.labelRaw].label}while(g=b.exec(c)){var e=g.index;var f=b.lastIndex-4;var S=c.substring(e+3,f);var m=new T(S);for(var i=0;i<t.length;++i){var g={};var h=t[i];var j=new RegExp(h,"ig");if(S!==h){var k=S.match(j);if(k&&k instanceof Array&&k.length>0){m.highlight(h)}}}S=m.render();c=c.substring(0,e)+S+c.substring(f+4)}r[v.labelRaw].label=c;if(v.dataSource.getObjectName().value!=="$$AllDataSources$$"){r[v.labelRaw].categories.push({label:v.dataSource.getObjectName().label,data:v})}});return jQuery.map(r,function(v,k){return[v]})}});var T=function(){this.init.apply(this,arguments)};T.prototype={init:function(t){this.text=t;this.lower=t.toLocaleLowerCase();this.globalBold=false;this.bold=new Array(this.text.length);for(var i=0;i<this.bold.length;++i){this.bold[i]=false}},highlight:function(t){t=t.toLowerCase();var a=-1;while(a<this.lower.length){var a=this.lower.indexOf(t,a);if(a>=0){for(var i=a;i<a+t.length;++i){this.bold[i]=true;this.globalBold=true}a+=t.length}else{break}}},render:function(){if(!this.globalBold){return this.text}var b=false;var r=[];var s=0;for(var i=0;i<this.text.length;++i){if(b&&!this.bold[i]||!b&&this.bold[i]){r.push(this.text.substring(s,i));if(b){r.push("</b>")}else{r.push("<b>")}b=!b;s=i}}r.push(this.text.substring(s,i));if(b){r.push("</b>")}return r.join("")}}}());
