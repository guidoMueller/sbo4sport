// Copyright (c) 2013 SAP AG, All Rights Reserved
(function(){"use strict";jQuery.sap.declare("sap.ushell.renderers.fiori2.launchpad.DashboardManager");jQuery.sap.require("sap.ushell.services.Message");jQuery.sap.require('sap.ui.thirdparty.jqueryui.jquery-ui-core');jQuery.sap.require('sap.ui.thirdparty.jqueryui.jquery-ui-widget');jQuery.sap.require('sap.ui.thirdparty.jqueryui.jquery-ui-mouse');jQuery.sap.require('sap.ui.thirdparty.jqueryui.jquery-ui-sortable');jQuery.sap.require('sap.ui.thirdparty.jqueryui.jquery-ui-draggable');jQuery.sap.require('sap.ui.thirdparty.jqueryui.jquery-ui-droppable');jQuery.sap.require('sap.ui.thirdparty.jqueryui.jquery-ui-effect');jQuery.sap.require('sap.ui.thirdparty.jqueryui.jquery-ui-effect-shake');var g=function(m,p){return p?sap.ushell.resources.i18n.getText(m,p):sap.ushell.resources.i18n.getText(m)};var a=function(c){var C=this.oModel.getProperty('/catalogTiles'),b=C.filter(function(t){return t.catalogId===c.id&&t.isTileIntentSupported===true});return b.length};sap.ui.base.EventProvider.extend("sap.ushell.renderers.fiori2.launchpad.DashboardManager",{metadata:{publicMethods:["getModel","getDashboardView","getGroupListView","loadPersonalizedGroups","attachEvent","detachEvent","attachEventOnce"]},constructor:function(i,s){if(sap.ushell.renderers.fiori2.launchpad.getDashboardManager&&sap.ushell.renderers.fiori2.launchpad.getDashboardManager()){return sap.ushell.renderers.fiori2.launchpad.getDashboardManager()}sap.ushell.renderers.fiori2.launchpad.getDashboardManager=jQuery.sap.getter(this.getInterface());this.oPageBuilderService=sap.ushell.Container.getService("LaunchPage");this.oModel=s.model;this.oConfig=s.config;this.oDashboardView=sap.ui.view('dashboard',{type:sap.ui.core.mvc.ViewType.JS,viewName:"sap.ushell.renderers.fiori2.launchpad.dashboard.DashboardContent",viewData:{config:this.oConfig}});this.oDashboardView.setWidth('');this.oDashboardView.setDisplayBlock(true);this.oSortableDeferred=$.Deferred();this.oSortableDeferred.resolve();this.aRequestQueue=[];this.bRequestRunning=false;this.registerEvents();this.oTileCatalogToGroupsMap={};this.tileViewUpdateQueue=[];this.tileViewUpdateTimeoutID=0},registerEvents:function(){var e=sap.ui.getCore().getEventBus();e.subscribe("launchpad","addBookmarkTile",this._createBookmark,this);e.subscribe("launchpad","loadDashboardGroups",this.loadPersonalizedGroups,this);e.subscribe("launchpad","createGroup",this._createGroup,this);e.subscribe("launchpad","deleteGroup",this._deleteGroup,this);e.subscribe("launchpad","resetGroup",this._resetGroup,this);e.subscribe("launchpad","changeGroupTitle",this._changeGroupTitle,this);e.subscribe("launchpad","moveGroup",this._moveGroup,this);e.subscribe("launchpad","deleteTile",this._deleteTile,this);e.subscribe("launchpad","moveTile",this._moveTile,this);e.subscribe("launchpad","sortableStart",this._sortableStart,this);e.subscribe("launchpad","sortableStop",this._sortableStop,this);e.subscribe("showCatalog",this.loadAllCatalogs,this);this.oDashboardView.addEventDelegate({onBeforeFirstShow:jQuery.proxy(function(b){try{this.loadPersonalizedGroups()}catch(c){console.log("DahsboardManager ; oDashboardView.addEventDelegate failed ; exception: "+c)}},this),onAfterHide:jQuery.proxy(function(b){try{sap.ushell.utils.setTilesNoVisibility()}catch(c){console.log("DahsboardManager ; Call to _sap.ushell.utils.setTilesNoVisibility failed ; exception: "+c)}},this)})},destroy:function(){var e=sap.ui.getCore().getEventBus();e.unsubscribe("launchpad","addBookmarkTile",this._createBookmark,this);e.unsubscribe("launchpad","loadDashboardGroups",this.loadPersonalizedGroups,this);e.unsubscribe("launchpad","createGroup",this._createGroup,this);e.unsubscribe("launchpad","deleteGroup",this._deleteGroup,this);e.unsubscribe("launchpad","resetGroup",this._resetGroup,this);e.unsubscribe("launchpad","changeGroupTitle",this._changeGroupTitle,this);e.unsubscribe("launchpad","moveGroup",this._moveGroup,this);e.unsubscribe("launchpad","deleteTile",this._deleteTile,this);e.unsubscribe("launchpad","moveTile",this._moveTile,this);e.unsubscribe("launchpad","sortableStart",this._sortableStart,this);e.unsubscribe("launchpad","sortableStop",this._sortableStop,this);e.unsubscribe("showCatalog",this.loadAllCatalogs,this);this.oDashboardView.destroy();sap.ushell.renderers.fiori2.launchpad.getDashboardManager=undefined},_refreshTiles:function(){var t=this,G=this.oModel.getProperty("/groups");jQuery.each(G,function(n,o){jQuery.each(o.tiles,function(n,T){t.oPageBuilderService.refreshTile(T.object)})})},_sortableStart:function(){this.oSortableDeferred=$.Deferred()},_createBookmark:function(c,e,d){var t=d.group?d.group.object:"",b=d.group?d.group.groupId:0,f;delete d.group;this._addRequest($.proxy(function(){var r=sap.ushell.Container.getService("Bookmark").addBookmark(d,t),R=sap.ushell.resources.i18n;r.always($.proxy(this._checkRequestQueue,this));r.done(function(T){if(!T){this.loadPersonalizedGroups();return}var n=this._getTileModel(T);f=this.oModel.getProperty("/groups/"+(this._getIndexOfGroup(b)||0));f.tiles.push(n);this.oModel.setProperty("/groups/"+this._getIndexOfGroup(b),f);if(sap.ushell.Container){sap.ushell.Container.getService('Message').info(R.getText('tile_created_msg'))}}.bind(this));r.fail(function(m){jQuery.sap.log.error("Failed to add bookmark",m,"sap.ushell.ui.footerbar.AddBookmarkButton");if(sap.ushell.Container){sap.ushell.Container.getService('Message').error(R.getText('fail_to_add_tile_msg'))}})},this))},_sortableStop:function(){this.oSortableDeferred.resolve()},_handleAfterSortable:function(f){return $.proxy(function(){var o=Array.prototype.slice.call(arguments);this.oSortableDeferred.done(function(){f.apply(null,o)})},this)},_addRequest:function(r){this.aRequestQueue.push(r);if(!this.bRequestRunning){this.bRequestRunning=true;this.aRequestQueue.shift()()}},_checkRequestQueue:function(){if(this.aRequestQueue.length===0){this.bRequestRunning=false}else{this.aRequestQueue.shift()()}},_requestFailed:function(){this.aRequestQueue=[];this.bRequestRunning=false},_createGroup:function(c,e,d){var t=this,G=this._getGroupModel(null),b=this.oModel.getProperty("/groups"),m=this.oModel;m.setProperty("/groupList-skipScrollToGroup",true);window.setTimeout(function(){m.setProperty("/groups/"+b.length,G)},500);window.setTimeout(function(){m.setProperty("/groupList-skipScrollToGroup",false)},1000)},_getIndexOfGroup:function(G){var n=null,b=this.oModel.getProperty("/groups");jQuery.each(b,function(c,o){if(o.groupId===G){n=c;return false}});return n},_getPathOfGroup:function(G){return"/groups/"+this._getIndexOfGroup(G)},_getPathOfTile:function(t){var G=this.oModel.getProperty("/groups"),n=null,b=null;jQuery.each(G,function(c,o){jQuery.each(o.tiles,function(d,T){if(T.uuid===t){n=c;b=d;return false}});if(n!==null){return false}});return n!==null?"/groups/"+n+"/tiles/"+b:null},_moveInArray:function(A,n,b){if(b>=A.length){var k=b-A.length;while((k--)+1){A.push(undefined)}}A.splice(b,0,A.splice(n,1)[0])},_updateGroupIndices:function(A){var k;for(k=0;k<A.length;k++){A[k].index=k}},_deleteGroup:function(c,e,d){var t=this,G=d.groupId,b=this.oModel.getProperty("/groups"),n=this._getIndexOfGroup(G),o=null,r,m,f,B;f=b.length-1===n?n-1:n;this._destroyGroupModel("/groups"+n);o=b.splice(n,1)[0].object;m=this.oModel;m.setProperty("/groupList-skipScrollToGroup",true);m.setProperty("/groups",b);this._updateGroupIndices(b);if(f>=0){B=sap.ui.getCore().getEventBus();window.setTimeout($.proxy(B.publish,B,"launchpad","scrollToGroup",{groupId:this.oModel.getProperty("/groups")[f].groupId}),200)}window.setTimeout(function(){m.setProperty("/groupList-skipScrollToGroup",false)},1000);this._addRequest($.proxy(function(){var h=sap.ushell.Container.getService("LaunchPage").getGroupTitle(o);try{r=this.oPageBuilderService.removeGroup(o)}catch(i){this._resetGroupsOnFailure("fail_to_delete_group_msg");return}r.done($.proxy(this._showLocalizedMessage("group_deleted_msg",[h])));r.fail(this._handleAfterSortable(t._resetGroupsOnFailureHelper("fail_to_delete_group_msg")));r.always($.proxy(this._checkRequestQueue,this))},this))},_resetGroup:function(c,e,d){var t=this,G=d.groupId,n=this._getIndexOfGroup(G),o=this.oModel.getProperty("/groups/"+n),r;this.oModel.setProperty("/groups/"+n+"/sortable",false);this._addRequest($.proxy(function(){try{r=this.oPageBuilderService.resetGroup(o.object)}catch(b){this._resetGroupsOnFailure("fail_to_reset_group_msg");return}r.done(this._handleAfterSortable($.proxy(function(G,o,R){var n=t._getIndexOfGroup(G);this._loadGroup(n,R||o.object);this._showLocalizedMessage("group_reset_msg",[o.title]);this.oModel.setProperty("/groups/"+n+"/sortable",true)},this,G,o)));r.fail(this._handleAfterSortable(t._resetGroupsOnFailureHelper("fail_to_reset_group_msg")));r.always($.proxy(this._checkRequestQueue,this))},this))},_moveGroup:function(c,e,d){var f=d.fromIndex,t=d.toIndex,G=this.oModel.getProperty("/groups"),m=this.oModel,r;f=this._adjustFromGroupIndex(f,G);var o=G[f],s=o.groupId;t=this._adjustToGroupIndex(t,G,s);this._moveInArray(G,f,t);this._updateGroupIndices(G);m.setProperty("/groupList-skipScrollToGroup",true);m.setProperty("/groups",G);window.setTimeout(function(){m.setProperty("/groupList-skipScrollToGroup",false)},1000);if(o.isDefaultGroup){that.toggleDefaultGroupVisibility(false)}this._addRequest($.proxy(function(){var o=this.oModel.getProperty(this._getPathOfGroup(s));try{r=this.oPageBuilderService.moveGroup(o.object,t)}catch(b){this._resetGroupsOnFailure("fail_to_move_group_msg");return}r.fail(this._handleAfterSortable(this._resetGroupsOnFailureHelper("fail_to_move_group_msg")));r.always($.proxy(this._checkRequestQueue,this))},this))},_adjustToGroupIndex:function(t,b,c){var v=0,I=false,i=0;for(i=0;i<b.length&&v<t;i++){if(b[i].isGroupVisible){if(b[i].groupId===c){I=true}else{v++}}}if(I){return i-1}return i},_adjustFromGroupIndex:function(b,c){var v=0;for(var i=0;i<c.length;i++){if(c[i].isGroupVisible){v++}if(v===b+1){return i}}return b},_changeGroupTitle:function(c,e,d){var n=d.newTitle,G=d.groupId,b=this._getIndexOfGroup(G),o=this.oModel.getProperty("/groups/"+b),r;this.oModel.setProperty("/groups/"+b+"/title",n);if(!o.object){this._addRequest($.proxy(function(){try{r=this.oPageBuilderService.addGroup(n)}catch(f){this._resetGroupsOnFailure("fail_to_create_group_msg");return}r.done(this._handleAfterSortable($.proxy(function(G,N){var b=this._getIndexOfGroup(G);this._loadGroup(b,N)},this,G)));r.fail(this._handleAfterSortable(this._resetGroupsOnFailureHelper("fail_to_create_group_msg")))},this))}else{this._addRequest($.proxy(function(){try{r=this.oPageBuilderService.setGroupTitle(o.object,n)}catch(f){this._resetGroupsOnFailure("fail_to_rename_group_msg");return}r.fail(this._handleAfterSortable($.proxy(function(G,O){var s=this._getPathOfGroup(G);this._showLocalizedError("fail_to_rename_group_msg");this.oModel.setProperty(s+"/title",O);this._requestFailed()},this,G)))},this))}r.always($.proxy(this._checkRequestQueue,this))},_createTile:function(d){var c=d.catalogTileContext,C=d.groupContext,G=this.oModel.getProperty(C.getPath()),s=G.groupId,r,b=jQuery.Deferred(),R={};var B=sap.ui.getCore().getEventBus();$.proxy(B.publish,B,"launchpad","addTile",{catalogTileContext:c,groupContext:C});if(C.getObject().isDefaultGroup){this.toggleDefaultGroupVisibility(true)}if(!c){jQuery.sap.log.warning("DashboardManager: Did not receive catalog tile object. Abort.",this);return}this._addRequest($.proxy(function(){try{r=this.oPageBuilderService.addTile(c.getProperty("src"),C.getProperty("object"))}catch(e){this._resetGroupsOnFailure("fail_to_add_tile_msg");return}var t=this;r.done(this._handleAfterSortable($.proxy(function(s,T){var f=this._getPathOfGroup(s);this._addTileToGroup(f,T);R={group:G,status:1,action:'add'};b.resolve(R)},this,s))).fail(function(){R={group:G,status:0,action:'add'};b.resolve(R)}).always(function(){t._checkRequestQueue()})},this));return b.promise()},_createGroupAndSaveTile:function(d){var c=d.catalogTileContext,n=d.newGroupName,r,b=jQuery.Deferred(),t=this,R={};if(sap.ushell.utils.validHash(n)&&c){var G=this._getGroupModel(null),e=this.oModel.getProperty("/groups"),B=sap.ui.getCore().getEventBus(),s=G.groupId;var i=e.length;this.oModel.setProperty("/groups/"+i,G);this.oModel.setProperty("/groups/"+i+"/title",n);if(!c){jQuery.sap.log.warning("DashboardManager: Did not receive catalog tile object. Abort.",this);return}this._addRequest($.proxy(function(){try{r=this.oPageBuilderService.addGroup(n)}catch(f){this._resetGroupsOnFailure("fail_to_create_group_msg");return}r.done(this._handleAfterSortable($.proxy(function(s,N){var h=this._getIndexOfGroup(s);this._loadGroup(h,N);var C=new sap.ui.model.Context(this.oModel,"/groups/"+h);var p=this._createTile({catalogTileContext:c,groupContext:C});p.done(function(j){R={group:j.group,status:1,action:'addTileToNewGroup'};b.resolve(R)}).fail(function(j){R={group:j.group,status:0,action:'addTileToNewGroup'};b.resolve(R)})},this,s)));r.fail(function(h){this._handleAfterSortable(this._resetGroupsOnFailureHelper("fail_to_create_group_msg"));R={group:h.group,status:0,action:'createNewGroup'};b.resolve(R)});r.always($.proxy(this._checkRequestQueue,this))},this))}return b.promise()},_deleteTile:function(c,e,d){var t=this,T=d.tileId,G=this.oModel.getProperty("/groups");jQuery.each(G,function(n,o){var f=false;jQuery.each(o.tiles,function(b,h){if(h.uuid===T){t._destroyTileModel("/groups/"+n+"/tiles/"+b);var i=o.tiles.splice(b,1)[0],r;t.oModel.setProperty("/groups/"+n+"/tiles",o.tiles);if(o.isDefaultGroup&&o.tiles.length==0){t.toggleDefaultGroupVisibility(false)}t._addRequest(function(){try{r=t.oPageBuilderService.removeTile(o.object,i.object)}catch(j){this._resetGroupsOnFailure("fail_to_remove_tile_msg");return}r.done(t._handleAfterSortable(function(){var s=sap.ushell.Container.getService("LaunchPage").getTileTitle(i.object);if(s){t._showLocalizedMessage("tile_deleted_msg",[s])}else{t._showLocalizedMessage("empty_tile_deleted_msg")}}.bind(i)));r.fail(t._handleAfterSortable(t._resetGroupsOnFailureHelper("fail_to_remove_tile_msg")));r.always($.proxy(t._checkRequestQueue,t))});sap.ushell.utils.handleTilesVisibility();f=true;return false}});if(f){return false}})},_sendDeleteTileRequest:function(G,t){var r,b=sap.ushell.Container.getService('LaunchPage');try{r=b.removeTile(G,t.object)}catch(e){jQuery.sap.log.error("_deleteCatalogTileFromGroup ; removeTile ; Exception occurred: "+e)}return r},_deleteCatalogTileFromGroup:function(d){var t=this,D=decodeURIComponent(d.tileId),G=d.groupIndex,o=this.oModel.getProperty("/groups/"+G),T=this.oModel.getProperty("/groups/"+G+"/tiles/"),s=sap.ushell.Container.getService("LaunchPage"),b=jQuery.Deferred(),c=[],e,i,t=this,f;f=o.tiles.filter(function(h){var e=s.getCatalogTileId(h.object);if(e!==D){return true}else{var p=jQuery.Deferred(),j=t._sendDeleteTileRequest(o.object,h);j.done((function(b){return function(){b.resolve({status:true})}})(p));j.fail((function(b){return function(){b.resolve({status:false})}})(p));c.push(p);return false}});o.tiles=f;jQuery.when.apply(jQuery,c).done(function(r){var S=true,i=0,p=c.length;for(i;i<p;i++){if(!r.status){S=false;break}}if(S){t.oModel.setProperty("/groups/"+G,o)}b.resolve({group:o,status:S,action:'remove'})});return b.promise()},_moveTile:function(c,e,d){var t=this,n=d.toIndex,N=d.toGroupId,T=d.sTileId,o,b,O,f,h,i,G=this.oModel.getProperty("/groups");jQuery.each(G,function(k,l){var F=false;jQuery.each(l.tiles,function(m,p){if(p.uuid===T){o=p;b=m;O=l;f=k;F=true;return false}});if(F){return false}});jQuery.each(G,function(k,l){if(l.groupId===N){h=l;i=k;if(O.isDefaultGroup&&f!=i&&O.tiles.length<=1){t.toggleDefaultGroupVisibility(false)}}});if(n&&n>h.tiles.length){n=h.tiles.length}if(O.groupId===N){if(n===null||n===undefined){O.tiles.splice(b,1);n=O.tiles.length;O.tiles.push(o)}else{n=this._adjustTileIndex(n,o,O);this._moveInArray(O.tiles,b,n)}this.oModel.setProperty("/groups/"+f+"/tiles",O.tiles)}else{O.tiles.splice(b,1);this.oModel.setProperty("/groups/"+f+"/tiles",O.tiles);if(n===null||n===undefined){n=h.tiles.length;h.tiles.push(o)}else{n=this._adjustTileIndex(n,o,h);h.tiles.splice(n,0,o)}this.oModel.setProperty("/groups/"+i+"/tiles",h.tiles)}sap.ushell.utils.handleTilesVisibility();var s=this.oModel.getProperty("/groups/"+f).object,j=this.oModel.getProperty("/groups/"+i).object,r;this._addRequest($.proxy(function(){try{r=this.oPageBuilderService.moveTile(o.object,b,n,s,j)}catch(k){this._resetGroupsOnFailure("fail_to_move_tile_msg");return}r.done(this._handleAfterSortable($.proxy(function(T,l){var m=this._getPathOfTile(T),p=this.oPageBuilderService;if(m){this.oModel.setProperty(m+"/object",l)}},this,T)));r.fail(this._handleAfterSortable(this._resetGroupsOnFailureHelper("fail_to_move_tile_msg")));r.always($.proxy(this._checkRequestQueue,this))},this))},_adjustTileIndex:function(n,t,b){var v=0,I=false,i=0;for(i=0;i<b.tiles.length&&v<n;i++){if(b.tiles[i].isTileIntentSupported){if(b.tiles[i]===t){I=true}else{v++}}}if(I){return i-1}return i},toggleDefaultGroupVisibility:function(v){var d=this.oDashboardView.oDashboardGroupsBox.getGroups()[0],G;if(sap.ui.getCore().byId('groupList')){G=sap.ui.getCore().byId('groupList').oGroupList.getItems()[0];if(G){G.setShow(v)}}if(d){d.setVisible(v)}},getModel:function(){return this.oModel},getDashboardView:function(){if(!sap.ui.getCore().byId('dashboard')){this.oDashboardView=sap.ui.jsview("dashboard","sap.ushell.renderers.fiori2.launchpad.dashboard.DashboardContent")}return this.oDashboardView},getGroupListView:function(){if(!sap.ui.getCore().byId('groupList')){this.oGroupListView=sap.ui.jsview("groupList","sap.ushell.renderers.fiori2.launchpad.group_list.GroupList")}return this.oGroupListView},loadAllCatalogs:function(c,e,d){if(!this.oModel.getProperty("/catalogs")||!sap.ushell.Container.getService("LaunchPage").isCatalogsValid()){var t=this;if(!this.oModel.getProperty("/groups")||this.oModel.getProperty("/groups").length===0){this.loadPersonalizedGroups()}this.numOfLoadedCatalogs=0;this._destroyAllGroupModels("/catalogs");this._destroyAllTileModels("/catalogTiles");this.oModel.setProperty("/catalogs",[]);this.oModel.setProperty("/catalogTiles",[]);sap.ushell.Container.getService("LaunchPage").getCatalogs().done(this.onDoneLoadingCatalogs.bind(this)).fail(t._showLocalizedErrorHelper("fail_to_load_catalog_msg")).progress(this.addCatalogToModel.bind(this))}var G=this.getModel().getProperty("/groups");if(G&&G.length!==0){this.mapCatalogTilesToGroups();this.updateCatalogTilesToGroupsMap()}},updateCatalogTilesToGroupsMap:function(){var c=this.getModel().getProperty("/catalogTiles"),t,i,b,d,G;var s=sap.ushell.Container.getService("LaunchPage");var e=this.getModel().getProperty("/catalogTiles");if(c){for(i=0;i<c.length;i++){t=c[i];b=encodeURIComponent(s.getCatalogTileId(t.src));d=this.getModel().getProperty("/catalogTiles/"+i+"/associatedGroups");G=this.oTileCatalogToGroupsMap[b];d=G?G:[];e[i].associatedGroups=d}}this.getModel().setProperty("/catalogTiles",e)},addCatalogToModel:function(c){var C=this.oModel.getProperty('/catalogs');var s=sap.ushell.Container.getService("LaunchPage");var b=s.getCatalogId(c);var d=false;C.forEach(function(e){if(e.id===b){d=true}});if(!d){var o={title:s.getCatalogTitle(c),id:s.getCatalogId(c),"static":false,tiles:[]};s.getCatalogTiles(c).done(function(t){if(!t.length){return}var e={catalog:o.title,id:o.id,index:this.numOfLoadedCatalogs};this.setCatalogTiles("/catalogTiles",true,e,t);o.numIntentSupportedTiles=a.call(this,o);C.push(o);this.oModel.setProperty('/catalogs',C);this.numOfLoadedCatalogs++}.bind(this)).fail(this._showLocalizedErrorHelper("fail_to_load_catalog_tiles_msg"))}},onDoneLoadingCatalogs:function(c){var s=sap.ushell.Container.getService("LaunchPage");var l=c.filter(function(o){return!s.getCatalogError(o)});if(l.length!==c.length){this._showLocalizedError("partialCatalogFail")}var C=this.oModel.getProperty('/catalogs');if(C[0]&&C[0].title===sap.ushell.resources.i18n.getText('catalogsLoading')){C.splice(0,1)}C.splice(0,0,{title:g("all"),"static":true,tiles:[],numIntentSupportedTiles:-1});this.oModel.setProperty('/catalogs',C);sap.ushell.utils.handleTilesVisibility()},setCatalogTiles:function(p,A,d,c){var s=sap.ushell.Container.getService("LaunchPage");this.oModel.setProperty(p,$.merge((A&&this.oModel.getProperty(p))||[],$.map(c,function(C,t){var b=encodeURIComponent(s.getCatalogTileId(C)),e=this.oTileCatalogToGroupsMap[b]||[];return{associatedGroups:e,src:C,catalog:d.catalog,catalogIndex:d.index*100000+t,catalogId:d.id,title:s.getCatalogTileTitle(C),keywords:(s.getCatalogTileKeywords(C)||[]).join(','),id:b,size:s.getCatalogTileSize(C),content:[s.getCatalogTileView(C)],isTileIntentSupported:s.isTileIntentSupported(C)}}.bind(this))))},mapCatalogTilesToGroups:function(){this.oTileCatalogToGroupsMap={};var G=this.oModel.getProperty("/groups"),s=sap.ushell.Container.getService("LaunchPage"),i=0,o,t,T,b,c,d;for(i=0;i<G.length;i++){o=G[i];T=o.tiles;if(T){for(t=0;t<T.length;++t){b=encodeURIComponent(s.getCatalogTileId(T[t].object));c=this.oTileCatalogToGroupsMap[b]||[];d=s.getGroupId(o.object);if(c.indexOf(d)===-1&&(typeof(o.isGroupVisible)==='undefined'||o.isGroupVisible)){c.push(d)}this.oTileCatalogToGroupsMap[b]=c}}}},_showLocalizedMessage:function(m,p,t){sap.ushell.Container.getService("Message").show(t||sap.ushell.services.Message.Type.INFO,g(m,p),p)},_showLocalizedError:function(m,p){this._showLocalizedMessage(m,p,sap.ushell.services.Message.Type.ERROR)},_showLocalizedErrorHelper:function(m,p){var t=this;return function(){t._showLocalizedError(m,p)}},_resetGroupsOnFailureHelper:function(m){var t=this;return function(G){t._showLocalizedError(m);setTimeout(function(){t.loadGroupsFromArray(G)})}},_resetGroupsOnFailure:function(m,p){this._requestFailed();this._showLocalizedError(m,p);this.loadPersonalizedGroups();this.oModel.updateBindings(true)},loadGroupsFromArray:function(G){var t=this;this.oPageBuilderService.getDefaultGroup().done(function(d){var i,k=1;t._loadGroup(0,d);for(i=0;i<G.length;++i){if(G[i]!==d){t._loadGroup(k,G[i]);k++}}for(i=G.length;i<t.oModel.getProperty("/groups/length");++i){t._destroyGroupModel("/groups/"+i)}t.oModel.setProperty("/groups/length",G.length);if(t.oModel.getProperty('/currentState/stateName')==="catalog"){t.mapCatalogTilesToGroups();t.updateCatalogTilesToGroupsMap()}}).fail(t._resetGroupsOnFailureHelper("fail_to_get_default_group_msg"))},_loadGroup:function(n,G){var t=this,s="/groups/"+n;this._destroyGroupModel(s);var o=this.oModel.getProperty(s+"/groupId"),N=this._getGroupModel(G,n===0);if(o){N.groupId=o}N.index=n;this.oModel.setProperty(s,N)},_getGroupModel:function(G,d){var s=this.oPageBuilderService,b=(G&&s.getGroupTiles(G))||[],m=[],i,c;if(sap.ui.getCore().byId("shell")&&sap.ui.getCore().byId("shell").getModel()){c=sap.ui.getCore().byId("shell").getModel().getProperty("/personalization")}for(i=0;i<b.length;++i){m.push(this._getTileModel(b[i]))}return{title:(d&&g("my_group"))||(G&&s.getGroupTitle(G))||"",object:G,groupId:jQuery.sap.uid(),tiles:m,isDefaultGroup:d||false,editMode:!G,removable:!G||s.isGroupRemovable(G),sortable:c,isGroupVisible:!G||s.isGroupVisible(G),isEnabled:!d}},_addTileToGroup:function(G,t){var T=G+"/tiles",n=this.oModel.getProperty(T).length;this.oModel.setProperty(T+"/"+n,this._getTileModel(t))},_updateModelWithTileView:function(t,T){var b=this;this.tileViewUpdateQueue.push({uuid:t,view:T});if(this.tileViewUpdateTimeoutID){clearTimeout(this.tileViewUpdateTimeoutID)}this.tileViewUpdateTimeoutID=setTimeout(function(){b.tileViewUpdateTimeoutID=undefined;b.oSortableDeferred.done(function(){b._updateModelWithTilesViews()})},50)},_updateModelWithTilesViews:function(){var G=this.oModel.getProperty("/groups"),t,T,u,s;if(!G){return}for(var i=0;i<G.length;i=i+1){t=G[i].tiles;for(var j=0;j<t.length;j=j+1){T=t[j];for(var q=0;q<this.tileViewUpdateQueue.length;q++){u=this.tileViewUpdateQueue[q];if(T.uuid==u.uuid){if(u.view){T.content[0].destroy();T.content=[u.view]}else{T.content[0].setState("Failed")}s=this.oPageBuilderService.getTileSize(T.object);T['long']=((s!==null)&&(s==="1x2"||s==="2x2"))||false;T.tall=((s!==null)&&(s==="2x1"||s==="2x2"))||false;break}}}}this.tileViewUpdateQueue=[];this.oModel.setProperty("/groups",G)},_getTileModel:function(t){var s=this.oPageBuilderService,S=s.getTileSize(t),T=jQuery.sap.uid(),o,u,b=this,d;;s.setTileVisible(t,false);d=s.getTileView(t);d.done(function(v){o=v;if(u){u.apply(b,[T,o])}});d.fail(function(){if(u){u.apply(b,[T])}else{o=new sap.ushell.ui.launchpad.TileState({state:"Failed"})}});if(!o){u=this._updateModelWithTileView;o=new sap.ushell.ui.launchpad.TileState({state:"Loading"})}return{"object":t,"uuid":T,"content":[o],"long":((S!==null)&&(S==="1x2"||S==="2x2"))||false,"tall":((S!==null)&&(S==="2x1"||S==="2x2"))||false,"target":s.getTileTarget(t)||"","debugInfo":s.getTileDebugInfo(t),"isTileIntentSupported":s.isTileIntentSupported(t),"rgba":""}},_destroyAllGroupModels:function(t){var G=(typeof t==="string")?this.oModel.getProperty(t):t,i;if(G){for(i=0;i<G.length;i=i+1){this._destroyGroupModel(G[i])}}},_destroyGroupModel:function(t){var G=(typeof t==="string")?this.oModel.getProperty(t):t,i;if(G){this._destroyAllTileModels(G.tiles)}},_destroyAllTileModels:function(t){var T=(typeof t==="string")?this.oModel.getProperty(t):t,i;if(T){for(i=0;i<T.length;i=i+1){this._destroyTileModel(T[i])}}},_destroyTileModel:function(t){var T=(typeof t==="string")?this.oModel.getProperty(t):t,i;if(T&&T.content){for(i=0;i<T.content.length;i=i+1){T.content[i].destroy()}}},loadPersonalizedGroups:function(){var t=this,G=this.oPageBuilderService.getGroups();G.done(function(b){t.loadGroupsFromArray(b)});G.fail(t._showLocalizedErrorHelper("fail_to_load_groups_msg"))}})}());
