/*!
 * SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2013 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.ushell.ui.footerbar.LoginDetailsButton");jQuery.sap.require("sap.ushell.library");jQuery.sap.require("sap.m.Button");sap.m.Button.extend("sap.ushell.ui.footerbar.LoginDetailsButton",{metadata:{library:"sap.ushell"}});
// Copyright (c) 2013 SAP AG, All Rights Reserved
(function(){"use strict";jQuery.sap.require("sap.ui.layout.form.SimpleForm");jQuery.sap.require("sap.m.Label");jQuery.sap.require("sap.m.Text");jQuery.sap.require("sap.m.Input");jQuery.sap.require("sap.m.Dialog");jQuery.sap.require("sap.m.Button");jQuery.sap.require("sap.ushell.resources");jQuery.sap.require("sap.ushell.services.Container");jQuery.sap.declare("sap.ushell.ui.footerbar.LoginDetailsButton");sap.ushell.ui.footerbar.LoginDetailsButton.prototype.init=function(){this.setIcon('sap-icon://person-placeholder');this.setWidth('100%');this.setText(sap.ushell.resources.i18n.getText("userPreferences"));this.setTooltip(sap.ushell.resources.i18n.getText("userPreferences_tooltip"));this.attachPress(this.showLoginDetailsDialog);this.setEnabled();if(sap.m.Button.prototype.init){sap.m.Button.prototype.init.apply(this,arguments)}};sap.ushell.ui.footerbar.LoginDetailsButton.prototype.showLoginDetailsDialog=function(){var i=[],t,s,o,c,m=sap.ui.getCore().byId("shell").getModel(),T,a,g,l,b,d=this;try{this.userInfoService=sap.ushell.Container.getService("UserInfo");this.oUser=this.userInfoService.getUser()}catch(e){jQuery.sap.log.error("Getting UserInfo service failed");this.oUser=sap.ushell.Container.getUser()}this.translationBundle=sap.ushell.resources.i18n;T=this.oUser.isSetThemePermitted();a=this.oUser.getTheme();l=new sap.ui.core.Item({text:sap.ushell.resources.i18n.getText('themesLoading'),enabled:true});d.themeSelection=new sap.m.Select({id:"themesDropdown",enabled:!!m.getProperty("/setTheme"),visible:true,name:"Our Drop-Down",items:l});b=[new sap.m.Text("userName",{text:d.oUser.getFullName()||''})];if(d.oUser.getEmail()){b.push(new sap.m.Label(''));b.push(new sap.m.Text("userEmail",{text:d.oUser.getEmail()}))}b=b.concat(new sap.m.Label("selectedTheme",{required:true,text:" "+this.translationBundle.getText("theme")}),d.themeSelection,new sap.m.Label("serverNameLbl",{text:this.translationBundle.getText("serverFld")}),new sap.m.Text("serverNameTxt",{text:window.location.host}),new sap.m.Label("languageLbl",{text:this.translationBundle.getText("languageFld")}),new sap.m.Text("languageTxt",{text:d.oUser.getLanguage()||''}));s=new sap.ui.layout.form.SimpleForm({content:b});o=new sap.m.Button({id:"okButton",text:this.translationBundle.getText("okBtn"),press:d._dialogOkButtonHandler.bind(d),enabled:false});c=new sap.m.Button({id:"cancelButton",text:this.translationBundle.getText("cancelBtn"),press:function(){d.oDialog.close()}.bind(d)});d.oDialog=new sap.m.Dialog({id:"loginDetailsDialog",title:this.translationBundle.getText("userPreferences"),contentWidth:"300px",content:s,beginButton:o,endButton:c,afterClose:function(){d.themeSelection.destroy();d.oDialog.destroy();this.oUser.resetChangedProperties()}.bind(d)});d.oDialog.open();if(T){g=this.userInfoService.getThemeList();g.done(function(D){var f,h;t=D.options||[];for(f=0;f<t.length;f++){h=t[f].name;if(h){i[f]=new sap.ui.core.Item({id:t[f].id,text:h,enabled:true,key:h})}}if(t.length>1){i.sort(function(j,k){var n=j.getText().toLowerCase(),p=k.getText().toLowerCase();if(n<p){return-1}if(n>p){return 1}return 0})}o.setEnabled()});g.fail(function(){i[0]=new sap.ui.core.Item({id:a,text:a,enabled:true,key:a});bEnableThemeSelection=false});g.always(jQuery.proxy(this._setThemeSelection,this,i,a))}else{d.themeSelection.addItem(new sap.ui.core.Item({id:a,text:a,enabled:true,key:a}));d.themeSelection.setSelectedKey(a);d.themeSelection.setEnabled(false)}};sap.ushell.ui.footerbar.LoginDetailsButton.prototype._setThemeSelection=function(i,c){var a,b,C;if(i){this.themeSelection.removeAllItems();for(a=0;a<i.length;a++){this.themeSelection.addItem(i[a])}b=i.filter(function(t){return t.getId()===c});C=b.length?b[0].getText():{};if(C){this.themeSelection.setSelectedKey(C)}}};sap.ushell.ui.footerbar.LoginDetailsButton.prototype._restoreUserPreferencesProperties=function(e){var m,o=this.oUser.getChangedProperties().filter(function(C){return C.name==="THEME"})[0].oldValue;this.oUser.setTheme(o);m=sap.ushell.Container.getService("Message");m.error(this.translationBundle.getText("changeThemeFailed"));jQuery.sap.log.error(e)};sap.ushell.ui.footerbar.LoginDetailsButton.prototype._dialogOkButtonHandler=function(){this.oDialog.close();var c=this.oUser.getTheme(),u,m;if(this.themeSelection.getSelectedItemId()!==c){this.oUser.setTheme(this.themeSelection.getSelectedItemId());u=this.userInfoService.updateUserPreferences(this.oUser);u.done(function(){m=this.translationBundle.getText("savedChanges");jQuery.sap.require("sap.m.MessageToast");sap.m.MessageToast.show(m,{duration:3000,width:"15em",my:"center bottom",at:"center bottom",of:window,offset:"0 -50",collision:"fit fit"});this.oUser.resetChangedProperties()}.bind(this));u.fail(function(e){this._restoreUserPreferencesProperties(e)}.bind(this))}};sap.ushell.ui.footerbar.LoginDetailsButton.prototype.setEnabled=function(e){if(!sap.ushell.Container){if(this.getEnabled()){jQuery.sap.log.warning("Disabling 'Login Details' button: unified shell container not initialized",null,"sap.ushell.ui.footerbar.LoginDetailsButton")}e=false}sap.m.Button.prototype.setEnabled.call(this,e)}}());
