(function(){"use strict";sap.ui.controller("tiles.indicatornumeric.NumericTile",{onInit:function(){var t=this;this.firstTimeVisible=false;this.oKpiTileView=this.getView();this.oViewData=this.oKpiTileView.getViewData();this.oTileApi=this.oViewData.chip;if(this.oTileApi.visible){this.oTileApi.visible.attachVisible(this.visibleHandler.bind(this))}this.system=this.oTileApi.url.getApplicationSystem();this.oKpiTileView.oGenericTile.setState(sap.suite.ui.commons.LoadState.Loading);try{sap.ushell.components.tiles.indicatorTileUtils.util.getParsedChip(t.oTileApi.configuration.getParameterValueAsString("tileConfiguration"),function(c){t.oConfig=c;t.setTextInTile();if(t.oTileApi.preview){t.oTileApi.preview.setTargetUrl(sap.ushell.components.tiles.indicatorTileUtils.util.getNavigationTarget(t.oConfig,t.system))}if(t.oTileApi.preview.isEnabled()){t._updateTileModel({value:"10.34",scale:"M",valueColor:sap.suite.ui.commons.InfoTileValueColor.Neutral,indicator:sap.suite.ui.commons.DeviationIndicator.None});t.oKpiTileView.oGenericTile.setState(sap.suite.ui.commons.LoadState.Loaded)}else{t.oKpiTileView.oGenericTile.attachPress(function(){sap.ushell.components.tiles.indicatorTileUtils.util.abortPendingODataCalls(t.queryServiceUriODataReadRef);sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,null);window.location.hash=sap.ushell.components.tiles.indicatorTileUtils.util.getNavigationTarget(t.oConfig,t.system)});if(Number(t.oTileApi.configuration.getParameterValueAsString("isSufficient"))){sap.ushell.components.tiles.indicatorTileUtils.cache.setEvaluationById(t.oConfig.TILE_PROPERTIES.id,t.oConfig);t.flowWithoutDesignTimeCall()}else{t.flowWithDesignTimeCall()}}})}catch(e){this.logError(e)}},_setLocalModelToTile:function(){if(this.getTile().getModel()){}else{this.getTile().setModel(new sap.ui.model.json.JSONModel({}))}},getTile:function(){return this.oKpiTileView.oGenericTile},_updateTileModel:function(n){var m=this.getTile().getModel().getData();jQuery.extend(m,n);this.getTile().getModel().setData(m)},fetchKpiValue:function(s,E){var t=this;var k=0;var a=0;var c=0;var b=0;var w=0;var d=0;var f=0;try{var u=this.DEFINITION_DATA.EVALUATION.ODATA_URL;var g=this.DEFINITION_DATA.EVALUATION.ODATA_ENTITYSET;var T=this.setThresholdValues();var m=T.fullyFormedMeasure;var h=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(t.oConfig.TILE_PROPERTIES.id);if(!h){var v=sap.ushell.components.tiles.indicatorTileUtils.util.prepareFilterStructure(this.DEFINITION_DATA.EVALUATION_FILTERS,this.DEFINITION_DATA.ADDITIONAL_FILTERS);var q=sap.ushell.components.tiles.indicatorTileUtils.util.prepareQueryServiceUri(t.oTileApi.url.addSystemToServiceUrl(u),g,m,null,v);if(q){this.QUERY_SERVICE_MODEL=q.model;this.queryUriForKpiValue=q.uri;this.queryServiceUriODataReadRef=this.QUERY_SERVICE_MODEL.read(q.uri,null,null,true,function(i){if(i&&i.results&&i.results.length){k=i.results[0][t.DEFINITION_DATA.EVALUATION.COLUMN_NAME];var j={};if(q.unit){t._updateTileModel({unit:i.results[0][q.unit.name]});j.unit=q.unit;j.unit.name=q.unit.name}j.data=i;sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.oConfig.TILE_PROPERTIES.id,j);if(t.DEFINITION_DATA.EVALUATION.VALUES_SOURCE=="MEASURE"){T.criticalHighValue=i.results[0][T.sCriticalHigh];T.criticalLowValue=i.results[0][T.sCriticalLow];T.warningHighValue=i.results[0][T.sWarningHigh];T.warningLowValue=i.results[0][T.sWarningLow];T.targetValue=i.results[0][T.sTarget];T.trendValue=i.results[0][T.sTrend]}s.call(t,k,T)}else{E.call(t,"no Response from QueryServiceUri")}},function(i){if(i&&i.response){E.call(t,i.message)}})}else{E.call(t,"Error Preparing Query Service URI")}}else{if(h.data&&h.data.results&&h.data.results.length){k=h.data.results[0][t.DEFINITION_DATA.EVALUATION.COLUMN_NAME];if(h.unit){t._updateTileModel({unit:h.data.results[0][h.unit.name]})}if(t.DEFINITION_DATA.EVALUATION.VALUES_SOURCE=="MEASURE"){T.criticalHighValue=h.data.results[0][T.sCriticalHigh];T.criticalLowValue=h.data.results[0][T.sCriticalLow];T.warningHighValue=h.data.results[0][T.sWarningHigh];T.warningLowValue=h.data.results[0][T.sWarningLow];T.targetValue=h.data.results[0][T.sTarget];T.trendValue=h.data.results[0][T.sTrend]}s.call(t,k,T)}else{E.call(t,"no Response from QueryServiceUri")}}}catch(e){E.call(t,e)}},getTrendColor:function(c,a,w,b,t){var d=this;try{var i=this.DEFINITION_DATA.EVALUATION.GOAL_TYPE;var f=this.DEFINITION_DATA.EVALUATION_VALUES;var r=sap.suite.ui.commons.InfoTileValueColor.Neutral;if(i==="MI"){if(c&&w){c=Number(c);w=Number(w);if(this.CALCULATED_KPI_VALUE<w){r=sap.suite.ui.commons.InfoTileValueColor.Good}else if(this.CALCULATED_KPI_VALUE<=c){r=sap.suite.ui.commons.InfoTileValueColor.Critical}else{r=sap.suite.ui.commons.InfoTileValueColor.Error}}}else if(i==="MA"){if(a&&b){a=Number(a);b=Number(b);if(this.CALCULATED_KPI_VALUE<a){r=sap.suite.ui.commons.InfoTileValueColor.Error}else if(this.CALCULATED_KPI_VALUE<=b){r=sap.suite.ui.commons.InfoTileValueColor.Critical}else{r=sap.suite.ui.commons.InfoTileValueColor.Good}}}else{if(b&&w&&a&&c){c=Number(c);w=Number(w);b=Number(b);a=Number(a);if(this.CALCULATED_KPI_VALUE<a||this.CALCULATED_KPI_VALUE>c){r=sap.suite.ui.commons.InfoTileValueColor.Error}else if((this.CALCULATED_KPI_VALUE>=a&&this.CALCULATED_KPI_VALUE<=b)||(this.CALCULATED_KPI_VALUE>=w&&this.CALCULATED_KPI_VALUE<=c)){r=sap.suite.ui.commons.InfoTileValueColor.Critical}else{r=sap.suite.ui.commons.InfoTileValueColor.Good}}}return r}catch(e){d.logError(e)}},getTrendIndicator:function(t){var a=this;t=Number(t);try{var b=sap.suite.ui.commons.DeviationIndicator.None;if(t>this.CALCULATED_KPI_VALUE){b=sap.suite.ui.commons.DeviationIndicator.Down}else if(t<this.CALCULATED_KPI_VALUE){b=sap.suite.ui.commons.DeviationIndicator.Up}return b}catch(e){a.logError(e)}},flowWithoutDesignTimeCall:function(){var t=this;this.DEFINITION_DATA=this.oConfig;this._updateTileModel(this.DEFINITION_DATA);if(this.oTileApi.visible.isVisible()&&!this.firstTimeVisible){this.firstTimeVisible=true;this.fetchKpiValue(function(k,T){this.CALCULATED_KPI_VALUE=k;var e=this.DEFINITION_DATA.EVALUATION_VALUES;var a=this.getTrendColor(T.criticalHighValue,T.criticalLowValue,T.warningHighValue,T.warningLowValue,T.targetValue);var b=this.getTrendIndicator(T.trendValue);var s="";var c=this.CALCULATED_KPI_VALUE;if(this.oConfig.EVALUATION.SCALING==-2){c*=100;this.getView().oNVConfContS.setFormatterValue(false)}s=sap.ushell.components.tiles.indicatorTileUtils.util.getLocaleFormattedValue(Number(c),this.oConfig.EVALUATION.SCALING);if(this.oConfig.EVALUATION.SCALING==-2)this._updateTileModel({scale:"%"});this._updateTileModel({value:s.toString(),valueColor:a,indicator:b});var n=sap.ushell.components.tiles.indicatorTileUtils.util.getNavigationTarget(t.oConfig,t.system);t.oKpiTileView.oGenericTile.$().wrap("<a href ='"+n+"'/>");this.oKpiTileView.oGenericTile.setState(sap.suite.ui.commons.LoadState.Loaded)},this.logError)}},flowWithDesignTimeCall:function(){var t=this;try{var a=sap.ushell.components.tiles.indicatorTileUtils.cache.getEvaluationById(this.oConfig.EVALUATION.ID);if(a){t.oConfig.EVALUATION_FILTERS=a.EVALUATION_FILTERS;t.flowWithoutDesignTimeCall()}else{sap.ushell.components.tiles.indicatorTileUtils.util.getFilterFromRunTimeService(this.oConfig,function(f){t.oConfig.EVALUATION_FILTERS=f;sap.ushell.components.tiles.indicatorTileUtils.cache.setEvaluationById(t.oConfig.TILE_PROPERTIES.id,t.oConfig);t.flowWithoutDesignTimeCall()})}}catch(e){this.logError(e)}},setThresholdValues:function(){var t=this;try{var T={};T.fullyFormedMeasure=this.DEFINITION_DATA.EVALUATION.COLUMN_NAME;if(this.DEFINITION_DATA.EVALUATION.VALUES_SOURCE=="MEASURE"){switch(this.DEFINITION_DATA.EVALUATION.GOAL_TYPE){case"MI":T.sWarningHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WH","MEASURE");T.sCriticalHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CH","MEASURE");T.sTarget=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TA","MEASURE");T.sTrend=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TC","MEASURE");T.fullyFormedMeasure+=t.formSelectStatement(T);break;case"MA":T.sWarningLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WL","MEASURE");T.sCriticalLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CL","MEASURE");T.sTarget=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TA","MEASURE");T.sTrend=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TC","MEASURE");T.fullyFormedMeasure+=t.formSelectStatement(T);break;case"RA":T.sWarningHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WH","MEASURE");T.sCriticalHigh=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CH","MEASURE");T.sTarget=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TA","MEASURE");T.sTrend=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TC","MEASURE");T.sWarningLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WL","MEASURE");T.sCriticalLow=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CL","MEASURE");T.fullyFormedMeasure+=t.formSelectStatement(T);break}}else{T.criticalHighValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CH","FIXED");T.criticalLowValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"CL","FIXED");T.warningHighValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WH","FIXED");T.warningLowValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"WL","FIXED");T.targetValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TA","FIXED");T.trendValue=sap.ushell.components.tiles.indicatorTileUtils.util.getEvalValueMeasureName(t.oConfig,"TC","FIXED")}return T}catch(e){t.logError(e)}},formSelectStatement:function(o){var t=Object.keys(o);var f="";for(var i=0;i<t.length;i++)if((o[t[i]]!==undefined)&&(o.fullyFormedMeasure))f+=","+o[t[i]];return f},setTextInTile:function(){var t=this;this._updateTileModel({header:t.oTileApi.preview.getTitle()||sap.ushell.components.tiles.indicatorTileUtils.util.getChipTitle(t.oConfig),subheader:t.oTileApi.preview.getDescription()||sap.ushell.components.tiles.indicatorTileUtils.util.getChipSubTitle(t.oConfig)})},logError:function(e){this._updateTileModel({value:"",scale:"",unit:""});this.oKpiTileView.oGenericTile.setState(sap.suite.ui.commons.LoadState.Failed);this.oKpiTileView.oGenericTile.setState(sap.suite.ui.commons.LoadState.Failed);sap.ushell.components.tiles.indicatorTileUtils.util.logError(e)},refreshHandler:function(c){if(!c.firstTimeVisible){if(Number(this.oTileApi.configuration.getParameterValueAsString("isSufficient")))c.flowWithoutDesignTimeCall();else c.flowWithDesignTimeCall()}},visibleHandler:function(i){if(!i){this.firstTimeVisible=false;sap.ushell.components.tiles.indicatorTileUtils.util.abortPendingODataCalls(this.queryServiceUriODataReadRef)}if(i){this.refreshHandler(this)}},onExit:function(){sap.ushell.components.tiles.indicatorTileUtils.util.abortPendingODataCalls(this.queryServiceUriODataReadRef)}})}());
