// Copyright (c) 2013 SAP AG, All Rights Reserved
(function(){"use strict";jQuery.sap.declare("sap.ushell.services.NavTargetResolution");sap.ushell.services.NavTargetResolution=function(A,c,p,s){var S=s&&s.config,l,r=[{name:"DefaultAdapter",isApplicable:function(){return true},resolveHashFragment:A.resolveHashFragment.bind(A)}],C;this._nextResolveHashFragment=function(a,h){var R,f;R=a.pop();if(R.isApplicable(h)){jQuery.sap.log.info("NavTargetResolution: custom resolver "+R.name+" resolves "+h);f=this._nextResolveHashFragment.bind(this,a);return R.resolveHashFragment(h,f)}return this._nextResolveHashFragment(a,h)};this.resolveHashFragment=function(h){var o=r.map(function(a){return a});return this._nextResolveHashFragment(o,h).done(function(R){C=R})};this.baseResolveHashFragment=function(h){return A.resolveHashFragment(h)};this.getSemanticObjectLinks=function(a,P,i){if(/\?/.test(a)){throw new Error("Parameter must not be part of semantic object")}if(A.getSemanticObjectLinks){return A.getSemanticObjectLinks(a,P,i)}return(new jQuery.Deferred()).resolve([]).promise()};this.isIntentSupported=function(i){var R={};if(A.isIntentSupported){return A.isIntentSupported(i)}i.forEach(function(I){R[I]={supported:undefined}});return(new jQuery.Deferred()).resolve(R).promise()};this.registerCustomResolver=function(o){if(typeof o.name!=="string"){jQuery.sap.log.error("NavTargetResolution: Custom Resolver must have name {string} member");return false}if(typeof o.isApplicable!=="function"){jQuery.sap.log.error("NavTargetResolution: Custom Resolver must have isApplicable member");return false}if(typeof o.resolveHashFragment!=="function"){jQuery.sap.log.error("NavTargetResolution: Custom Resolver must have \"resolveHashFragment\" member");return false}r.push(o);return true};if(S&&jQuery.isArray(S.resolveLocal)){l=S.resolveLocal.map(function(a){return a.linkId});this.registerCustomResolver({name:"localResolveNavigationResolver",cleanHash:function(h){if(h===""){return"#"}var a=sap.ushell.Container.getService("URLParsing").parseShellHash(h.substring(1));if(!a){return"#"}h="#"+a.semanticObject+"-"+a.action;return h},_getIndex:function(o){var h=this.cleanHash(o);return l.indexOf(h.substring(1))},isApplicable:function(o){return this._getIndex(o)>=0},resolveHashFragment:function(h){var d,i=this._getIndex(h),R,o,a,n;d=new jQuery.Deferred();R=JSON.parse(JSON.stringify(S.resolveLocal[i].resolveTo));o=sap.ushell.Container.getService("URLParsing").parseShellHash(h);if(o&&o.params){n=sap.ushell.Container.getService("URLParsing").paramsToString(o.params);a=R.url.indexOf('?')>=0;R.url=R.url+(a?"":"?")+n}d.resolve(R);return d.promise()}})}this.registerCustomResolver({name:"StandaloneLocalResolver",aElement:undefined,cleanHash:function(h){if(h===""){return undefined}var a=sap.ushell.Container.getService("URLParsing").parseShellHash(h.substring(1));if(!a){return undefined}h="#"+a.semanticObject+"-"+a.action;return h},isRunStandaloneHash:function(h){return typeof h==="string"&&h.indexOf("#Shell-runStandaloneApp")===0},isApplicable:function(h){h=this.cleanHash(h);if(!h){return false}return h==="#Test-url"||h==="#Test-local1"||h==="#Test-local2"||h==="#Test-config"||h==="#Test-clear"||this.isRunStandaloneHash(h)},parseUrl:function(u){if(!this.aElement){this.aElement=window.document.createElement('a')}this.aElement.href=u;return this.aElement},resolveHashFragment:function(h){var d=new jQuery.Deferred(),b=null,t=this,e,P,L,f,g,n,i,o,F=h,u;h=this.cleanHash(h);if(!h){return false}b={"#Test-config":{applicationType:"URL",url:"/sap/bc/ui5_ui5/ui2/ushell/test-resources/sap/ushell/demoapps/FioriSandboxConfigApp",additionalInformation:"SAPUI5.Component=sap.ushell.demoapps.FioriSandboxConfigApp"},"none":{applicationType:"URL",url:"",additionalInformation:""}};function j(K){if(localStorage){return localStorage[K]}return undefined}function k(o,K){var e={},a;for(a in o){if(o.hasOwnProperty(a)){if(a!==K){e[a]=o[a]}}}return e}function m(U){if(t.parseUrl(U).origin!==window.location.origin){return undefined}var a=t.parseUrl(U).pathname,x=jQuery.sap.getObject("runStandaloneAppFolderWhitelist",0,S),y;if(!x){return undefined}for(y in x){if(x.hasOwnProperty(y)){if(x[y]){if(y==="*"||a.indexOf(t.parseUrl(y).pathname)===0){return U}}}}return undefined}function q(K){return jQuery.sap.getUriParameters().get(K)}function v(a,K){return(a.params&&a.params[K]&&a.params[K][0])||q(K)}function w(K,V){if(localStorage){localStorage[K]=V}}if(b[h]){e=b[h]}else if(h==="#Test-clear"){w("sap.ushell.#Test-local1",undefined);w("sap.ushell.#Test-local2",undefined);jQuery.sap.log.info("NavTargetResolution: Local storage keys for #Test have been cleared");e=b["#Test-config"]}else if(this.isRunStandaloneHash(h)){L={applicationType:"URL"};P=sap.ushell.Container.getService("URLParsing").parseShellHash(F);f=(v(P,"sap-ushell-SAPUI5.Component")&&"SAPUI5.Component="+v(P,"sap-ushell-SAPUI5.Component"))||(v(P,"sap-ushell-additionalInformation"));u=v(P,"sap-ushell-url")||"";o=k(P.params,"sap-ushell-SAPUI5.Component");o=k(o,"sap-ushell-additionalInformation");o=k(o,"sap-ushell-url");n=sap.ushell.Container.getService("URLParsing").paramsToString(o);i=u.indexOf('?')>=0;if(n){u=u+(i?(((u[u.length-1]!=="&")&&"&")||""):"?")+n}L.url=m(u);L.additionalInformation=f;e=L}else if(h==="#Test-local1"||h==="#Test-local2"||h==="#Test-url"){e=j("sap.ushell."+h);if(!e||e==="undefined"){L={applicationType:"URL"}}else{L=JSON.parse(e)}if((window.location.hostname==="localhost")||S.allowTestUrlComponentConfig){g="sap-ushell-test-"+h.substring(6);f=q(g+"-additionalInformation");if(f){L.additionalInformation=f}u=q(g+"-url");if(u){L.url=m(u)}}if(!L.url){jQuery.sap.log.info("NavTargetResolution: No configured app for "+h+" found ( local storage or url params sap-ushell-test-local1-url  sap-ushell-test-local1-additionalInfo  not supplied? ");jQuery.sap.log.info("NavTargetResolution: Defaulting to config app ...\n");d.reject("URL is not resolvable");return d.promise()}L.url=m(L.url);e=L}if(e.url===undefined){d.reject("URL is not resolvable");return d.promise()}jQuery.sap.log.info("NavTargetResolution: As URL:  http://localhost:8080/sap/bc/ui5_ui5/ui2/ushell/shells/abap/FioriLaunchpad.html?sap-ushell-test-local1-url="+encodeURIComponent((e&&e.url)||"")+"&sap-ushell-test-local1-additionalInformation="+encodeURIComponent((e&&e.additionalInfo)||"")+"#Test-local1");jQuery.sap.log.info("NavTargetResolution: Resolving "+h+" to "+JSON.stringify(e));d.resolve(e);return d.promise()}});this.getCurrentResolution=function(){return C}}}());
