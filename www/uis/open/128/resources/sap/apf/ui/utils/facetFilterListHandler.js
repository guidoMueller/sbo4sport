/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.declare('sap.apf.ui.utils.facetFilterListHandler');jQuery.sap.require('sap.apf.ui.representations.utils.formatter');
sap.apf.ui.utils.FacetFilterListHandler=function(c,u,p,f){"use strict";var F=f.label;var s=f.property;var a=f.alias;var S=a||s;var b=f.filterResolutionRequest;var v=f.valueHelpRequest;var m;var o;var t=false;var h=false;this.fetchValueHelpData=function(){m=new jQuery.Deferred();if(v){var V=new sap.apf.ui.utils.PromiseBasedCreateReadRequest(c,v);V.then(this._getFormattedData).then(this._resolveMasterDataPromiseWith,this._handleError)}else{this._resolveMasterDataPromiseWith([])}return m.promise()};this.fetchSelectedFilterData=function(){o=new jQuery.Deferred();var P=p.getAllIds().indexOf(s)!==-1;if(P){var d=p.get(s);var O=d.getInternalFilter().getFilterTerms().map(function(g){return g.getOp()});var H=O.some(function(g){return g!=="EQ"});if(H||(!v&&!t)){t=true;if(b){var e=new sap.apf.ui.utils.PromiseBasedCreateReadRequest(c,b,d);e.then(this._resolveRelationalOperatorFromPCH,this._handleError).then(this._getFormattedData).then(this._resolveSelectDataPromiseWith);return o.promise()}if(H){this._handleFrrError();return o.promise()}}var D=d.getInternalFilter().getFilterTerms().map(function(g){return{key:g.getValue(),text:g.getValue()}});this._resolveSelectDataPromiseWith(D)}else{this._resolveSelectDataPromiseWith([])}return o.promise()};this._resolveMasterDataPromiseWith=function(V){m.resolveWith(this,[V])};this._resolveSelectDataPromiseWith=function(V){h=true;o.resolveWith(this,[V])};this._getFormattedData=function(A){var d=A.aData;var M=A.oMetadata;var e=new sap.apf.ui.representations.utils.formatter({getEventCallback:u.getEventCallback.bind(u),getTextNotHtmlEncoded:c.getTextNotHtmlEncoded},M,d);var T=M.getPropertyMetadata(S).text;var g=d.map(function(D){var i=e.getFormattedValue(S,D[S]);var j;if(T){var k=e.getFormattedValue(T,D[T]);j=i+" - "+k}else{j=i}return{key:D[S],text:j}});return g};this._resolveRelationalOperatorFromPCH=function(A){var d=A.aData;var M=A.oMetadata;var e=c.createFilter();var O=e.getTopAnd().addOr();d.forEach(function(D){var V=D[s];O.addExpression({name:s,operator:"EQ",value:V})});p.update(s,e);if(!h){p.saveInitialContext([s])}return{aData:d,oMetadata:M}};this._handleError=function(){var M=c.createMessageObject({code:"6010",aParameters:[c.getTextNotHtmlEncoded(F)]});c.putMessage(M)}};
sap.apf.ui.utils.PromiseBasedCreateReadRequest=function(c,r,f){var d=new jQuery.Deferred();var R=c.createReadRequestByRequiredFilter(r);var C=function(D,m,M){var a={aData:D,oMetadata:m};if(D&&m){d.resolveWith(this,[a])}else{d.rejectWith(this,[a])}};if(!f){f=c.createFilter()}R.send(f,C);return d.promise()};
