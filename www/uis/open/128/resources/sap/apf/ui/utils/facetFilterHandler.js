/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.declare('sap.apf.ui.utils.facetFilterHandler');jQuery.sap.require('sap.ui.thirdparty.d3');
sap.apf.ui.utils.FacetFilterHandler=function(i){"use strict";var c=i.oCoreApi;var s=i.oSBHandler;var p=i.oPathContextHandler;var u=i.oUiApi;var f=[];var S=[];var F=[];var C=[];var o={};var a;var b;this.initialize=function(){s.initialize();f=c.getFacetFilterConfigurations();b=s.getAllFilters();b.then(this._prepareContext.bind(this))};this._prepareContext=function(d){this._setSBFilters(d);this._setFacetFiltersFromConfiguration();this._setConsolidatedFilters();this._setContextFilterMap();this._updatePathContextHandler()};this._setSBFilters=function(d){S=d};this._setFacetFiltersFromConfiguration=function(){var d=this;f.forEach(function(e){if(d._isPresentInSbFilters(e.property)){return}if(e.preselectionDefaults||e.preselectionFunction){var v=e.preselectionDefaults||e.preselectionFunction.call();v.forEach(function(g){var h={NAME:e.property,OPERATOR:"EQ",VALUE_1:g,VALUE_2:null};F.push(h)})}})};this._setConsolidatedFilters=function(){C=[].concat(S,F)};this._setContextFilterMap=function(){C.forEach(function(d){if(!o[d.NAME]){o[d.NAME]=[]}o[d.NAME].push({OPERATOR:d.OPERATOR,VALUE_1:d.VALUE_1,VALUE_2:d.VALUE_2})});o=d3.map(o)};this._updatePathContextHandler=function(){o.forEach(function(d,e){var g=c.createFilter();var h=g.getTopAnd().addOr(d);e.forEach(function(E){var j={name:d,operator:E.OPERATOR,value:E.VALUE_1};if(E.OPERATOR==="BT"){j.high=E.VALUE_2}h.addExpression(j)});p.update(d,g)});p.saveInitialContext();u.contextChanged()};this._isPresentInSbFilters=function(d){var e=S.map(function(h){return h.NAME});var g=e.indexOf(d);return g!==-1};this._drawFacetFilter=function(){if(f&&f.length){a=sap.ui.view({viewName:"sap.apf.ui.reuse.view.facetFilter",type:sap.ui.core.mvc.ViewType.JS,viewData:{oCoreApi:c,oUiApi:u,oPathContextHandler:p,aFacetFilterListData:f}});u.getLayoutView().getController().addFacetFilter(a);sap.ui.getCore().applyChanges()}};this.drawFacetFilter=function(){b.then(this._drawFacetFilter)};this.contextChanged=function(){if(a){a.onContextChanged.call()}}};
