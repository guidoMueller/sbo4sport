/*!
* SAP APF Analysis Path Framework
* 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
*/
jQuery.sap.require('sap.apf.ui.utils.facetFilterListHandler');sap.ui.controller("sap.apf.ui.reuse.controller.facetFilter",{onInit:function(){var s=this;this.oView=this.getView();this.oCoreApi=this.oView.oCoreApi;this.oUiApi=this.oView.oUiApi;this.oPathContextHandler=this.oView.oPathContextHandler;this.aFacetFilterListData=this.oView.aFacetFilterListData;this.aFacetFilterListControls=this.oView.aFacetFilterListControls;this.aFacetFilterListHandlers=this.aFacetFilterListData.map(function(f){return new sap.apf.ui.utils.FacetFilterListHandler(s.oCoreApi,s.oUiApi,s.oPathContextHandler,f)});this.aFacetFilterListDatasets=this.aFacetFilterListData.map(function(){return[]});this._setInitialBinding();this._populateValueHelpData();this._updateSelectedFilters()},_setInitialBinding:function(){var s=this;this.aFacetFilterListControls.forEach(function(f,i){f.bindItems("/",new sap.m.FacetFilterItem({key:'{key}',text:'{text}',selected:'{selected}'}));var m=new sap.ui.model.json.JSONModel(s.aFacetFilterListDatasets[i]);m.setSizeLimit(1000);f.setModel(m)})},_populateValueHelpData:function(){var s=this;this.aFacetFilterListHandlers.forEach(function(f,i){f.fetchValueHelpData().then(s._populateValueHelpDataFor(i))})},_updateSelectedFilters:function(){var s=this;this.aFacetFilterListHandlers.forEach(function(f,i){f.fetchSelectedFilterData().then(s._updateSelectedFilterFor(i))})},_populateValueHelpDataFor:function(i){var f=this.aFacetFilterListControls[i];var F=this.aFacetFilterListData[i];var a=this.aFacetFilterListDatasets[i];var o=f.getModel();return function(d){d.forEach(function(D){var s=false;var n=-1;a.forEach(function(b,i){if(b.key===D.key){n=i;return}});if(n!==-1){s=a[n].selected;a.splice(n,1)}a.push({key:D.key,text:D.text,selected:s})});o.updateBindings()}},_updateSelectedFilterFor:function(i){var f=this.aFacetFilterListControls[i];var F=this.aFacetFilterListData[i];var a=this.aFacetFilterListDatasets[i];var o=f.getModel();return function(d){a.forEach(function(D){D.selected=false});d.forEach(function(D){var m=a.filter(function(b){return b.key===D.key});m.forEach(function(b){b.selected=true});if(!m.length){a.push({key:D.key,text:D.text,selected:true})}});o.updateBindings()}},onListClose:function(e){var c=e.getSource();var n=this.aFacetFilterListControls.indexOf(c);var p=this.aFacetFilterListData[n].property;var i=e.getParameter('allSelected');var s=i?c.getItems():e.getParameter('selectedItems');var S=s.map(function(I){return I.getKey()});var f=this.oCoreApi.createFilter();var o=f.getTopAnd().addOr();S.forEach(function(v){o.addExpression({name:p,operator:"EQ",value:v})});this.oPathContextHandler.update(p,f);this.oUiApi.selectionChanged(true)},onResetPress:function(){var f=this.aFacetFilterListData.map(function(F){return F.property});this.oPathContextHandler.restoreInitialContext(f);this.onContextChanged();this.oUiApi.selectionChanged(true)},onContextChanged:function(){this._updateSelectedFilters()}});
