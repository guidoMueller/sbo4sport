/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.apf.ui.controls.draggableCarousel.DraggableCarousel");(function(u){"use strict";var a;var d=(function(){a=window.hasOwnProperty('ontouchstart')||window.hasOwnProperty('onmsgesturechange')}());sap.apf.ui.controls.draggableCarousel.DraggableCarousel=function(o){var b=o||{};this.eleRefs={blocks:[],containerEle:o.containerEle};this._editState=b.editable===u?true:b.editable;this._dragState=this._editState;this._removeState=this._editState;this.styles={containerHeight:b.containerHeight,containerWidth:b.containerWidth,blockHeight:b.blockHeight,blockWidth:b.blockWidth,blockMargin:b.blockMargin,separatorHeight:b.separatorHeight,removeIconHeight:b.removeIconHeight};this.elems={separator:b.separator,removeIcon:b.removeIcon};this.callbacks={onBeforeDrag:b.onBeforeDrag,onAfterDrop:b.onAfterDrop,onAfterRemove:b.onAfterRemove,onAfterSelect:b.onAfterSelect};this.eleRefs.containerEle=this._drawSkeleton();this._initDimensions();this._isMouseDown=false};sap.apf.ui.controls.draggableCarousel.DraggableCarousel.prototype={_initDimensions:function(){var m=this.styles.blockMargin;this._blockMargin=parseInt(m.replace("px"),10);var b=this.styles.blockHeight;this._blockHeight=parseInt(b.replace("px"),10);this._blockTotalHeight=this._blockHeight+(2*this._blockMargin);this._separatorHeight=0;if(this.elems.separator!==u){var s=this.styles.separatorHeight;this._separatorHeight=parseInt(s.replace("px"),10)}this._mFactor=this._blockTotalHeight+this._separatorHeight},_drawSkeleton:function(){var c;if(this.eleRefs.containerEle===u){c=document.createElement('div')}else{c=this.eleRefs.containerEle}c.style.cssText+=this._getContainerStyles();c.classList.add('DnD-container');var s=this;var t=a?"touchend":"mouseup";document.addEventListener(t,function(e){s._onMouseUp(e,s)});return c},_getBlockWrapper:function(b){var c=b.blockElement;var f=this.eleRefs.blocks;var g=b.dragState===u?true:b.dragState;var h=b.dropState===u?true:b.dropState;var r=b.removable===u?true:b.removable;var i=document.createElement('div');i.style.cssText+=this._getBlockStyles();i.setAttribute('class','DnD-block');i.setAttribute('drag-state',g);i.setAttribute('drop-state',h);if(r){var j=this._getRemoveIconEle();i.appendChild(j)}var s=this;var t=a?"touchstart":"mousedown";i.addEventListener(t,function(e){s._onMouseDown(e,s,this)});var k=a?"touchmove":"mousemove";i.addEventListener(k,function(e){window.clearTimeout(s._TIMEOUTID)});this._keypress(i,13,function(l,e){var m=f.indexOf(l);s.callbacks.onAfterSelect.apply(l,[m])});this._keypress(i,32,function(l,e){var m=f.indexOf(l);s.callbacks.onAfterSelect.apply(l,[m])});this._keypress(i,36,function(l,e){jQuery(f).removeAttr("tabindex");jQuery(f).attr("tabindex",-1);jQuery(f[0]).attr("tabindex",0);jQuery(f[0]).focus()});this._keypress(i,35,function(l,e){jQuery(f).removeAttr("tabindex");jQuery(f).attr("tabindex",-1);jQuery(f[f.length-1]).attr("tabindex",0);jQuery(f[f.length-1]).focus()});if(r===true){this._keypress(i,46,function(l,e){var m=f.indexOf(l);s.removeBlock(m,s.callbacks.onAfterRemove);s._grouping(f);jQuery(f).parent().wrap("<div>").find("[tabindex='0']").focus()})}i.appendChild(c);return i},_getSeparatorEle:function(){var s=document.createElement('div');s.style.cssText+=this._getSeparatorStyles();s.setAttribute('class','DnD-separator');s.innerHTML=this.elems.separator.outerHTML;return s},_getRemoveIconEle:function(){var r=this.elems.removeIcon;var b=document.createElement('div');b.style.cssText+=this._getRemoveIconStyles();b.setAttribute('class','DnD-removeIconWrapper');b.innerHTML=r.outerHTML;var s=this;var t=a?"touchstart":"mousedown";b.addEventListener(t,function(e){s._onRemoveBlock(e,s,this)});return b},addBlock:function(b){if(b instanceof Array){var i;for(i=0;i<b.length;i++){this.addBlock(b[i])}return}var c=this._getBlockWrapper(b);var e=this.eleRefs.blocks.length;var f=this.eleRefs.blocks;var s=this;var y=e*this._mFactor;c.style.cssText=c.style.cssText+this._getTransformCss(y);this.eleRefs.blocks.push(c);var g=this.eleRefs.containerEle;g.appendChild(c);this._setHorizontalBlockMargin();if(this.elems.separator!==u){var h=this._getSeparatorEle();var j=y+this._blockHeight+2*this._blockMargin;h.style.cssText=h.style.cssText+this._getTransformCss(j);g.appendChild(h)}this._grouping(f)},swapBlocks:function(f,t){var b=this.eleRefs.blocks[f];var c=this.eleRefs.blocks[t];if((b.getAttribute('drag-state')!=="true"&&b.getAttribute('drop-state')!=="true")||(c.getAttribute('drag-state')!=="true"&&c.getAttribute('drop-state')!=="true")){return false}var e=f*this._mFactor;var g=e;var h=g+this._blockHeight+(2*this._blockMargin);var i=t*this._mFactor;var j=i;var k=j+this._blockHeight+(2*this._blockMargin);var l=document.getElementsByClassName('scrollContainerEle')[0]?document.getElementsByClassName('scrollContainerEle')[0]:this.eleRefs.containerEle;var s=l.scrollTop;if((f>t)&&j<l.scrollTop){s=j}if((f<t)&&k-l.offsetHeight>l.scrollTop){s=k-l.offsetHeight}var p;var m=40;var n=window.setInterval(function(){l.scrollTop+=(s-l.scrollTop)/m;if(l.scrollTop===p){window.clearInterval(n)}p=l.scrollTop},1000/60);this._setTransformYValue(b,i);this._setTransformYValue(c,e);this._swapArray(this.eleRefs.blocks,f,t);return true},insertBlock:function(b,c){var e=this.eleRefs.blocks;e.push({});var i;for(i=e.length-1;i>c;i--){e[i]=e[i-1];var f=i*this._mFactor;this._setTransformYValue(e[i],f)}var g=this._getBlockWrapper(b);e[i]=g;var y=c*this._mFactor;g.style.cssText=g.style.cssText+this._getTransformCss(y);var h=this.eleRefs.containerEle;h.appendChild(g);this._setHorizontalBlockMargin();if(this.elems.separator!==u){var s=this._getSeparatorEle();var j=y+this._blockHeight+2*this._blockMargin;s.style.cssText=s.style.cssText+this._getTransformCss(j);h.appendChild(s)}this._grouping(e)},removeBlock:function(b,c){var e=this.eleRefs.blocks;var f=this.eleRefs.containerEle;var i;var r=e[b];f.removeChild(r);for(i=b;i<e.length-1;i++){e[i]=e[i+1];var y=i*this._mFactor;this._setTransformYValue(e[i],y)}e.pop();if(this.elems.separator!==u){var s=f.querySelectorAll('.DnD-separator');var l=s[s.length-1];f.removeChild(l)}c.apply(f,[b]);this._grouping(e)},placeAt:function(i){var e=document.getElementById(i);e.appendChild(this.eleRefs.containerEle);this._setHorizontalBlockMargin()},getEditable:function(){return this._editState},setEditable:function(e){this._editState=e;this._setDragState(e);this._setRemoveState(e)},_setDragState:function(b){this._dragState=b},_setRemoveState:function(r){this._removeState=r;var b=this.eleRefs.containerEle.querySelectorAll('.DnD-removeIconWrapper');var c;if(r){c="display : block"}else{c="display : none"}var i;for(i=0;i<b.length;i++){b[i].style.cssText+=c}},_getContainerStyles:function(){var s=["height : ",this.styles.containerHeight,";width : ",this.styles.containerWidth,"overflow : auto; position : relative"].join("");return s},_getBlockStyles:function(){if(this.styles.horizontalBlockMargin===u){var c=this.eleRefs.containerEle.clientWidth;var b=this.eleRefs.blocks[0]===u?0:this.eleRefs.blocks[0].clientWidth;this.styles.horizontalBlockMargin=((c-b)/2)+"px"}var s=["height : ",this.styles.blockHeight,";width : ",this.styles.blockWidth,";margin : ",this.styles.blockMargin," ",this.styles.horizontalBlockMargin,";position : absolute"].join("");return s},_getSeparatorStyles:function(){var s=["height : ",this.styles.separatorHeight,";width : 100%",";position : absolute"].join("");return s},_getRemoveIconStyles:function(){var s=["height : ",this.styles.removeIconHeight,";width : ",this.styles.removeIconHeight,";float : right",";margin : -10px -13px -10px 0",";z-index : 2",";position : relative",";cursor : pointer"].join("");if(this._removeState){s+=";display : block"}else{s+=";display : none"}return s},_getTransformCss:function(y){var Y=y+"px";var t=["transform","-webkit-transform","-moz-transform","-ms-transform","-o-transform"];var c="";var i;for(i=0;i<t.length;i++){c+=t[i]+": translate3d(0px,"+Y+", 0px); "}return c},_setTransformYValue:function(e,y){var v=[{"WebkitTransform":"-webkit-transform"},{"MozTransform":"-moz-transform"},{"MsTransform":"-ms-transform"},{"OTransform":"-o-transform"}];var t="transform";var i;for(i=0;i<v.length;i++){if(e.style.hasOwnProperty(Object.keys(v[i])[0])){t=v[i][Object.keys(v[i])[0]]}}var Y=y+'px';e.style.cssText=e.style.cssText+" "+t+": translate3d(0px,"+Y+", 0px);"},_setHorizontalBlockMargin:function(){var b=this.eleRefs.blocks;var c=this.eleRefs.containerEle;var e=b[0]===u?0:b[0].clientWidth;var f=c.clientWidth;this.styles.horizontalBlockMargin=((f-e)/2)+"px";var m=this.styles.horizontalBlockMargin;[].forEach.call(b,function(g){g.style.cssText+="margin-right : "+m+";margin-left : "+m})},_onMouseDown:function(e,c,b){c._isMouseDown=true;c._TIMEOUTID=window.setTimeout(function(){if(c._isMouseDown){c._onDragStart(e,c,b)}},500)},_onMouseUp:function(e,c){c._isMouseDown=false;if(c._dragEle!==u&&c._dragEle.ele!==u){c._onDrop(e,c)}},_onDragStart:function(e,c,b){if(!c._dragState||b.getAttribute('drag-state')!=='true'){return}c._dragIndex=c.eleRefs.blocks.indexOf(b);var y=c._dragIndex*c._mFactor;var f=document.getElementsByClassName('scrollContainerEle')[0]?document.getElementsByClassName('scrollContainerEle')[0]:c.eleRefs.containerEle;c._containerEleOffsetHeight=f.offsetHeight;c._containerEleScrollHeight=f.scrollHeight;c._blockEleOffsetHeight=b.offsetHeight;c._containerEleScrollTop=f.scrollTop;var g=y+c._blockMargin;var h=g+c._blockHeight;if(g<c._containerEleScrollTop){f.scrollTop=g;c._containerEleScrollTop=Math.max(0,g)}if(h-c._containerEleOffsetHeight>f.scrollTop){f.scrollTop=h-c._containerEleOffsetHeight;c._containerEleScrollTop=Math.min(c._containerEleScrollHeight-c._containerEleOffsetHeight,h-c._containerEleOffsetHeight)}c._diffTop=e.pageY-y+c._containerEleScrollTop;c._dragEle={ele:b,pos:{y:y}};c.callbacks.onBeforeDrag.apply(b,[c._dragIndex]);c._dragEle.ele.className=c._dragEle.ele.className+" "+"DnD-drag";var t=a?"touchmove":"mousemove";document.addEventListener(t,function(e){if(c._dragEle.ele!==u){e.preventDefault();c._onDrag(e,c);e.stopPropagation()}})},_onDrag:function(e,c){var b=document.getElementsByClassName('scrollContainerEle')[0]?document.getElementsByClassName('scrollContainerEle')[0]:c.eleRefs.containerEle;var y=e.pageY-c._diffTop+c._containerEleScrollTop;var f=y+c._blockMargin;var g=f+c._blockHeight;var h=((e.pageY-c._diffTop)>c._prevPageY);var j=((e.pageY-c._diffTop)<c._prevPageY);c._prevPageY=(e.pageY-c._diffTop);if(j&&(f<c._containerEleScrollTop)){b.scrollTop=f;c._containerEleScrollTop=Math.max(0,f);y=e.pageY-c._diffTop+c._containerEleScrollTop}if(h&&((g-c._containerEleOffsetHeight)>c._containerEleScrollTop)){b.scrollTop=g-c._containerEleOffsetHeight;c._containerEleScrollTop=Math.min(c._containerEleScrollHeight-c._containerEleOffsetHeight,g-c._containerEleOffsetHeight);y=e.pageY-c._diffTop+c._containerEleScrollTop}c._setTransformYValue(c._dragEle.ele,y);var m=c.styles.blockMargin;var k=parseInt(m.replace("px"),10);var l=y;var n=y+c._blockEleOffsetHeight;var o=c._dragEle.pos.y-(c._mFactor-(c._blockHeight/2));var p=(c._dragEle.pos.y+c._blockEleOffsetHeight)+(c._mFactor-(c._blockHeight/2));var q=c._dragEle.pos.y;var r=q/(c._mFactor);var s=c.eleRefs.blocks;var t=-1,v=s.length;var i,w;for(i=r-1;i>=0;i--){w=s[i];if(w.getAttribute('drop-state')==='true'){t=i;break}}for(i=r+1;i<s.length;i++){w=s[i];if(w.getAttribute('drop-state')==='true'){v=i;break}}o=c._dragEle.pos.y-((r-t)*c._mFactor-(c._blockHeight/2));p=(c._dragEle.pos.y+c._blockEleOffsetHeight)+((v-r)*c._mFactor-(c._blockHeight/2));var x;var S=false;if(l<o){S=true;x=t}else if(n>p){S=true;x=v}if(S&&(x>=0)&&(x<=s.length-1)){c._dragEle.pos.y=x*(c._mFactor);var z=s[x];if(z!==u){c._setTransformYValue(z,q);c._swapArray(s,r,x)}}},_onDrop:function(e,c){c._dragEle.ele.className=c._dragEle.ele.className.replace(" DnD-drag","");var b=c.eleRefs.containerEle.querySelectorAll('.DnD-drag');var i;for(i=0;i<b.length;i++){b[i].className=b[i].className.replace(" DnD-drag","")}var f=c._dragEle.pos.y;c._dropIndex=f/(c._mFactor);c._setTransformYValue(c._dragEle.ele,f);c.callbacks.onAfterDrop.apply(c._dragEle.ele,[c._dragIndex,c._dropIndex]);c._dragEle={}},_onRemoveBlock:function(e,c,r){e.stopPropagation();var b=r.parentElement;var f=c.eleRefs.blocks.indexOf(b);c.removeBlock(f,c.callbacks.onAfterRemove)},_swapArray:function(b,f,t){var c=b[f];b[f]=b[t];b[t]=c;return b},_grouping:function(b){var c=b;var f=(b.length>2)?b.length-2:0;jQuery(c).removeAttr("tabindex");jQuery(c).attr("tabindex",-1);jQuery(c[f]).attr("tabindex",0);this._keypress(c,38,function(g,e){var i=c.indexOf(g);if(i===0){return}jQuery(c).removeAttr("tabindex");jQuery(c).attr("tabindex",-1);jQuery(c[i-1]).attr("tabindex",0);jQuery(c[i-1]).focus()});this._keypress(c,40,function(g,e){var i=c.indexOf(g);if(i===c.length-1){return}jQuery(c).removeAttr("tabindex");jQuery(c).attr("tabindex",-1);jQuery(c[i+1]).attr("tabindex",0);jQuery(c[i+1]).focus()})},_keypress:function(b,k,c){jQuery(b).keydown(function(e){var f=e.keyCode||e.which;if(f===k){c(this,e);return false}})}}}(undefined));
