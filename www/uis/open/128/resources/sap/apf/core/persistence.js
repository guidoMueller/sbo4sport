/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.apf.core.persistence");
sap.apf.core.Persistence=function(I){this.createPath=function(n,C,E){var S=I.coreApi.serializePath();if(E){S.pathContextHandler=E.pathContextHandler}var o=d(S);var r={data:{AnalysisPath:"",AnalysisPathName:n,LogicalSystem:I.coreApi.getLogicalSystem(),ApplicationConfigurationURL:I.coreApi.getApplicationConfigurationURL(),SerializedAnalysisPath:JSON.stringify(S),StructuredAnalysisPath:JSON.stringify(o)},method:"POST"};s(r,R.bind(this));function R(f,h,m){if(m){C({oResponse:f,status:"failed"},h,m)}else{I.messageHandler.check(f&&f.data&&f.statusCode===201&&f.statusText==="Created","Persistence create Path - proper response");C({AnalysisPath:f.data.AnalysisPath,status:"successful"},h,m)}}};this.readPaths=function(C){var r={method:"GET"};s(r,R.bind(this));function R(o,E,m){if(!m&&o&&o.data&&o.data.results){for(var i in o.data.results){o.data.results[i].StructuredAnalysisPath=JSON.parse(o.data.results[i].StructuredAnalysisPath)}}else if(!m||o.statusCode!==200||o.statusText!=="OK"){m=I.messageHandler.createMessageObject({code:'5211'})}if(m){C({oResponse:o,status:"failed"},E,m)}else{C({paths:o.data.results,status:"successful"},E,m)}}};this.deletePath=function(A,C){var r={method:"DELETE"};s(r,R.bind(this),A);function R(o,E,m){if((o.statusCode!==204||o.statusText!=="No Content")&&(!m)){m=I.messageHandler.createMessageObject({code:5201});m.setPrevious(I.messageHandler.createMessageObject({code:5200,aParameters:[o.statusCode,o.statusText]}))}if(m){C({oResponse:o,status:"failed"},E,m)}else{C({status:"successful"},E,m)}}};this.modifyPath=function(A,n,C,E){var S=I.coreApi.serializePath();if(E){S.pathContextHandler=E.pathContextHandler}var o=d(S);var r={data:{AnalysisPathName:n,LogicalSystem:I.coreApi.getLogicalSystem(),ApplicationConfigurationURL:I.coreApi.getApplicationConfigurationURL(),SerializedAnalysisPath:JSON.stringify(S),StructuredAnalysisPath:JSON.stringify(o)},method:"PUT"};s(r,R.bind(this),A);function R(f,h,m){if((f.statusCode!==204||f.statusText!=="No Content")&&(!m)){m=I.messageHandler.createMessageObject({code:5201});m.setPrevious(I.messageHandler.createMessageObject({code:5200,aParameters:[f.statusCode,f.statusText]}))}if(m){C({oResponse:f,status:"failed"},h,m)}else{C({AnalysisPath:A,status:"successful"},h,m)}}};this.openPath=function(A,C,n){var r={method:"GET"};s(r,R.bind(this),A);function R(o,E,m){var M;if(!m&&o&&o.statusCode===200&&o.data&&o.data.SerializedAnalysisPath){o.data.SerializedAnalysisPath=JSON.parse(o.data.SerializedAnalysisPath);m=a(o.data,n)}if(m){M=I.messageHandler.createMessageObject({code:'5210'});M.setPrevious(m);I.messageHandler.putMessage(M)}if(M){C({oResponse:o,status:"failed"},E,M)}else{C({path:o.data,status:"successful"},E,M)}}};function s(r,l,A){var u=g();switch(r.method){case"GET":if(!r.data&&A){r.requestUri=u+"('"+A+"')"}else if(!r.data&&!A){r.requestUri=u+"?$select=AnalysisPath,AnalysisPathName,StructuredAnalysisPath,CreationUTCDateTime,LastChangeUTCDateTime&$filter=(LogicalSystem%20eq%20'"+I.coreApi.getLogicalSystem()+"'%20and%20ApplicationConfigurationURL%20eq%20'"+I.coreApi.getApplicationConfigurationURL()+"')&$orderby=LastChangeUTCDateTime%20desc"}break;case"POST":if(r.data&&!A){r.requestUri=u}break;case"DELETE":if(!r.data&&A){r.requestUri=u+"('"+A+"')"}break;case"PUT":if(r.data&&A){r.requestUri=u+"('"+A+"')"}break;default:break}r.headers={"x-csrf-token":I.coreApi.getXsrfToken(g())};var S=function(D,R){l(R,e(),undefined)};var E=function(o){var m;if(o.messageObject&&o.messageObject.getCode&&o.messageObject.getCode()==5021){l(o,e(),o.messageObject);return}var f=c(o.response.body);if(f!==undefined){m=I.messageHandler.createMessageObject({code:f})}if(o.response.body.match("274")){m=I.messageHandler.createMessageObject({code:'5207'})}if(o.response.statusCode===400){m=I.messageHandler.createMessageObject({code:'5203'})}if(o.response.statusCode===403){m=I.messageHandler.createMessageObject({code:'5206'})}if(o.response.statusCode===405){m=I.messageHandler.createMessageObject({code:'5202'})}if(o.response.statusCode===404){m=I.messageHandler.createMessageObject({code:'5208'})}if(!m&&o.response.statusCode===500){m=I.messageHandler.createMessageObject({code:'5200',aParameters:[o.response.statusCode,o.response.statusText]})}if(!m){m=I.messageHandler.createMessageObject({code:'5201'})}I.messageHandler.putMessage(m);l(o,e(),m)};I.coreApi.odataRequest(r,S,E)}function c(E){var f=E.match("52[0-9]{2}");if(f){return f[0]}else{return undefined}}function a(r,n){var p;var m;var o=I.coreApi.getContext();function f(){I.messageHandler.putMessage=p}function h(){p=I.messageHandler.putMessage;I.messageHandler.putMessage=function(m){throw m}}if(n!==undefined){r.SerializedAnalysisPath.path.indicesOfActiveSteps[0]=n}I.coreApi.resetPath(true);h();try{I.coreApi.deserializePath(r.SerializedAnalysisPath)}catch(E){I.coreApi.restoreOriginalPath();I.coreApi.setContext(o);m=b(E)}finally{f()}return m}function b(E){var m;if(E.type&&E.type==="messageObject"){m=E}else{m=new I.coreApi.MessageObject({code:sap.apf.core.constants.message.code.errorUnknown});m.setSeverity(sap.apf.core.constants.message.severity.error);m.setMessage("Unknown exception caught "+E.message)}return m}function g(){var p=I.coreApi.getPersistenceConfiguration().path;var S=p.service+"/"+p.entityType;return S}function d(S){var f=[];var h=S.path.steps;var j;for(var i in h){f.push({stepId:h[i].stepId,selectedRepresentationId:h[i].binding.selectedRepresentationId})}j={steps:f,indexOfActiveStep:S.path.indicesOfActiveSteps[0]};return j}function e(){var C=I.coreApi.getPersistenceConfiguration();var E=I.coreApi.getEntityTypeMetadata(C.path.service,C.path.entityType);return E}};
